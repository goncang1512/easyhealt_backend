import{createServer as If}from"http";import{Http2ServerRequest as Xs}from"http2";import{Readable as Ja}from"stream";import Fu from"crypto";import{PrismaClient as xf}from"@prisma/client";import Cf from"fs";import Pf from"path";import Uf from"os";var Tr=class extends Error{constructor(e,t){super(e,t),this.name="RequestError"}},Lf=e=>e instanceof Tr?e:new Tr(e.message,{cause:e}),$f=global.Request,vs=class extends $f{constructor(t,r){typeof t=="object"&&_n in t&&(t=t[_n]()),typeof r?.body?.getReader<"u"&&(r.duplex??="half"),super(t,r)}},Df=e=>{const t=[],r=e.rawHeaders;for(let n=0;n<r.length;n+=2){const{[n]:s,[n+1]:i}=r;s.charCodeAt(0)!==58&&t.push([s,i])}return new Headers(t)},Bu=Symbol("wrapBodyStream"),qf=(e,t,r,n,s)=>{const i={method:e,headers:r,signal:s.signal};if(e==="TRACE"){i.method="GET";const o=new vs(t,i);return Object.defineProperty(o,"method",{get(){return"TRACE"}}),o}if(!(e==="GET"||e==="HEAD"))if("rawBody"in n&&n.rawBody instanceof Buffer)i.body=new ReadableStream({start(o){o.enqueue(n.rawBody),o.close()}});else if(n[Bu]){let o;i.body=new ReadableStream({async pull(a){try{o||=Ja.toWeb(n).getReader();const{done:c,value:u}=await o.read();c?a.close():a.enqueue(u)}catch(c){a.error(c)}}})}else i.body=Ja.toWeb(n);return new vs(t,i)},_n=Symbol("getRequestCache"),Wf=Symbol("requestCache"),ei=Symbol("incomingKey"),hi=Symbol("urlKey"),zf=Symbol("headersKey"),gn=Symbol("abortControllerKey"),Mf=Symbol("getAbortController"),Vi={get method(){return this[ei].method||"GET"},get url(){return this[hi]},get headers(){return this[zf]||=Df(this[ei])},[Mf](){return this[_n](),this[gn]},[_n](){return this[gn]||=new AbortController,this[Wf]||=qf(this.method,this[hi],this.headers,this[ei],this[gn])}};["body","bodyUsed","cache","credentials","destination","integrity","mode","redirect","referrer","referrerPolicy","signal","keepalive"].forEach(e=>{Object.defineProperty(Vi,e,{get(){return this[_n]()[e]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(e=>{Object.defineProperty(Vi,e,{value:function(){return this[_n]()[e]()}})});Object.setPrototypeOf(Vi,vs.prototype);var jf=(e,t)=>{const r=Object.create(Vi);r[ei]=e;const n=e.url||"";if(n[0]!=="/"&&(n.startsWith("http://")||n.startsWith("https://"))){if(e instanceof Xs)throw new Tr("Absolute URL for :path is not allowed in HTTP/2");try{const a=new URL(n);r[hi]=a.href}catch(a){throw new Tr("Invalid absolute URL",{cause:a})}return r}const s=(e instanceof Xs?e.authority:e.headers.host)||t;if(!s)throw new Tr("Missing host header");let i;if(e instanceof Xs){if(i=e.scheme,!(i==="http"||i==="https"))throw new Tr("Unsupported scheme")}else i=e.socket&&e.socket.encrypted?"https":"http";const o=new URL(`${i}://${s}${n}`);if(o.hostname.length!==s.length&&o.hostname!==s.replace(/:\d+$/,""))throw new Tr("Invalid host header");return r[hi]=o.href,r},Ga=Symbol("responseCache"),fn=Symbol("getResponseCache"),xr=Symbol("cache"),ia=global.Response,xs=class Hu{#e;#t;[fn](){return delete this[xr],this[Ga]||=new ia(this.#e,this.#t)}constructor(t,r){let n;if(this.#e=t,r instanceof Hu){const s=r[Ga];if(s){this.#t=s,this[fn]();return}else this.#t=r.#t,n=new Headers(r.#t.headers)}else this.#t=r;(typeof t=="string"||typeof t?.getReader<"u"||t instanceof Blob||t instanceof Uint8Array)&&(n||=r?.headers||{"content-type":"text/plain; charset=UTF-8"},this[xr]=[r?.status||200,t,n])}get headers(){const t=this[xr];return t?(t[2]instanceof Headers||(t[2]=new Headers(t[2])),t[2]):this[fn]().headers}get status(){return this[xr]?.[0]??this[fn]().status}get ok(){const t=this.status;return t>=200&&t<300}};["body","bodyUsed","redirected","statusText","trailers","type","url"].forEach(e=>{Object.defineProperty(xs.prototype,e,{get(){return this[fn]()[e]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(e=>{Object.defineProperty(xs.prototype,e,{value:function(){return this[fn]()[e]()}})});Object.setPrototypeOf(xs,ia);Object.setPrototypeOf(xs.prototype,ia.prototype);async function Vf(e){return Promise.race([e,Promise.resolve().then(()=>Promise.resolve(void 0))])}function Ku(e,t,r){const n=()=>{};return t.on("error",n),(r??e.read()).then(o,s),e.closed.finally(()=>{t.off("error",n)});function s(a){a&&t.destroy(a)}function i(){e.read().then(o,s)}function o({done:a,value:c}){try{if(a)t.end();else if(!t.write(c))t.once("drain",i);else return e.read().then(o,s)}catch(u){s(u)}}}function Ff(e,t){if(e.locked)throw new TypeError("ReadableStream is locked.");return t.destroyed?void 0:Ku(e.getReader(),t)}var Zu=e=>{const t={};e instanceof Headers||(e=new Headers(e??void 0));const r=[];for(const[n,s]of e)n==="set-cookie"?r.push(s):t[n]=s;return r.length>0&&(t["set-cookie"]=r),t["content-type"]??="text/plain; charset=UTF-8",t},Bf="x-hono-already-sent",Hf=global.fetch;typeof global.crypto>"u"&&(global.crypto=Fu);global.fetch=(e,t)=>(t={compress:!1,...t},Hf(e,t));var oa=Symbol("outgoingEnded"),Kf=()=>new Response(null,{status:400}),Ju=e=>new Response(null,{status:e instanceof Error&&(e.name==="TimeoutError"||e.constructor.name==="TimeoutError")?504:500}),Co=(e,t)=>{const r=e instanceof Error?e:new Error("unknown error",{cause:e});r.code==="ERR_STREAM_PREMATURE_CLOSE"?console.info("The user aborted a request."):(console.error(e),t.headersSent||t.writeHead(500,{"Content-Type":"text/plain"}),t.end(`Error: ${r.message}`),t.destroy(r))},Gu=e=>{"flushHeaders"in e&&e.writable&&e.flushHeaders()},Qu=async(e,t)=>{let[r,n,s]=e[xr];s instanceof Headers&&(s=Zu(s)),typeof n=="string"?s["Content-Length"]=Buffer.byteLength(n):n instanceof Uint8Array?s["Content-Length"]=n.byteLength:n instanceof Blob&&(s["Content-Length"]=n.size),t.writeHead(r,s),typeof n=="string"||n instanceof Uint8Array?t.end(n):n instanceof Blob?t.end(new Uint8Array(await n.arrayBuffer())):(Gu(t),await Ff(n,t)?.catch(i=>Co(i,t))),t[oa]?.()},Zf=e=>typeof e.then=="function",Jf=async(e,t,r={})=>{if(Zf(e))if(r.errorHandler)try{e=await e}catch(s){const i=await r.errorHandler(s);if(!i)return;e=i}else e=await e.catch(Ju);if(xr in e)return Qu(e,t);const n=Zu(e.headers);if(e.body){const s=e.body.getReader(),i=[];let o=!1,a;if(n["transfer-encoding"]!=="chunked"){let c=2;for(let u=0;u<c;u++){a||=s.read();const d=await Vf(a).catch(l=>{console.error(l),o=!0});if(!d){if(u===1){await new Promise(l=>setTimeout(l)),c=3;continue}break}if(a=void 0,d.value&&i.push(d.value),d.done){o=!0;break}}o&&!("content-length"in n)&&(n["content-length"]=i.reduce((u,d)=>u+d.length,0))}t.writeHead(e.status,n),i.forEach(c=>{t.write(c)}),o?t.end():(i.length===0&&Gu(t),await Ku(s,t,a))}else n[Bf]||(t.writeHead(e.status,n),t.end());t[oa]?.()},Gf=(e,t={})=>{const r=t.autoCleanupIncoming??!0;return t.overrideGlobalObjects!==!1&&global.Request!==vs&&(Object.defineProperty(global,"Request",{value:vs}),Object.defineProperty(global,"Response",{value:xs})),async(n,s)=>{let i,o;try{o=jf(n,t.hostname);let a=!r||n.method==="GET"||n.method==="HEAD";if(a||(n[Bu]=!0,n.on("end",()=>{a=!0}),n instanceof Xs&&(s[oa]=()=>{a||setTimeout(()=>{a||setTimeout(()=>{n.destroy(),s.destroy()})})})),s.on("close",()=>{o[gn]&&(n.errored?o[gn].abort(n.errored.toString()):s.writableFinished||o[gn].abort("Client connection prematurely closed.")),a||setTimeout(()=>{a||setTimeout(()=>{n.destroy()})})}),i=e(o,{incoming:n,outgoing:s}),xr in i)return Qu(i,s)}catch(a){if(i)return Co(a,s);if(t.errorHandler){if(i=await t.errorHandler(o?a:Lf(a)),!i)return}else o?i=Ju(a):i=Kf()}try{return await Jf(i,s,t)}catch(a){return Co(a,s)}}},Qf=e=>{const t=e.fetch,r=Gf(t,{hostname:e.hostname,overrideGlobalObjects:e.overrideGlobalObjects,autoCleanupIncoming:e.autoCleanupIncoming});return(e.createServer||If)(e.serverOptions||{},r)},Yu=(e,t)=>{const r=Qf(e);return r.listen(e?.port??3e3,e.hostname,()=>{const n=r.address();t&&t(n)}),r};function Ur(){const e=typeof globalThis<"u"&&globalThis.crypto;if(e&&typeof e.subtle=="object"&&e.subtle!=null)return e.subtle;throw new Error("crypto.subtle must be defined")}const fi=(()=>{const e=function(){};return e.prototype=Object.create(null),e})();function Qa(){return{root:{key:""},static:new fi}}function aa(e){return e.split("/").filter(Boolean)}function Xu(e,t){const r=new fi;for(const[n,s]of t){const i=n<0?e.slice(-1*n).join("/"):e[n];if(typeof s=="string")r[s]=i;else{const o=i.match(s);if(o)for(const a in o.groups)r[a]=o.groups[a]}}return r}function Ya(e,t="",r,n){const s=aa(r);let i=e.root,o=0;const a=[];for(let u=0;u<s.length;u++){const d=s[u];if(d.startsWith("**")){i.wildcard||(i.wildcard={key:"**"}),i=i.wildcard,a.push([-u,d.split(":")[1]||"_",d.length===2]);break}if(d==="*"||d.includes(":")){i.param||(i.param={key:"*"}),i=i.param;const h=d==="*";a.push([u,h?`_${o++}`:Yf(d),h]);continue}const l=i.static?.[d];if(l)i=l;else{const h={key:d};i.static||(i.static=new fi),i.static[d]=h,i=h}}const c=a.length>0;i.methods||(i.methods=new fi),i.methods[t]||(i.methods[t]=[]),i.methods[t].push({data:n||null,paramsMap:c?a:void 0}),c||(e.static[r]=i)}function Yf(e){if(!e.includes(":",1))return e.slice(1);const t=e.replace(/:(\w+)/g,(r,n)=>`(?<${n}>\\w+)`);return new RegExp(`^${t}$`)}function Xf(e,t="",r,n){r[r.length-1]==="/"&&(r=r.slice(0,-1));const s=e.static[r];if(s&&s.methods){const a=s.methods[t]||s.methods[""];if(a!==void 0)return a[0]}const i=aa(r),o=Po(e,e.root,t,i,0)?.[0];if(o!==void 0)return{data:o.data,params:o.paramsMap?Xu(i,o.paramsMap):void 0}}function Po(e,t,r,n,s){if(s===n.length){if(t.methods){const o=t.methods[r]||t.methods[""];if(o)return o}if(t.param&&t.param.methods){const o=t.param.methods[r]||t.param.methods[""];if(o){const a=o[0].paramsMap;if(a?.[a?.length-1]?.[2])return o}}if(t.wildcard&&t.wildcard.methods){const o=t.wildcard.methods[r]||t.wildcard.methods[""];if(o){const a=o[0].paramsMap;if(a?.[a?.length-1]?.[2])return o}}return}const i=n[s];if(t.static){const o=t.static[i];if(o){const a=Po(e,o,r,n,s+1);if(a)return a}}if(t.param){const o=Po(e,t.param,r,n,s+1);if(o)return o}if(t.wildcard&&t.wildcard.methods)return t.wildcard.methods[r]||t.wildcard.methods[""]}function ep(e,t="",r,n){r[r.length-1]==="/"&&(r=r.slice(0,-1));const s=aa(r);return Uo(e,e.root,t,s,0).map(o=>({data:o.data,params:o.paramsMap?Xu(s,o.paramsMap):void 0}))}function Uo(e,t,r,n,s,i=[]){const o=n[s];if(t.wildcard&&t.wildcard.methods){const c=t.wildcard.methods[r]||t.wildcard.methods[""];c&&i.push(...c)}if(t.param&&(Uo(e,t.param,r,n,s+1,i),s===n.length&&t.param.methods)){const c=t.param.methods[r]||t.param.methods[""];c&&i.push(...c)}const a=t.static?.[o];if(a&&Uo(e,a,r,n,s+1,i),s===n.length&&t.methods){const c=t.methods[r]||t.methods[""];c&&i.push(...c)}return i}var tp=Object.defineProperty,rp=(e,t)=>{for(var r in t)tp(e,r,{get:t[r],enumerable:!0})};function np(){const e=Object.getOwnPropertyDescriptor(Error,"stackTraceLimit");return e===void 0?Object.isExtensible(Error):Object.prototype.hasOwnProperty.call(e,"writable")?e.writable:e.set!==void 0}function sp(e){const t=e.split(`
    at `);return t.length<=1?e:(t.splice(1,1),t.join(`
    at `))}function ip(e,t){class r extends e{#e;constructor(...s){if(np()){const o=Error.stackTraceLimit;Error.stackTraceLimit=0,super(...s),Error.stackTraceLimit=o}else super(...s);const i=new Error().stack;i&&(this.#e=sp(i.replace(/^Error/,this.name)))}get errorStack(){return this.#e}}return Object.defineProperty(r.prototype,"constructor",{get(){return t},enumerable:!1,configurable:!0}),r}var op={OK:200,CREATED:201,ACCEPTED:202,NO_CONTENT:204,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,TEMPORARY_REDIRECT:307,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,PAYLOAD_TOO_LARGE:413,URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,"I'M_A_TEAPOT":418,MISDIRECTED_REQUEST:421,UNPROCESSABLE_ENTITY:422,LOCKED:423,FAILED_DEPENDENCY:424,TOO_EARLY:425,UPGRADE_REQUIRED:426,PRECONDITION_REQUIRED:428,TOO_MANY_REQUESTS:429,REQUEST_HEADER_FIELDS_TOO_LARGE:431,UNAVAILABLE_FOR_LEGAL_REASONS:451,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,VARIANT_ALSO_NEGOTIATES:506,INSUFFICIENT_STORAGE:507,LOOP_DETECTED:508,NOT_EXTENDED:510,NETWORK_AUTHENTICATION_REQUIRED:511},ap=class extends Error{constructor(e="INTERNAL_SERVER_ERROR",t=void 0,r={},n=typeof e=="number"?e:op[e]){super(t?.message,t?.cause?{cause:t.cause}:void 0),this.status=e,this.body=t,this.headers=r,this.statusCode=n,this.name="APIError",this.status=e,this.headers=r,this.statusCode=n,this.body=t?{code:t?.message?.toUpperCase().replace(/ /g,"_").replace(/[^A-Z0-9_]/g,""),...t}:void 0}},T=ip(ap,Error);async function cp(e){const t=e.headers.get("content-type")||"";if(e.body){if(t.includes("application/json"))return await e.json();if(t.includes("application/x-www-form-urlencoded")){const r=await e.formData(),n={};return r.forEach((s,i)=>{n[i]=s.toString()}),n}if(t.includes("multipart/form-data")){const r=await e.formData(),n={};return r.forEach((s,i)=>{n[i]=s}),n}return t.includes("text/plain")?await e.text():t.includes("application/octet-stream")?await e.arrayBuffer():t.includes("application/pdf")||t.includes("image/")||t.includes("video/")?await e.blob():t.includes("application/stream")||e.body instanceof ReadableStream?e.body:await e.text()}}function pi(e){return e instanceof T||e?.name==="APIError"}function up(e){try{return e.includes("%")?decodeURIComponent(e):e}catch{return e}}function dp(e){if(e===void 0)return!1;const t=typeof e;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function lp(e,t,r){let n=0;const s=new WeakMap;return JSON.stringify(e,(o,a)=>{if(typeof a=="bigint")return a.toString();if(typeof a=="object"&&a!==null){if(s.has(a))return`[Circular ref-${s.get(a)}]`;s.set(a,n++)}return a},r)}function hp(e){return!e||typeof e!="object"?!1:"_flag"in e&&e._flag==="json"}function Lr(e,t){if(e instanceof Response)return t?.headers instanceof Headers&&t.headers.forEach((i,o)=>{e.headers.set(o,i)}),e;if(hp(e)){const i=e.body,o=e.routerResponse;if(o instanceof Response)return o;const a=new Headers({...o?.headers,...e.headers,...t?.headers,"Content-Type":"application/json"});return new Response(JSON.stringify(i),{...o,headers:a,status:e.status??t?.status??o?.status,statusText:t?.statusText??o?.statusText})}if(pi(e))return Lr(e.body,{status:t?.status??e.statusCode,statusText:e.status.toString(),headers:t?.headers||e.headers});let n=e,s=new Headers(t?.headers);return e?typeof e=="string"?(n=e,s.set("Content-Type","text/plain")):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?(n=e,s.set("Content-Type","application/octet-stream")):e instanceof Blob?(n=e,s.set("Content-Type",e.type||"application/octet-stream")):e instanceof FormData?n=e:e instanceof URLSearchParams?(n=e,s.set("Content-Type","application/x-www-form-urlencoded")):e instanceof ReadableStream?(n=e,s.set("Content-Type","application/octet-stream")):dp(e)&&(n=lp(e),s.set("Content-Type","application/json")):(e===null&&(n=JSON.stringify(null)),s.set("content-type","application/json")),new Response(n,{...t,headers:s})}async function fp(e,t={}){let r={body:t.body,query:t.query};if(e.body){const n=await e.body["~standard"].validate(t.body);if(n.issues)return{data:null,error:Xa(n.issues,"body")};r.body=n.value}if(e.query){const n=await e.query["~standard"].validate(t.query);if(n.issues)return{data:null,error:Xa(n.issues,"query")};r.query=n.value}return e.requireHeaders&&!t.headers?{data:null,error:{message:"Headers is required"}}:e.requireRequest&&!t.request?{data:null,error:{message:"Request is required"}}:{data:r,error:null}}function Xa(e,t){for(const r of e)r.message;return{message:`Invalid ${t} parameters`}}var ca={name:"HMAC",hash:"SHA-256"},ed=async e=>{const t=typeof e=="string"?new TextEncoder().encode(e):e;return await Ur().importKey("raw",t,ca,!1,["sign","verify"])},pp=async(e,t,r)=>{try{const n=atob(e),s=new Uint8Array(n.length);for(let i=0,o=n.length;i<o;i++)s[i]=n.charCodeAt(i);return await Ur().verify(ca,r,s,new TextEncoder().encode(t))}catch{return!1}},mp=async(e,t)=>{const r=await ed(t),n=await Ur().sign(ca.name,r,new TextEncoder().encode(e));return btoa(String.fromCharCode(...new Uint8Array(n)))},yp=async(e,t)=>{const r=await mp(e,t);return e=`${e}.${r}`,e=encodeURIComponent(e),e},ec=(e,t)=>{let r=e;if(t)if(t==="secure")r="__Secure-"+e;else if(t==="host")r="__Host-"+e;else return;return r};function wp(e){if(typeof e!="string")throw new TypeError("argument str must be a string");const t=new Map;let r=0;for(;r<e.length;){const n=e.indexOf("=",r);if(n===-1)break;let s=e.indexOf(";",r);if(s===-1)s=e.length;else if(s<n){r=e.lastIndexOf(";",n-1)+1;continue}const i=e.slice(r,n).trim();if(!t.has(i)){let o=e.slice(n+1,s).trim();o.codePointAt(0)===34&&(o=o.slice(1,-1)),t.set(i,up(o))}r=s+1}return t}var td=(e,t,r={})=>{let n;if(r?.prefix==="secure"?n=`${`__Secure-${e}`}=${t}`:r?.prefix==="host"?n=`${`__Host-${e}`}=${t}`:n=`${e}=${t}`,e.startsWith("__Secure-")&&!r.secure&&(r.secure=!0),e.startsWith("__Host-")&&(r.secure||(r.secure=!0),r.path!=="/"&&(r.path="/"),r.domain&&(r.domain=void 0)),r&&typeof r.maxAge=="number"&&r.maxAge>=0){if(r.maxAge>3456e4)throw new Error("Cookies Max-Age SHOULD NOT be greater than 400 days (34560000 seconds) in duration.");n+=`; Max-Age=${Math.floor(r.maxAge)}`}if(r.domain&&r.prefix!=="host"&&(n+=`; Domain=${r.domain}`),r.path&&(n+=`; Path=${r.path}`),r.expires){if(r.expires.getTime()-Date.now()>3456e7)throw new Error("Cookies Expires SHOULD NOT be greater than 400 days (34560000 seconds) in the future.");n+=`; Expires=${r.expires.toUTCString()}`}return r.httpOnly&&(n+="; HttpOnly"),r.secure&&(n+="; Secure"),r.sameSite&&(n+=`; SameSite=${r.sameSite.charAt(0).toUpperCase()+r.sameSite.slice(1)}`),r.partitioned&&(r.secure||(r.secure=!0),n+="; Partitioned"),n},gp=(e,t,r)=>(t=encodeURIComponent(t),td(e,t,r)),bp=async(e,t,r,n)=>(t=await yp(t,r),td(e,t,n)),rd=async(e,{options:t,path:r})=>{const n=new Headers,{data:s,error:i}=await fp(t,e);if(i)throw new T(400,{message:i.message,code:"VALIDATION_ERROR"});const o="headers"in e?e.headers instanceof Headers?e.headers:new Headers(e.headers):"request"in e&&e.request instanceof Request?e.request.headers:null,a=o?.get("cookie"),c=a?wp(a):void 0,u={...e,body:s.body,query:s.query,path:e.path||r,context:"context"in e&&e.context?e.context:{},returned:void 0,headers:e?.headers,request:e?.request,params:"params"in e?e.params:void 0,method:e.method,setHeader:(d,l)=>{n.set(d,l)},getHeader:d=>o?o.get(d):null,getCookie:(d,l)=>{const h=ec(d,l);return h&&c?.get(h)||null},getSignedCookie:async(d,l,h)=>{const p=ec(d,h);if(!p)return null;const m=c?.get(p);if(!m)return null;const y=m.lastIndexOf(".");if(y<1)return null;const g=m.substring(0,y),b=m.substring(y+1);if(b.length!==44||!b.endsWith("="))return null;const w=await ed(l);return await pp(b,g,w)?g:!1},setCookie:(d,l,h)=>{const p=gp(d,l,h);return n.append("set-cookie",p),p},setSignedCookie:async(d,l,h,p)=>{const m=await bp(d,l,h,p);return n.append("set-cookie",m),m},redirect:d=>(n.set("location",d),new T("FOUND",void 0,n)),error:(d,l,h)=>new T(d,l,h),json:(d,l)=>e.asResponse?{body:l?.body||d,routerResponse:l,_flag:"json"}:d,responseHeaders:n};for(const d of t.use||[]){const l=await d({...u,returnHeaders:!0,asResponse:!1});l.response&&Object.assign(u.context,l.response),l.headers&&l.headers.forEach((h,p)=>{u.responseHeaders.set(p,h)})}return u};function bn(e,t){const r=async n=>{const s=n,i=typeof e=="function"?e:t,a=await rd(s,{options:typeof e=="function"?{}:e,path:"/"});if(!i)throw new Error("handler must be defined");const c=await i(a),u=a.responseHeaders;return s.returnHeaders?{headers:u,response:c}:c};return r.options=typeof e=="function"?{}:e,r}bn.create=e=>{function t(r,n){if(typeof r=="function")return bn({use:e?.use},r);if(!n)throw new Error("Middleware handler is required");return bn({...r,method:"*",use:[...e?.use||[],...r.use||[]]},n)}return t};var mi=(e,t,r)=>{const n=async(...s)=>{const i=s[0]||{},o=await rd(i,{options:t,path:e}),a=await r(o).catch(async u=>{if(pi(u)){const d=t.onAPIError;if(d&&await d(u),i.asResponse)return u}throw u}),c=o.responseHeaders;return i.asResponse?Lr(a,{headers:c}):i.returnHeaders?{headers:c,response:a}:a};return n.options=t,n.path=e,n};mi.create=e=>(t,r,n)=>mi(t,{...r,use:[...r?.use||[],...e?.use||[]]},n);function F(e,t,r){function n(a,c){var u;Object.defineProperty(a,"_zod",{value:a._zod??{},enumerable:!1}),(u=a._zod).traits??(u.traits=new Set),a._zod.traits.add(e),t(a,c);for(const d in o.prototype)d in a||Object.defineProperty(a,d,{value:o.prototype[d].bind(a)});a._zod.constr=o,a._zod.def=c}const s=r?.Parent??Object;class i extends s{}Object.defineProperty(i,"name",{value:e});function o(a){var c;const u=r?.Parent?new i:this;n(u,a),(c=u._zod).deferred??(c.deferred=[]);for(const d of u._zod.deferred)d();return u}return Object.defineProperty(o,"init",{value:n}),Object.defineProperty(o,Symbol.hasInstance,{value:a=>r?.Parent&&a instanceof r.Parent?!0:a?._zod?.traits?.has(e)}),Object.defineProperty(o,"name",{value:e}),o}var Ns=class extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}},nd={};function qr(e){return nd}var ze={};rp(ze,{BIGINT_FORMAT_RANGES:()=>Lp,Class:()=>Fp,NUMBER_FORMAT_RANGES:()=>Up,aborted:()=>vn,allowsEval:()=>od,assert:()=>kp,assertEqual:()=>vp,assertIs:()=>Ep,assertNever:()=>Ap,assertNotEqual:()=>Np,assignProp:()=>da,cached:()=>ua,captureStackTrace:()=>la,cleanEnum:()=>Vp,cleanRegex:()=>Bi,clone:()=>br,createTransparentProxy:()=>Pp,defineLazy:()=>be,esc:()=>cn,escapeRegex:()=>cd,extend:()=>qp,finalizeIssue:()=>hr,floatSafeRemainder:()=>_p,getElementAtPath:()=>Sp,getEnumValues:()=>sd,getLengthableOrigin:()=>Ki,getParsedType:()=>xp,getSizableOrigin:()=>jp,isObject:()=>yi,isPlainObject:()=>wi,issue:()=>ld,joinValues:()=>Tp,jsonStringifyReplacer:()=>id,merge:()=>Wp,normalizeParams:()=>Vr,nullish:()=>Fi,numKeys:()=>Ip,omit:()=>Dp,optionalKeys:()=>dd,partial:()=>zp,pick:()=>$p,prefixIssues:()=>Hi,primitiveTypes:()=>Cp,promiseAllObject:()=>Rp,propertyKeyTypes:()=>ad,randomString:()=>Op,required:()=>Mp,stringifyPrimitive:()=>ud,unwrapMessage:()=>ts});function vp(e){return e}function Np(e){return e}function Ep(e){}function Ap(e){throw new Error}function kp(e){}function sd(e){const t=Object.values(e).filter(n=>typeof n=="number");return Object.entries(e).filter(([n,s])=>t.indexOf(+n)===-1).map(([n,s])=>s)}function Tp(e,t="|"){return e.map(r=>ud(r)).join(t)}function id(e,t){return typeof t=="bigint"?t.toString():t}function ua(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function Fi(e){return e==null}function Bi(e){const t=e.startsWith("^")?1:0,r=e.endsWith("$")?e.length-1:e.length;return e.slice(t,r)}function _p(e,t){const r=(e.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,s=r>n?r:n,i=Number.parseInt(e.toFixed(s).replace(".","")),o=Number.parseInt(t.toFixed(s).replace(".",""));return i%o/10**s}function be(e,t,r){Object.defineProperty(e,t,{get(){{const n=r();return e[t]=n,n}},set(n){Object.defineProperty(e,t,{value:n})},configurable:!0})}function da(e,t,r){Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!0,configurable:!0})}function Sp(e,t){return t?t.reduce((r,n)=>r?.[n],e):e}function Rp(e){const t=Object.keys(e),r=t.map(n=>e[n]);return Promise.all(r).then(n=>{const s={};for(let i=0;i<t.length;i++)s[t[i]]=n[i];return s})}function Op(e=10){const t="abcdefghijklmnopqrstuvwxyz";let r="";for(let n=0;n<e;n++)r+=t[Math.floor(Math.random()*t.length)];return r}function cn(e){return JSON.stringify(e)}var la=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{};function yi(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}var od=ua(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function wi(e){if(yi(e)===!1)return!1;const t=e.constructor;if(t===void 0)return!0;const r=t.prototype;return!(yi(r)===!1||Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")===!1)}function Ip(e){let t=0;for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t++;return t}var xp=e=>{const t=typeof e;switch(t){case"undefined":return"undefined";case"string":return"string";case"number":return Number.isNaN(e)?"nan":"number";case"boolean":return"boolean";case"function":return"function";case"bigint":return"bigint";case"symbol":return"symbol";case"object":return Array.isArray(e)?"array":e===null?"null":e.then&&typeof e.then=="function"&&e.catch&&typeof e.catch=="function"?"promise":typeof Map<"u"&&e instanceof Map?"map":typeof Set<"u"&&e instanceof Set?"set":typeof Date<"u"&&e instanceof Date?"date":typeof File<"u"&&e instanceof File?"file":"object";default:throw new Error(`Unknown data type: ${t}`)}},ad=new Set(["string","number","symbol"]),Cp=new Set(["string","number","bigint","boolean","symbol","undefined"]);function cd(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function br(e,t,r){const n=new e._zod.constr(t??e._zod.def);return(!t||r?.parent)&&(n._zod.parent=e),n}function Vr(e){const t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}function Pp(e){let t;return new Proxy({},{get(r,n,s){return t??(t=e()),Reflect.get(t,n,s)},set(r,n,s,i){return t??(t=e()),Reflect.set(t,n,s,i)},has(r,n){return t??(t=e()),Reflect.has(t,n)},deleteProperty(r,n){return t??(t=e()),Reflect.deleteProperty(t,n)},ownKeys(r){return t??(t=e()),Reflect.ownKeys(t)},getOwnPropertyDescriptor(r,n){return t??(t=e()),Reflect.getOwnPropertyDescriptor(t,n)},defineProperty(r,n,s){return t??(t=e()),Reflect.defineProperty(t,n,s)}})}function ud(e){return typeof e=="bigint"?e.toString()+"n":typeof e=="string"?`"${e}"`:`${e}`}function dd(e){return Object.keys(e).filter(t=>e[t]._zod.optin==="optional"&&e[t]._zod.optout==="optional")}var Up={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]},Lp={int64:[BigInt("-9223372036854775808"),BigInt("9223372036854775807")],uint64:[BigInt(0),BigInt("18446744073709551615")]};function $p(e,t){const r={},n=e._zod.def;for(const s in t){if(!(s in n.shape))throw new Error(`Unrecognized key: "${s}"`);t[s]&&(r[s]=n.shape[s])}return br(e,{...e._zod.def,shape:r,checks:[]})}function Dp(e,t){const r={...e._zod.def.shape},n=e._zod.def;for(const s in t){if(!(s in n.shape))throw new Error(`Unrecognized key: "${s}"`);t[s]&&delete r[s]}return br(e,{...e._zod.def,shape:r,checks:[]})}function qp(e,t){if(!wi(t))throw new Error("Invalid input to extend: expected a plain object");const r={...e._zod.def,get shape(){const n={...e._zod.def.shape,...t};return da(this,"shape",n),n},checks:[]};return br(e,r)}function Wp(e,t){return br(e,{...e._zod.def,get shape(){const r={...e._zod.def.shape,...t._zod.def.shape};return da(this,"shape",r),r},catchall:t._zod.def.catchall,checks:[]})}function zp(e,t,r){const n=t._zod.def.shape,s={...n};if(r)for(const i in r){if(!(i in n))throw new Error(`Unrecognized key: "${i}"`);r[i]&&(s[i]=e?new e({type:"optional",innerType:n[i]}):n[i])}else for(const i in n)s[i]=e?new e({type:"optional",innerType:n[i]}):n[i];return br(t,{...t._zod.def,shape:s,checks:[]})}function Mp(e,t,r){const n=t._zod.def.shape,s={...n};if(r)for(const i in r){if(!(i in s))throw new Error(`Unrecognized key: "${i}"`);r[i]&&(s[i]=new e({type:"nonoptional",innerType:n[i]}))}else for(const i in n)s[i]=new e({type:"nonoptional",innerType:n[i]});return br(t,{...t._zod.def,shape:s,checks:[]})}function vn(e,t=0){for(let r=t;r<e.issues.length;r++)if(e.issues[r]?.continue!==!0)return!0;return!1}function Hi(e,t){return t.map(r=>{var n;return(n=r).path??(n.path=[]),r.path.unshift(e),r})}function ts(e){return typeof e=="string"?e:e?.message}function hr(e,t,r){const n={...e,path:e.path??[]};if(!e.message){const s=ts(e.inst?._zod.def?.error?.(e))??ts(t?.error?.(e))??ts(r.customError?.(e))??ts(r.localeError?.(e))??"Invalid input";n.message=s}return delete n.inst,delete n.continue,t?.reportInput||delete n.input,n}function jp(e){return e instanceof Set?"set":e instanceof Map?"map":e instanceof File?"file":"unknown"}function Ki(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function ld(...e){const[t,r,n]=e;return typeof t=="string"?{message:t,code:"custom",input:r,inst:n}:{...t}}function Vp(e){return Object.entries(e).filter(([t,r])=>Number.isNaN(Number.parseInt(t,10))).map(t=>t[1])}var Fp=class{constructor(...e){}},hd=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get(){return JSON.stringify(t,id,2)},enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},fd=F("$ZodError",hd),pd=F("$ZodError",hd,{Parent:Error});function Bp(e,t=r=>r.message){const r={},n=[];for(const s of e.issues)s.path.length>0?(r[s.path[0]]=r[s.path[0]]||[],r[s.path[0]].push(t(s))):n.push(t(s));return{formErrors:n,fieldErrors:r}}function Hp(e,t){const r=t||function(i){return i.message},n={_errors:[]},s=i=>{for(const o of i.issues)if(o.code==="invalid_union"&&o.errors.length)o.errors.map(a=>s({issues:a}));else if(o.code==="invalid_key")s({issues:o.issues});else if(o.code==="invalid_element")s({issues:o.issues});else if(o.path.length===0)n._errors.push(r(o));else{let a=n,c=0;for(;c<o.path.length;){const u=o.path[c];c===o.path.length-1?(a[u]=a[u]||{_errors:[]},a[u]._errors.push(r(o))):a[u]=a[u]||{_errors:[]},a=a[u],c++}}};return s(e),n}var Kp=e=>(t,r,n,s)=>{const i=n?Object.assign(n,{async:!1}):{async:!1},o=t._zod.run({value:r,issues:[]},i);if(o instanceof Promise)throw new Ns;if(o.issues.length){const a=new(s?.Err??e)(o.issues.map(c=>hr(c,i,qr())));throw la(a,s?.callee),a}return o.value},Zp=e=>async(t,r,n,s)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let o=t._zod.run({value:r,issues:[]},i);if(o instanceof Promise&&(o=await o),o.issues.length){const a=new(s?.Err??e)(o.issues.map(c=>hr(c,i,qr())));throw la(a,s?.callee),a}return o.value},md=e=>(t,r,n)=>{const s=n?{...n,async:!1}:{async:!1},i=t._zod.run({value:r,issues:[]},s);if(i instanceof Promise)throw new Ns;return i.issues.length?{success:!1,error:new(e??fd)(i.issues.map(o=>hr(o,s,qr())))}:{success:!0,data:i.value}},Jp=md(pd),yd=e=>async(t,r,n)=>{const s=n?Object.assign(n,{async:!0}):{async:!0};let i=t._zod.run({value:r,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map(o=>hr(o,s,qr())))}:{success:!0,data:i.value}},Gp=yd(pd),qn=F("$ZodCheck",(e,t)=>{var r;e._zod??(e._zod={}),e._zod.def=t,(r=e._zod).onattach??(r.onattach=[])}),Qp=F("$ZodCheckMaxLength",(e,t)=>{var r;qn.init(e,t),(r=e._zod.def).when??(r.when=n=>{const s=n.value;return!Fi(s)&&s.length!==void 0}),e._zod.onattach.push(n=>{const s=n._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<s&&(n._zod.bag.maximum=t.maximum)}),e._zod.check=n=>{const s=n.value;if(s.length<=t.maximum)return;const o=Ki(s);n.issues.push({origin:o,code:"too_big",maximum:t.maximum,inclusive:!0,input:s,inst:e,continue:!t.abort})}}),Yp=F("$ZodCheckMinLength",(e,t)=>{var r;qn.init(e,t),(r=e._zod.def).when??(r.when=n=>{const s=n.value;return!Fi(s)&&s.length!==void 0}),e._zod.onattach.push(n=>{const s=n._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>s&&(n._zod.bag.minimum=t.minimum)}),e._zod.check=n=>{const s=n.value;if(s.length>=t.minimum)return;const o=Ki(s);n.issues.push({origin:o,code:"too_small",minimum:t.minimum,inclusive:!0,input:s,inst:e,continue:!t.abort})}}),Xp=F("$ZodCheckLengthEquals",(e,t)=>{var r;qn.init(e,t),(r=e._zod.def).when??(r.when=n=>{const s=n.value;return!Fi(s)&&s.length!==void 0}),e._zod.onattach.push(n=>{const s=n._zod.bag;s.minimum=t.length,s.maximum=t.length,s.length=t.length}),e._zod.check=n=>{const s=n.value,i=s.length;if(i===t.length)return;const o=Ki(s),a=i>t.length;n.issues.push({origin:o,...a?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:n.value,inst:e,continue:!t.abort})}}),em=F("$ZodCheckOverwrite",(e,t)=>{qn.init(e,t),e._zod.check=r=>{r.value=t.tx(r.value)}}),tm=class{constructor(t=[]){this.content=[],this.indent=0,this&&(this.args=t)}indented(t){this.indent+=1,t(this),this.indent-=1}write(t){if(typeof t=="function"){t(this,{execution:"sync"}),t(this,{execution:"async"});return}const n=t.split(`
`).filter(o=>o),s=Math.min(...n.map(o=>o.length-o.trimStart().length)),i=n.map(o=>o.slice(s)).map(o=>" ".repeat(this.indent*2)+o);for(const o of i)this.content.push(o)}compile(){const t=Function,r=this?.args,s=[...(this?.content??[""]).map(i=>`  ${i}`)];return new t(...r,s.join(`
`))}},rm={major:4,minor:0,patch:0},Ue=F("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=rm;const n=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&n.unshift(e);for(const s of n)for(const i of s._zod.onattach)i(e);if(n.length===0)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const s=(i,o,a)=>{let c=vn(i),u;for(const d of o){if(d._zod.def.when){if(!d._zod.def.when(i))continue}else if(c)continue;const l=i.issues.length,h=d._zod.check(i);if(h instanceof Promise&&a?.async===!1)throw new Ns;if(u||h instanceof Promise)u=(u??Promise.resolve()).then(async()=>{await h,i.issues.length!==l&&(c||(c=vn(i,l)))});else{if(i.issues.length===l)continue;c||(c=vn(i,l))}}return u?u.then(()=>i):i};e._zod.run=(i,o)=>{const a=e._zod.parse(i,o);if(a instanceof Promise){if(o.async===!1)throw new Ns;return a.then(c=>s(c,n,o))}return s(a,n,o)}}e["~standard"]={validate:s=>{try{const i=Jp(e,s);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return Gp(e,s).then(o=>o.success?{value:o.data}:{issues:o.error?.issues})}},vendor:"zod",version:1}}),nm=F("$ZodUnknown",(e,t)=>{Ue.init(e,t),e._zod.parse=r=>r}),sm=F("$ZodNever",(e,t)=>{Ue.init(e,t),e._zod.parse=(r,n)=>(r.issues.push({expected:"never",code:"invalid_type",input:r.value,inst:e}),r)});function tc(e,t,r){e.issues.length&&t.issues.push(...Hi(r,e.issues)),t.value[r]=e.value}var im=F("$ZodArray",(e,t)=>{Ue.init(e,t),e._zod.parse=(r,n)=>{const s=r.value;if(!Array.isArray(s))return r.issues.push({expected:"array",code:"invalid_type",input:s,inst:e}),r;r.value=Array(s.length);const i=[];for(let o=0;o<s.length;o++){const a=s[o],c=t.element._zod.run({value:a,issues:[]},n);c instanceof Promise?i.push(c.then(u=>tc(u,r,o))):tc(c,r,o)}return i.length?Promise.all(i).then(()=>r):r}});function zs(e,t,r){e.issues.length&&t.issues.push(...Hi(r,e.issues)),t.value[r]=e.value}function rc(e,t,r,n){e.issues.length?n[r]===void 0?r in n?t.value[r]=void 0:t.value[r]=e.value:t.issues.push(...Hi(r,e.issues)):e.value===void 0?r in n&&(t.value[r]=void 0):t.value[r]=e.value}var om=F("$ZodObject",(e,t)=>{Ue.init(e,t);const r=ua(()=>{const l=Object.keys(t.shape);for(const p of l)if(!(t.shape[p]instanceof Ue))throw new Error(`Invalid element at key "${p}": expected a Zod schema`);const h=dd(t.shape);return{shape:t.shape,keys:l,keySet:new Set(l),numKeys:l.length,optionalKeys:new Set(h)}});be(e._zod,"propValues",()=>{const l=t.shape,h={};for(const p in l){const m=l[p]._zod;if(m.values){h[p]??(h[p]=new Set);for(const y of m.values)h[p].add(y)}}return h});const n=l=>{const h=new tm(["shape","payload","ctx"]),p=r.value,m=w=>{const N=cn(w);return`shape[${N}]._zod.run({ value: input[${N}], issues: [] }, ctx)`};h.write("const input = payload.value;");const y=Object.create(null);let g=0;for(const w of p.keys)y[w]=`key_${g++}`;h.write("const newResult = {}");for(const w of p.keys)if(p.optionalKeys.has(w)){const N=y[w];h.write(`const ${N} = ${m(w)};`);const v=cn(w);h.write(`
        if (${N}.issues.length) {
          if (input[${v}] === undefined) {
            if (${v} in input) {
              newResult[${v}] = undefined;
            }
          } else {
            payload.issues = payload.issues.concat(
              ${N}.issues.map((iss) => ({
                ...iss,
                path: iss.path ? [${v}, ...iss.path] : [${v}],
              }))
            );
          }
        } else if (${N}.value === undefined) {
          if (${v} in input) newResult[${v}] = undefined;
        } else {
          newResult[${v}] = ${N}.value;
        }
        `)}else{const N=y[w];h.write(`const ${N} = ${m(w)};`),h.write(`
          if (${N}.issues.length) payload.issues = payload.issues.concat(${N}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${cn(w)}, ...iss.path] : [${cn(w)}]
          })));`),h.write(`newResult[${cn(w)}] = ${N}.value`)}h.write("payload.value = newResult;"),h.write("return payload;");const b=h.compile();return(w,N)=>b(l,w,N)};let s;const i=yi,o=!nd.jitless,c=o&&od.value,u=t.catchall;let d;e._zod.parse=(l,h)=>{d??(d=r.value);const p=l.value;if(!i(p))return l.issues.push({expected:"object",code:"invalid_type",input:p,inst:e}),l;const m=[];if(o&&c&&h?.async===!1&&h.jitless!==!0)s||(s=n(t.shape)),l=s(l,h);else{l.value={};const N=d.shape;for(const v of d.keys){const k=N[v],A=k._zod.run({value:p[v],issues:[]},h),S=k._zod.optin==="optional"&&k._zod.optout==="optional";A instanceof Promise?m.push(A.then(q=>S?rc(q,l,v,p):zs(q,l,v))):S?rc(A,l,v,p):zs(A,l,v)}}if(!u)return m.length?Promise.all(m).then(()=>l):l;const y=[],g=d.keySet,b=u._zod,w=b.def.type;for(const N of Object.keys(p)){if(g.has(N))continue;if(w==="never"){y.push(N);continue}const v=b.run({value:p[N],issues:[]},h);v instanceof Promise?m.push(v.then(k=>zs(k,l,N))):zs(v,l,N)}return y.length&&l.issues.push({code:"unrecognized_keys",keys:y,input:p,inst:e}),m.length?Promise.all(m).then(()=>l):l}});function nc(e,t,r,n){for(const s of e)if(s.issues.length===0)return t.value=s.value,t;return t.issues.push({code:"invalid_union",input:t.value,inst:r,errors:e.map(s=>s.issues.map(i=>hr(i,n,qr())))}),t}var am=F("$ZodUnion",(e,t)=>{Ue.init(e,t),be(e._zod,"optin",()=>t.options.some(r=>r._zod.optin==="optional")?"optional":void 0),be(e._zod,"optout",()=>t.options.some(r=>r._zod.optout==="optional")?"optional":void 0),be(e._zod,"values",()=>{if(t.options.every(r=>r._zod.values))return new Set(t.options.flatMap(r=>Array.from(r._zod.values)))}),be(e._zod,"pattern",()=>{if(t.options.every(r=>r._zod.pattern)){const r=t.options.map(n=>n._zod.pattern);return new RegExp(`^(${r.map(n=>Bi(n.source)).join("|")})$`)}}),e._zod.parse=(r,n)=>{let s=!1;const i=[];for(const o of t.options){const a=o._zod.run({value:r.value,issues:[]},n);if(a instanceof Promise)i.push(a),s=!0;else{if(a.issues.length===0)return a;i.push(a)}}return s?Promise.all(i).then(o=>nc(o,r,e,n)):nc(i,r,e,n)}}),cm=F("$ZodIntersection",(e,t)=>{Ue.init(e,t),e._zod.parse=(r,n)=>{const s=r.value,i=t.left._zod.run({value:s,issues:[]},n),o=t.right._zod.run({value:s,issues:[]},n);return i instanceof Promise||o instanceof Promise?Promise.all([i,o]).then(([c,u])=>sc(r,c,u)):sc(r,i,o)}});function Lo(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e==+t)return{valid:!0,data:e};if(wi(e)&&wi(t)){const r=Object.keys(t),n=Object.keys(e).filter(i=>r.indexOf(i)!==-1),s={...e,...t};for(const i of n){const o=Lo(e[i],t[i]);if(!o.valid)return{valid:!1,mergeErrorPath:[i,...o.mergeErrorPath]};s[i]=o.data}return{valid:!0,data:s}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const r=[];for(let n=0;n<e.length;n++){const s=e[n],i=t[n],o=Lo(s,i);if(!o.valid)return{valid:!1,mergeErrorPath:[n,...o.mergeErrorPath]};r.push(o.data)}return{valid:!0,data:r}}return{valid:!1,mergeErrorPath:[]}}function sc(e,t,r){if(t.issues.length&&e.issues.push(...t.issues),r.issues.length&&e.issues.push(...r.issues),vn(e))return e;const n=Lo(t.value,r.value);if(!n.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(n.mergeErrorPath)}`);return e.value=n.data,e}var um=F("$ZodEnum",(e,t)=>{Ue.init(e,t);const r=sd(t.entries);e._zod.values=new Set(r),e._zod.pattern=new RegExp(`^(${r.filter(n=>ad.has(typeof n)).map(n=>typeof n=="string"?cd(n):n.toString()).join("|")})$`),e._zod.parse=(n,s)=>{const i=n.value;return e._zod.values.has(i)||n.issues.push({code:"invalid_value",values:r,input:i,inst:e}),n}}),dm=F("$ZodTransform",(e,t)=>{Ue.init(e,t),e._zod.parse=(r,n)=>{const s=t.transform(r.value,r);if(n.async)return(s instanceof Promise?s:Promise.resolve(s)).then(o=>(r.value=o,r));if(s instanceof Promise)throw new Ns;return r.value=s,r}}),lm=F("$ZodOptional",(e,t)=>{Ue.init(e,t),e._zod.optin="optional",e._zod.optout="optional",be(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),be(e._zod,"pattern",()=>{const r=t.innerType._zod.pattern;return r?new RegExp(`^(${Bi(r.source)})?$`):void 0}),e._zod.parse=(r,n)=>t.innerType._zod.optin==="optional"?t.innerType._zod.run(r,n):r.value===void 0?r:t.innerType._zod.run(r,n)}),hm=F("$ZodNullable",(e,t)=>{Ue.init(e,t),be(e._zod,"optin",()=>t.innerType._zod.optin),be(e._zod,"optout",()=>t.innerType._zod.optout),be(e._zod,"pattern",()=>{const r=t.innerType._zod.pattern;return r?new RegExp(`^(${Bi(r.source)}|null)$`):void 0}),be(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(r,n)=>r.value===null?r:t.innerType._zod.run(r,n)}),fm=F("$ZodDefault",(e,t)=>{Ue.init(e,t),e._zod.optin="optional",be(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(r,n)=>{if(r.value===void 0)return r.value=t.defaultValue,r;const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>ic(i,t)):ic(s,t)}});function ic(e,t){return e.value===void 0&&(e.value=t.defaultValue),e}var pm=F("$ZodPrefault",(e,t)=>{Ue.init(e,t),e._zod.optin="optional",be(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(r,n)=>(r.value===void 0&&(r.value=t.defaultValue),t.innerType._zod.run(r,n))}),mm=F("$ZodNonOptional",(e,t)=>{Ue.init(e,t),be(e._zod,"values",()=>{const r=t.innerType._zod.values;return r?new Set([...r].filter(n=>n!==void 0)):void 0}),e._zod.parse=(r,n)=>{const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>oc(i,e)):oc(s,e)}});function oc(e,t){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}var ym=F("$ZodCatch",(e,t)=>{Ue.init(e,t),e._zod.optin="optional",be(e._zod,"optout",()=>t.innerType._zod.optout),be(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(r,n)=>{const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>(r.value=i.value,i.issues.length&&(r.value=t.catchValue({...r,error:{issues:i.issues.map(o=>hr(o,n,qr()))},input:r.value}),r.issues=[]),r)):(r.value=s.value,s.issues.length&&(r.value=t.catchValue({...r,error:{issues:s.issues.map(i=>hr(i,n,qr()))},input:r.value}),r.issues=[]),r)}}),wm=F("$ZodPipe",(e,t)=>{Ue.init(e,t),be(e._zod,"values",()=>t.in._zod.values),be(e._zod,"optin",()=>t.in._zod.optin),be(e._zod,"optout",()=>t.out._zod.optout),e._zod.parse=(r,n)=>{const s=t.in._zod.run(r,n);return s instanceof Promise?s.then(i=>ac(i,t,n)):ac(s,t,n)}});function ac(e,t,r){return vn(e)?e:t.out._zod.run({value:e.value,issues:e.issues},r)}var gm=F("$ZodReadonly",(e,t)=>{Ue.init(e,t),be(e._zod,"propValues",()=>t.innerType._zod.propValues),be(e._zod,"values",()=>t.innerType._zod.values),be(e._zod,"optin",()=>t.innerType._zod.optin),be(e._zod,"optout",()=>t.innerType._zod.optout),e._zod.parse=(r,n)=>{const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(cc):cc(s)}});function cc(e){return e.value=Object.freeze(e.value),e}var bm=F("$ZodCustom",(e,t)=>{qn.init(e,t),Ue.init(e,t),e._zod.parse=(r,n)=>r,e._zod.check=r=>{const n=r.value,s=t.fn(n);if(s instanceof Promise)return s.then(i=>uc(i,r,n,e));uc(s,r,n,e)}});function uc(e,t,r,n){if(!e){const s={code:"custom",input:r,inst:n,path:[...n._zod.def.path??[]],continue:!n._zod.def.abort};n._zod.def.params&&(s.params=n._zod.def.params),t.issues.push(ld(s))}}var vm=class{constructor(){this._map=new Map,this._idmap=new Map}add(t,...r){const n=r[0];if(this._map.set(t,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,t)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(t){const r=this._map.get(t);return r&&typeof r=="object"&&"id"in r&&this._idmap.delete(r.id),this._map.delete(t),this}get(t){const r=t._zod.parent;if(r){const n={...this.get(r)??{}};return delete n.id,{...n,...this._map.get(t)}}return this._map.get(t)}has(t){return this._map.has(t)}};function Nm(){return new vm}var Ms=Nm();function Em(e){return new e({type:"unknown"})}function Am(e,t){return new e({type:"never",...Vr(t)})}function km(e,t){return new Qp({check:"max_length",...Vr(t),maximum:e})}function dc(e,t){return new Yp({check:"min_length",...Vr(t),minimum:e})}function Tm(e,t){return new Xp({check:"length_equals",...Vr(t),length:e})}function _m(e){return new em({check:"overwrite",tx:e})}function Sm(e,t,r){return new e({type:"array",element:t,...Vr(r)})}function Rm(e,t,r){return new e({type:"custom",check:"custom",fn:t,...Vr(r)})}var Om=(e,t)=>{fd.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:r=>Hp(e,r)},flatten:{value:r=>Bp(e,r)},addIssue:{value:r=>e.issues.push(r)},addIssues:{value:r=>e.issues.push(...r)},isEmpty:{get(){return e.issues.length===0}}})},Zi=F("ZodError",Om,{Parent:Error}),Im=Kp(Zi),xm=Zp(Zi),Cm=md(Zi),Pm=yd(Zi),Ve=F("ZodType",(e,t)=>(Ue.init(e,t),e.def=t,Object.defineProperty(e,"_def",{value:t}),e.check=(...r)=>e.clone({...t,checks:[...t.checks??[],...r.map(n=>typeof n=="function"?{_zod:{check:n,def:{check:"custom"},onattach:[]}}:n)]}),e.clone=(r,n)=>br(e,r,n),e.brand=()=>e,e.register=(r,n)=>(r.add(e,n),e),e.parse=(r,n)=>Im(e,r,n,{callee:e.parse}),e.safeParse=(r,n)=>Cm(e,r,n),e.parseAsync=async(r,n)=>xm(e,r,n,{callee:e.parseAsync}),e.safeParseAsync=async(r,n)=>Pm(e,r,n),e.spa=e.safeParseAsync,e.refine=(r,n)=>e.check(iy(r,n)),e.superRefine=r=>e.check(oy(r)),e.overwrite=r=>e.check(_m(r)),e.optional=()=>hc(e),e.nullable=()=>fc(e),e.nullish=()=>hc(fc(e)),e.nonoptional=r=>Qm(e,r),e.array=()=>qm(e),e.or=r=>zm([e,r]),e.and=r=>jm(e,r),e.transform=r=>pc(e,Bm(r)),e.default=r=>Zm(e,r),e.prefault=r=>Gm(e,r),e.catch=r=>Xm(e,r),e.pipe=r=>pc(e,r),e.readonly=()=>ry(e),e.describe=r=>{const n=e.clone();return Ms.add(n,{description:r}),n},Object.defineProperty(e,"description",{get(){return Ms.get(e)?.description},configurable:!0}),e.meta=(...r)=>{if(r.length===0)return Ms.get(e);const n=e.clone();return Ms.add(n,r[0]),n},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),Um=F("ZodUnknown",(e,t)=>{nm.init(e,t),Ve.init(e,t)});function lc(){return Em(Um)}var Lm=F("ZodNever",(e,t)=>{sm.init(e,t),Ve.init(e,t)});function $m(e){return Am(Lm,e)}var Dm=F("ZodArray",(e,t)=>{im.init(e,t),Ve.init(e,t),e.element=t.element,e.min=(r,n)=>e.check(dc(r,n)),e.nonempty=r=>e.check(dc(1,r)),e.max=(r,n)=>e.check(km(r,n)),e.length=(r,n)=>e.check(Tm(r,n)),e.unwrap=()=>e.element});function qm(e,t){return Sm(Dm,e,t)}var gi=F("ZodObject",(e,t)=>{om.init(e,t),Ve.init(e,t),ze.defineLazy(e,"shape",()=>t.shape),e.keyof=()=>Vm(Object.keys(e._zod.def.shape)),e.catchall=r=>e.clone({...e._zod.def,catchall:r}),e.passthrough=()=>e.clone({...e._zod.def,catchall:lc()}),e.loose=()=>e.clone({...e._zod.def,catchall:lc()}),e.strict=()=>e.clone({...e._zod.def,catchall:$m()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=r=>ze.extend(e,r),e.merge=r=>ze.merge(e,r),e.pick=r=>ze.pick(e,r),e.omit=r=>ze.omit(e,r),e.partial=(...r)=>ze.partial(rs,e,r[0]),e.required=(...r)=>ze.required(wd,e,r[0])}),Wm=F("ZodUnion",(e,t)=>{am.init(e,t),Ve.init(e,t),e.options=t.options});function zm(e,t){return new Wm({type:"union",options:e,...ze.normalizeParams(t)})}var Mm=F("ZodIntersection",(e,t)=>{cm.init(e,t),Ve.init(e,t)});function jm(e,t){return new Mm({type:"intersection",left:e,right:t})}var $o=F("ZodEnum",(e,t)=>{um.init(e,t),Ve.init(e,t),e.enum=t.entries,e.options=Object.values(t.entries);const r=new Set(Object.keys(t.entries));e.extract=(n,s)=>{const i={};for(const o of n)if(r.has(o))i[o]=t.entries[o];else throw new Error(`Key ${o} not found in enum`);return new $o({...t,checks:[],...ze.normalizeParams(s),entries:i})},e.exclude=(n,s)=>{const i={...t.entries};for(const o of n)if(r.has(o))delete i[o];else throw new Error(`Key ${o} not found in enum`);return new $o({...t,checks:[],...ze.normalizeParams(s),entries:i})}});function Vm(e,t){const r=Array.isArray(e)?Object.fromEntries(e.map(n=>[n,n])):e;return new $o({type:"enum",entries:r,...ze.normalizeParams(t)})}var Fm=F("ZodTransform",(e,t)=>{dm.init(e,t),Ve.init(e,t),e._zod.parse=(r,n)=>{r.addIssue=i=>{if(typeof i=="string")r.issues.push(ze.issue(i,r.value,t));else{const o=i;o.fatal&&(o.continue=!1),o.code??(o.code="custom"),o.input??(o.input=r.value),o.inst??(o.inst=e),o.continue??(o.continue=!0),r.issues.push(ze.issue(o))}};const s=t.transform(r.value,r);return s instanceof Promise?s.then(i=>(r.value=i,r)):(r.value=s,r)}});function Bm(e){return new Fm({type:"transform",transform:e})}var rs=F("ZodOptional",(e,t)=>{lm.init(e,t),Ve.init(e,t),e.unwrap=()=>e._zod.def.innerType});function hc(e){return new rs({type:"optional",innerType:e})}var Hm=F("ZodNullable",(e,t)=>{hm.init(e,t),Ve.init(e,t),e.unwrap=()=>e._zod.def.innerType});function fc(e){return new Hm({type:"nullable",innerType:e})}var Km=F("ZodDefault",(e,t)=>{fm.init(e,t),Ve.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function Zm(e,t){return new Km({type:"default",innerType:e,get defaultValue(){return typeof t=="function"?t():t}})}var Jm=F("ZodPrefault",(e,t)=>{pm.init(e,t),Ve.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Gm(e,t){return new Jm({type:"prefault",innerType:e,get defaultValue(){return typeof t=="function"?t():t}})}var wd=F("ZodNonOptional",(e,t)=>{mm.init(e,t),Ve.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Qm(e,t){return new wd({type:"nonoptional",innerType:e,...ze.normalizeParams(t)})}var Ym=F("ZodCatch",(e,t)=>{ym.init(e,t),Ve.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function Xm(e,t){return new Ym({type:"catch",innerType:e,catchValue:typeof t=="function"?t:()=>t})}var ey=F("ZodPipe",(e,t)=>{wm.init(e,t),Ve.init(e,t),e.in=t.in,e.out=t.out});function pc(e,t){return new ey({type:"pipe",in:e,out:t})}var ty=F("ZodReadonly",(e,t)=>{gm.init(e,t),Ve.init(e,t)});function ry(e){return new ty({type:"readonly",innerType:e})}var ny=F("ZodCustom",(e,t)=>{bm.init(e,t),Ve.init(e,t)});function sy(e){const t=new qn({check:"custom"});return t._zod.check=e,t}function iy(e,t={}){return Rm(ny,e,t)}function oy(e){const t=sy(r=>(r.addIssue=n=>{if(typeof n=="string")r.issues.push(ze.issue(n,r.value,t._zod.def));else{const s=n;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=r.value),s.inst??(s.inst=t),s.continue??(s.continue=!t._zod.def.abort),r.issues.push(ze.issue(s))}},e(r.value,r)));return t}var fo={};function gd(e){switch(e.constructor.name){case"ZodString":return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodObject":return"object";case"ZodArray":return"array";default:return"string"}}function mc(e){const t=[];return e.metadata?.openapi?.parameters?(t.push(...e.metadata.openapi.parameters),t):(e.query instanceof gi&&Object.entries(e.query.shape).forEach(([r,n])=>{n instanceof gi&&t.push({name:r,in:"query",schema:{type:gd(n),..."minLength"in n&&n.minLength?{minLength:n.minLength}:{},description:n.description}})}),t)}function ay(e){if(e.metadata?.openapi?.requestBody)return e.metadata.openapi.requestBody;if(e.body&&(e.body instanceof gi||e.body instanceof rs)){const t=e.body.shape;if(!t)return;const r={},n=[];return Object.entries(t).forEach(([s,i])=>{i instanceof gi&&(r[s]={type:gd(i),description:i.description},i instanceof rs||n.push(s))}),{required:e.body instanceof rs?!1:!!e.body,content:{"application/json":{schema:{type:"object",properties:r,required:n}}}}}}function yc(e){return{400:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Bad Request. Usually due to missing parameters, or invalid parameters."},401:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Unauthorized. Due to missing or invalid authentication."},403:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Forbidden. You do not have permission to access this resource or to perform this action."},404:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Not Found. The requested resource was not found."},429:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Too Many Requests. You have exceeded the rate limit. Try again later."},500:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Internal Server Error. This is a problem with the server that you cannot fix."},...e}}async function cy(e,t){const r={schemas:{}};return Object.entries(e).forEach(([s,i])=>{const o=i.options;if(!o.metadata?.SERVER_ONLY&&(o.method==="GET"&&(fo[i.path]={get:{tags:["Default",...o.metadata?.openapi?.tags||[]],description:o.metadata?.openapi?.description,operationId:o.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:mc(o),responses:yc(o.metadata?.openapi?.responses)}}),o.method==="POST")){const a=ay(o);fo[i.path]={post:{tags:["Default",...o.metadata?.openapi?.tags||[]],description:o.metadata?.openapi?.description,operationId:o.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:mc(o),...a?{requestBody:a}:{requestBody:{content:{"application/json":{schema:{type:"object",properties:{}}}}}},responses:yc(o.metadata?.openapi?.responses)}}}}),{openapi:"3.1.1",info:{title:"Better Auth",description:"API Reference for your Better Auth Instance",version:"1.1.0"},components:r,security:[{apiKeyCookie:[]}],servers:[{url:t?.url}],tags:[{name:"Default",description:"Default endpoints that are included with Better Auth by default. These endpoints are not part of any plugin."}],paths:fo}}var uy=(e,t)=>`<!doctype html>
<html>
  <head>
    <title>Scalar API Reference</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <script
      id="api-reference"
      type="application/json">
    ${JSON.stringify(e)}
    <\/script>
	 <script>
      var configuration = {
	  	favicon: ${t?.logo?`data:image/svg+xml;utf8,${encodeURIComponent(t.logo)}`:void 0} ,
	   	theme: ${t?.theme||"saturn"},
        metaData: {
			title: ${t?.title||"Open API Reference"},
			description: ${t?.description||"Better Call Open API"},
		}
      }
      document.getElementById('api-reference').dataset.configuration =
        JSON.stringify(configuration)
    <\/script>
	  <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference"><\/script>
  </body>
</html>`,dy=(e,t)=>{if(!t?.openapi?.disabled){const i={path:"/api/reference",...t?.openapi};e.openapi=mi(i.path,{method:"GET"},async o=>{const a=await cy(e);return new Response(uy(a,i.scalar),{headers:{"Content-Type":"text/html"}})})}const r=Qa(),n=Qa();for(const i of Object.values(e)){if(!i.options||i.options?.metadata?.SERVER_ONLY)continue;const o=Array.isArray(i.options?.method)?i.options.method:[i.options?.method];for(const a of o)Ya(r,a,i.path,i)}if(t?.routerMiddleware?.length)for(const{path:i,middleware:o}of t.routerMiddleware)Ya(n,"*",i,o);const s=async i=>{const o=new URL(i.url),a=t?.basePath?o.pathname.split(t.basePath).reduce((h,p,m)=>(m!==0&&(m>1?h.push(`${t.basePath}${p}`):h.push(p)),h),[]).join(""):o.pathname;if(!a?.length)return new Response(null,{status:404,statusText:"Not Found"});const c=Xf(r,i.method,a);if(!c?.data)return new Response(null,{status:404,statusText:"Not Found"});const u={};o.searchParams.forEach((h,p)=>{p in u?Array.isArray(u[p])?u[p].push(h):u[p]=[u[p],h]:u[p]=h});const d=c.data,l={path:a,method:i.method,headers:i.headers,params:c.params?JSON.parse(JSON.stringify(c.params)):{},request:i,body:d.options.disableBody?void 0:await cp(d.options.cloneRequest?i.clone():i),query:u,_flag:"router",asResponse:!0,context:t?.routerContext};try{const h=ep(n,"*",a);if(h?.length)for(const{data:m,params:y}of h){const g=await m({...l,params:y,asResponse:!1});if(g instanceof Response)return g}return await d(l)}catch(h){if(t?.onError)try{const p=await t.onError(h);if(p instanceof Response)return Lr(p)}catch(p){if(pi(p))return Lr(p);throw p}if(t?.throwError)throw h;return pi(h)?Lr(h):(console.error("# SERVER_ERROR: ",h),new Response(null,{status:500,statusText:"Internal Server Error"}))}};return{handler:async i=>{const o=await t?.onRequest?.(i);if(o instanceof Response)return o;const a=o instanceof Request?o:i,c=await s(a),u=await t?.onResponse?.(c);return u instanceof Response?u:c},endpoints:e}};function _(e,t,r){function n(a,c){var u;Object.defineProperty(a,"_zod",{value:a._zod??{},enumerable:!1}),(u=a._zod).traits??(u.traits=new Set),a._zod.traits.add(e),t(a,c);for(const d in o.prototype)d in a||Object.defineProperty(a,d,{value:o.prototype[d].bind(a)});a._zod.constr=o,a._zod.def=c}const s=r?.Parent??Object;class i extends s{}Object.defineProperty(i,"name",{value:e});function o(a){var c;const u=r?.Parent?new i:this;n(u,a),(c=u._zod).deferred??(c.deferred=[]);for(const d of u._zod.deferred)d();return u}return Object.defineProperty(o,"init",{value:n}),Object.defineProperty(o,Symbol.hasInstance,{value:a=>r?.Parent&&a instanceof r.Parent?!0:a?._zod?.traits?.has(e)}),Object.defineProperty(o,"name",{value:e}),o}class Nn extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class bd extends Error{constructor(t){super(`Encountered unidirectional transform during encode: ${t}`),this.name="ZodEncodeError"}}const vd={};function fr(e){return vd}function ly(e){const t=Object.values(e).filter(n=>typeof n=="number");return Object.entries(e).filter(([n,s])=>t.indexOf(+n)===-1).map(([n,s])=>s)}function Do(e,t){return typeof t=="bigint"?t.toString():t}function ha(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function fa(e){return e==null}function pa(e){const t=e.startsWith("^")?1:0,r=e.endsWith("$")?e.length-1:e.length;return e.slice(t,r)}function hy(e,t){const r=(e.toString().split(".")[1]||"").length,n=t.toString();let s=(n.split(".")[1]||"").length;if(s===0&&/\d?e-\d?/.test(n)){const c=n.match(/\d?e-(\d?)/);c?.[1]&&(s=Number.parseInt(c[1]))}const i=r>s?r:s,o=Number.parseInt(e.toFixed(i).replace(".","")),a=Number.parseInt(t.toFixed(i).replace(".",""));return o%a/10**i}const wc=Symbol("evaluating");function de(e,t,r){let n;Object.defineProperty(e,t,{get(){if(n!==wc)return n===void 0&&(n=wc,n=r()),n},set(s){Object.defineProperty(e,t,{value:s})},configurable:!0})}function Fr(e,t,r){Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!0,configurable:!0})}function Br(...e){const t={};for(const r of e){const n=Object.getOwnPropertyDescriptors(r);Object.assign(t,n)}return Object.defineProperties({},t)}function gc(e){return JSON.stringify(e)}const Nd="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function bi(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const fy=ha(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function Sn(e){if(bi(e)===!1)return!1;const t=e.constructor;if(t===void 0)return!0;const r=t.prototype;return!(bi(r)===!1||Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")===!1)}function Ed(e){return Sn(e)?{...e}:Array.isArray(e)?[...e]:e}const py=new Set(["string","number","symbol"]);function Ji(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function vr(e,t,r){const n=new e._zod.constr(t??e._zod.def);return(!t||r?.parent)&&(n._zod.parent=e),n}function j(e){const t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}function my(e){return Object.keys(e).filter(t=>e[t]._zod.optin==="optional"&&e[t]._zod.optout==="optional")}const yy={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function wy(e,t){const r=e._zod.def,n=Br(e._zod.def,{get shape(){const s={};for(const i in t){if(!(i in r.shape))throw new Error(`Unrecognized key: "${i}"`);t[i]&&(s[i]=r.shape[i])}return Fr(this,"shape",s),s},checks:[]});return vr(e,n)}function gy(e,t){const r=e._zod.def,n=Br(e._zod.def,{get shape(){const s={...e._zod.def.shape};for(const i in t){if(!(i in r.shape))throw new Error(`Unrecognized key: "${i}"`);t[i]&&delete s[i]}return Fr(this,"shape",s),s},checks:[]});return vr(e,n)}function by(e,t){if(!Sn(t))throw new Error("Invalid input to extend: expected a plain object");const r=e._zod.def.checks;if(r&&r.length>0)throw new Error("Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.");const s=Br(e._zod.def,{get shape(){const i={...e._zod.def.shape,...t};return Fr(this,"shape",i),i},checks:[]});return vr(e,s)}function vy(e,t){if(!Sn(t))throw new Error("Invalid input to safeExtend: expected a plain object");const r={...e._zod.def,get shape(){const n={...e._zod.def.shape,...t};return Fr(this,"shape",n),n},checks:e._zod.def.checks};return vr(e,r)}function Ny(e,t){const r=Br(e._zod.def,{get shape(){const n={...e._zod.def.shape,...t._zod.def.shape};return Fr(this,"shape",n),n},get catchall(){return t._zod.def.catchall},checks:[]});return vr(e,r)}function Ey(e,t,r){const n=Br(t._zod.def,{get shape(){const s=t._zod.def.shape,i={...s};if(r)for(const o in r){if(!(o in s))throw new Error(`Unrecognized key: "${o}"`);r[o]&&(i[o]=e?new e({type:"optional",innerType:s[o]}):s[o])}else for(const o in s)i[o]=e?new e({type:"optional",innerType:s[o]}):s[o];return Fr(this,"shape",i),i},checks:[]});return vr(t,n)}function Ay(e,t,r){const n=Br(t._zod.def,{get shape(){const s=t._zod.def.shape,i={...s};if(r)for(const o in r){if(!(o in i))throw new Error(`Unrecognized key: "${o}"`);r[o]&&(i[o]=new e({type:"nonoptional",innerType:s[o]}))}else for(const o in s)i[o]=new e({type:"nonoptional",innerType:s[o]});return Fr(this,"shape",i),i},checks:[]});return vr(t,n)}function pn(e,t=0){if(e.aborted===!0)return!0;for(let r=t;r<e.issues.length;r++)if(e.issues[r]?.continue!==!0)return!0;return!1}function mn(e,t){return t.map(r=>{var n;return(n=r).path??(n.path=[]),r.path.unshift(e),r})}function js(e){return typeof e=="string"?e:e?.message}function pr(e,t,r){const n={...e,path:e.path??[]};if(!e.message){const s=js(e.inst?._zod.def?.error?.(e))??js(t?.error?.(e))??js(r.customError?.(e))??js(r.localeError?.(e))??"Invalid input";n.message=s}return delete n.inst,delete n.continue,t?.reportInput||delete n.input,n}function ma(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function Es(...e){const[t,r,n]=e;return typeof t=="string"?{message:t,code:"custom",input:r,inst:n}:{...t}}const Ad=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,Do,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},kd=_("$ZodError",Ad),Td=_("$ZodError",Ad,{Parent:Error});function ky(e,t=r=>r.message){const r={},n=[];for(const s of e.issues)s.path.length>0?(r[s.path[0]]=r[s.path[0]]||[],r[s.path[0]].push(t(s))):n.push(t(s));return{formErrors:n,fieldErrors:r}}function Ty(e,t){const r=t||function(i){return i.message},n={_errors:[]},s=i=>{for(const o of i.issues)if(o.code==="invalid_union"&&o.errors.length)o.errors.map(a=>s({issues:a}));else if(o.code==="invalid_key")s({issues:o.issues});else if(o.code==="invalid_element")s({issues:o.issues});else if(o.path.length===0)n._errors.push(r(o));else{let a=n,c=0;for(;c<o.path.length;){const u=o.path[c];c===o.path.length-1?(a[u]=a[u]||{_errors:[]},a[u]._errors.push(r(o))):a[u]=a[u]||{_errors:[]},a=a[u],c++}}};return s(e),n}const ya=e=>(t,r,n,s)=>{const i=n?Object.assign(n,{async:!1}):{async:!1},o=t._zod.run({value:r,issues:[]},i);if(o instanceof Promise)throw new Nn;if(o.issues.length){const a=new(s?.Err??e)(o.issues.map(c=>pr(c,i,fr())));throw Nd(a,s?.callee),a}return o.value},wa=e=>async(t,r,n,s)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let o=t._zod.run({value:r,issues:[]},i);if(o instanceof Promise&&(o=await o),o.issues.length){const a=new(s?.Err??e)(o.issues.map(c=>pr(c,i,fr())));throw Nd(a,s?.callee),a}return o.value},Gi=e=>(t,r,n)=>{const s=n?{...n,async:!1}:{async:!1},i=t._zod.run({value:r,issues:[]},s);if(i instanceof Promise)throw new Nn;return i.issues.length?{success:!1,error:new(e??kd)(i.issues.map(o=>pr(o,s,fr())))}:{success:!0,data:i.value}},_y=Gi(Td),Qi=e=>async(t,r,n)=>{const s=n?Object.assign(n,{async:!0}):{async:!0};let i=t._zod.run({value:r,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map(o=>pr(o,s,fr())))}:{success:!0,data:i.value}},Sy=Qi(Td),Ry=e=>(t,r,n)=>{const s=n?Object.assign(n,{direction:"backward"}):{direction:"backward"};return ya(e)(t,r,s)},Oy=e=>(t,r,n)=>ya(e)(t,r,n),Iy=e=>async(t,r,n)=>{const s=n?Object.assign(n,{direction:"backward"}):{direction:"backward"};return wa(e)(t,r,s)},xy=e=>async(t,r,n)=>wa(e)(t,r,n),Cy=e=>(t,r,n)=>{const s=n?Object.assign(n,{direction:"backward"}):{direction:"backward"};return Gi(e)(t,r,s)},Py=e=>(t,r,n)=>Gi(e)(t,r,n),Uy=e=>async(t,r,n)=>{const s=n?Object.assign(n,{direction:"backward"}):{direction:"backward"};return Qi(e)(t,r,s)},Ly=e=>async(t,r,n)=>Qi(e)(t,r,n),$y=/^[cC][^\s-]{8,}$/,Dy=/^[0-9a-z]+$/,qy=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,Wy=/^[0-9a-vA-V]{20}$/,zy=/^[A-Za-z0-9]{27}$/,My=/^[a-zA-Z0-9_-]{21}$/,jy=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,Vy=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,bc=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,Fy=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,By="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function Hy(){return new RegExp(By,"u")}const Ky=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Zy=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,Jy=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,Gy=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Qy=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,_d=/^[A-Za-z0-9_-]*$/,Yy=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,Xy=/^\+(?:[0-9]){6,14}[0-9]$/,Sd="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",ew=new RegExp(`^${Sd}$`);function Rd(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof e.precision=="number"?e.precision===-1?`${t}`:e.precision===0?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}function tw(e){return new RegExp(`^${Rd(e)}$`)}function rw(e){const t=Rd({precision:e.precision}),r=["Z"];e.local&&r.push(""),e.offset&&r.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const n=`${t}(?:${r.join("|")})`;return new RegExp(`^${Sd}T(?:${n})$`)}const nw=e=>{const t=e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${t}$`)},sw=/^-?\d+$/,iw=/^-?\d+(?:\.\d+)?/,ow=/^(?:true|false)$/i,aw=/^[^A-Z]*$/,cw=/^[^a-z]*$/,Xe=_("$ZodCheck",(e,t)=>{var r;e._zod??(e._zod={}),e._zod.def=t,(r=e._zod).onattach??(r.onattach=[])}),Od={number:"number",bigint:"bigint",object:"date"},Id=_("$ZodCheckLessThan",(e,t)=>{Xe.init(e,t);const r=Od[typeof t.value];e._zod.onattach.push(n=>{const s=n._zod.bag,i=(t.inclusive?s.maximum:s.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<i&&(t.inclusive?s.maximum=t.value:s.exclusiveMaximum=t.value)}),e._zod.check=n=>{(t.inclusive?n.value<=t.value:n.value<t.value)||n.issues.push({origin:r,code:"too_big",maximum:t.value,input:n.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),xd=_("$ZodCheckGreaterThan",(e,t)=>{Xe.init(e,t);const r=Od[typeof t.value];e._zod.onattach.push(n=>{const s=n._zod.bag,i=(t.inclusive?s.minimum:s.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>i&&(t.inclusive?s.minimum=t.value:s.exclusiveMinimum=t.value)}),e._zod.check=n=>{(t.inclusive?n.value>=t.value:n.value>t.value)||n.issues.push({origin:r,code:"too_small",minimum:t.value,input:n.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),uw=_("$ZodCheckMultipleOf",(e,t)=>{Xe.init(e,t),e._zod.onattach.push(r=>{var n;(n=r._zod.bag).multipleOf??(n.multipleOf=t.value)}),e._zod.check=r=>{if(typeof r.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");(typeof r.value=="bigint"?r.value%t.value===BigInt(0):hy(r.value,t.value)===0)||r.issues.push({origin:typeof r.value,code:"not_multiple_of",divisor:t.value,input:r.value,inst:e,continue:!t.abort})}}),dw=_("$ZodCheckNumberFormat",(e,t)=>{Xe.init(e,t),t.format=t.format||"float64";const r=t.format?.includes("int"),n=r?"int":"number",[s,i]=yy[t.format];e._zod.onattach.push(o=>{const a=o._zod.bag;a.format=t.format,a.minimum=s,a.maximum=i,r&&(a.pattern=sw)}),e._zod.check=o=>{const a=o.value;if(r){if(!Number.isInteger(a)){o.issues.push({expected:n,format:t.format,code:"invalid_type",continue:!1,input:a,inst:e});return}if(!Number.isSafeInteger(a)){a>0?o.issues.push({input:a,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:n,continue:!t.abort}):o.issues.push({input:a,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:n,continue:!t.abort});return}}a<s&&o.issues.push({origin:"number",input:a,code:"too_small",minimum:s,inclusive:!0,inst:e,continue:!t.abort}),a>i&&o.issues.push({origin:"number",input:a,code:"too_big",maximum:i,inst:e})}}),lw=_("$ZodCheckMaxLength",(e,t)=>{var r;Xe.init(e,t),(r=e._zod.def).when??(r.when=n=>{const s=n.value;return!fa(s)&&s.length!==void 0}),e._zod.onattach.push(n=>{const s=n._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<s&&(n._zod.bag.maximum=t.maximum)}),e._zod.check=n=>{const s=n.value;if(s.length<=t.maximum)return;const o=ma(s);n.issues.push({origin:o,code:"too_big",maximum:t.maximum,inclusive:!0,input:s,inst:e,continue:!t.abort})}}),hw=_("$ZodCheckMinLength",(e,t)=>{var r;Xe.init(e,t),(r=e._zod.def).when??(r.when=n=>{const s=n.value;return!fa(s)&&s.length!==void 0}),e._zod.onattach.push(n=>{const s=n._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>s&&(n._zod.bag.minimum=t.minimum)}),e._zod.check=n=>{const s=n.value;if(s.length>=t.minimum)return;const o=ma(s);n.issues.push({origin:o,code:"too_small",minimum:t.minimum,inclusive:!0,input:s,inst:e,continue:!t.abort})}}),fw=_("$ZodCheckLengthEquals",(e,t)=>{var r;Xe.init(e,t),(r=e._zod.def).when??(r.when=n=>{const s=n.value;return!fa(s)&&s.length!==void 0}),e._zod.onattach.push(n=>{const s=n._zod.bag;s.minimum=t.length,s.maximum=t.length,s.length=t.length}),e._zod.check=n=>{const s=n.value,i=s.length;if(i===t.length)return;const o=ma(s),a=i>t.length;n.issues.push({origin:o,...a?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:n.value,inst:e,continue:!t.abort})}}),Yi=_("$ZodCheckStringFormat",(e,t)=>{var r,n;Xe.init(e,t),e._zod.onattach.push(s=>{const i=s._zod.bag;i.format=t.format,t.pattern&&(i.patterns??(i.patterns=new Set),i.patterns.add(t.pattern))}),t.pattern?(r=e._zod).check??(r.check=s=>{t.pattern.lastIndex=0,!t.pattern.test(s.value)&&s.issues.push({origin:"string",code:"invalid_format",format:t.format,input:s.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(n=e._zod).check??(n.check=()=>{})}),pw=_("$ZodCheckRegex",(e,t)=>{Yi.init(e,t),e._zod.check=r=>{t.pattern.lastIndex=0,!t.pattern.test(r.value)&&r.issues.push({origin:"string",code:"invalid_format",format:"regex",input:r.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),mw=_("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=aw),Yi.init(e,t)}),yw=_("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=cw),Yi.init(e,t)}),ww=_("$ZodCheckIncludes",(e,t)=>{Xe.init(e,t);const r=Ji(t.includes),n=new RegExp(typeof t.position=="number"?`^.{${t.position}}${r}`:r);t.pattern=n,e._zod.onattach.push(s=>{const i=s._zod.bag;i.patterns??(i.patterns=new Set),i.patterns.add(n)}),e._zod.check=s=>{s.value.includes(t.includes,t.position)||s.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:s.value,inst:e,continue:!t.abort})}}),gw=_("$ZodCheckStartsWith",(e,t)=>{Xe.init(e,t);const r=new RegExp(`^${Ji(t.prefix)}.*`);t.pattern??(t.pattern=r),e._zod.onattach.push(n=>{const s=n._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(r)}),e._zod.check=n=>{n.value.startsWith(t.prefix)||n.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:n.value,inst:e,continue:!t.abort})}}),bw=_("$ZodCheckEndsWith",(e,t)=>{Xe.init(e,t);const r=new RegExp(`.*${Ji(t.suffix)}$`);t.pattern??(t.pattern=r),e._zod.onattach.push(n=>{const s=n._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(r)}),e._zod.check=n=>{n.value.endsWith(t.suffix)||n.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:n.value,inst:e,continue:!t.abort})}}),vw=_("$ZodCheckOverwrite",(e,t)=>{Xe.init(e,t),e._zod.check=r=>{r.value=t.tx(r.value)}});class Nw{constructor(t=[]){this.content=[],this.indent=0,this&&(this.args=t)}indented(t){this.indent+=1,t(this),this.indent-=1}write(t){if(typeof t=="function"){t(this,{execution:"sync"}),t(this,{execution:"async"});return}const n=t.split(`
`).filter(o=>o),s=Math.min(...n.map(o=>o.length-o.trimStart().length)),i=n.map(o=>o.slice(s)).map(o=>" ".repeat(this.indent*2)+o);for(const o of i)this.content.push(o)}compile(){const t=Function,r=this?.args,s=[...(this?.content??[""]).map(i=>`  ${i}`)];return new t(...r,s.join(`
`))}}const Ew={major:4,minor:1,patch:11},ve=_("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Ew;const n=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&n.unshift(e);for(const s of n)for(const i of s._zod.onattach)i(e);if(n.length===0)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const s=(o,a,c)=>{let u=pn(o),d;for(const l of a){if(l._zod.def.when){if(!l._zod.def.when(o))continue}else if(u)continue;const h=o.issues.length,p=l._zod.check(o);if(p instanceof Promise&&c?.async===!1)throw new Nn;if(d||p instanceof Promise)d=(d??Promise.resolve()).then(async()=>{await p,o.issues.length!==h&&(u||(u=pn(o,h)))});else{if(o.issues.length===h)continue;u||(u=pn(o,h))}}return d?d.then(()=>o):o},i=(o,a,c)=>{if(pn(o))return o.aborted=!0,o;const u=s(a,n,c);if(u instanceof Promise){if(c.async===!1)throw new Nn;return u.then(d=>e._zod.parse(d,c))}return e._zod.parse(u,c)};e._zod.run=(o,a)=>{if(a.skipChecks)return e._zod.parse(o,a);if(a.direction==="backward"){const u=e._zod.parse({value:o.value,issues:[]},{...a,skipChecks:!0});return u instanceof Promise?u.then(d=>i(d,o,a)):i(u,o,a)}const c=e._zod.parse(o,a);if(c instanceof Promise){if(a.async===!1)throw new Nn;return c.then(u=>s(u,n,a))}return s(c,n,a)}}e["~standard"]={validate:s=>{try{const i=_y(e,s);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return Sy(e,s).then(o=>o.success?{value:o.data}:{issues:o.error?.issues})}},vendor:"zod",version:1}}),ga=_("$ZodString",(e,t)=>{ve.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??nw(e._zod.bag),e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=String(r.value)}catch{}return typeof r.value=="string"||r.issues.push({expected:"string",code:"invalid_type",input:r.value,inst:e}),r}}),Ne=_("$ZodStringFormat",(e,t)=>{Yi.init(e,t),ga.init(e,t)}),Aw=_("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=Vy),Ne.init(e,t)}),kw=_("$ZodUUID",(e,t)=>{if(t.version){const n={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(n===void 0)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=bc(n))}else t.pattern??(t.pattern=bc());Ne.init(e,t)}),Tw=_("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=Fy),Ne.init(e,t)}),_w=_("$ZodURL",(e,t)=>{Ne.init(e,t),e._zod.check=r=>{try{const n=r.value.trim(),s=new URL(n);t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(s.hostname)||r.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:Yy.source,input:r.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(s.protocol.endsWith(":")?s.protocol.slice(0,-1):s.protocol)||r.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:r.value,inst:e,continue:!t.abort})),t.normalize?r.value=s.href:r.value=n;return}catch{r.issues.push({code:"invalid_format",format:"url",input:r.value,inst:e,continue:!t.abort})}}}),Sw=_("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=Hy()),Ne.init(e,t)}),Rw=_("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=My),Ne.init(e,t)}),Ow=_("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=$y),Ne.init(e,t)}),Iw=_("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=Dy),Ne.init(e,t)}),xw=_("$ZodULID",(e,t)=>{t.pattern??(t.pattern=qy),Ne.init(e,t)}),Cw=_("$ZodXID",(e,t)=>{t.pattern??(t.pattern=Wy),Ne.init(e,t)}),Pw=_("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=zy),Ne.init(e,t)}),Uw=_("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=rw(t)),Ne.init(e,t)}),Lw=_("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=ew),Ne.init(e,t)}),$w=_("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=tw(t)),Ne.init(e,t)}),Dw=_("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=jy),Ne.init(e,t)}),qw=_("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=Ky),Ne.init(e,t),e._zod.onattach.push(r=>{const n=r._zod.bag;n.format="ipv4"})}),Ww=_("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=Zy),Ne.init(e,t),e._zod.onattach.push(r=>{const n=r._zod.bag;n.format="ipv6"}),e._zod.check=r=>{try{new URL(`http://[${r.value}]`)}catch{r.issues.push({code:"invalid_format",format:"ipv6",input:r.value,inst:e,continue:!t.abort})}}}),zw=_("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=Jy),Ne.init(e,t)}),Mw=_("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=Gy),Ne.init(e,t),e._zod.check=r=>{const n=r.value.split("/");try{if(n.length!==2)throw new Error;const[s,i]=n;if(!i)throw new Error;const o=Number(i);if(`${o}`!==i)throw new Error;if(o<0||o>128)throw new Error;new URL(`http://[${s}]`)}catch{r.issues.push({code:"invalid_format",format:"cidrv6",input:r.value,inst:e,continue:!t.abort})}}});function Cd(e){if(e==="")return!0;if(e.length%4!==0)return!1;try{return atob(e),!0}catch{return!1}}const jw=_("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=Qy),Ne.init(e,t),e._zod.onattach.push(r=>{r._zod.bag.contentEncoding="base64"}),e._zod.check=r=>{Cd(r.value)||r.issues.push({code:"invalid_format",format:"base64",input:r.value,inst:e,continue:!t.abort})}});function Vw(e){if(!_d.test(e))return!1;const t=e.replace(/[-_]/g,n=>n==="-"?"+":"/"),r=t.padEnd(Math.ceil(t.length/4)*4,"=");return Cd(r)}const Fw=_("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=_d),Ne.init(e,t),e._zod.onattach.push(r=>{r._zod.bag.contentEncoding="base64url"}),e._zod.check=r=>{Vw(r.value)||r.issues.push({code:"invalid_format",format:"base64url",input:r.value,inst:e,continue:!t.abort})}}),Bw=_("$ZodE164",(e,t)=>{t.pattern??(t.pattern=Xy),Ne.init(e,t)});function Hw(e,t=null){try{const r=e.split(".");if(r.length!==3)return!1;const[n]=r;if(!n)return!1;const s=JSON.parse(atob(n));return!("typ"in s&&s?.typ!=="JWT"||!s.alg||t&&(!("alg"in s)||s.alg!==t))}catch{return!1}}const Kw=_("$ZodJWT",(e,t)=>{Ne.init(e,t),e._zod.check=r=>{Hw(r.value,t.alg)||r.issues.push({code:"invalid_format",format:"jwt",input:r.value,inst:e,continue:!t.abort})}}),Pd=_("$ZodNumber",(e,t)=>{ve.init(e,t),e._zod.pattern=e._zod.bag.pattern??iw,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=Number(r.value)}catch{}const s=r.value;if(typeof s=="number"&&!Number.isNaN(s)&&Number.isFinite(s))return r;const i=typeof s=="number"?Number.isNaN(s)?"NaN":Number.isFinite(s)?void 0:"Infinity":void 0;return r.issues.push({expected:"number",code:"invalid_type",input:s,inst:e,...i?{received:i}:{}}),r}}),Zw=_("$ZodNumber",(e,t)=>{dw.init(e,t),Pd.init(e,t)}),Jw=_("$ZodBoolean",(e,t)=>{ve.init(e,t),e._zod.pattern=ow,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=!!r.value}catch{}const s=r.value;return typeof s=="boolean"||r.issues.push({expected:"boolean",code:"invalid_type",input:s,inst:e}),r}}),Gw=_("$ZodAny",(e,t)=>{ve.init(e,t),e._zod.parse=r=>r}),Qw=_("$ZodUnknown",(e,t)=>{ve.init(e,t),e._zod.parse=r=>r}),Yw=_("$ZodNever",(e,t)=>{ve.init(e,t),e._zod.parse=(r,n)=>(r.issues.push({expected:"never",code:"invalid_type",input:r.value,inst:e}),r)}),Xw=_("$ZodDate",(e,t)=>{ve.init(e,t),e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=new Date(r.value)}catch{}const s=r.value,i=s instanceof Date;return i&&!Number.isNaN(s.getTime())||r.issues.push({expected:"date",code:"invalid_type",input:s,...i?{received:"Invalid Date"}:{},inst:e}),r}});function vc(e,t,r){e.issues.length&&t.issues.push(...mn(r,e.issues)),t.value[r]=e.value}const eg=_("$ZodArray",(e,t)=>{ve.init(e,t),e._zod.parse=(r,n)=>{const s=r.value;if(!Array.isArray(s))return r.issues.push({expected:"array",code:"invalid_type",input:s,inst:e}),r;r.value=Array(s.length);const i=[];for(let o=0;o<s.length;o++){const a=s[o],c=t.element._zod.run({value:a,issues:[]},n);c instanceof Promise?i.push(c.then(u=>vc(u,r,o))):vc(c,r,o)}return i.length?Promise.all(i).then(()=>r):r}});function vi(e,t,r,n){e.issues.length&&t.issues.push(...mn(r,e.issues)),e.value===void 0?r in n&&(t.value[r]=void 0):t.value[r]=e.value}function Ud(e){const t=Object.keys(e.shape);for(const n of t)if(!e.shape?.[n]?._zod?.traits?.has("$ZodType"))throw new Error(`Invalid element at key "${n}": expected a Zod schema`);const r=my(e.shape);return{...e,keys:t,keySet:new Set(t),numKeys:t.length,optionalKeys:new Set(r)}}function Ld(e,t,r,n,s,i){const o=[],a=s.keySet,c=s.catchall._zod,u=c.def.type;for(const d of Object.keys(t)){if(a.has(d))continue;if(u==="never"){o.push(d);continue}const l=c.run({value:t[d],issues:[]},n);l instanceof Promise?e.push(l.then(h=>vi(h,r,d,t))):vi(l,r,d,t)}return o.length&&r.issues.push({code:"unrecognized_keys",keys:o,input:t,inst:i}),e.length?Promise.all(e).then(()=>r):r}const tg=_("$ZodObject",(e,t)=>{if(ve.init(e,t),!Object.getOwnPropertyDescriptor(t,"shape")?.get){const a=t.shape;Object.defineProperty(t,"shape",{get:()=>{const c={...a};return Object.defineProperty(t,"shape",{value:c}),c}})}const n=ha(()=>Ud(t));de(e._zod,"propValues",()=>{const a=t.shape,c={};for(const u in a){const d=a[u]._zod;if(d.values){c[u]??(c[u]=new Set);for(const l of d.values)c[u].add(l)}}return c});const s=bi,i=t.catchall;let o;e._zod.parse=(a,c)=>{o??(o=n.value);const u=a.value;if(!s(u))return a.issues.push({expected:"object",code:"invalid_type",input:u,inst:e}),a;a.value={};const d=[],l=o.shape;for(const h of o.keys){const m=l[h]._zod.run({value:u[h],issues:[]},c);m instanceof Promise?d.push(m.then(y=>vi(y,a,h,u))):vi(m,a,h,u)}return i?Ld(d,u,a,c,n.value,e):d.length?Promise.all(d).then(()=>a):a}}),rg=_("$ZodObjectJIT",(e,t)=>{tg.init(e,t);const r=e._zod.parse,n=ha(()=>Ud(t)),s=h=>{const p=new Nw(["shape","payload","ctx"]),m=n.value,y=N=>{const v=gc(N);return`shape[${v}]._zod.run({ value: input[${v}], issues: [] }, ctx)`};p.write("const input = payload.value;");const g=Object.create(null);let b=0;for(const N of m.keys)g[N]=`key_${b++}`;p.write("const newResult = {};");for(const N of m.keys){const v=g[N],k=gc(N);p.write(`const ${v} = ${y(N)};`),p.write(`
        if (${v}.issues.length) {
          payload.issues = payload.issues.concat(${v}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${k}, ...iss.path] : [${k}]
          })));
        }
        
        
        if (${v}.value === undefined) {
          if (${k} in input) {
            newResult[${k}] = undefined;
          }
        } else {
          newResult[${k}] = ${v}.value;
        }
        
      `)}p.write("payload.value = newResult;"),p.write("return payload;");const w=p.compile();return(N,v)=>w(h,N,v)};let i;const o=bi,a=!vd.jitless,u=a&&fy.value,d=t.catchall;let l;e._zod.parse=(h,p)=>{l??(l=n.value);const m=h.value;return o(m)?a&&u&&p?.async===!1&&p.jitless!==!0?(i||(i=s(t.shape)),h=i(h,p),d?Ld([],m,h,p,l,e):h):r(h,p):(h.issues.push({expected:"object",code:"invalid_type",input:m,inst:e}),h)}});function Nc(e,t,r,n){for(const i of e)if(i.issues.length===0)return t.value=i.value,t;const s=e.filter(i=>!pn(i));return s.length===1?(t.value=s[0].value,s[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:r,errors:e.map(i=>i.issues.map(o=>pr(o,n,fr())))}),t)}const ng=_("$ZodUnion",(e,t)=>{ve.init(e,t),de(e._zod,"optin",()=>t.options.some(s=>s._zod.optin==="optional")?"optional":void 0),de(e._zod,"optout",()=>t.options.some(s=>s._zod.optout==="optional")?"optional":void 0),de(e._zod,"values",()=>{if(t.options.every(s=>s._zod.values))return new Set(t.options.flatMap(s=>Array.from(s._zod.values)))}),de(e._zod,"pattern",()=>{if(t.options.every(s=>s._zod.pattern)){const s=t.options.map(i=>i._zod.pattern);return new RegExp(`^(${s.map(i=>pa(i.source)).join("|")})$`)}});const r=t.options.length===1,n=t.options[0]._zod.run;e._zod.parse=(s,i)=>{if(r)return n(s,i);let o=!1;const a=[];for(const c of t.options){const u=c._zod.run({value:s.value,issues:[]},i);if(u instanceof Promise)a.push(u),o=!0;else{if(u.issues.length===0)return u;a.push(u)}}return o?Promise.all(a).then(c=>Nc(c,s,e,i)):Nc(a,s,e,i)}}),sg=_("$ZodIntersection",(e,t)=>{ve.init(e,t),e._zod.parse=(r,n)=>{const s=r.value,i=t.left._zod.run({value:s,issues:[]},n),o=t.right._zod.run({value:s,issues:[]},n);return i instanceof Promise||o instanceof Promise?Promise.all([i,o]).then(([c,u])=>Ec(r,c,u)):Ec(r,i,o)}});function qo(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e==+t)return{valid:!0,data:e};if(Sn(e)&&Sn(t)){const r=Object.keys(t),n=Object.keys(e).filter(i=>r.indexOf(i)!==-1),s={...e,...t};for(const i of n){const o=qo(e[i],t[i]);if(!o.valid)return{valid:!1,mergeErrorPath:[i,...o.mergeErrorPath]};s[i]=o.data}return{valid:!0,data:s}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const r=[];for(let n=0;n<e.length;n++){const s=e[n],i=t[n],o=qo(s,i);if(!o.valid)return{valid:!1,mergeErrorPath:[n,...o.mergeErrorPath]};r.push(o.data)}return{valid:!0,data:r}}return{valid:!1,mergeErrorPath:[]}}function Ec(e,t,r){if(t.issues.length&&e.issues.push(...t.issues),r.issues.length&&e.issues.push(...r.issues),pn(e))return e;const n=qo(t.value,r.value);if(!n.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(n.mergeErrorPath)}`);return e.value=n.data,e}const ig=_("$ZodRecord",(e,t)=>{ve.init(e,t),e._zod.parse=(r,n)=>{const s=r.value;if(!Sn(s))return r.issues.push({expected:"record",code:"invalid_type",input:s,inst:e}),r;const i=[];if(t.keyType._zod.values){const o=t.keyType._zod.values;r.value={};for(const c of o)if(typeof c=="string"||typeof c=="number"||typeof c=="symbol"){const u=t.valueType._zod.run({value:s[c],issues:[]},n);u instanceof Promise?i.push(u.then(d=>{d.issues.length&&r.issues.push(...mn(c,d.issues)),r.value[c]=d.value})):(u.issues.length&&r.issues.push(...mn(c,u.issues)),r.value[c]=u.value)}let a;for(const c in s)o.has(c)||(a=a??[],a.push(c));a&&a.length>0&&r.issues.push({code:"unrecognized_keys",input:s,inst:e,keys:a})}else{r.value={};for(const o of Reflect.ownKeys(s)){if(o==="__proto__")continue;const a=t.keyType._zod.run({value:o,issues:[]},n);if(a instanceof Promise)throw new Error("Async schemas not supported in object keys currently");if(a.issues.length){r.issues.push({code:"invalid_key",origin:"record",issues:a.issues.map(u=>pr(u,n,fr())),input:o,path:[o],inst:e}),r.value[a.value]=a.value;continue}const c=t.valueType._zod.run({value:s[o],issues:[]},n);c instanceof Promise?i.push(c.then(u=>{u.issues.length&&r.issues.push(...mn(o,u.issues)),r.value[a.value]=u.value})):(c.issues.length&&r.issues.push(...mn(o,c.issues)),r.value[a.value]=c.value)}}return i.length?Promise.all(i).then(()=>r):r}}),og=_("$ZodEnum",(e,t)=>{ve.init(e,t);const r=ly(t.entries),n=new Set(r);e._zod.values=n,e._zod.pattern=new RegExp(`^(${r.filter(s=>py.has(typeof s)).map(s=>typeof s=="string"?Ji(s):s.toString()).join("|")})$`),e._zod.parse=(s,i)=>{const o=s.value;return n.has(o)||s.issues.push({code:"invalid_value",values:r,input:o,inst:e}),s}}),ag=_("$ZodTransform",(e,t)=>{ve.init(e,t),e._zod.parse=(r,n)=>{if(n.direction==="backward")throw new bd(e.constructor.name);const s=t.transform(r.value,r);if(n.async)return(s instanceof Promise?s:Promise.resolve(s)).then(o=>(r.value=o,r));if(s instanceof Promise)throw new Nn;return r.value=s,r}});function Ac(e,t){return e.issues.length&&t===void 0?{issues:[],value:void 0}:e}const cg=_("$ZodOptional",(e,t)=>{ve.init(e,t),e._zod.optin="optional",e._zod.optout="optional",de(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),de(e._zod,"pattern",()=>{const r=t.innerType._zod.pattern;return r?new RegExp(`^(${pa(r.source)})?$`):void 0}),e._zod.parse=(r,n)=>{if(t.innerType._zod.optin==="optional"){const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>Ac(i,r.value)):Ac(s,r.value)}return r.value===void 0?r:t.innerType._zod.run(r,n)}}),ug=_("$ZodNullable",(e,t)=>{ve.init(e,t),de(e._zod,"optin",()=>t.innerType._zod.optin),de(e._zod,"optout",()=>t.innerType._zod.optout),de(e._zod,"pattern",()=>{const r=t.innerType._zod.pattern;return r?new RegExp(`^(${pa(r.source)}|null)$`):void 0}),de(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(r,n)=>r.value===null?r:t.innerType._zod.run(r,n)}),dg=_("$ZodDefault",(e,t)=>{ve.init(e,t),e._zod.optin="optional",de(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(r,n)=>{if(n.direction==="backward")return t.innerType._zod.run(r,n);if(r.value===void 0)return r.value=t.defaultValue,r;const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>kc(i,t)):kc(s,t)}});function kc(e,t){return e.value===void 0&&(e.value=t.defaultValue),e}const lg=_("$ZodPrefault",(e,t)=>{ve.init(e,t),e._zod.optin="optional",de(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(r,n)=>(n.direction==="backward"||r.value===void 0&&(r.value=t.defaultValue),t.innerType._zod.run(r,n))}),hg=_("$ZodNonOptional",(e,t)=>{ve.init(e,t),de(e._zod,"values",()=>{const r=t.innerType._zod.values;return r?new Set([...r].filter(n=>n!==void 0)):void 0}),e._zod.parse=(r,n)=>{const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>Tc(i,e)):Tc(s,e)}});function Tc(e,t){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const fg=_("$ZodCatch",(e,t)=>{ve.init(e,t),de(e._zod,"optin",()=>t.innerType._zod.optin),de(e._zod,"optout",()=>t.innerType._zod.optout),de(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(r,n)=>{if(n.direction==="backward")return t.innerType._zod.run(r,n);const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(i=>(r.value=i.value,i.issues.length&&(r.value=t.catchValue({...r,error:{issues:i.issues.map(o=>pr(o,n,fr()))},input:r.value}),r.issues=[]),r)):(r.value=s.value,s.issues.length&&(r.value=t.catchValue({...r,error:{issues:s.issues.map(i=>pr(i,n,fr()))},input:r.value}),r.issues=[]),r)}}),pg=_("$ZodPipe",(e,t)=>{ve.init(e,t),de(e._zod,"values",()=>t.in._zod.values),de(e._zod,"optin",()=>t.in._zod.optin),de(e._zod,"optout",()=>t.out._zod.optout),de(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(r,n)=>{if(n.direction==="backward"){const i=t.out._zod.run(r,n);return i instanceof Promise?i.then(o=>Vs(o,t.in,n)):Vs(i,t.in,n)}const s=t.in._zod.run(r,n);return s instanceof Promise?s.then(i=>Vs(i,t.out,n)):Vs(s,t.out,n)}});function Vs(e,t,r){return e.issues.length?(e.aborted=!0,e):t._zod.run({value:e.value,issues:e.issues},r)}const mg=_("$ZodReadonly",(e,t)=>{ve.init(e,t),de(e._zod,"propValues",()=>t.innerType._zod.propValues),de(e._zod,"values",()=>t.innerType._zod.values),de(e._zod,"optin",()=>t.innerType._zod.optin),de(e._zod,"optout",()=>t.innerType._zod.optout),e._zod.parse=(r,n)=>{if(n.direction==="backward")return t.innerType._zod.run(r,n);const s=t.innerType._zod.run(r,n);return s instanceof Promise?s.then(_c):_c(s)}});function _c(e){return e.value=Object.freeze(e.value),e}const yg=_("$ZodCustom",(e,t)=>{Xe.init(e,t),ve.init(e,t),e._zod.parse=(r,n)=>r,e._zod.check=r=>{const n=r.value,s=t.fn(n);if(s instanceof Promise)return s.then(i=>Sc(i,r,n,e));Sc(s,r,n,e)}});function Sc(e,t,r,n){if(!e){const s={code:"custom",input:r,inst:n,path:[...n._zod.def.path??[]],continue:!n._zod.def.abort};n._zod.def.params&&(s.params=n._zod.def.params),t.issues.push(Es(s))}}class wg{constructor(){this._map=new WeakMap,this._idmap=new Map}add(t,...r){const n=r[0];if(this._map.set(t,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,t)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(t){const r=this._map.get(t);return r&&typeof r=="object"&&"id"in r&&this._idmap.delete(r.id),this._map.delete(t),this}get(t){const r=t._zod.parent;if(r){const n={...this.get(r)??{}};delete n.id;const s={...n,...this._map.get(t)};return Object.keys(s).length?s:void 0}return this._map.get(t)}has(t){return this._map.has(t)}}function gg(){return new wg}const Fs=gg();function bg(e,t){return new e({type:"string",...j(t)})}function vg(e,t){return new e({type:"string",coerce:!0,...j(t)})}function $d(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,...j(t)})}function Rc(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...j(t)})}function Ng(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...j(t)})}function Eg(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...j(t)})}function Ag(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...j(t)})}function kg(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...j(t)})}function Tg(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,...j(t)})}function _g(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...j(t)})}function Sg(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...j(t)})}function Rg(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...j(t)})}function Og(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...j(t)})}function Ig(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...j(t)})}function xg(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...j(t)})}function Cg(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...j(t)})}function Pg(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...j(t)})}function Ug(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...j(t)})}function Lg(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...j(t)})}function $g(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...j(t)})}function Dg(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...j(t)})}function qg(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...j(t)})}function Wg(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...j(t)})}function zg(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...j(t)})}function Mg(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...j(t)})}function jg(e,t){return new e({type:"string",format:"date",check:"string_format",...j(t)})}function Vg(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,...j(t)})}function Fg(e,t){return new e({type:"string",format:"duration",check:"string_format",...j(t)})}function Bg(e,t){return new e({type:"number",checks:[],...j(t)})}function Hg(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...j(t)})}function Kg(e,t){return new e({type:"boolean",...j(t)})}function Zg(e,t){return new e({type:"boolean",coerce:!0,...j(t)})}function Jg(e){return new e({type:"any"})}function Gg(e){return new e({type:"unknown"})}function Qg(e,t){return new e({type:"never",...j(t)})}function Yg(e,t){return new e({type:"date",...j(t)})}function Oc(e,t){return new Id({check:"less_than",...j(t),value:e,inclusive:!1})}function ti(e,t){return new Id({check:"less_than",...j(t),value:e,inclusive:!0})}function Ic(e,t){return new xd({check:"greater_than",...j(t),value:e,inclusive:!1})}function ri(e,t){return new xd({check:"greater_than",...j(t),value:e,inclusive:!0})}function xc(e,t){return new uw({check:"multiple_of",...j(t),value:e})}function Dd(e,t){return new lw({check:"max_length",...j(t),maximum:e})}function Ni(e,t){return new hw({check:"min_length",...j(t),minimum:e})}function qd(e,t){return new fw({check:"length_equals",...j(t),length:e})}function Xg(e,t){return new pw({check:"string_format",format:"regex",...j(t),pattern:e})}function eb(e){return new mw({check:"string_format",format:"lowercase",...j(e)})}function tb(e){return new yw({check:"string_format",format:"uppercase",...j(e)})}function rb(e,t){return new ww({check:"string_format",format:"includes",...j(t),includes:e})}function nb(e,t){return new gw({check:"string_format",format:"starts_with",...j(t),prefix:e})}function sb(e,t){return new bw({check:"string_format",format:"ends_with",...j(t),suffix:e})}function Cs(e){return new vw({check:"overwrite",tx:e})}function ib(e){return Cs(t=>t.normalize(e))}function ob(){return Cs(e=>e.trim())}function ab(){return Cs(e=>e.toLowerCase())}function cb(){return Cs(e=>e.toUpperCase())}function ub(e,t,r){return new e({type:"array",element:t,...j(r)})}function db(e,t,r){return new e({type:"custom",check:"custom",fn:t,...j(r)})}function lb(e){const t=hb(r=>(r.addIssue=n=>{if(typeof n=="string")r.issues.push(Es(n,r.value,t._zod.def));else{const s=n;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=r.value),s.inst??(s.inst=t),s.continue??(s.continue=!t._zod.def.abort),r.issues.push(Es(s))}},e(r.value,r)));return t}function hb(e,t){const r=new Xe({check:"custom",...j(t)});return r._zod.check=e,r}const fb=_("ZodISODateTime",(e,t)=>{Uw.init(e,t),ke.init(e,t)});function pb(e){return Mg(fb,e)}const mb=_("ZodISODate",(e,t)=>{Lw.init(e,t),ke.init(e,t)});function yb(e){return jg(mb,e)}const wb=_("ZodISOTime",(e,t)=>{$w.init(e,t),ke.init(e,t)});function gb(e){return Vg(wb,e)}const bb=_("ZodISODuration",(e,t)=>{Dw.init(e,t),ke.init(e,t)});function vb(e){return Fg(bb,e)}const Nb=(e,t)=>{kd.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:r=>Ty(e,r)},flatten:{value:r=>ky(e,r)},addIssue:{value:r=>{e.issues.push(r),e.message=JSON.stringify(e.issues,Do,2)}},addIssues:{value:r=>{e.issues.push(...r),e.message=JSON.stringify(e.issues,Do,2)}},isEmpty:{get(){return e.issues.length===0}}})},lt=_("ZodError",Nb,{Parent:Error}),Eb=ya(lt),Ab=wa(lt),kb=Gi(lt),Tb=Qi(lt),_b=Ry(lt),Sb=Oy(lt),Rb=Iy(lt),Ob=xy(lt),Ib=Cy(lt),xb=Py(lt),Cb=Uy(lt),Pb=Ly(lt),Ae=_("ZodType",(e,t)=>(ve.init(e,t),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...r)=>e.clone(Br(t,{checks:[...t.checks??[],...r.map(n=>typeof n=="function"?{_zod:{check:n,def:{check:"custom"},onattach:[]}}:n)]})),e.clone=(r,n)=>vr(e,r,n),e.brand=()=>e,e.register=((r,n)=>(r.add(e,n),e)),e.parse=(r,n)=>Eb(e,r,n,{callee:e.parse}),e.safeParse=(r,n)=>kb(e,r,n),e.parseAsync=async(r,n)=>Ab(e,r,n,{callee:e.parseAsync}),e.safeParseAsync=async(r,n)=>Tb(e,r,n),e.spa=e.safeParseAsync,e.encode=(r,n)=>_b(e,r,n),e.decode=(r,n)=>Sb(e,r,n),e.encodeAsync=async(r,n)=>Rb(e,r,n),e.decodeAsync=async(r,n)=>Ob(e,r,n),e.safeEncode=(r,n)=>Ib(e,r,n),e.safeDecode=(r,n)=>xb(e,r,n),e.safeEncodeAsync=async(r,n)=>Cb(e,r,n),e.safeDecodeAsync=async(r,n)=>Pb(e,r,n),e.refine=(r,n)=>e.check(Av(r,n)),e.superRefine=r=>e.check(kv(r)),e.overwrite=r=>e.check(Cs(r)),e.optional=()=>Ai(e),e.nullable=()=>Lc(e),e.nullish=()=>Ai(Lc(e)),e.nonoptional=r=>yv(e,r),e.array=()=>Ei(e),e.or=r=>iv([e,r]),e.and=r=>av(e,r),e.transform=r=>$c(e,dv(r)),e.default=r=>fv(e,r),e.prefault=r=>mv(e,r),e.catch=r=>gv(e,r),e.pipe=r=>$c(e,r),e.readonly=()=>Nv(e),e.describe=r=>{const n=e.clone();return Fs.add(n,{description:r}),n},Object.defineProperty(e,"description",{get(){return Fs.get(e)?.description},configurable:!0}),e.meta=(...r)=>{if(r.length===0)return Fs.get(e);const n=e.clone();return Fs.add(n,r[0]),n},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),Wd=_("_ZodString",(e,t)=>{ga.init(e,t),Ae.init(e,t);const r=e._zod.bag;e.format=r.format??null,e.minLength=r.minimum??null,e.maxLength=r.maximum??null,e.regex=(...n)=>e.check(Xg(...n)),e.includes=(...n)=>e.check(rb(...n)),e.startsWith=(...n)=>e.check(nb(...n)),e.endsWith=(...n)=>e.check(sb(...n)),e.min=(...n)=>e.check(Ni(...n)),e.max=(...n)=>e.check(Dd(...n)),e.length=(...n)=>e.check(qd(...n)),e.nonempty=(...n)=>e.check(Ni(1,...n)),e.lowercase=n=>e.check(eb(n)),e.uppercase=n=>e.check(tb(n)),e.trim=()=>e.check(ob()),e.normalize=(...n)=>e.check(ib(...n)),e.toLowerCase=()=>e.check(ab()),e.toUpperCase=()=>e.check(cb())}),zd=_("ZodString",(e,t)=>{ga.init(e,t),Wd.init(e,t),e.email=r=>e.check($d(Md,r)),e.url=r=>e.check(Tg(Ub,r)),e.jwt=r=>e.check(zg(Jb,r)),e.emoji=r=>e.check(_g(Lb,r)),e.guid=r=>e.check(Rc(Cc,r)),e.uuid=r=>e.check(Ng(Bs,r)),e.uuidv4=r=>e.check(Eg(Bs,r)),e.uuidv6=r=>e.check(Ag(Bs,r)),e.uuidv7=r=>e.check(kg(Bs,r)),e.nanoid=r=>e.check(Sg($b,r)),e.guid=r=>e.check(Rc(Cc,r)),e.cuid=r=>e.check(Rg(Db,r)),e.cuid2=r=>e.check(Og(qb,r)),e.ulid=r=>e.check(Ig(Wb,r)),e.base64=r=>e.check(Dg(Hb,r)),e.base64url=r=>e.check(qg(Kb,r)),e.xid=r=>e.check(xg(zb,r)),e.ksuid=r=>e.check(Cg(Mb,r)),e.ipv4=r=>e.check(Pg(jb,r)),e.ipv6=r=>e.check(Ug(Vb,r)),e.cidrv4=r=>e.check(Lg(Fb,r)),e.cidrv6=r=>e.check($g(Bb,r)),e.e164=r=>e.check(Wg(Zb,r)),e.datetime=r=>e.check(pb(r)),e.date=r=>e.check(yb(r)),e.time=r=>e.check(gb(r)),e.duration=r=>e.check(vb(r))});function C(e){return bg(zd,e)}const ke=_("ZodStringFormat",(e,t)=>{Ne.init(e,t),Wd.init(e,t)}),Md=_("ZodEmail",(e,t)=>{Tw.init(e,t),ke.init(e,t)});function jd(e){return $d(Md,e)}const Cc=_("ZodGUID",(e,t)=>{Aw.init(e,t),ke.init(e,t)}),Bs=_("ZodUUID",(e,t)=>{kw.init(e,t),ke.init(e,t)}),Ub=_("ZodURL",(e,t)=>{_w.init(e,t),ke.init(e,t)}),Lb=_("ZodEmoji",(e,t)=>{Sw.init(e,t),ke.init(e,t)}),$b=_("ZodNanoID",(e,t)=>{Rw.init(e,t),ke.init(e,t)}),Db=_("ZodCUID",(e,t)=>{Ow.init(e,t),ke.init(e,t)}),qb=_("ZodCUID2",(e,t)=>{Iw.init(e,t),ke.init(e,t)}),Wb=_("ZodULID",(e,t)=>{xw.init(e,t),ke.init(e,t)}),zb=_("ZodXID",(e,t)=>{Cw.init(e,t),ke.init(e,t)}),Mb=_("ZodKSUID",(e,t)=>{Pw.init(e,t),ke.init(e,t)}),jb=_("ZodIPv4",(e,t)=>{qw.init(e,t),ke.init(e,t)}),Vb=_("ZodIPv6",(e,t)=>{Ww.init(e,t),ke.init(e,t)}),Fb=_("ZodCIDRv4",(e,t)=>{zw.init(e,t),ke.init(e,t)}),Bb=_("ZodCIDRv6",(e,t)=>{Mw.init(e,t),ke.init(e,t)}),Hb=_("ZodBase64",(e,t)=>{jw.init(e,t),ke.init(e,t)}),Kb=_("ZodBase64URL",(e,t)=>{Fw.init(e,t),ke.init(e,t)}),Zb=_("ZodE164",(e,t)=>{Bw.init(e,t),ke.init(e,t)}),Jb=_("ZodJWT",(e,t)=>{Kw.init(e,t),ke.init(e,t)}),Vd=_("ZodNumber",(e,t)=>{Pd.init(e,t),Ae.init(e,t),e.gt=(n,s)=>e.check(Ic(n,s)),e.gte=(n,s)=>e.check(ri(n,s)),e.min=(n,s)=>e.check(ri(n,s)),e.lt=(n,s)=>e.check(Oc(n,s)),e.lte=(n,s)=>e.check(ti(n,s)),e.max=(n,s)=>e.check(ti(n,s)),e.int=n=>e.check(Pc(n)),e.safe=n=>e.check(Pc(n)),e.positive=n=>e.check(Ic(0,n)),e.nonnegative=n=>e.check(ri(0,n)),e.negative=n=>e.check(Oc(0,n)),e.nonpositive=n=>e.check(ti(0,n)),e.multipleOf=(n,s)=>e.check(xc(n,s)),e.step=(n,s)=>e.check(xc(n,s)),e.finite=()=>e;const r=e._zod.bag;e.minValue=Math.max(r.minimum??Number.NEGATIVE_INFINITY,r.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(r.maximum??Number.POSITIVE_INFINITY,r.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(r.format??"").includes("int")||Number.isSafeInteger(r.multipleOf??.5),e.isFinite=!0,e.format=r.format??null});function Fd(e){return Bg(Vd,e)}const Gb=_("ZodNumberFormat",(e,t)=>{Zw.init(e,t),Vd.init(e,t)});function Pc(e){return Hg(Gb,e)}const Bd=_("ZodBoolean",(e,t)=>{Jw.init(e,t),Ae.init(e,t)});function mr(e){return Kg(Bd,e)}const Qb=_("ZodAny",(e,t)=>{Gw.init(e,t),Ae.init(e,t)});function Hd(){return Jg(Qb)}const Yb=_("ZodUnknown",(e,t)=>{Qw.init(e,t),Ae.init(e,t)});function Uc(){return Gg(Yb)}const Xb=_("ZodNever",(e,t)=>{Yw.init(e,t),Ae.init(e,t)});function ev(e){return Qg(Xb,e)}const tv=_("ZodDate",(e,t)=>{Xw.init(e,t),Ae.init(e,t),e.min=(n,s)=>e.check(ri(n,s)),e.max=(n,s)=>e.check(ti(n,s));const r=e._zod.bag;e.minDate=r.minimum?new Date(r.minimum):null,e.maxDate=r.maximum?new Date(r.maximum):null});function Rn(e){return Yg(tv,e)}const rv=_("ZodArray",(e,t)=>{eg.init(e,t),Ae.init(e,t),e.element=t.element,e.min=(r,n)=>e.check(Ni(r,n)),e.nonempty=r=>e.check(Ni(1,r)),e.max=(r,n)=>e.check(Dd(r,n)),e.length=(r,n)=>e.check(qd(r,n)),e.unwrap=()=>e.element});function Ei(e,t){return ub(rv,e,t)}const nv=_("ZodObject",(e,t)=>{rg.init(e,t),Ae.init(e,t),de(e,"shape",()=>t.shape),e.keyof=()=>Zd(Object.keys(e._zod.def.shape)),e.catchall=r=>e.clone({...e._zod.def,catchall:r}),e.passthrough=()=>e.clone({...e._zod.def,catchall:Uc()}),e.loose=()=>e.clone({...e._zod.def,catchall:Uc()}),e.strict=()=>e.clone({...e._zod.def,catchall:ev()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=r=>by(e,r),e.safeExtend=r=>vy(e,r),e.merge=r=>Ny(e,r),e.pick=r=>wy(e,r),e.omit=r=>gy(e,r),e.partial=(...r)=>Ey(Jd,e,r[0]),e.required=(...r)=>Ay(Gd,e,r[0])});function oe(e,t){const r={type:"object",shape:e??{},...j(t)};return new nv(r)}const sv=_("ZodUnion",(e,t)=>{ng.init(e,t),Ae.init(e,t),e.options=t.options});function iv(e,t){return new sv({type:"union",options:e,...j(t)})}const ov=_("ZodIntersection",(e,t)=>{sg.init(e,t),Ae.init(e,t)});function av(e,t){return new ov({type:"intersection",left:e,right:t})}const cv=_("ZodRecord",(e,t)=>{ig.init(e,t),Ae.init(e,t),e.keyType=t.keyType,e.valueType=t.valueType});function Kd(e,t,r){return new cv({type:"record",keyType:e,valueType:t,...j(r)})}const Wo=_("ZodEnum",(e,t)=>{og.init(e,t),Ae.init(e,t),e.enum=t.entries,e.options=Object.values(t.entries);const r=new Set(Object.keys(t.entries));e.extract=(n,s)=>{const i={};for(const o of n)if(r.has(o))i[o]=t.entries[o];else throw new Error(`Key ${o} not found in enum`);return new Wo({...t,checks:[],...j(s),entries:i})},e.exclude=(n,s)=>{const i={...t.entries};for(const o of n)if(r.has(o))delete i[o];else throw new Error(`Key ${o} not found in enum`);return new Wo({...t,checks:[],...j(s),entries:i})}});function Zd(e,t){const r=Array.isArray(e)?Object.fromEntries(e.map(n=>[n,n])):e;return new Wo({type:"enum",entries:r,...j(t)})}const uv=_("ZodTransform",(e,t)=>{ag.init(e,t),Ae.init(e,t),e._zod.parse=(r,n)=>{if(n.direction==="backward")throw new bd(e.constructor.name);r.addIssue=i=>{if(typeof i=="string")r.issues.push(Es(i,r.value,t));else{const o=i;o.fatal&&(o.continue=!1),o.code??(o.code="custom"),o.input??(o.input=r.value),o.inst??(o.inst=e),r.issues.push(Es(o))}};const s=t.transform(r.value,r);return s instanceof Promise?s.then(i=>(r.value=i,r)):(r.value=s,r)}});function dv(e){return new uv({type:"transform",transform:e})}const Jd=_("ZodOptional",(e,t)=>{cg.init(e,t),Ae.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Ai(e){return new Jd({type:"optional",innerType:e})}const lv=_("ZodNullable",(e,t)=>{ug.init(e,t),Ae.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Lc(e){return new lv({type:"nullable",innerType:e})}const hv=_("ZodDefault",(e,t)=>{dg.init(e,t),Ae.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function fv(e,t){return new hv({type:"default",innerType:e,get defaultValue(){return typeof t=="function"?t():Ed(t)}})}const pv=_("ZodPrefault",(e,t)=>{lg.init(e,t),Ae.init(e,t),e.unwrap=()=>e._zod.def.innerType});function mv(e,t){return new pv({type:"prefault",innerType:e,get defaultValue(){return typeof t=="function"?t():Ed(t)}})}const Gd=_("ZodNonOptional",(e,t)=>{hg.init(e,t),Ae.init(e,t),e.unwrap=()=>e._zod.def.innerType});function yv(e,t){return new Gd({type:"nonoptional",innerType:e,...j(t)})}const wv=_("ZodCatch",(e,t)=>{fg.init(e,t),Ae.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function gv(e,t){return new wv({type:"catch",innerType:e,catchValue:typeof t=="function"?t:()=>t})}const bv=_("ZodPipe",(e,t)=>{pg.init(e,t),Ae.init(e,t),e.in=t.in,e.out=t.out});function $c(e,t){return new bv({type:"pipe",in:e,out:t})}const vv=_("ZodReadonly",(e,t)=>{mg.init(e,t),Ae.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Nv(e){return new vv({type:"readonly",innerType:e})}const Ev=_("ZodCustom",(e,t)=>{yg.init(e,t),Ae.init(e,t)});function Av(e,t={}){return db(Ev,e,t)}function kv(e){return lb(e)}function ba(e){return vg(zd,e)}function Dc(e){return Zg(Bd,e)}const yr=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));class X extends Error{constructor(t,r){super(t),this.name="BetterAuthError",this.message=t,this.cause=r,this.stack=""}}var Tv={},zo={};const ni=Object.create(null),Zn=e=>Tv||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?ni:globalThis),ie=new Proxy(ni,{get(e,t){return Zn()[t]??ni[t]},has(e,t){const r=Zn();return t in r||t in ni},set(e,t,r){const n=Zn(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;const r=Zn(!0);return delete r[t],!0},ownKeys(){const e=Zn(!0);return Object.keys(e)}});function _v(e){return e?e!=="false":!1}const ki=typeof process<"u"&&zo&&"production"||"",Mo=ki==="production",va=ki==="dev"||ki==="development",Na=()=>ki==="test"||_v(ie.TEST);function Ee(e,t){return typeof process<"u"&&zo?zo[e]??t:typeof Deno<"u"?Deno.env.get(e)??t:typeof Bun<"u"?Bun.env[e]??t:t}function qc(e,t=!0){const r=Ee(e);return r?r!=="0"&&r.toLowerCase()!=="false"&&r!=="":t}const Sv={get BETTER_AUTH_TELEMETRY_ENDPOINT(){return Ee("BETTER_AUTH_TELEMETRY_ENDPOINT","https://telemetry.better-auth.com/v1/track")}};function Ti(e){return e?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"}function Qd(e,t,r){let n="",s=0,i=0;for(const o of e)for(s=s<<8|o,i+=8;i>=6;)i-=6,n+=t[s>>i&63];if(i>0&&(n+=t[s<<6-i&63]),r){const o=(4-n.length%4)%4;n+="=".repeat(o)}return n}function Yd(e,t){const r=new Map;for(let o=0;o<t.length;o++)r.set(t[o],o);const n=[];let s=0,i=0;for(const o of e){if(o==="=")break;const a=r.get(o);if(a===void 0)throw new Error(`Invalid Base64 character: ${o}`);s=s<<6|a,i+=6,i>=8&&(i-=8,n.push(s>>i&255))}return Uint8Array.from(n)}const Ft={encode(e,t={}){const r=Ti(!1),n=typeof e=="string"?new TextEncoder().encode(e):new Uint8Array(e);return Qd(n,r,t.padding??!0)},decode(e){typeof e!="string"&&(e=new TextDecoder().decode(e));const t=e.includes("-")||e.includes("_"),r=Ti(t);return Yd(e,r)}},Xi={encode(e,t={}){const r=Ti(!0),n=typeof e=="string"?new TextEncoder().encode(e):new Uint8Array(e);return Qd(n,r,t.padding??!0)},decode(e){const t=e.includes("-")||e.includes("_"),r=Ti(t);return Yd(e,r)}},Rv="0123456789abcdef",_i={encode:e=>{if(typeof e=="string"&&(e=new TextEncoder().encode(e)),e.byteLength===0)return"";const t=new Uint8Array(e);let r="";for(const n of t)r+=n.toString(16).padStart(2,"0");return r},decode:e=>{if(!e)return"";if(typeof e=="string"){if(e.length%2!==0)throw new Error("Invalid hexadecimal string");if(!new RegExp(`^[${Rv}]+$`).test(e))throw new Error("Invalid hexadecimal string");const t=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)t[r/2]=parseInt(e.slice(r,r+2),16);return new TextDecoder().decode(t)}return new TextDecoder().decode(e)}},Xd=(e="SHA-256",t="none")=>{const r={importKey:async(n,s)=>Ur().importKey("raw",typeof n=="string"?new TextEncoder().encode(n):n,{name:"HMAC",hash:{name:e}},!1,[s]),sign:async(n,s)=>{typeof n=="string"&&(n=await r.importKey(n,"sign"));const i=await Ur().sign("HMAC",n,typeof s=="string"?new TextEncoder().encode(s):s);return t==="hex"?_i.encode(i):t==="base64"||t==="base64url"||t==="base64urlnopad"?Xi.encode(i,{padding:t!=="base64urlnopad"}):i},verify:async(n,s,i)=>(typeof n=="string"&&(n=await r.importKey(n,"verify")),t==="hex"&&(i=_i.decode(i)),(t==="base64"||t==="base64url"||t==="base64urlnopad")&&(i=await Ft.decode(i)),Ur().verify("HMAC",n,typeof i=="string"?new TextEncoder().encode(i):i,typeof s=="string"?new TextEncoder().encode(s):s))};return r},Jn=1,Le=4,At=8,Je=24,Wc={eterm:Le,cons25:Le,console:Le,cygwin:Le,dtterm:Le,gnome:Le,hurd:Le,jfbterm:Le,konsole:Le,kterm:Le,mlterm:Le,mosh:Je,putty:Le,st:Le,"rxvt-unicode-24bit":Je,terminator:Je,"xterm-kitty":Je},Ov=new Map(Object.entries({APPVEYOR:At,BUILDKITE:At,CIRCLECI:Je,DRONE:At,GITEA_ACTIONS:Je,GITHUB_ACTIONS:Je,GITLAB_CI:At,TRAVIS:At})),Iv=[/ansi/,/color/,/linux/,/direct/,/^con[0-9]*x[0-9]/,/^rxvt/,/^screen/,/^xterm/,/^vt100/,/^vt220/];function xv(){if(Ee("FORCE_COLOR")!==void 0)switch(Ee("FORCE_COLOR")){case"":case"1":case"true":return Le;case"2":return At;case"3":return Je;default:return Jn}if(Ee("NODE_DISABLE_COLORS")!==void 0&&Ee("NODE_DISABLE_COLORS")!==""||Ee("NO_COLOR")!==void 0&&Ee("NO_COLOR")!==""||Ee("TERM")==="dumb")return Jn;if(typeof process<"u"&&process.platform==="win32"||Ee("TMUX"))return Je;if("TF_BUILD"in ie&&"AGENT_NAME"in ie)return Le;if("CI"in ie){for(const{0:e,1:t}of Ov)if(e in ie)return t;return Ee("CI_NAME")==="codeship"?At:Jn}if("TEAMCITY_VERSION"in ie)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.exec(Ee("TEAMCITY_VERSION"))!==null?Le:Jn;switch(Ee("TERM_PROGRAM")){case"iTerm.app":return!Ee("TERM_PROGRAM_VERSION")||/^[0-2]\./.exec(Ee("TERM_PROGRAM_VERSION"))!==null?At:Je;case"HyperTerm":case"MacTerm":return Je;case"Apple_Terminal":return At}if(Ee("COLORTERM")==="truecolor"||Ee("COLORTERM")==="24bit")return Je;if(Ee("TERM")){if(/truecolor/.exec(Ee("TERM"))!==null)return Je;if(/^xterm-256/.exec(Ee("TERM"))!==null)return At;const e=Ee("TERM").toLowerCase();if(Wc[e])return Wc[e];if(Iv.some(t=>t.exec(e)!==null))return Le}return Ee("COLORTERM")?Le:Jn}const jo=["info","success","warn","error","debug"];function eo(e,t){return jo.indexOf(t)<=jo.indexOf(e)}const kt={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",fg:{red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m"}},Cv={info:kt.fg.blue,success:kt.fg.green,warn:kt.fg.yellow,error:kt.fg.red,debug:kt.fg.magenta},Pv=(e,t,r)=>{const n=new Date().toISOString();return r?`${kt.dim}${n}${kt.reset} ${Cv[e]}${e.toUpperCase()}${kt.reset} ${kt.bright}[Better Auth]:${kt.reset} ${t}`:`${n} ${e.toUpperCase()} [Better Auth]: ${t}`},Ea=e=>{const t=e?.disabled!==!0,r=e?.level??"error",s=e?.disableColors!==void 0?!e.disableColors:xv()!==1,i=(a,c,u=[])=>{if(!t||!eo(r,a))return;const d=Pv(a,c,s);if(!e||typeof e.log!="function"){a==="error"?console.error(d,...u):a==="warn"?console.warn(d,...u):console.log(d,...u);return}e.log(a==="success"?"info":a,c,...u)};return{...Object.fromEntries(jo.map(a=>[a,(...[c,...u])=>i(a,c,u)])),get level(){return r}}},K=Ea();function He(e){function t(r,n){if(typeof n=="string"&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(n)){const i=new Date(n);if(!isNaN(i.getTime()))return i}return n}try{return typeof e!="string"?e:JSON.parse(e,t)}catch(r){return K.error("Error parsing JSON",{error:r}),null}}function Uv(e){try{return new URL(e).pathname!=="/"}catch{throw new X(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function Gn(e,t="/api/auth"){return Uv(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e.replace(/\/+$/,"")}${t}`)}function Aa(e,t,r){if(e)return Gn(e,t);const n=ie.BETTER_AUTH_URL||ie.NEXT_PUBLIC_BETTER_AUTH_URL||ie.PUBLIC_BETTER_AUTH_URL||ie.NUXT_PUBLIC_BETTER_AUTH_URL||ie.NUXT_PUBLIC_AUTH_URL||(ie.BASE_URL!=="/"?ie.BASE_URL:void 0);if(n)return Gn(n,t);const s=r?.headers.get("x-forwarded-host"),i=r?.headers.get("x-forwarded-proto");if(s&&i)return Gn(`${i}://${s}`,t);if(r){const o=On(r.url);if(!o)throw new X("Could not get origin from request. Please provide a valid base URL.");return Gn(o,t)}if(typeof window<"u"&&window.location)return Gn(window.location.origin,t)}function On(e){try{return new URL(e).origin}catch{return null}}function el(e){try{return new URL(e).protocol}catch{return null}}function tl(e){try{return new URL(e).host}catch{return e}}const po=new Map,Lv=new TextEncoder,$v={decode:(e,t="utf-8")=>(po.has(t)||po.set(t,new TextDecoder(t)),po.get(t).decode(e)),encode:Lv.encode},rl=1e3,nl=rl*60,sl=nl*60,ka=sl*24,Dv=ka*7,il=ka*365.25,qv=il/12;function Wv(e,t){return zv(e)}function zv(e){if(e.length===0||e.length>100)throw new Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(e)}`);const t=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(e);if(!t?.groups)return NaN;const{value:r,unit:n="ms"}=t.groups,s=parseFloat(r),i=n.toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return s*il;case"months":case"month":case"mo":return s*qv;case"weeks":case"week":case"w":return s*Dv;case"days":case"day":case"d":return s*ka;case"hours":case"hour":case"hrs":case"hr":case"h":return s*sl;case"minutes":case"minute":case"mins":case"min":case"m":return s*nl;case"seconds":case"second":case"secs":case"sec":case"s":return s*rl;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:throw new Error(`Unknown unit "${i}" provided to ms.parse(). value=${JSON.stringify(e)}`)}}function ol(e){const r=(e.advanced?.useSecureCookies!==void 0?e.advanced?.useSecureCookies:e.baseURL!==void 0?!!e.baseURL.startsWith("https://"):Mo)?"__Secure-":"",n=!!e.advanced?.crossSubDomainCookies?.enabled,s=n?e.advanced?.crossSubDomainCookies?.domain||(e.baseURL?new URL(e.baseURL).hostname:void 0):void 0;if(n&&!s)throw new X("baseURL is required when crossSubdomainCookies are enabled");function i(o,a={}){const c=e.advanced?.cookiePrefix||"better-auth",u=e.advanced?.cookies?.[o]?.name||`${c}.${o}`,d=e.advanced?.cookies?.[o]?.attributes;return{name:`${r}${u}`,attributes:{secure:!!r,sameSite:"lax",path:"/",httpOnly:!0,...n?{domain:s}:{},...e.advanced?.defaultCookieAttributes,...a,...d}}}return i}function Mv(e){const t=ol(e),r=e.session?.expiresIn||Wv("7d")/1e3,n=t("session_token",{maxAge:r}),s=t("session_data",{maxAge:e.session?.cookieCache?.maxAge||300}),i=t("dont_remember");return{sessionToken:{name:n.name,options:n.attributes},sessionData:{name:s.name,options:s.attributes},dontRememberToken:{name:i.name,options:i.attributes}}}async function al(e,t,r){if(e.context.options.session?.cookieCache?.enabled){const i={session:Object.entries(t.session).reduce((u,[d,l])=>{const h=e.context.options.session?.additionalFields?.[d];return(!h||h.returned!==!1)&&(u[d]=l),u},{}),user:t.user},o={...e.context.authCookies.sessionData.options,maxAge:r?void 0:e.context.authCookies.sessionData.options.maxAge},a=yr(o.maxAge||60,"sec").getTime(),c=Xi.encode(JSON.stringify({session:i,expiresAt:a,signature:await Xd("SHA-256","base64urlnopad").sign(e.context.secret,JSON.stringify({...i,expiresAt:a}))}),{padding:!1});if(c.length>4093)throw new X("Session data is too large to store in the cookie. Please disable session cookie caching or reduce the size of the session data");e.setCookie(e.context.authCookies.sessionData.name,c,o)}}async function yt(e,t,r,n){const s=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);r=r!==void 0?r:!!s;const i=e.context.authCookies.sessionToken.options,o=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,t.session.token,e.context.secret,{...i,maxAge:o,...n}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),await al(e,t,r),e.context.setNewSession(t),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(t.session.token,JSON.stringify({user:t.user,session:t.session}),Math.floor((new Date(t.session.expiresAt).getTime()-Date.now())/1e3))}function In(e,t){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0}),e.setCookie(e.context.authCookies.sessionData.name,"",{...e.context.authCookies.sessionData.options,maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}const cl=bn(async()=>({})),Wn=bn.create({use:[cl,bn(async()=>({}))]}),ee=mi.create({use:[cl]}),V={USER_NOT_FOUND:"User not found",FAILED_TO_CREATE_USER:"Failed to create user",FAILED_TO_CREATE_SESSION:"Failed to create session",FAILED_TO_UPDATE_USER:"Failed to update user",FAILED_TO_GET_SESSION:"Failed to get session",INVALID_PASSWORD:"Invalid password",INVALID_EMAIL:"Invalid email",INVALID_EMAIL_OR_PASSWORD:"Invalid email or password",SOCIAL_ACCOUNT_ALREADY_LINKED:"Social account already linked",PROVIDER_NOT_FOUND:"Provider not found",INVALID_TOKEN:"Invalid token",ID_TOKEN_NOT_SUPPORTED:"id_token not supported",FAILED_TO_GET_USER_INFO:"Failed to get user info",USER_EMAIL_NOT_FOUND:"User email not found",EMAIL_NOT_VERIFIED:"Email not verified",PASSWORD_TOO_SHORT:"Password too short",PASSWORD_TOO_LONG:"Password too long",USER_ALREADY_EXISTS:"User already exists. Use another email.",EMAIL_CAN_NOT_BE_UPDATED:"Email can not be updated",CREDENTIAL_ACCOUNT_NOT_FOUND:"Credential account not found",SESSION_EXPIRED:"Session expired. Re-authenticate to perform this action.",FAILED_TO_UNLINK_LAST_ACCOUNT:"You can't unlink your last account",ACCOUNT_NOT_FOUND:"Account not found",USER_ALREADY_HAS_PASSWORD:"User already has a password. Provide that to delete the account."},jv=Ai(oe({disableCookieCache:Dc().describe("Disable cookie cache and fetch session from database").optional(),disableRefresh:Dc().describe("Disable session refresh. Useful for checking session status, without updating the session").optional()})),ul=()=>ee("/get-session",{method:"GET",query:jv,requireHeaders:!0,metadata:{openapi:{description:"Get the current session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}},required:["session","user"]}}}}}}}},async e=>{try{const t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)return null;const r=e.getCookie(e.context.authCookies.sessionData.name),n=r?He($v.decode(Xi.decode(r))):null;if(n&&!await Xd("SHA-256","base64urlnopad").verify(e.context.secret,JSON.stringify({...n.session,expiresAt:n.expiresAt}),n.signature)){const l=e.context.authCookies.sessionData.name;return e.setCookie(l,"",{maxAge:0}),e.json(null)}const s=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(n?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){const d=n.session;if(n.expiresAt<Date.now()||d.session.expiresAt<new Date){const h=e.context.authCookies.sessionData.name;e.setCookie(h,"",{maxAge:0})}else return e.context.session=d,e.json(d)}const i=await e.context.internalAdapter.findSession(t);if(e.context.session=i,!i||i.session.expiresAt<new Date)return In(e),i&&await e.context.internalAdapter.deleteSession(i.session.token),e.json(null);if(s||e.query?.disableRefresh)return e.json(i);const o=e.context.sessionConfig.expiresIn,a=e.context.sessionConfig.updateAge;if(i.session.expiresAt.valueOf()-o*1e3+a*1e3<=Date.now()&&(!e.query?.disableRefresh||!e.context.options.session?.disableSessionRefresh)){const d=await e.context.internalAdapter.updateSession(i.session.token,{expiresAt:yr(e.context.sessionConfig.expiresIn,"sec"),updatedAt:new Date});if(!d)return In(e),e.json(null,{status:401});const l=(d.expiresAt.valueOf()-Date.now())/1e3;return await yt(e,{session:d,user:i.user},!1,{maxAge:l}),e.json({session:d,user:i.user})}return await al(e,i,!!s),e.json(i)}catch(t){throw e.context.logger.error("INTERNAL_SERVER_ERROR",t),new T("INTERNAL_SERVER_ERROR",{message:V.FAILED_TO_GET_SESSION})}}),Rt=async(e,t)=>{if(e.context.session)return e.context.session;const r=await ul()({...e,asResponse:!1,headers:e.headers,returnHeaders:!1,query:{...t,...e.query}}).catch(n=>null);return e.context.session=r,r},Ps=Wn(async e=>{const t=await Rt(e);if(!t?.session)throw new T("UNAUTHORIZED");return{session:t}}),Hr=Wn(async e=>{const t=await Rt(e,{disableCookieCache:!0});if(!t?.session)throw new T("UNAUTHORIZED");return{session:t}});Wn(async e=>{const t=await Rt(e);if(!t?.session&&(e.request||e.headers))throw new T("UNAUTHORIZED");return{session:t}});const Vv=Wn(async e=>{const t=await Rt(e);if(!t?.session)throw new T("UNAUTHORIZED");if(e.context.sessionConfig.freshAge===0)return{session:t};const r=e.context.sessionConfig.freshAge,n=t.session.updatedAt?.valueOf()||t.session.createdAt.valueOf();if(!(Date.now()-n<r*1e3))throw new T("FORBIDDEN",{message:"Session is not fresh"});return{session:t}}),Fv=()=>ee("/list-sessions",{method:"GET",use:[Ps],requireHeaders:!0,metadata:{openapi:{description:"List all active sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}}}}}},async e=>{try{const r=(await e.context.internalAdapter.listSessions(e.context.session.user.id)).filter(n=>n.expiresAt>new Date);return e.json(r)}catch(t){throw e.context.logger.error(t),e.error("INTERNAL_SERVER_ERROR")}}),Bv=ee("/revoke-session",{method:"POST",body:oe({token:C().describe("The token to revoke")}),use:[Hr],requireHeaders:!0,metadata:{openapi:{description:"Revoke a single session",requestBody:{content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",description:"The token to revoke"}},required:["token"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the session was revoked successfully"}},required:["status"]}}}}}}}},async e=>{const t=e.body.token,r=await e.context.internalAdapter.findSession(t);if(!r)throw new T("BAD_REQUEST",{message:"Session not found"});if(r.session.userId!==e.context.session.user.id)throw new T("UNAUTHORIZED");try{await e.context.internalAdapter.deleteSession(t)}catch(n){throw e.context.logger.error(n&&typeof n=="object"&&"name"in n?n.name:"",n),new T("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),Hv=ee("/revoke-sessions",{method:"POST",use:[Hr],requireHeaders:!0,metadata:{openapi:{description:"Revoke all sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(t){throw e.context.logger.error(t&&typeof t=="object"&&"name"in t?t.name:"",t),new T("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),Kv=ee("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[Hr],metadata:{openapi:{description:"Revoke all other sessions for the user except the current one",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all other sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{const t=e.context.session;if(!t.user)throw new T("UNAUTHORIZED");const s=(await e.context.internalAdapter.listSessions(t.user.id)).filter(i=>i.expiresAt>new Date).filter(i=>i.token!==e.context.session.session.token);return await Promise.all(s.map(i=>e.context.internalAdapter.deleteSession(i.token))),e.json({status:!0})});function to(e,t){return{digest:async r=>{const n=new TextEncoder,s=typeof r=="string"?n.encode(r):r;return await Ur().digest(e,s)}}}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */function Zv(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function Vo(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}function si(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function Pe(e,t,r=""){const n=Zv(e),s=e?.length,i=t!==void 0;if(!n||i&&s!==t){const o=r&&`"${r}" `,a=i?` of length ${t}`:"",c=n?`length=${s}`:`type=${typeof e}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return e}function zc(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Jv(e,t){Pe(e,void 0,"output");const r=t.outputLen;if(e.length<r)throw new Error("digestInto() expects output buffer of length at least "+r)}function lr(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function xn(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function Gv(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}const Qv=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68,dl=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Yv=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function Xv(e){if(Pe(e),dl)return e.toHex();let t="";for(let r=0;r<e.length;r++)t+=Yv[e[r]];return t}const xt={_0:48,_9:57,A:65,F:70,a:97,f:102};function Mc(e){if(e>=xt._0&&e<=xt._9)return e-xt._0;if(e>=xt.A&&e<=xt.F)return e-(xt.A-10);if(e>=xt.a&&e<=xt.f)return e-(xt.a-10)}function eN(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);if(dl)return Uint8Array.fromHex(e);const t=e.length,r=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(r);for(let s=0,i=0;s<r;s++,i+=2){const o=Mc(e.charCodeAt(i)),a=Mc(e.charCodeAt(i+1));if(o===void 0||a===void 0){const c=e[i]+e[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}function tN(e){if(typeof e!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(e))}function rN(...e){let t=0;for(let n=0;n<e.length;n++){const s=e[n];Pe(s),t+=s.length}const r=new Uint8Array(t);for(let n=0,s=0;n<e.length;n++){const i=e[n];r.set(i,s),s+=i.length}return r}function nN(e,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(e,t)}function sN(e,t){if(e.length!==t.length)return!1;let r=0;for(let n=0;n<e.length;n++)r|=e[n]^t[n];return r===0}const iN=(e,t)=>{function r(n,...s){if(Pe(n,void 0,"key"),!Qv)throw new Error("Non little-endian hardware is not yet supported");if(e.nonceLength!==void 0){const d=s[0];Pe(d,e.varSizeNonce?void 0:e.nonceLength,"nonce")}const i=e.tagLength;i&&s[1]!==void 0&&Pe(s[1],void 0,"AAD");const o=t(n,...s),a=(d,l)=>{if(l!==void 0){if(d!==2)throw new Error("cipher output not supported");Pe(l,void 0,"output")}};let c=!1;return{encrypt(d,l){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Pe(d),a(o.encrypt.length,l),o.encrypt(d,l)},decrypt(d,l){if(Pe(d),i&&d.length<i)throw new Error('"ciphertext" expected length bigger than tagLength='+i);return a(o.decrypt.length,l),o.decrypt(d,l)}}}return Object.assign(r,e),r};function jc(e,t,r=!0){if(t===void 0)return new Uint8Array(e);if(t.length!==e)throw new Error('"output" expected Uint8Array of length '+e+", got: "+t.length);if(r&&!aN(t))throw new Error("invalid output, must be aligned");return t}function oN(e,t,r){Vo(r);const n=new Uint8Array(16),s=Gv(n);return s.setBigUint64(0,BigInt(t),r),s.setBigUint64(8,BigInt(e),r),n}function aN(e){return e.byteOffset%4===0}function Si(e){return Uint8Array.from(e)}function cN(e=32){const t=typeof globalThis=="object"?globalThis.crypto:null;if(typeof t?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}function ll(e,t=cN){const{nonceLength:r}=e;si(r);const n=(s,i)=>{const o=rN(s,i);return i.fill(0),o};return((s,...i)=>({encrypt(o){Pe(o);const a=t(r),c=e(s,a,...i).encrypt(o);return c instanceof Promise?c.then(u=>n(a,u)):n(a,c)},decrypt(o){Pe(o);const a=o.subarray(0,r),c=o.subarray(r);return e(s,a,...i).decrypt(c)}}))}const hl=e=>Uint8Array.from(e.split(""),t=>t.charCodeAt(0)),uN=hl("expand 16-byte k"),dN=hl("expand 32-byte k"),lN=lr(uN),hN=lr(dN);function z(e,t){return e<<t|e>>>32-t}function Fo(e){return e.byteOffset%4===0}const Hs=64,fN=16,fl=2**32-1,Vc=Uint32Array.of();function pN(e,t,r,n,s,i,o,a){const c=s.length,u=new Uint8Array(Hs),d=lr(u),l=Fo(s)&&Fo(i),h=l?lr(s):Vc,p=l?lr(i):Vc;for(let m=0;m<c;o++){if(e(t,r,n,d,o,a),o>=fl)throw new Error("arx: counter overflow");const y=Math.min(Hs,c-m);if(l&&y===Hs){const g=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let b=0,w;b<fN;b++)w=g+b,p[w]=h[w]^d[b];m+=Hs;continue}for(let g=0,b;g<y;g++)b=m+g,i[b]=s[b]^u[g];m+=y}}function mN(e,t){const{allowShortKeys:r,extendNonceFn:n,counterLength:s,counterRight:i,rounds:o}=nN({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof e!="function")throw new Error("core must be a function");return si(s),si(o),Vo(i),Vo(r),(a,c,u,d,l=0)=>{Pe(a,void 0,"key"),Pe(c,void 0,"nonce"),Pe(u,void 0,"data");const h=u.length;if(d===void 0&&(d=new Uint8Array(h)),Pe(d,void 0,"output"),si(l),l<0||l>=fl)throw new Error("arx: counter overflow");if(d.length<h)throw new Error(`arx: output (${d.length}) is shorter than data (${h})`);const p=[];let m=a.length,y,g;if(m===32)p.push(y=Si(a)),g=hN;else if(m===16&&r)y=new Uint8Array(32),y.set(a),y.set(a,16),g=lN,p.push(y);else throw Pe(a,32,"arx key"),new Error("invalid key size");Fo(c)||p.push(c=Si(c));const b=lr(y);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(g,b,lr(c.subarray(0,16)),b),c=c.subarray(16)}const w=16-s;if(w!==c.length)throw new Error(`arx: nonce must be ${w} or 16 bytes`);if(w!==12){const v=new Uint8Array(12);v.set(c,i?0:12-c.length),c=v,p.push(c)}const N=lr(c);return pN(e,g,b,N,u,d,l,o),xn(...p),d}}function We(e,t){return e[t++]&255|(e[t++]&255)<<8}class yN{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(t){t=Si(Pe(t,32,"key"));const r=We(t,0),n=We(t,2),s=We(t,4),i=We(t,6),o=We(t,8),a=We(t,10),c=We(t,12),u=We(t,14);this.r[0]=r&8191,this.r[1]=(r>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|u<<8)&8191,this.r[9]=u>>>5&127;for(let d=0;d<8;d++)this.pad[d]=We(t,16+2*d)}process(t,r,n=!1){const s=n?0:2048,{h:i,r:o}=this,a=o[0],c=o[1],u=o[2],d=o[3],l=o[4],h=o[5],p=o[6],m=o[7],y=o[8],g=o[9],b=We(t,r+0),w=We(t,r+2),N=We(t,r+4),v=We(t,r+6),k=We(t,r+8),A=We(t,r+10),S=We(t,r+12),q=We(t,r+14);let O=i[0]+(b&8191),$=i[1]+((b>>>13|w<<3)&8191),I=i[2]+((w>>>10|N<<6)&8191),E=i[3]+((N>>>7|v<<9)&8191),R=i[4]+((v>>>4|k<<12)&8191),P=i[5]+(k>>>1&8191),D=i[6]+((k>>>14|A<<2)&8191),W=i[7]+((A>>>11|S<<5)&8191),M=i[8]+((S>>>8|q<<8)&8191),U=i[9]+(q>>>5|s),x=0,B=x+O*a+$*(5*g)+I*(5*y)+E*(5*m)+R*(5*p);x=B>>>13,B&=8191,B+=P*(5*h)+D*(5*l)+W*(5*d)+M*(5*u)+U*(5*c),x+=B>>>13,B&=8191;let Q=x+O*c+$*a+I*(5*g)+E*(5*y)+R*(5*m);x=Q>>>13,Q&=8191,Q+=P*(5*p)+D*(5*h)+W*(5*l)+M*(5*d)+U*(5*u),x+=Q>>>13,Q&=8191;let J=x+O*u+$*c+I*a+E*(5*g)+R*(5*y);x=J>>>13,J&=8191,J+=P*(5*m)+D*(5*p)+W*(5*h)+M*(5*l)+U*(5*d),x+=J>>>13,J&=8191;let qe=x+O*d+$*u+I*c+E*a+R*(5*g);x=qe>>>13,qe&=8191,qe+=P*(5*y)+D*(5*m)+W*(5*p)+M*(5*h)+U*(5*l),x+=qe>>>13,qe&=8191;let It=x+O*l+$*d+I*u+E*c+R*a;x=It>>>13,It&=8191,It+=P*(5*g)+D*(5*y)+W*(5*m)+M*(5*p)+U*(5*h),x+=It>>>13,It&=8191;let ht=x+O*h+$*l+I*d+E*u+R*c;x=ht>>>13,ht&=8191,ht+=P*a+D*(5*g)+W*(5*y)+M*(5*m)+U*(5*p),x+=ht>>>13,ht&=8191;let Qr=x+O*p+$*h+I*l+E*d+R*u;x=Qr>>>13,Qr&=8191,Qr+=P*c+D*a+W*(5*g)+M*(5*y)+U*(5*m),x+=Qr>>>13,Qr&=8191;let Yr=x+O*m+$*p+I*h+E*l+R*d;x=Yr>>>13,Yr&=8191,Yr+=P*u+D*c+W*a+M*(5*g)+U*(5*y),x+=Yr>>>13,Yr&=8191;let Xr=x+O*y+$*m+I*p+E*h+R*l;x=Xr>>>13,Xr&=8191,Xr+=P*d+D*u+W*c+M*a+U*(5*g),x+=Xr>>>13,Xr&=8191;let en=x+O*g+$*y+I*m+E*p+R*h;x=en>>>13,en&=8191,en+=P*l+D*d+W*u+M*c+U*a,x+=en>>>13,en&=8191,x=(x<<2)+x|0,x=x+B|0,B=x&8191,x=x>>>13,Q+=x,i[0]=B,i[1]=Q,i[2]=J,i[3]=qe,i[4]=It,i[5]=ht,i[6]=Qr,i[7]=Yr,i[8]=Xr,i[9]=en}finalize(){const{h:t,pad:r}=this,n=new Uint16Array(10);let s=t[1]>>>13;t[1]&=8191;for(let a=2;a<10;a++)t[a]+=s,s=t[a]>>>13,t[a]&=8191;t[0]+=s*5,s=t[0]>>>13,t[0]&=8191,t[1]+=s,s=t[1]>>>13,t[1]&=8191,t[2]+=s,n[0]=t[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=t[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(s^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)t[a]=t[a]&i|n[a];t[0]=(t[0]|t[1]<<13)&65535,t[1]=(t[1]>>>3|t[2]<<10)&65535,t[2]=(t[2]>>>6|t[3]<<7)&65535,t[3]=(t[3]>>>9|t[4]<<4)&65535,t[4]=(t[4]>>>12|t[5]<<1|t[6]<<14)&65535,t[5]=(t[6]>>>2|t[7]<<11)&65535,t[6]=(t[7]>>>5|t[8]<<8)&65535,t[7]=(t[8]>>>8|t[9]<<5)&65535;let o=t[0]+r[0];t[0]=o&65535;for(let a=1;a<8;a++)o=(t[a]+r[a]|0)+(o>>>16)|0,t[a]=o&65535;xn(n)}update(t){zc(this),Pe(t),t=Si(t);const{buffer:r,blockLen:n}=this,s=t.length;for(let i=0;i<s;){const o=Math.min(n-this.pos,s-i);if(o===n){for(;n<=s-i;i+=n)this.process(t,i);continue}r.set(t.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===n&&(this.process(r,0,!1),this.pos=0)}return this}destroy(){xn(this.h,this.r,this.buffer,this.pad)}digestInto(t){zc(this),Jv(t,this),this.finished=!0;const{buffer:r,h:n}=this;let{pos:s}=this;if(s){for(r[s++]=1;s<16;s++)r[s]=0;this.process(r,0,!0)}this.finalize();let i=0;for(let o=0;o<8;o++)t[i++]=n[o]>>>0,t[i++]=n[o]>>>8;return t}digest(){const{buffer:t,outputLen:r}=this;this.digestInto(t);const n=t.slice(0,r);return this.destroy(),n}}function wN(e){const t=(n,s)=>e(s).update(n).digest(),r=e(new Uint8Array(32));return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=n=>e(n),t}const gN=wN(e=>new yN(e));function bN(e,t,r,n,s,i=20){let o=e[0],a=e[1],c=e[2],u=e[3],d=t[0],l=t[1],h=t[2],p=t[3],m=t[4],y=t[5],g=t[6],b=t[7],w=s,N=r[0],v=r[1],k=r[2],A=o,S=a,q=c,O=u,$=d,I=l,E=h,R=p,P=m,D=y,W=g,M=b,U=w,x=N,B=v,Q=k;for(let qe=0;qe<i;qe+=2)A=A+$|0,U=z(U^A,16),P=P+U|0,$=z($^P,12),A=A+$|0,U=z(U^A,8),P=P+U|0,$=z($^P,7),S=S+I|0,x=z(x^S,16),D=D+x|0,I=z(I^D,12),S=S+I|0,x=z(x^S,8),D=D+x|0,I=z(I^D,7),q=q+E|0,B=z(B^q,16),W=W+B|0,E=z(E^W,12),q=q+E|0,B=z(B^q,8),W=W+B|0,E=z(E^W,7),O=O+R|0,Q=z(Q^O,16),M=M+Q|0,R=z(R^M,12),O=O+R|0,Q=z(Q^O,8),M=M+Q|0,R=z(R^M,7),A=A+I|0,Q=z(Q^A,16),W=W+Q|0,I=z(I^W,12),A=A+I|0,Q=z(Q^A,8),W=W+Q|0,I=z(I^W,7),S=S+E|0,U=z(U^S,16),M=M+U|0,E=z(E^M,12),S=S+E|0,U=z(U^S,8),M=M+U|0,E=z(E^M,7),q=q+R|0,x=z(x^q,16),P=P+x|0,R=z(R^P,12),q=q+R|0,x=z(x^q,8),P=P+x|0,R=z(R^P,7),O=O+$|0,B=z(B^O,16),D=D+B|0,$=z($^D,12),O=O+$|0,B=z(B^O,8),D=D+B|0,$=z($^D,7);let J=0;n[J++]=o+A|0,n[J++]=a+S|0,n[J++]=c+q|0,n[J++]=u+O|0,n[J++]=d+$|0,n[J++]=l+I|0,n[J++]=h+E|0,n[J++]=p+R|0,n[J++]=m+P|0,n[J++]=y+D|0,n[J++]=g+W|0,n[J++]=b+M|0,n[J++]=w+U|0,n[J++]=N+x|0,n[J++]=v+B|0,n[J++]=k+Q|0}function vN(e,t,r,n){let s=e[0],i=e[1],o=e[2],a=e[3],c=t[0],u=t[1],d=t[2],l=t[3],h=t[4],p=t[5],m=t[6],y=t[7],g=r[0],b=r[1],w=r[2],N=r[3];for(let k=0;k<20;k+=2)s=s+c|0,g=z(g^s,16),h=h+g|0,c=z(c^h,12),s=s+c|0,g=z(g^s,8),h=h+g|0,c=z(c^h,7),i=i+u|0,b=z(b^i,16),p=p+b|0,u=z(u^p,12),i=i+u|0,b=z(b^i,8),p=p+b|0,u=z(u^p,7),o=o+d|0,w=z(w^o,16),m=m+w|0,d=z(d^m,12),o=o+d|0,w=z(w^o,8),m=m+w|0,d=z(d^m,7),a=a+l|0,N=z(N^a,16),y=y+N|0,l=z(l^y,12),a=a+l|0,N=z(N^a,8),y=y+N|0,l=z(l^y,7),s=s+u|0,N=z(N^s,16),m=m+N|0,u=z(u^m,12),s=s+u|0,N=z(N^s,8),m=m+N|0,u=z(u^m,7),i=i+d|0,g=z(g^i,16),y=y+g|0,d=z(d^y,12),i=i+d|0,g=z(g^i,8),y=y+g|0,d=z(d^y,7),o=o+l|0,b=z(b^o,16),h=h+b|0,l=z(l^h,12),o=o+l|0,b=z(b^o,8),h=h+b|0,l=z(l^h,7),a=a+c|0,w=z(w^a,16),p=p+w|0,c=z(c^p,12),a=a+c|0,w=z(w^a,8),p=p+w|0,c=z(c^p,7);let v=0;n[v++]=s,n[v++]=i,n[v++]=o,n[v++]=a,n[v++]=g,n[v++]=b,n[v++]=w,n[v++]=N}const NN=mN(bN,{counterRight:!1,counterLength:8,extendNonceFn:vN,allowShortKeys:!1}),EN=new Uint8Array(16),Fc=(e,t)=>{e.update(t);const r=t.length%16;r&&e.update(EN.subarray(r))},AN=new Uint8Array(32);function Bc(e,t,r,n,s){s!==void 0&&Pe(s,void 0,"AAD");const i=e(t,r,AN),o=oN(n.length,s?s.length:0,!0),a=gN.create(i);s&&Fc(a,s),Fc(a,n),a.update(o);const c=a.digest();return xn(i,o),c}const kN=e=>(t,r,n)=>({encrypt(i,o){const a=i.length;o=jc(a+16,o,!1),o.set(i);const c=o.subarray(0,-16);e(t,r,c,c,1);const u=Bc(e,t,r,c,n);return o.set(u,a),xn(u),o},decrypt(i,o){o=jc(i.length-16,o,!1);const a=i.subarray(0,-16),c=i.subarray(-16),u=Bc(e,t,r,a,n);if(!sN(c,u))throw new Error("invalid tag");return o.set(i.subarray(0,-16)),e(t,r,o,o,1),xn(u),o}}),pl=iN({blockSize:64,nonceLength:24,tagLength:16},kN(NN)),_t=new TextEncoder,Bt=new TextDecoder;function ml(...e){const t=e.reduce((s,{length:i})=>s+i,0),r=new Uint8Array(t);let n=0;for(const s of e)r.set(s,n),n+=s.length;return r}function TN(e){if(Uint8Array.prototype.toBase64)return e.toBase64();const t=32768,r=[];for(let n=0;n<e.length;n+=t)r.push(String.fromCharCode.apply(null,e.subarray(n,n+t)));return btoa(r.join(""))}function _N(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(e);const t=atob(e),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}function $r(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(typeof e=="string"?e:Bt.decode(e),{alphabet:"base64url"});let t=e;t instanceof Uint8Array&&(t=Bt.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return _N(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}}function mo(e){let t=e;return typeof t=="string"&&(t=_t.encode(t)),Uint8Array.prototype.toBase64?t.toBase64({alphabet:"base64url",omitPadding:!0}):TN(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}class at extends Error{static code="ERR_JOSE_GENERIC";code="ERR_JOSE_GENERIC";constructor(t,r){super(t,r),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}class gt extends at{static code="ERR_JWT_CLAIM_VALIDATION_FAILED";code="ERR_JWT_CLAIM_VALIDATION_FAILED";claim;reason;payload;constructor(t,r,n="unspecified",s="unspecified"){super(t,{cause:{claim:n,reason:s,payload:r}}),this.claim=n,this.reason=s,this.payload=r}}class Bo extends at{static code="ERR_JWT_EXPIRED";code="ERR_JWT_EXPIRED";claim;reason;payload;constructor(t,r,n="unspecified",s="unspecified"){super(t,{cause:{claim:n,reason:s,payload:r}}),this.claim=n,this.reason=s,this.payload=r}}class SN extends at{static code="ERR_JOSE_ALG_NOT_ALLOWED";code="ERR_JOSE_ALG_NOT_ALLOWED"}class Tt extends at{static code="ERR_JOSE_NOT_SUPPORTED";code="ERR_JOSE_NOT_SUPPORTED"}class Te extends at{static code="ERR_JWS_INVALID";code="ERR_JWS_INVALID"}class Et extends at{static code="ERR_JWT_INVALID";code="ERR_JWT_INVALID"}class yl extends at{static code="ERR_JWKS_INVALID";code="ERR_JWKS_INVALID"}class wl extends at{static code="ERR_JWKS_NO_MATCHING_KEY";code="ERR_JWKS_NO_MATCHING_KEY";constructor(t="no applicable key found in the JSON Web Key Set",r){super(t,r)}}class RN extends at{[Symbol.asyncIterator];static code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";constructor(t="multiple matching keys found in the JSON Web Key Set",r){super(t,r)}}class ON extends at{static code="ERR_JWKS_TIMEOUT";code="ERR_JWKS_TIMEOUT";constructor(t="request timed out",r){super(t,r)}}class IN extends at{static code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";constructor(t="signature verification failed",r){super(t,r)}}function bt(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function tn(e,t){return e.name===t}function yo(e){return parseInt(e.name.slice(4),10)}function xN(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function CN(e,t){if(t&&!e.usages.includes(t))throw new TypeError(`CryptoKey does not support this operation, its usages must include ${t}.`)}function PN(e,t,r){switch(t){case"HS256":case"HS384":case"HS512":{if(!tn(e.algorithm,"HMAC"))throw bt("HMAC");const n=parseInt(t.slice(2),10);if(yo(e.algorithm.hash)!==n)throw bt(`SHA-${n}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!tn(e.algorithm,"RSASSA-PKCS1-v1_5"))throw bt("RSASSA-PKCS1-v1_5");const n=parseInt(t.slice(2),10);if(yo(e.algorithm.hash)!==n)throw bt(`SHA-${n}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!tn(e.algorithm,"RSA-PSS"))throw bt("RSA-PSS");const n=parseInt(t.slice(2),10);if(yo(e.algorithm.hash)!==n)throw bt(`SHA-${n}`,"algorithm.hash");break}case"Ed25519":case"EdDSA":{if(!tn(e.algorithm,"Ed25519"))throw bt("Ed25519");break}case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":{if(!tn(e.algorithm,t))throw bt(t);break}case"ES256":case"ES384":case"ES512":{if(!tn(e.algorithm,"ECDSA"))throw bt("ECDSA");const n=xN(t);if(e.algorithm.namedCurve!==n)throw bt(n,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}CN(e,r)}function gl(e,t,...r){if(r=r.filter(Boolean),r.length>2){const n=r.pop();e+=`one of type ${r.join(", ")}, or ${n}.`}else r.length===2?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return t==null?e+=` Received ${t}`:typeof t=="function"&&t.name?e+=` Received function ${t.name}`:typeof t=="object"&&t!=null&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}const UN=(e,...t)=>gl("Key must be ",e,...t);function bl(e,t,...r){return gl(`Key for the ${e} algorithm must be `,t,...r)}function vl(e){return e?.[Symbol.toStringTag]==="CryptoKey"}function Nl(e){return e?.[Symbol.toStringTag]==="KeyObject"}const El=e=>vl(e)||Nl(e),Al=(...e)=>{const t=e.filter(Boolean);if(t.length===0||t.length===1)return!0;let r;for(const n of t){const s=Object.keys(n);if(!r||r.size===0){r=new Set(s);continue}for(const i of s){if(r.has(i))return!1;r.add(i)}}return!0};function LN(e){return typeof e=="object"&&e!==null}const wt=e=>{if(!LN(e)||Object.prototype.toString.call(e)!=="[object Object]")return!1;if(Object.getPrototypeOf(e)===null)return!0;let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t},kl=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if(typeof r!="number"||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};function $N(e){let t,r;switch(e.kty){case"AKP":{switch(e.alg){case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":t={name:e.alg},r=e.priv?["sign"]:["verify"];break;default:throw new Tt('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"RSA":{switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new Tt('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"EC":{switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new Tt('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"OKP":{switch(e.alg){case"Ed25519":case"EdDSA":t={name:"Ed25519"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new Tt('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}default:throw new Tt('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}const ii=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:r}=$N(e),n={...e};return n.kty!=="AKP"&&delete n.alg,delete n.use,crypto.subtle.importKey("jwk",n,t,e.ext??!(e.d||e.priv),e.key_ops??r)};async function Ta(e,t,r){if(!wt(e))throw new TypeError("JWK must be an object");let n;switch(t??=e.alg,n??=e.ext,e.kty){case"oct":if(typeof e.k!="string"||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return $r(e.k);case"RSA":if("oth"in e&&e.oth!==void 0)throw new Tt('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');return ii({...e,alg:t,ext:n});case"AKP":{if(typeof e.alg!="string"||!e.alg)throw new TypeError('missing "alg" (Algorithm) Parameter value');if(t!==void 0&&t!==e.alg)throw new TypeError("JWK alg and alg option value mismatch");return ii({...e,ext:n})}case"EC":case"OKP":return ii({...e,alg:t,ext:n});default:throw new Tt('Unsupported "kty" (Key Type) Parameter value')}}const Tl=(e,t,r,n,s)=>{if(s.crit!==void 0&&n?.crit===void 0)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!n||n.crit===void 0)return new Set;if(!Array.isArray(n.crit)||n.crit.length===0||n.crit.some(o=>typeof o!="string"||o.length===0))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let i;r!==void 0?i=new Map([...Object.entries(r),...t.entries()]):i=t;for(const o of n.crit){if(!i.has(o))throw new Tt(`Extension Header Parameter "${o}" is not recognized`);if(s[o]===void 0)throw new e(`Extension Header Parameter "${o}" is missing`);if(i.get(o)&&n[o]===void 0)throw new e(`Extension Header Parameter "${o}" MUST be integrity protected`)}return new Set(n.crit)},DN=(e,t)=>{if(t!==void 0&&(!Array.isArray(t)||t.some(r=>typeof r!="string")))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};function _a(e){return wt(e)&&typeof e.kty=="string"}function qN(e){return e.kty!=="oct"&&(e.kty==="AKP"&&typeof e.priv=="string"||typeof e.d=="string")}function WN(e){return e.kty!=="oct"&&typeof e.d>"u"&&typeof e.priv>"u"}function zN(e){return e.kty==="oct"&&typeof e.k=="string"}let En;const Hc=async(e,t,r,n=!1)=>{En||=new WeakMap;let s=En.get(e);if(s?.[r])return s[r];const i=await ii({...t,alg:r});return n&&Object.freeze(e),s?s[r]=i:En.set(e,{[r]:i}),i},MN=(e,t)=>{En||=new WeakMap;let r=En.get(e);if(r?.[t])return r[t];const n=e.type==="public",s=!!n;let i;if(e.asymmetricKeyType==="x25519"){switch(t){case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}i=e.toCryptoKey(e.asymmetricKeyType,s,n?[]:["deriveBits"])}if(e.asymmetricKeyType==="ed25519"){if(t!=="EdDSA"&&t!=="Ed25519")throw new TypeError("given KeyObject instance cannot be used for this algorithm");i=e.toCryptoKey(e.asymmetricKeyType,s,[n?"verify":"sign"])}switch(e.asymmetricKeyType){case"ml-dsa-44":case"ml-dsa-65":case"ml-dsa-87":{if(t!==e.asymmetricKeyType.toUpperCase())throw new TypeError("given KeyObject instance cannot be used for this algorithm");i=e.toCryptoKey(e.asymmetricKeyType,s,[n?"verify":"sign"])}}if(e.asymmetricKeyType==="rsa"){let o;switch(t){case"RSA-OAEP":o="SHA-1";break;case"RS256":case"PS256":case"RSA-OAEP-256":o="SHA-256";break;case"RS384":case"PS384":case"RSA-OAEP-384":o="SHA-384";break;case"RS512":case"PS512":case"RSA-OAEP-512":o="SHA-512";break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}if(t.startsWith("RSA-OAEP"))return e.toCryptoKey({name:"RSA-OAEP",hash:o},s,n?["encrypt"]:["decrypt"]);i=e.toCryptoKey({name:t.startsWith("PS")?"RSA-PSS":"RSASSA-PKCS1-v1_5",hash:o},s,[n?"verify":"sign"])}if(e.asymmetricKeyType==="ec"){const a=new Map([["prime256v1","P-256"],["secp384r1","P-384"],["secp521r1","P-521"]]).get(e.asymmetricKeyDetails?.namedCurve);if(!a)throw new TypeError("given KeyObject instance cannot be used for this algorithm");t==="ES256"&&a==="P-256"&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:a},s,[n?"verify":"sign"])),t==="ES384"&&a==="P-384"&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:a},s,[n?"verify":"sign"])),t==="ES512"&&a==="P-521"&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:a},s,[n?"verify":"sign"])),t.startsWith("ECDH-ES")&&(i=e.toCryptoKey({name:"ECDH",namedCurve:a},s,n?[]:["deriveBits"]))}if(!i)throw new TypeError("given KeyObject instance cannot be used for this algorithm");return r?r[t]=i:En.set(e,{[t]:i}),i},_l=async(e,t)=>{if(e instanceof Uint8Array||vl(e))return e;if(Nl(e)){if(e.type==="secret")return e.export();if("toCryptoKey"in e&&typeof e.toCryptoKey=="function")try{return MN(e,t)}catch(n){if(n instanceof TypeError)throw n}let r=e.export({format:"jwk"});return Hc(e,r,t)}if(_a(e))return e.k?$r(e.k):Hc(e,e,t,!0);throw new Error("unreachable")},un=e=>e?.[Symbol.toStringTag],Ho=(e,t,r)=>{if(t.use!==void 0){let n;switch(r){case"sign":case"verify":n="sig";break;case"encrypt":case"decrypt":n="enc";break}if(t.use!==n)throw new TypeError(`Invalid key for this operation, its "use" must be "${n}" when present`)}if(t.alg!==void 0&&t.alg!==e)throw new TypeError(`Invalid key for this operation, its "alg" must be "${e}" when present`);if(Array.isArray(t.key_ops)){let n;switch(!0){case(r==="sign"||r==="verify"):case e==="dir":case e.includes("CBC-HS"):n=r;break;case e.startsWith("PBES2"):n="deriveBits";break;case/^A\d{3}(?:GCM)?(?:KW)?$/.test(e):!e.includes("GCM")&&e.endsWith("KW")?n=r==="encrypt"?"wrapKey":"unwrapKey":n=r;break;case(r==="encrypt"&&e.startsWith("RSA")):n="wrapKey";break;case r==="decrypt":n=e.startsWith("RSA")?"unwrapKey":"deriveBits";break}if(n&&t.key_ops?.includes?.(n)===!1)throw new TypeError(`Invalid key for this operation, its "key_ops" must include "${n}" when present`)}return!0},jN=(e,t,r)=>{if(!(t instanceof Uint8Array)){if(_a(t)){if(zN(t)&&Ho(e,t,r))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!El(t))throw new TypeError(bl(e,t,"CryptoKey","KeyObject","JSON Web Key","Uint8Array"));if(t.type!=="secret")throw new TypeError(`${un(t)} instances for symmetric algorithms must be of type "secret"`)}},VN=(e,t,r)=>{if(_a(t))switch(r){case"decrypt":case"sign":if(qN(t)&&Ho(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"encrypt":case"verify":if(WN(t)&&Ho(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!El(t))throw new TypeError(bl(e,t,"CryptoKey","KeyObject","JSON Web Key"));if(t.type==="secret")throw new TypeError(`${un(t)} instances for asymmetric algorithms must not be of type "secret"`);if(t.type==="public")switch(r){case"sign":throw new TypeError(`${un(t)} instances for asymmetric algorithm signing must be of type "private"`);case"decrypt":throw new TypeError(`${un(t)} instances for asymmetric algorithm decryption must be of type "private"`)}if(t.type==="private")switch(r){case"verify":throw new TypeError(`${un(t)} instances for asymmetric algorithm verifying must be of type "public"`);case"encrypt":throw new TypeError(`${un(t)} instances for asymmetric algorithm encryption must be of type "public"`)}},Sl=(e,t,r)=>{e.startsWith("HS")||e==="dir"||e.startsWith("PBES2")||/^A(?:128|192|256)(?:GCM)?(?:KW)?$/.test(e)||/^A(?:128|192|256)CBC-HS(?:256|384|512)$/.test(e)?jN(e,t,r):VN(e,t,r)},Rl=(e,t)=>{const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:parseInt(e.slice(-3),10)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"Ed25519":case"EdDSA":return{name:"Ed25519"};case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":return{name:e};default:throw new Tt(`alg ${e} is not supported either by JOSE or your javascript runtime`)}},Ol=async(e,t,r)=>{if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(UN(t,"CryptoKey","KeyObject","JSON Web Key"));return crypto.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}return PN(t,e,r),t},FN=async(e,t,r,n)=>{const s=await Ol(e,t,"verify");kl(e,s);const i=Rl(e,s.algorithm);try{return await crypto.subtle.verify(i,s,r,n)}catch{return!1}};async function BN(e,t,r){if(!wt(e))throw new Te("Flattened JWS must be an object");if(e.protected===void 0&&e.header===void 0)throw new Te('Flattened JWS must have either of the "protected" or "header" members');if(e.protected!==void 0&&typeof e.protected!="string")throw new Te("JWS Protected Header incorrect type");if(e.payload===void 0)throw new Te("JWS Payload missing");if(typeof e.signature!="string")throw new Te("JWS Signature missing or incorrect type");if(e.header!==void 0&&!wt(e.header))throw new Te("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{const g=$r(e.protected);n=JSON.parse(Bt.decode(g))}catch{throw new Te("JWS Protected Header is invalid")}if(!Al(n,e.header))throw new Te("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const s={...n,...e.header},i=Tl(Te,new Map([["b64",!0]]),r?.crit,n,s);let o=!0;if(i.has("b64")&&(o=n.b64,typeof o!="boolean"))throw new Te('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:a}=s;if(typeof a!="string"||!a)throw new Te('JWS "alg" (Algorithm) Header Parameter missing or invalid');const c=r&&DN("algorithms",r.algorithms);if(c&&!c.has(a))throw new SN('"alg" (Algorithm) Header Parameter value not allowed');if(o){if(typeof e.payload!="string")throw new Te("JWS Payload must be a string")}else if(typeof e.payload!="string"&&!(e.payload instanceof Uint8Array))throw new Te("JWS Payload must be a string or an Uint8Array instance");let u=!1;typeof t=="function"&&(t=await t(n,e),u=!0),Sl(a,t,"verify");const d=ml(_t.encode(e.protected??""),_t.encode("."),typeof e.payload=="string"?_t.encode(e.payload):e.payload);let l;try{l=$r(e.signature)}catch{throw new Te("Failed to base64url decode the signature")}const h=await _l(t,a);if(!await FN(a,h,l,d))throw new IN;let m;if(o)try{m=$r(e.payload)}catch{throw new Te("Failed to base64url decode the payload")}else typeof e.payload=="string"?m=_t.encode(e.payload):m=e.payload;const y={payload:m};return e.protected!==void 0&&(y.protectedHeader=n),e.header!==void 0&&(y.unprotectedHeader=e.header),u?{...y,key:h}:y}async function HN(e,t,r){if(e instanceof Uint8Array&&(e=Bt.decode(e)),typeof e!="string")throw new Te("Compact JWS must be a string or Uint8Array");const{0:n,1:s,2:i,length:o}=e.split(".");if(o!==3)throw new Te("Invalid Compact JWS");const a=await BN({payload:s,protected:n,signature:i},t,r),c={payload:a.payload,protectedHeader:a.protectedHeader};return typeof t=="function"?{...c,key:a.key}:c}const er=e=>Math.floor(e.getTime()/1e3),Il=60,xl=Il*60,Sa=xl*24,KN=Sa*7,ZN=Sa*365.25,JN=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,ns=e=>{const t=JN.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const r=parseFloat(t[2]),n=t[3].toLowerCase();let s;switch(n){case"sec":case"secs":case"second":case"seconds":case"s":s=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":s=Math.round(r*Il);break;case"hour":case"hours":case"hr":case"hrs":case"h":s=Math.round(r*xl);break;case"day":case"days":case"d":s=Math.round(r*Sa);break;case"week":case"weeks":case"w":s=Math.round(r*KN);break;default:s=Math.round(r*ZN);break}return t[1]==="-"||t[4]==="ago"?-s:s};function Er(e,t){if(!Number.isFinite(t))throw new TypeError(`Invalid ${e} input`);return t}const Kc=e=>e.includes("/")?e.toLowerCase():`application/${e.toLowerCase()}`,GN=(e,t)=>typeof e=="string"?t.includes(e):Array.isArray(e)?t.some(Set.prototype.has.bind(new Set(e))):!1;function QN(e,t,r={}){let n;try{n=JSON.parse(Bt.decode(t))}catch{}if(!wt(n))throw new Et("JWT Claims Set must be a top-level JSON object");const{typ:s}=r;if(s&&(typeof e.typ!="string"||Kc(e.typ)!==Kc(s)))throw new gt('unexpected "typ" JWT header value',n,"typ","check_failed");const{requiredClaims:i=[],issuer:o,subject:a,audience:c,maxTokenAge:u}=r,d=[...i];u!==void 0&&d.push("iat"),c!==void 0&&d.push("aud"),a!==void 0&&d.push("sub"),o!==void 0&&d.push("iss");for(const m of new Set(d.reverse()))if(!(m in n))throw new gt(`missing required "${m}" claim`,n,m,"missing");if(o&&!(Array.isArray(o)?o:[o]).includes(n.iss))throw new gt('unexpected "iss" claim value',n,"iss","check_failed");if(a&&n.sub!==a)throw new gt('unexpected "sub" claim value',n,"sub","check_failed");if(c&&!GN(n.aud,typeof c=="string"?[c]:c))throw new gt('unexpected "aud" claim value',n,"aud","check_failed");let l;switch(typeof r.clockTolerance){case"string":l=ns(r.clockTolerance);break;case"number":l=r.clockTolerance;break;case"undefined":l=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:h}=r,p=er(h||new Date);if((n.iat!==void 0||u)&&typeof n.iat!="number")throw new gt('"iat" claim must be a number',n,"iat","invalid");if(n.nbf!==void 0){if(typeof n.nbf!="number")throw new gt('"nbf" claim must be a number',n,"nbf","invalid");if(n.nbf>p+l)throw new gt('"nbf" claim timestamp check failed',n,"nbf","check_failed")}if(n.exp!==void 0){if(typeof n.exp!="number")throw new gt('"exp" claim must be a number',n,"exp","invalid");if(n.exp<=p-l)throw new Bo('"exp" claim timestamp check failed',n,"exp","check_failed")}if(u){const m=p-n.iat,y=typeof u=="number"?u:ns(u);if(m-l>y)throw new Bo('"iat" claim timestamp check failed (too far in the past)',n,"iat","check_failed");if(m<0-l)throw new gt('"iat" claim timestamp check failed (it should be in the past)',n,"iat","check_failed")}return n}class YN{#e;constructor(t){if(!wt(t))throw new TypeError("JWT Claims Set MUST be an object");this.#e=structuredClone(t)}data(){return _t.encode(JSON.stringify(this.#e))}get iss(){return this.#e.iss}set iss(t){this.#e.iss=t}get sub(){return this.#e.sub}set sub(t){this.#e.sub=t}get aud(){return this.#e.aud}set aud(t){this.#e.aud=t}set jti(t){this.#e.jti=t}set nbf(t){typeof t=="number"?this.#e.nbf=Er("setNotBefore",t):t instanceof Date?this.#e.nbf=Er("setNotBefore",er(t)):this.#e.nbf=er(new Date)+ns(t)}set exp(t){typeof t=="number"?this.#e.exp=Er("setExpirationTime",t):t instanceof Date?this.#e.exp=Er("setExpirationTime",er(t)):this.#e.exp=er(new Date)+ns(t)}set iat(t){typeof t>"u"?this.#e.iat=er(new Date):t instanceof Date?this.#e.iat=Er("setIssuedAt",er(t)):typeof t=="string"?this.#e.iat=Er("setIssuedAt",er(new Date)+ns(t)):this.#e.iat=Er("setIssuedAt",t)}}async function ro(e,t,r){const n=await HN(e,t,r);if(n.protectedHeader.crit?.includes("b64")&&n.protectedHeader.b64===!1)throw new Et("JWTs MUST NOT use unencoded payload");const i={payload:QN(n.protectedHeader,n.payload,r),protectedHeader:n.protectedHeader};return typeof t=="function"?{...i,key:n.key}:i}const XN=async(e,t,r)=>{const n=await Ol(e,t,"sign");kl(e,n);const s=await crypto.subtle.sign(Rl(e,n.algorithm),n,r);return new Uint8Array(s)};class eE{#e;#t;#r;constructor(t){if(!(t instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this.#e=t}setProtectedHeader(t){if(this.#t)throw new TypeError("setProtectedHeader can only be called once");return this.#t=t,this}setUnprotectedHeader(t){if(this.#r)throw new TypeError("setUnprotectedHeader can only be called once");return this.#r=t,this}async sign(t,r){if(!this.#t&&!this.#r)throw new Te("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!Al(this.#t,this.#r))throw new Te("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const n={...this.#t,...this.#r},s=Tl(Te,new Map([["b64",!0]]),r?.crit,this.#t,n);let i=!0;if(s.has("b64")&&(i=this.#t.b64,typeof i!="boolean"))throw new Te('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:o}=n;if(typeof o!="string"||!o)throw new Te('JWS "alg" (Algorithm) Header Parameter missing or invalid');Sl(o,t,"sign");let a=this.#e;i&&(a=_t.encode(mo(a)));let c;this.#t?c=_t.encode(mo(JSON.stringify(this.#t))):c=_t.encode("");const u=ml(c,_t.encode("."),a),d=await _l(t,o),l=await XN(o,d,u),h={signature:mo(l),payload:""};return i&&(h.payload=Bt.decode(a)),this.#r&&(h.header=this.#r),this.#t&&(h.protected=Bt.decode(c)),h}}class tE{#e;constructor(t){this.#e=new eE(t)}setProtectedHeader(t){return this.#e.setProtectedHeader(t),this}async sign(t,r){const n=await this.#e.sign(t,r);if(n.payload===void 0)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${n.protected}.${n.payload}.${n.signature}`}}class rE{#e;#t;constructor(t={}){this.#t=new YN(t)}setIssuer(t){return this.#t.iss=t,this}setSubject(t){return this.#t.sub=t,this}setAudience(t){return this.#t.aud=t,this}setJti(t){return this.#t.jti=t,this}setNotBefore(t){return this.#t.nbf=t,this}setExpirationTime(t){return this.#t.exp=t,this}setIssuedAt(t){return this.#t.iat=t,this}setProtectedHeader(t){return this.#e=t,this}async sign(t,r){const n=new tE(this.#t.data());if(n.setProtectedHeader(this.#e),Array.isArray(this.#e?.crit)&&this.#e.crit.includes("b64")&&this.#e.b64===!1)throw new Et("JWTs MUST NOT use unencoded payload");return n.sign(t,r)}}function nE(e){switch(typeof e=="string"&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";case"ML":return"AKP";default:throw new Tt('Unsupported "alg" value for a JSON Web Key Set')}}function sE(e){return e&&typeof e=="object"&&Array.isArray(e.keys)&&e.keys.every(iE)}function iE(e){return wt(e)}class oE{#e;#t=new WeakMap;constructor(t){if(!sE(t))throw new yl("JSON Web Key Set malformed");this.#e=structuredClone(t)}jwks(){return this.#e}async getKey(t,r){const{alg:n,kid:s}={...t,...r?.header},i=nE(n),o=this.#e.keys.filter(u=>{let d=i===u.kty;if(d&&typeof s=="string"&&(d=s===u.kid),d&&(typeof u.alg=="string"||i==="AKP")&&(d=n===u.alg),d&&typeof u.use=="string"&&(d=u.use==="sig"),d&&Array.isArray(u.key_ops)&&(d=u.key_ops.includes("verify")),d)switch(n){case"ES256":d=u.crv==="P-256";break;case"ES384":d=u.crv==="P-384";break;case"ES512":d=u.crv==="P-521";break;case"Ed25519":case"EdDSA":d=u.crv==="Ed25519";break}return d}),{0:a,length:c}=o;if(c===0)throw new wl;if(c!==1){const u=new RN,d=this.#t;throw u[Symbol.asyncIterator]=async function*(){for(const l of o)try{yield await Zc(d,l,n)}catch{}},u}return Zc(this.#t,a,n)}}async function Zc(e,t,r){const n=e.get(t)||e.set(t,{}).get(t);if(n[r]===void 0){const s=await Ta({...t,ext:!0},r);if(s instanceof Uint8Array||s.type!=="public")throw new yl("JSON Web Key Set members must be public keys");n[r]=s}return n[r]}function Jc(e){const t=new oE(e),r=async(n,s)=>t.getKey(n,s);return Object.defineProperties(r,{jwks:{value:()=>structuredClone(t.jwks()),enumerable:!1,configurable:!1,writable:!1}}),r}function aE(){return typeof WebSocketPair<"u"||typeof navigator<"u"&&navigator.userAgent==="Cloudflare-Workers"||typeof EdgeRuntime<"u"&&EdgeRuntime==="vercel"}let Ko;(typeof navigator>"u"||!navigator.userAgent?.startsWith?.("Mozilla/5.0 "))&&(Ko="jose/v6.1.0");const cE=Symbol();async function uE(e,t,r,n=fetch){const s=await n(e,{method:"GET",signal:r,redirect:"manual",headers:t}).catch(i=>{throw i.name==="TimeoutError"?new ON:i});if(s.status!==200)throw new at("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await s.json()}catch{throw new at("Failed to parse the JSON Web Key Set HTTP response as JSON")}}const wo=Symbol();function dE(e,t){return!(typeof e!="object"||e===null||!("uat"in e)||typeof e.uat!="number"||Date.now()-e.uat>=t||!("jwks"in e)||!wt(e.jwks)||!Array.isArray(e.jwks.keys)||!Array.prototype.every.call(e.jwks.keys,wt))}class lE{#e;#t;#r;#n;#s;#i;#c;#a;#o;#u;constructor(t,r){if(!(t instanceof URL))throw new TypeError("url must be an instance of URL");this.#e=new URL(t.href),this.#t=typeof r?.timeoutDuration=="number"?r?.timeoutDuration:5e3,this.#r=typeof r?.cooldownDuration=="number"?r?.cooldownDuration:3e4,this.#n=typeof r?.cacheMaxAge=="number"?r?.cacheMaxAge:6e5,this.#c=new Headers(r?.headers),Ko&&!this.#c.has("User-Agent")&&this.#c.set("User-Agent",Ko),this.#c.has("accept")||(this.#c.set("accept","application/json"),this.#c.append("accept","application/jwk-set+json")),this.#a=r?.[cE],r?.[wo]!==void 0&&(this.#u=r?.[wo],dE(r?.[wo],this.#n)&&(this.#s=this.#u.uat,this.#o=Jc(this.#u.jwks)))}pendingFetch(){return!!this.#i}coolingDown(){return typeof this.#s=="number"?Date.now()<this.#s+this.#r:!1}fresh(){return typeof this.#s=="number"?Date.now()<this.#s+this.#n:!1}jwks(){return this.#o?.jwks()}async getKey(t,r){(!this.#o||!this.fresh())&&await this.reload();try{return await this.#o(t,r)}catch(n){if(n instanceof wl&&this.coolingDown()===!1)return await this.reload(),this.#o(t,r);throw n}}async reload(){this.#i&&aE()&&(this.#i=void 0),this.#i||=uE(this.#e.href,this.#c,AbortSignal.timeout(this.#t),this.#a).then(t=>{this.#o=Jc(t),this.#u&&(this.#u.uat=Date.now(),this.#u.jwks=t),this.#s=Date.now(),this.#i=void 0}).catch(t=>{throw this.#i=void 0,t}),await this.#i}}function hE(e,t){const r=new lE(e,t),n=async(s,i)=>r.getKey(s,i);return Object.defineProperties(n,{coolingDown:{get:()=>r.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>r.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>r.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>r.pendingFetch(),enumerable:!0,configurable:!1},jwks:{value:()=>r.jwks(),enumerable:!0,configurable:!1,writable:!1}}),n}function Cl(e){let t;if(typeof e=="string"){const r=e.split(".");(r.length===3||r.length===5)&&([t]=r)}else if(typeof e=="object"&&e)if("protected"in e)t=e.protected;else throw new TypeError("Token does not contain a Protected Header");try{if(typeof t!="string"||!t)throw new Error;const r=JSON.parse(Bt.decode($r(t)));if(!wt(r))throw new Error;return r}catch{throw new TypeError("Invalid Token or Protected Header formatting")}}function Nr(e){if(typeof e!="string")throw new Et("JWTs must use Compact JWS serialization, JWT must be a string");const{1:t,length:r}=e.split(".");if(r===5)throw new Et("Only JWTs using Compact JWS serialization can be decoded");if(r!==3)throw new Et("Invalid JWT");if(!t)throw new Et("JWTs must contain a payload");let n;try{n=$r(t)}catch{throw new Et("Failed to base64url decode the payload")}let s;try{s=JSON.parse(Bt.decode(n))}catch{throw new Et("Failed to parse the decoded payload as JSON")}if(!wt(s))throw new Et("Invalid JWT Claims Set");return s}/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function fE(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function pt(e,t=""){if(!Number.isSafeInteger(e)||e<0){const r=t&&`"${t}" `;throw new Error(`${r}expected integer >= 0, got ${e}`)}}function As(e,t,r=""){const n=fE(e),s=e?.length,i=t!==void 0;if(!n||i&&s!==t){const o=r&&`"${r}" `,a=i?` of length ${t}`:"",c=n?`length=${s}`:`type=${typeof e}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return e}function Pl(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash must wrapped by utils.createHasher");pt(e.outputLen),pt(e.blockLen)}function Ri(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function pE(e,t){As(e,void 0,"digestInto() output");const r=t.outputLen;if(e.length<r)throw new Error('"digestInto() output" expected to be of length >='+r)}function go(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function Cn(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function oi(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function vt(e,t){return e<<32-t|e>>>t}function Y(e,t){return e<<t|e>>>32-t>>>0}const mE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function yE(e){return e<<24&4278190080|e<<8&16711680|e>>>8&65280|e>>>24&255}function wE(e){for(let t=0;t<e.length;t++)e[t]=yE(e[t]);return e}const Gc=mE?e=>e:wE,gE=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Ct={_0:48,_9:57,A:65,F:70,a:97,f:102};function Qc(e){if(e>=Ct._0&&e<=Ct._9)return e-Ct._0;if(e>=Ct.A&&e<=Ct.F)return e-(Ct.A-10);if(e>=Ct.a&&e<=Ct.f)return e-(Ct.a-10)}function bE(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);if(gE)return Uint8Array.fromHex(e);const t=e.length,r=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(r);for(let s=0,i=0;s<r;s++,i+=2){const o=Qc(e.charCodeAt(i)),a=Qc(e.charCodeAt(i+1));if(o===void 0||a===void 0){const c=e[i]+e[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}const vE=async()=>{};async function Yc(e,t,r){let n=Date.now();for(let s=0;s<e;s++){r(s);const i=Date.now()-n;i>=0&&i<t||(await vE(),n+=i)}}function NE(e){if(typeof e!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(e))}function Xc(e,t=""){return typeof e=="string"?NE(e):As(e,void 0,t)}function Ul(e,t){if(t!==void 0&&{}.toString.call(t)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(e,t)}function EE(e,t={}){const r=(s,i)=>e(i).update(s).digest(),n=e(void 0);return r.outputLen=n.outputLen,r.blockLen=n.blockLen,r.create=s=>e(s),Object.assign(r,t),Object.freeze(r)}const AE=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])});class Ll{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(t,r){if(Pl(t),As(r,void 0,"key"),this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(r.length>n?t.create().update(r).digest():r);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=t.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),Cn(s)}update(t){return Ri(this),this.iHash.update(t),this}digestInto(t){Ri(this),As(t,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||=Object.create(Object.getPrototypeOf(this),{});const{oHash:r,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return t=t,t.finished=s,t.destroyed=i,t.blockLen=o,t.outputLen=a,t.oHash=r._cloneInto(t.oHash),t.iHash=n._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const $l=(e,t,r)=>new Ll(e,t).update(r).digest();$l.create=(e,t)=>new Ll(e,t);function kE(e,t,r,n){Pl(e);const s=Ul({dkLen:32,asyncTick:10},n),{c:i,dkLen:o,asyncTick:a}=s;if(pt(i,"c"),pt(o,"dkLen"),pt(a,"asyncTick"),i<1)throw new Error("iterations (c) must be >= 1");const c=Xc(t,"password"),u=Xc(r,"salt"),d=new Uint8Array(o),l=$l.create(e,c),h=l._cloneInto().update(u);return{c:i,dkLen:o,asyncTick:a,DK:d,PRF:l,PRFSalt:h}}function TE(e,t,r,n,s){return e.destroy(),t.destroy(),n&&n.destroy(),Cn(s),r}function Dl(e,t,r,n){const{c:s,dkLen:i,DK:o,PRF:a,PRFSalt:c}=kE(e,t,r,n);let u;const d=new Uint8Array(4),l=oi(d),h=new Uint8Array(a.outputLen);for(let p=1,m=0;m<i;p++,m+=a.outputLen){const y=o.subarray(m,m+a.outputLen);l.setInt32(0,p,!1),(u=c._cloneInto(u)).update(d).digestInto(h),y.set(h.subarray(0,y.length));for(let g=1;g<s;g++){a._cloneInto(u).update(h).digestInto(h);for(let b=0;b<y.length;b++)y[b]^=h[b]}}return TE(a,c,o,u,h)}function _E(e,t,r){return e&t^~e&r}function SE(e,t,r){return e&t^e&r^t&r}class RE{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(t,r,n,s){this.blockLen=t,this.outputLen=r,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(t),this.view=oi(this.buffer)}update(t){Ri(this),As(t);const{view:r,buffer:n,blockLen:s}=this,i=t.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=oi(t);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(t.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(r,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Ri(this),pE(t,this),this.finished=!0;const{buffer:r,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;r[o++]=128,Cn(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let l=o;l<s;l++)r[l]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const a=oi(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const u=c/4,d=this.get();if(u>d.length)throw new Error("_sha2: outputLen bigger than state");for(let l=0;l<u;l++)a.setUint32(4*l,d[l],i)}digest(){const{buffer:t,outputLen:r}=this;this.digestInto(t);const n=t.slice(0,r);return this.destroy(),n}_cloneInto(t){t||=new this.constructor,t.set(...this.get());const{blockLen:r,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return t.destroyed=o,t.finished=i,t.length=s,t.pos=a,s%r&&t.buffer.set(n),t}clone(){return this._cloneInto()}}const Gt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),OE=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Qt=new Uint32Array(64);class IE extends RE{constructor(t){super(64,t,8,!1)}get(){const{A:t,B:r,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[t,r,n,s,i,o,a,c]}set(t,r,n,s,i,o,a,c){this.A=t|0,this.B=r|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(t,r){for(let l=0;l<16;l++,r+=4)Qt[l]=t.getUint32(r,!1);for(let l=16;l<64;l++){const h=Qt[l-15],p=Qt[l-2],m=vt(h,7)^vt(h,18)^h>>>3,y=vt(p,17)^vt(p,19)^p>>>10;Qt[l]=y+Qt[l-7]+m+Qt[l-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:u,H:d}=this;for(let l=0;l<64;l++){const h=vt(a,6)^vt(a,11)^vt(a,25),p=d+h+_E(a,c,u)+OE[l]+Qt[l]|0,y=(vt(n,2)^vt(n,13)^vt(n,22))+SE(n,s,i)|0;d=u,u=c,c=a,a=o+p|0,o=i,i=s,s=n,n=p+y|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,d=d+this.H|0,this.set(n,s,i,o,a,c,u,d)}roundClean(){Cn(Qt)}destroy(){this.set(0,0,0,0,0,0,0,0),Cn(this.buffer)}}class xE extends IE{A=Gt[0]|0;B=Gt[1]|0;C=Gt[2]|0;D=Gt[3]|0;E=Gt[4]|0;F=Gt[5]|0;G=Gt[6]|0;H=Gt[7]|0;constructor(){super(32)}}const ql=EE(()=>new xE,AE(1));function eu(e,t,r,n,s,i){let o=e[t++]^r[n++],a=e[t++]^r[n++],c=e[t++]^r[n++],u=e[t++]^r[n++],d=e[t++]^r[n++],l=e[t++]^r[n++],h=e[t++]^r[n++],p=e[t++]^r[n++],m=e[t++]^r[n++],y=e[t++]^r[n++],g=e[t++]^r[n++],b=e[t++]^r[n++],w=e[t++]^r[n++],N=e[t++]^r[n++],v=e[t++]^r[n++],k=e[t++]^r[n++],A=o,S=a,q=c,O=u,$=d,I=l,E=h,R=p,P=m,D=y,W=g,M=b,U=w,x=N,B=v,Q=k;for(let J=0;J<8;J+=2)$^=Y(A+U|0,7),P^=Y($+A|0,9),U^=Y(P+$|0,13),A^=Y(U+P|0,18),D^=Y(I+S|0,7),x^=Y(D+I|0,9),S^=Y(x+D|0,13),I^=Y(S+x|0,18),B^=Y(W+E|0,7),q^=Y(B+W|0,9),E^=Y(q+B|0,13),W^=Y(E+q|0,18),O^=Y(Q+M|0,7),R^=Y(O+Q|0,9),M^=Y(R+O|0,13),Q^=Y(M+R|0,18),S^=Y(A+O|0,7),q^=Y(S+A|0,9),O^=Y(q+S|0,13),A^=Y(O+q|0,18),E^=Y(I+$|0,7),R^=Y(E+I|0,9),$^=Y(R+E|0,13),I^=Y($+R|0,18),M^=Y(W+D|0,7),P^=Y(M+W|0,9),D^=Y(P+M|0,13),W^=Y(D+P|0,18),U^=Y(Q+B|0,7),x^=Y(U+Q|0,9),B^=Y(x+U|0,13),Q^=Y(B+x|0,18);s[i++]=o+A|0,s[i++]=a+S|0,s[i++]=c+q|0,s[i++]=u+O|0,s[i++]=d+$|0,s[i++]=l+I|0,s[i++]=h+E|0,s[i++]=p+R|0,s[i++]=m+P|0,s[i++]=y+D|0,s[i++]=g+W|0,s[i++]=b+M|0,s[i++]=w+U|0,s[i++]=N+x|0,s[i++]=v+B|0,s[i++]=k+Q|0}function bo(e,t,r,n,s){let i=n+0,o=n+16*s;for(let a=0;a<16;a++)r[o+a]=e[t+(2*s-1)*16+a];for(let a=0;a<s;a++,i+=16,t+=16)eu(r,o,e,t,r,i),a>0&&(o+=16),eu(r,i,e,t+=16,r,o)}function CE(e,t,r){const n=Ul({dkLen:32,asyncTick:10,maxmem:1073742848},r),{N:s,r:i,p:o,dkLen:a,asyncTick:c,maxmem:u,onProgress:d}=n;if(pt(s,"N"),pt(i,"r"),pt(o,"p"),pt(a,"dkLen"),pt(c,"asyncTick"),pt(u,"maxmem"),d!==void 0&&typeof d!="function")throw new Error("progressCb must be a function");const l=128*i,h=l/4,p=Math.pow(2,32);if(s<=1||(s&s-1)!==0||s>p)throw new Error('"N" expected a power of 2, and 2^1 <= N <= 2^32');if(o<1||o>(p-1)*32/l)throw new Error('"p" expected integer 1..((2^32 - 1) * 32) / (128 * r)');if(a<1||a>(p-1)*32)throw new Error('"dkLen" expected integer 1..(2^32 - 1) * 32');if(l*(s+o)>u)throw new Error('"maxmem" limit was hit, expected 128*r*(N+p) <= "maxmem"='+u);const y=Dl(ql,e,t,{c:1,dkLen:l*o}),g=go(y),b=go(new Uint8Array(l*s)),w=go(new Uint8Array(l));let N=()=>{};if(d){const v=2*s*o,k=Math.max(Math.floor(v/1e4),1);let A=0;N=()=>{A++,d&&(!(A%k)||A===v)&&d(A/v)}}return{N:s,r:i,p:o,dkLen:a,blockSize32:h,V:b,B32:g,B:y,tmp:w,blockMixCb:N,asyncTick:c}}function PE(e,t,r,n,s){const i=Dl(ql,e,r,{c:1,dkLen:t});return Cn(r,n,s),i}async function UE(e,t,r){const{N:n,r:s,p:i,dkLen:o,blockSize32:a,V:c,B32:u,B:d,tmp:l,blockMixCb:h,asyncTick:p}=CE(e,t,r);Gc(u);for(let m=0;m<i;m++){const y=a*m;for(let b=0;b<a;b++)c[b]=u[y+b];let g=0;await Yc(n-1,p,()=>{bo(c,g,c,g+=a,s),h()}),bo(c,(n-1)*a,u,y,s),h(),await Yc(n,p,()=>{const b=(u[y+a-16]&n-1)>>>0;for(let w=0;w<a;w++)l[w]=u[y+w]^c[b*a+w];bo(l,0,u,y,s),h()})}return Gc(u),PE(e,o,d,c,l)}function tu(e){switch(e){case"a-z":return"abcdefghijklmnopqrstuvwxyz";case"A-Z":return"ABCDEFGHIJKLMNOPQRSTUVWXYZ";case"0-9":return"0123456789";case"-_":return"-_";default:throw new Error(`Unsupported alphabet: ${e}`)}}function Wl(...e){const t=e.map(tu).join("");if(t.length===0)throw new Error("No valid characters provided for random string generation.");const r=t.length;return(n,...s)=>{if(n<=0)throw new Error("Length must be a positive integer.");let i=t,o=r;s.length>0&&(i=s.map(tu).join(""),o=i.length);const a=Math.floor(256/o)*o,c=new Uint8Array(n*2),u=c.length;let d="",l=u,h;for(;d.length<n;)l>=u&&(crypto.getRandomValues(c),l=0),h=c[l++],h<a&&(d+=i[h%o]);return d}}const Zo=Wl("a-z","0-9","A-Z","-_");async function LE(e,t,r=3600){return await new rE(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r).sign(new TextEncoder().encode(t))}function $E(e,t){const r=new Uint8Array(e),n=new Uint8Array(t);let s=r.length^n.length;const i=Math.max(r.length,n.length);for(let o=0;o<i;o++)s|=(o<r.length?r[o]:0)^(o<n.length?n[o]:0);return s===0}async function ru(e){const t=await to("SHA-256").digest(e);return Ft.encode(t)}const rn={N:16384,r:16,p:1,dkLen:64};async function zl(e,t){return await UE(e.normalize("NFKC"),t,{N:rn.N,p:rn.p,r:rn.r,dkLen:rn.dkLen,maxmem:128*rn.N*rn.r*2})}const DE=async e=>{const t=_i.encode(crypto.getRandomValues(new Uint8Array(16))),r=await zl(e,t);return`${t}:${_i.encode(r)}`},qE=async({hash:e,password:t})=>{const[r,n]=e.split(":");if(!r||!n)throw new X("Invalid password hash");const s=await zl(t,r);return $E(s,bE(n))},WE=async({key:e,data:t})=>{const r=await to("SHA-256").digest(e),n=tN(t),s=ll(pl)(new Uint8Array(r));return Xv(s.encrypt(n))},zE=async({key:e,data:t})=>{const r=await to("SHA-256").digest(e),n=eN(t),s=ll(pl)(new Uint8Array(r));return new TextDecoder().decode(s.decrypt(n))};var ME=Object.defineProperty,jE=Object.defineProperties,VE=Object.getOwnPropertyDescriptors,nu=Object.getOwnPropertySymbols,FE=Object.prototype.hasOwnProperty,BE=Object.prototype.propertyIsEnumerable,su=(e,t,r)=>t in e?ME(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ar=(e,t)=>{for(var r in t||(t={}))FE.call(t,r)&&su(e,r,t[r]);if(nu)for(var r of nu(t))BE.call(t,r)&&su(e,r,t[r]);return e},kr=(e,t)=>jE(e,VE(t)),HE=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r}},KE=async(e,t)=>{var r,n,s,i,o,a;let c=t||{};const u={onRequest:[t?.onRequest],onResponse:[t?.onResponse],onSuccess:[t?.onSuccess],onError:[t?.onError],onRetry:[t?.onRetry]};if(!t||!t?.plugins)return{url:e,options:c,hooks:u};for(const d of t?.plugins||[]){if(d.init){const l=await((r=d.init)==null?void 0:r.call(d,e.toString(),t));c=l.options||c,e=l.url}u.onRequest.push((n=d.hooks)==null?void 0:n.onRequest),u.onResponse.push((s=d.hooks)==null?void 0:s.onResponse),u.onSuccess.push((i=d.hooks)==null?void 0:i.onSuccess),u.onError.push((o=d.hooks)==null?void 0:o.onError),u.onRetry.push((a=d.hooks)==null?void 0:a.onRetry)}return{url:e,options:c,hooks:u}},iu=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},ZE=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}};function JE(e){if(typeof e=="number")return new iu({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new iu(e);case"exponential":return new ZE(e);default:throw new Error("Invalid retry strategy")}}var GE=async e=>{const t={},r=async n=>typeof n=="function"?await n():n;if(e?.auth){if(e.auth.type==="Bearer"){const n=await r(e.auth.token);if(!n)return t;t.authorization=`Bearer ${n}`}else if(e.auth.type==="Basic"){const n=r(e.auth.username),s=r(e.auth.password);if(!n||!s)return t;t.authorization=`Basic ${btoa(`${n}:${s}`)}`}else if(e.auth.type==="Custom"){const n=r(e.auth.value);if(!n)return t;t.authorization=`${r(e.auth.prefix)} ${n}`}}return t},QE=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function YE(e){const t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";const n=t.split(";").shift()||"";return QE.test(n)?"json":r.has(n)||n.startsWith("text/")?"text":"blob"}function XE(e){try{return JSON.parse(e),!0}catch{return!1}}function Ml(e){if(e===void 0)return!1;const t=typeof e;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function ou(e){try{return JSON.parse(e)}catch{return e}}function au(e){return typeof e=="function"}function eA(e){if(e?.customFetchImpl)return e.customFetchImpl;if(typeof globalThis<"u"&&au(globalThis.fetch))return globalThis.fetch;if(typeof window<"u"&&au(window.fetch))return window.fetch;throw new Error("No fetch implementation found")}async function tA(e){const t=new Headers(e?.headers),r=await GE(e);for(const[n,s]of Object.entries(r||{}))t.set(n,s);if(!t.has("content-type")){const n=rA(e?.body);n&&t.set("content-type",n)}return t}function rA(e){return Ml(e)?"application/json":null}function nA(e){if(!e?.body)return null;const t=new Headers(e?.headers);if(Ml(e.body)&&!t.has("content-type")){for(const[r,n]of Object.entries(e?.body))n instanceof Date&&(e.body[r]=n.toISOString());return JSON.stringify(e.body)}return e.body}function sA(e,t){var r;if(t?.method)return t.method.toUpperCase();if(e.startsWith("@")){const n=(r=e.split("@")[1])==null?void 0:r.split("/")[0];return Vl.includes(n)?n.toUpperCase():t?.body?"POST":"GET"}return t?.body?"POST":"GET"}function iA(e,t){let r;return!e?.signal&&e?.timeout&&(r=setTimeout(()=>t?.abort(),e?.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}var oA=class jl extends Error{constructor(t,r){super(r||JSON.stringify(t,null,2)),this.issues=t,Object.setPrototypeOf(this,jl.prototype)}};async function aA(e,t){let r=await e["~standard"].validate(t);if(r.issues)throw new oA(r.issues);return r.value}var Vl=["get","post","put","patch","delete"];function cA(e,t){let{baseURL:r,params:n,query:s}=t||{query:{},params:{},baseURL:""},i=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r||"";if(e.startsWith("@")){const l=e.toString().split("@")[1].split("/")[0];Vl.includes(l)&&(e=e.replace(`@${l}/`,"/"))}i.endsWith("/")||(i+="/");let[o,a]=e.replace(i,"").split("?");const c=new URLSearchParams(a);for(const[l,h]of Object.entries(s||{}))h!=null&&c.set(l,String(h));if(n)if(Array.isArray(n)){const l=o.split("/").filter(h=>h.startsWith(":"));for(const[h,p]of l.entries()){const m=n[h];o=o.replace(p,m)}}else for(const[l,h]of Object.entries(n))o=o.replace(`:${l}`,String(h));o=o.split("/").map(encodeURIComponent).join("/"),o.startsWith("/")&&(o=o.slice(1));let u=c.toString();return u=u.length>0?`?${u}`.replace(/\+/g,"%20"):"",i.startsWith("http")?new URL(`${o}${u}`,i):`${i}${o}${u}`}var Z=async(e,t)=>{var r,n,s,i,o,a,c,u;const{hooks:d,url:l,options:h}=await KE(e,t),p=eA(h),m=new AbortController,y=(r=h.signal)!=null?r:m.signal,g=cA(l,h),b=nA(h),w=await tA(h),N=sA(l,h);let v=kr(Ar({},h),{url:g,headers:w,body:b,method:N,signal:y});for(const R of d.onRequest)if(R){const P=await R(v);P instanceof Object&&(v=P)}("pipeTo"in v&&typeof v.pipeTo=="function"||typeof((n=t?.body)==null?void 0:n.pipe)=="function")&&("duplex"in v||(v.duplex="half"));const{clearTimeout:k}=iA(h,m);let A=await p(v.url,v);k();const S={response:A,request:v};for(const R of d.onResponse)if(R){const P=await R(kr(Ar({},S),{response:(s=t?.hookOptions)!=null&&s.cloneResponse?A.clone():A}));P instanceof Response?A=P:P instanceof Object&&(A=P.response)}if(A.ok){if(!(v.method!=="HEAD"))return{data:"",error:null};const P=YE(A),D={data:"",response:A,request:v};if(P==="json"||P==="text"){const W=await A.text(),U=await((i=v.jsonParser)!=null?i:ou)(W);D.data=U}else D.data=await A[P]();v?.output&&v.output&&!v.disableValidation&&(D.data=await aA(v.output,D.data));for(const W of d.onSuccess)W&&await W(kr(Ar({},D),{response:(o=t?.hookOptions)!=null&&o.cloneResponse?A.clone():A}));return t?.throw?D.data:{data:D.data,error:null}}const q=(a=t?.jsonParser)!=null?a:ou,O=await A.text(),$=XE(O),I=$?await q(O):null,E={response:A,responseText:O,request:v,error:kr(Ar({},I),{status:A.status,statusText:A.statusText})};for(const R of d.onError)R&&await R(kr(Ar({},E),{response:(c=t?.hookOptions)!=null&&c.cloneResponse?A.clone():A}));if(t?.retry){const R=JE(t.retry),P=(u=t.retryAttempt)!=null?u:0;if(await R.shouldAttemptRetry(P,A)){for(const W of d.onRetry)W&&await W(S);const D=R.getDelay(P);return await new Promise(W=>setTimeout(W,D)),await Z(e,kr(Ar({},t),{retryAttempt:P+1}))}}if(t?.throw)throw new HE(A.status,A.statusText,$?I:O);return{data:null,error:kr(Ar({},I),{status:A.status,statusText:A.statusText})}};const Kr=e=>Wl("a-z","A-Z","0-9")(e||32),no=oe({id:C(),createdAt:Rn().default(()=>new Date),updatedAt:Rn().default(()=>new Date)});no.extend({providerId:C(),accountId:C(),userId:ba(),accessToken:C().nullish(),refreshToken:C().nullish(),idToken:C().nullish(),accessTokenExpiresAt:Rn().nullish(),refreshTokenExpiresAt:Rn().nullish(),scope:C().nullish(),password:C().nullish()});no.extend({email:C().transform(e=>e.toLowerCase()),emailVerified:mr().default(!1),name:C(),image:C().nullish()});no.extend({userId:ba(),expiresAt:Rn(),token:C(),ipAddress:C().nullish(),userAgent:C().nullish()});no.extend({value:C(),expiresAt:Rn(),identifier:C()});function Fl(e,t){const r=t.fields,n={};for(const s in e){const i=r[s];if(!i){n[s]=e[s];continue}i.returned!==!1&&(n[s]=e[s])}return n}function Ra(e,t){let r={...t==="user"?e.user?.additionalFields:{},...t==="session"?e.session?.additionalFields:{}};for(const n of e.plugins||[])n.schema&&n.schema[t]&&(r={...r,...n.schema[t].fields});return r}function cu(e,t){const r=Ra(e,"user");return Fl(t,{fields:r})}function vo(e,t){const r=Ra(e,"session");return Fl(t,{fields:r})}function uA(e,t){const r=t.action||"create",n=t.fields,s={};for(const i in n){if(i in e){if(n[i].input===!1){if(n[i].defaultValue){s[i]=n[i].defaultValue;continue}continue}if(n[i].validator?.input&&e[i]!==void 0){s[i]=n[i].validator.input.parse(e[i]);continue}if(n[i].transform?.input&&e[i]!==void 0){s[i]=n[i].transform?.input(e[i]);continue}s[i]=e[i];continue}if(n[i].defaultValue&&r==="create"){s[i]=n[i].defaultValue;continue}if(n[i].required&&r==="create")throw new T("BAD_REQUEST",{message:`${i} is required`})}return s}function Bl(e,t,r){const n=Ra(e,"user");return uA(t||{},{fields:n,action:r})}function No(e){if(e===null||typeof e!="object")return!1;const t=Object.getPrototypeOf(e);return t!==null&&t!==Object.prototype&&Object.getPrototypeOf(t)!==null||Symbol.iterator in e?!1:Symbol.toStringTag in e?Object.prototype.toString.call(e)==="[object Module]":!0}function Jo(e,t,r=".",n){if(!No(t))return Jo(e,{},r,n);const s=Object.assign({},t);for(const i in e){if(i==="__proto__"||i==="constructor")continue;const o=e[i];o!=null&&(n&&n(s,i,o,r)||(Array.isArray(o)&&Array.isArray(s[i])?s[i]=[...o,...s[i]]:No(o)&&No(s[i])?s[i]=Jo(o,s[i],(r?`${r}.`:"")+i.toString(),n):s[i]=o))}return s}function Hl(e){return(...t)=>t.reduce((r,n)=>Jo(r,n,"",e),{})}const dA=Hl();function Go(e){return e==="-"||e==="^"||e==="$"||e==="+"||e==="."||e==="("||e===")"||e==="|"||e==="["||e==="]"||e==="{"||e==="}"||e==="*"||e==="?"||e==="\\"?`\\${e}`:e}function lA(e){let t="";for(let r=0;r<e.length;r++)t+=Go(e[r]);return t}function Kl(e,t=!0){if(Array.isArray(e))return`(?:${e.map(d=>`^${Kl(d,t)}$`).join("|")})`;let r="",n="",s=".";t===!0?(r="/",n="[/\\\\]",s="[^/\\\\]"):t&&(r=t,n=lA(r),n.length>1?(n=`(?:${n})`,s=`((?!${n}).)`):s=`[^${n}]`);let i=t?`${n}+?`:"",o=t?`${n}*?`:"",a=t?e.split(r):[e],c="";for(let u=0;u<a.length;u++){let d=a[u],l=a[u+1],h="";if(!(!d&&u>0)){if(t&&(u===a.length-1?h=o:l!=="**"?h=i:h=""),t&&d==="**"){h&&(c+=u===0?"":h,c+=`(?:${s}*?${h})*?`);continue}for(let p=0;p<d.length;p++){let m=d[p];m==="\\"?p<d.length-1&&(c+=Go(d[p+1]),p++):m==="?"?c+=s:m==="*"?c+=`${s}*?`:c+=Go(m)}c+=h}}return c}function hA(e,t){if(typeof t!="string")throw new TypeError(`Sample must be a string, but ${typeof t} given`);return e.test(t)}function ks(e,t){if(typeof e!="string"&&!Array.isArray(e))throw new TypeError(`The first argument must be a single pattern string or an array of patterns, but ${typeof e} given`);if((typeof t=="string"||typeof t=="boolean")&&(t={separator:t}),arguments.length===2&&!(typeof t>"u"||typeof t=="object"&&t!==null&&!Array.isArray(t)))throw new TypeError(`The second argument must be an options object or a string/boolean separator, but ${typeof t} given`);if(t=t||{},t.separator==="\\")throw new Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");let r=Kl(e,t.separator),n=new RegExp(`^${r}$`,t.flags),s=hA.bind(null,n);return s.options=t,s.pattern=e,s.regexp=n,s}const fA=Wn(async e=>{if(e.request?.method!=="POST"||!e.request)return;const{body:t,query:r,context:n}=e,s=e.headers?.get("origin")||e.headers?.get("referer")||"",i=t?.callbackURL||r?.callbackURL,o=t?.redirectTo,a=t?.errorCallbackURL,c=t?.newUserCallbackURL,u=Array.isArray(n.options.trustedOrigins)?n.trustedOrigins:[...n.trustedOrigins,...await n.options.trustedOrigins?.(e.request)||[]],d=e.headers?.has("cookie"),l=(p,m)=>{if(p.startsWith("/"))return!1;if(m.includes("*"))return m.includes("://")?ks(m)(On(p)||p):ks(m)(tl(p));const y=el(p);return y==="http:"||y==="https:"||!y?m===On(p):p.startsWith(m)},h=(p,m)=>{if(!p)return;if(!u.some(g=>l(p,g)||p?.startsWith("/")&&m!=="origin"&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(p)))throw e.context.logger.error(`Invalid ${m}: ${p}`),e.context.logger.info(`If it's a valid URL, please add ${p} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${u}`),new T("FORBIDDEN",{message:`Invalid ${m}`})};d&&!e.context.options.advanced?.disableCSRFCheck&&h(s,"origin"),i&&h(i,"callbackURL"),o&&h(o,"redirectURL"),a&&h(a,"errorCallbackURL"),c&&h(c,"newUserCallbackURL")}),Oa=e=>Wn(async t=>{if(!t.request)return;const{context:r}=t,n=e(t),s=Array.isArray(r.options.trustedOrigins)?r.trustedOrigins:[...r.trustedOrigins,...await r.options.trustedOrigins?.(t.request)||[]],i=(c,u)=>{if(c.startsWith("/"))return!1;if(u.includes("*"))return u.includes("://")?ks(u)(On(c)||c):ks(u)(tl(c));const d=el(c);return d==="http:"||d==="https:"||!d?u===On(c):c.startsWith(u)},o=(c,u)=>{if(!c)return;if(!s.some(l=>i(c,l)||c?.startsWith("/")&&u!=="origin"&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(c)))throw t.context.logger.error(`Invalid ${u}: ${c}`),t.context.logger.info(`If it's a valid URL, please add ${c} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${s}`),new T("FORBIDDEN",{message:`Invalid ${u}`})},a=Array.isArray(n)?n:[n];for(const c of a)o(c,"callbackURL")});async function Wr(e,t,r,n=3600){return await LE({email:t.toLowerCase(),updateTo:r},e,n)}async function uu(e,t){if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new T("BAD_REQUEST",{message:"Verification email isn't enabled"});const r=await Wr(e.context.secret,t.email,void 0,e.context.options.emailVerification?.expiresIn),n=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:t,url:n,token:r},e.request)}const pA=ee("/send-verification-email",{method:"POST",body:oe({email:C().email().describe("The email to send the verification email to"),callbackURL:C().describe("The URL to use for email verification callback").optional()}),metadata:{openapi:{description:"Send a verification email to the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{email:{type:"string",description:"The email to send the verification email to",example:"user@example.com"},callbackURL:{type:"string",description:"The URL to use for email verification callback",example:"https://example.com/callback",nullable:!0}},required:["email"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the email was sent successfully",example:!0}}}}}},400:{description:"Bad Request",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Error message",example:"Verification email isn't enabled"}}}}}}}}}},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new T("BAD_REQUEST",{message:"Verification email isn't enabled"});const{email:t}=e.body,r=await Rt(e);if(!r){const n=await e.context.internalAdapter.findUserByEmail(t);return n?(await uu(e,n.user),e.json({status:!0})):e.json({status:!0})}if(r?.user.emailVerified)throw new T("BAD_REQUEST",{message:"You can only send a verification email to an unverified email"});if(r?.user.email!==t)throw new T("BAD_REQUEST",{message:"You can only send a verification email to your own email"});return await uu(e,r.user),e.json({status:!0})}),mA=ee("/verify-email",{method:"GET",query:oe({token:C().describe("The token to verify the email"),callbackURL:C().describe("The URL to redirect to after email verification").optional()}),use:[Oa(e=>e.query.callbackURL)],metadata:{openapi:{description:"Verify the email of the user",parameters:[{name:"token",in:"query",description:"The token to verify the email",required:!0,schema:{type:"string"}},{name:"callbackURL",in:"query",description:"The URL to redirect to after email verification",required:!1,schema:{type:"string"}}],responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",properties:{id:{type:"string",description:"User ID"},email:{type:"string",description:"User email"},name:{type:"string",description:"User name"},image:{type:"string",description:"User image URL"},emailVerified:{type:"boolean",description:"Indicates if the user email is verified"},createdAt:{type:"string",description:"User creation date"},updatedAt:{type:"string",description:"User update date"}},required:["id","email","name","image","emailVerified","createdAt","updatedAt"]},status:{type:"boolean",description:"Indicates if the email was verified successfully"}},required:["user","status"]}}}}}}}},async e=>{function t(c){throw e.query.callbackURL?e.query.callbackURL.includes("?")?e.redirect(`${e.query.callbackURL}&error=${c}`):e.redirect(`${e.query.callbackURL}?error=${c}`):new T("UNAUTHORIZED",{message:c})}const{token:r}=e.query;let n;try{n=await ro(r,new TextEncoder().encode(e.context.secret),{algorithms:["HS256"]})}catch(c){return c instanceof Bo?t("token_expired"):t("invalid_token")}const i=oe({email:C().email(),updateTo:C().optional()}).parse(n.payload),o=await e.context.internalAdapter.findUserByEmail(i.email);if(!o)return t("user_not_found");if(i.updateTo){const c=await Rt(e);if(!c){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return t("unauthorized")}if(c.user.email!==i.email){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return t("unauthorized")}const u=await e.context.internalAdapter.updateUserByEmail(i.email,{email:i.updateTo,emailVerified:!1},e),d=await Wr(e.context.secret,i.updateTo);if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:u,url:`${e.context.baseURL}/verify-email?token=${d}&callbackURL=${e.query.callbackURL||"/"}`,token:d},e.request),await yt(e,{session:c.session,user:{...c.user,email:i.updateTo,emailVerified:!1}}),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:{id:u.id,email:u.email,name:u.name,image:u.image,emailVerified:u.emailVerified,createdAt:u.createdAt,updatedAt:u.updatedAt}})}e.context.options.emailVerification?.onEmailVerification&&await e.context.options.emailVerification.onEmailVerification(o.user,e.request);const a=await e.context.internalAdapter.updateUserByEmail(i.email,{emailVerified:!0},e);if(e.context.options.emailVerification?.afterEmailVerification&&await e.context.options.emailVerification.afterEmailVerification(a,e.request),e.context.options.emailVerification?.autoSignInAfterVerification){const c=await Rt(e);if(!c||c.user.email!==i.email){const u=await e.context.internalAdapter.createSession(o.user.id,e);if(!u)throw new T("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await yt(e,{session:u,user:{...o.user,emailVerified:!0}})}else await yt(e,{session:c.session,user:{...c.user,emailVerified:!0}})}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:null})}),Ia={isAction:!1};async function Zl(e,t){const r=e.body?.callbackURL||e.context.options.baseURL;if(!r)throw new T("BAD_REQUEST",{message:"callbackURL is required"});const n=Zo(128),s=Zo(32),i=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL,newUserURL:e.body?.newUserCallbackURL,link:t,expiresAt:Date.now()+600*1e3,requestSignUp:e.body?.requestSignUp}),o=new Date;o.setMinutes(o.getMinutes()+10);const a=await e.context.internalAdapter.createVerificationValue({value:i,identifier:s,expiresAt:o},e);if(!a)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new T("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:a.identifier,codeVerifier:n}}async function yA(e){const t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r){e.context.logger.error("State Mismatch. Verification not found",{state:t});const s=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${s}?error=please_restart_the_process`)}const n=oe({callbackURL:C(),codeVerifier:C(),errorURL:C().optional(),newUserURL:C().optional(),expiresAt:Fd(),link:oe({email:C(),userId:ba()}).optional(),requestSignUp:mr().optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now()){await e.context.internalAdapter.deleteVerificationValue(r.id);const s=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${s}?error=please_restart_the_process`)}return await e.context.internalAdapter.deleteVerificationValue(r.id),n}async function Jl(e){const t=await to("SHA-256").digest(e);return Xi.encode(new Uint8Array(t),{padding:!1})}function Gl(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?yr(e.expires_in,"sec"):void 0,refreshTokenExpiresAt:e.refresh_token_expires_in?yr(e.refresh_token_expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}function wA(e,t){return e&&(t.options.account?.encryptOAuthTokens?zE({key:t.secret,data:e}):e)}function Qe(e,t){return t.options.account?.encryptOAuthTokens&&e?WE({key:t.secret,data:e}):e}async function Ql(e,{userInfo:t,account:r,callbackURL:n,disableSignUp:s,overrideUserInfo:i}){const o=await e.context.internalAdapter.findOAuthUser(t.email.toLowerCase(),r.accountId,r.providerId).catch(d=>{K.error(`Better auth was unable to query your database.
Error: `,d);const l=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${l}?error=internal_server_error`)});let a=o?.user,c=!a;if(o){const d=o.accounts.find(l=>l.providerId===r.providerId&&l.accountId===r.accountId);if(d){if(e.context.options.account?.updateAccountOnSignIn!==!1){const l=Object.fromEntries(Object.entries({idToken:r.idToken,accessToken:await Qe(r.accessToken,e.context),refreshToken:await Qe(r.refreshToken,e.context),accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope}).filter(([h,p])=>p!==void 0));Object.keys(l).length>0&&await e.context.internalAdapter.updateAccount(d.id,l,e)}t.emailVerified&&!o.user.emailVerified&&t.email.toLowerCase()===o.user.email&&await e.context.internalAdapter.updateUser(o.user.id,{emailVerified:!0})}else{if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.providerId)&&!t.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return va&&K.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:t.id.toString(),userId:o.user.id,accessToken:await Qe(r.accessToken,e.context),refreshToken:await Qe(r.refreshToken,e.context),idToken:r.idToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope},e)}catch(p){return K.error("Unable to link account",p),{error:"unable to link account",data:null}}t.emailVerified&&!o.user.emailVerified&&t.email.toLowerCase()===o.user.email&&await e.context.internalAdapter.updateUser(o.user.id,{emailVerified:!0})}if(i){const{id:l,...h}=t;await e.context.internalAdapter.updateUser(o.user.id,{...h,email:t.email.toLowerCase(),emailVerified:t.email.toLowerCase()===o.user.email&&o.user.emailVerified||t.emailVerified})}}else{if(s)return{error:"signup disabled",data:null,isRegister:!1};try{const{id:d,...l}=t;if(a=await e.context.internalAdapter.createOAuthUser({...l,email:t.email.toLowerCase()},{accessToken:await Qe(r.accessToken,e.context),refreshToken:await Qe(r.refreshToken,e.context),idToken:r.idToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope,providerId:r.providerId,accountId:t.id.toString()},e).then(h=>h?.user),!t.emailVerified&&a&&e.context.options.emailVerification?.sendOnSignUp){const h=await Wr(e.context.secret,a.email,void 0,e.context.options.emailVerification?.expiresIn),p=`${e.context.baseURL}/verify-email?token=${h}&callbackURL=${n}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:a,url:p,token:h},e.request)}}catch(d){return K.error(d),d instanceof T?{error:d.message,data:null,isRegister:!1}:{error:"unable to create user",data:null,isRegister:!1}}}if(!a)return{error:"unable to create user",data:null,isRegister:!1};const u=await e.context.internalAdapter.createSession(a.id,e);return u?{data:{session:u,user:a},error:null,isRegister:c}:{error:"unable to create session",data:null,isRegister:!1}}async function fe({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:s,scopes:i,claims:o,redirectURI:a,duration:c,prompt:u,accessType:d,responseType:l,display:h,loginHint:p,hd:m,responseMode:y,additionalParams:g,scopeJoiner:b}){const w=new URL(r);w.searchParams.set("response_type",l||"code");const N=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;if(w.searchParams.set("client_id",N),w.searchParams.set("state",n),w.searchParams.set("scope",i.join(b||" ")),w.searchParams.set("redirect_uri",t.redirectURI||a),c&&w.searchParams.set("duration",c),h&&w.searchParams.set("display",h),p&&w.searchParams.set("login_hint",p),u&&w.searchParams.set("prompt",u),m&&w.searchParams.set("hd",m),d&&w.searchParams.set("access_type",d),y&&w.searchParams.set("response_mode",y),s){const v=await Jl(s);w.searchParams.set("code_challenge_method","S256"),w.searchParams.set("code_challenge",v)}if(o){const v=o.reduce((k,A)=>(k[A]=null,k),{});w.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...v}}))}return g&&Object.entries(g).forEach(([v,k])=>{w.searchParams.set(v,k)}),w}function gA({code:e,codeVerifier:t,redirectURI:r,options:n,authentication:s,deviceId:i,headers:o,additionalParams:a={},resource:c}){const u=new URLSearchParams,d={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth",...o};if(u.set("grant_type","authorization_code"),u.set("code",e),t&&u.set("code_verifier",t),n.clientKey&&u.set("client_key",n.clientKey),i&&u.set("device_id",i),u.set("redirect_uri",n.redirectURI||r),c)if(typeof c=="string")u.append("resource",c);else for(const l of c)u.append("resource",l);if(s==="basic"){const l=Array.isArray(n.clientId)?n.clientId[0]:n.clientId,h=Ft.encode(`${l}:${n.clientSecret??""}`);d.authorization=`Basic ${h}`}else{const l=Array.isArray(n.clientId)?n.clientId[0]:n.clientId;u.set("client_id",l),n.clientSecret&&u.set("client_secret",n.clientSecret)}for(const[l,h]of Object.entries(a))u.has(l)||u.append(l,h);return{body:u,headers:d}}async function ae({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:s,authentication:i,deviceId:o,headers:a,additionalParams:c={},resource:u}){const{body:d,headers:l}=gA({code:e,codeVerifier:t,redirectURI:r,options:n,authentication:i,deviceId:o,headers:a,additionalParams:c,resource:u}),{data:h,error:p}=await Z(s,{method:"POST",body:d,headers:l});if(p)throw p;return Gl(h)}function bA({refreshToken:e,options:t,authentication:r,extraParams:n,resource:s}){const i=new URLSearchParams,o={"content-type":"application/x-www-form-urlencoded",accept:"application/json"};if(i.set("grant_type","refresh_token"),i.set("refresh_token",e),r==="basic"){const a=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;a?o.authorization="Basic "+Ft.encode(`${a}:${t.clientSecret??""}`):o.authorization="Basic "+Ft.encode(`:${t.clientSecret??""}`)}else{const a=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;i.set("client_id",a),t.clientSecret&&i.set("client_secret",t.clientSecret)}if(s)if(typeof s=="string")i.append("resource",s);else for(const a of s)i.append("resource",a);if(n)for(const[a,c]of Object.entries(n))i.set(a,c);return{body:i,headers:o}}async function ue({refreshToken:e,options:t,tokenEndpoint:r,authentication:n,extraParams:s}){const{body:i,headers:o}=bA({refreshToken:e,options:t,authentication:n,extraParams:s}),{data:a,error:c}=await Z(r,{method:"POST",body:i,headers:o});if(c)throw c;const u={accessToken:a.access_token,refreshToken:a.refresh_token,tokenType:a.token_type,scopes:a.scope?.split(" "),idToken:a.id_token};if(a.expires_in){const d=new Date;u.accessTokenExpiresAt=new Date(d.getTime()+a.expires_in*1e3)}return u}const vA=e=>{const t="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",async createAuthorizationURL({state:r,scopes:n,redirectURI:s}){const i=e.disableDefaultScope?[]:["email","name"];return e.scope&&i.push(...e.scope),n&&i.push(...n),await fe({id:"apple",options:e,authorizationEndpoint:"https://appleid.apple.com/auth/authorize",scopes:i,state:r,redirectURI:s,responseMode:"form_post",responseType:"code id_token"})},validateAuthorizationCode:async({code:r,codeVerifier:n,redirectURI:s})=>ae({code:r,codeVerifier:n,redirectURI:s,options:e,tokenEndpoint:t}),async verifyIdToken(r,n){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,n);const s=Cl(r),{kid:i,alg:o}=s;if(!i||!o)return!1;const a=await NA(i),{payload:c}=await ro(r,a,{algorithms:[o],issuer:"https://appleid.apple.com",audience:e.audience&&e.audience.length?e.audience:e.appBundleIdentifier?e.appBundleIdentifier:e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(u=>{c[u]!==void 0&&(c[u]=!!c[u])}),n&&c.nonce!==n?!1:!!c},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ue({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://appleid.apple.com/auth/token"}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);if(!r.idToken)return null;const n=Nr(r.idToken);if(!n)return null;const s=r.user?`${r.user.name?.firstName} ${r.user.name?.lastName}`:n.name||n.email,i=typeof n.email_verified=="boolean"?n.email_verified:n.email_verified==="true",o={...n,name:s},a=await e.mapProfileToUser?.(o);return{user:{id:n.sub,name:o.name,emailVerified:i,email:n.email,...a},data:o}},options:e}},NA=async e=>{const t="https://appleid.apple.com",r="/auth/keys",{data:n}=await Z(`${t}${r}`);if(!n?.keys)throw new T("BAD_REQUEST",{message:"Keys not found"});const s=n.keys.find(i=>i.kid===e);if(!s)throw new Error(`JWK with kid ${e} not found`);return await Ta(s,s.alg)},EA=e=>({id:"atlassian",name:"Atlassian",async createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:s}){if(!e.clientId||!e.clientSecret)throw K.error("Client Id and Secret are required for Atlassian"),new X("CLIENT_ID_AND_SECRET_REQUIRED");if(!n)throw new X("codeVerifier is required for Atlassian");const i=e.disableDefaultScope?[]:["read:jira-user","offline_access"];return e.scope&&i.push(...e.scope),r&&i.push(...r),fe({id:"atlassian",options:e,authorizationEndpoint:"https://auth.atlassian.com/authorize",scopes:i,state:t,codeVerifier:n,redirectURI:s,additionalParams:{audience:"api.atlassian.com"},prompt:e.prompt})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ae({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://auth.atlassian.com/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:"https://auth.atlassian.com/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return null;try{const{data:r}=await Z("https://api.atlassian.com/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(!r)return null;const n=await e.mapProfileToUser?.(r);return{user:{id:r.account_id,name:r.name,email:r.email,image:r.picture,emailVerified:!1,...n},data:r}}catch(r){return K.error("Failed to fetch user info from Figma:",r),null}},options:e}),AA=e=>{if(!e.domain||!e.region||!e.userPoolId)throw K.error("Domain, region and userPoolId are required for Amazon Cognito. Make sure to provide them in the options."),new X("DOMAIN_AND_REGION_REQUIRED");const t=e.domain.replace(/^https?:\/\//,""),r=`https://${t}/oauth2/authorize`,n=`https://${t}/oauth2/token`,s=`https://${t}/oauth2/userinfo`;return{id:"cognito",name:"Cognito",async createAuthorizationURL({state:i,scopes:o,codeVerifier:a,redirectURI:c}){if(!e.clientId)throw K.error("ClientId is required for Amazon Cognito. Make sure to provide them in the options."),new X("CLIENT_ID_AND_SECRET_REQUIRED");if(e.requireClientSecret&&!e.clientSecret)throw K.error("Client Secret is required when requireClientSecret is true. Make sure to provide it in the options."),new X("CLIENT_SECRET_REQUIRED");const u=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&u.push(...e.scope),o&&u.push(...o),await fe({id:"cognito",options:{...e},authorizationEndpoint:r,scopes:u,state:i,codeVerifier:a,redirectURI:c,prompt:e.prompt})},validateAuthorizationCode:async({code:i,codeVerifier:o,redirectURI:a})=>ae({code:i,codeVerifier:o,redirectURI:a,options:e,tokenEndpoint:n}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async i=>ue({refreshToken:i,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:n}),async verifyIdToken(i,o){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(i,o);try{const a=Cl(i),{kid:c,alg:u}=a;if(!c||!u)return!1;const d=await kA(c,e.region,e.userPoolId),l=`https://cognito-idp.${e.region}.amazonaws.com/${e.userPoolId}`,{payload:h}=await ro(i,d,{algorithms:[u],issuer:l,audience:e.clientId,maxTokenAge:"1h"});return!(o&&h.nonce!==o)}catch(a){return K.error("Failed to verify ID token:",a),!1}},async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);if(i.idToken)try{const o=Nr(i.idToken);if(!o)return null;const a=o.name||o.given_name||o.username||o.email,c={...o,name:a},u=await e.mapProfileToUser?.(c);return{user:{id:o.sub,name:c.name,email:o.email,image:o.picture,emailVerified:o.email_verified,...u},data:c}}catch(o){K.error("Failed to decode ID token:",o)}if(i.accessToken)try{const{data:o}=await Z(s,{headers:{Authorization:`Bearer ${i.accessToken}`}});if(o){const a=await e.mapProfileToUser?.(o);return{user:{id:o.sub,name:o.name||o.given_name||o.username,email:o.email,image:o.picture,emailVerified:o.email_verified,...a},data:o}}}catch(o){K.error("Failed to fetch user info from Cognito:",o)}return null},options:e}},kA=async(e,t,r)=>{const n=`https://cognito-idp.${t}.amazonaws.com/${r}/.well-known/jwks.json`;try{const{data:s}=await Z(n);if(!s?.keys)throw new T("BAD_REQUEST",{message:"Keys not found"});const i=s.keys.find(o=>o.kid===e);if(!i)throw new Error(`JWK with kid ${e} not found`);return await Ta(i,i.alg)}catch(s){throw K.error("Failed to fetch Cognito public key:",s),s}},TA=e=>({id:"discord",name:"Discord",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const s=e.disableDefaultScope?[]:["identify","email"];r&&s.push(...r),e.scope&&s.push(...e.scope);const o=s.includes("bot")&&e.permissions!==void 0?`&permissions=${e.permissions}`:"";return new URL(`https://discord.com/api/oauth2/authorize?scope=${s.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}&prompt=${e.prompt||"none"}${o}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>ae({code:t,redirectURI:r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${t.accessToken}`}});if(n)return null;if(r.avatar===null){const i=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${i}.png`}else{const i=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${i}`}const s=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.global_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url,...s},data:r}},options:e}),_A=e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:t,scopes:r,redirectURI:n,loginHint:s}){const i=e.disableDefaultScope?[]:["email","public_profile"];return e.scope&&i.push(...e.scope),r&&i.push(...r),await fe({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:i,state:t,redirectURI:n,loginHint:s,additionalParams:e.configId?{config_id:e.configId}:{}})},validateAuthorizationCode:async({code:t,redirectURI:r})=>ae({code:t,redirectURI:r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);if(t.split(".").length===3)try{const{payload:n}=await ro(t,hE(new URL("https://limited.facebook.com/.well-known/oauth/openid/jwks/")),{algorithms:["RS256"],audience:e.clientId,issuer:"https://www.facebook.com"});return r&&n.nonce!==r?!1:!!n}catch{return!1}return!0},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://graph.facebook.com/v18.0/oauth/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(t.idToken&&t.idToken.split(".").length===3){const o=Nr(t.idToken),a={id:o.sub,name:o.name,email:o.email,picture:{data:{url:o.picture,height:100,width:100,is_silhouette:!1}}},c=await e.mapProfileToUser?.({...a,email_verified:!0});return{user:{...a,emailVerified:!0,...c},data:o}}const r=["id","name","email","picture",...e?.fields||[]],{data:n,error:s}=await Z("https://graph.facebook.com/me?fields="+r.join(","),{auth:{type:"Bearer",token:t.accessToken}});if(s)return null;const i=await e.mapProfileToUser?.(n);return{user:{id:n.id,name:n.name,email:n.email,image:n.picture.data.url,emailVerified:n.email_verified,...i},data:n}},options:e}),SA=e=>({id:"figma",name:"Figma",async createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:s}){if(!e.clientId||!e.clientSecret)throw K.error("Client Id and Client Secret are required for Figma. Make sure to provide them in the options."),new X("CLIENT_ID_AND_SECRET_REQUIRED");if(!n)throw new X("codeVerifier is required for Figma");const i=e.disableDefaultScope?[]:["file_read"];return e.scope&&i.push(...e.scope),r&&i.push(...r),await fe({id:"figma",options:e,authorizationEndpoint:"https://www.figma.com/oauth",scopes:i,state:t,codeVerifier:n,redirectURI:s})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ae({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://www.figma.com/api/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.figma.com/api/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);try{const{data:r}=await Z("https://api.figma.com/v1/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(!r)return K.error("Failed to fetch user from Figma"),null;const n=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.handle,email:r.email,image:r.img_url,emailVerified:!!r.email,...n},data:r}}catch(r){return K.error("Failed to fetch user info from Figma:",r),null}},options:e}),RA=e=>{const t="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:n,loginHint:s,redirectURI:i}){const o=e.disableDefaultScope?[]:["read:user","user:email"];return e.scope&&o.push(...e.scope),n&&o.push(...n),fe({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:o,state:r,redirectURI:i,loginHint:s,prompt:e.prompt})},validateAuthorizationCode:async({code:r,redirectURI:n})=>ae({code:r,redirectURI:n,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ue({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://github.com/login/oauth/access_token"}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);const{data:n,error:s}=await Z("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(s)return null;const{data:i}=await Z("https://api.github.com/user/emails",{headers:{Authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});!n.email&&i&&(n.email=(i.find(c=>c.primary)??i[0])?.email);const o=i?.find(c=>c.email===n.email)?.verified??!1,a=await e.mapProfileToUser?.(n);return{user:{id:n.id,name:n.name||n.login,email:n.email,image:n.avatar_url,emailVerified:o,...a},data:n}},options:e}},OA=e=>({id:"google",name:"Google",async createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:s,loginHint:i,display:o}){if(!e.clientId||!e.clientSecret)throw K.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new X("CLIENT_ID_AND_SECRET_REQUIRED");if(!n)throw new X("codeVerifier is required for Google");const a=e.disableDefaultScope?[]:["email","profile","openid"];return e.scope&&a.push(...e.scope),r&&a.push(...r),await fe({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:a,state:t,codeVerifier:n,redirectURI:s,prompt:e.prompt,accessType:e.accessType,display:o||e.display,loginHint:i,hd:e.hd,additionalParams:{include_granted_scopes:"true"}})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ae({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);const n=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${t}`,{data:s}=await Z(n);return s?s.aud===e.clientId&&(s.iss==="https://accounts.google.com"||s.iss==="accounts.google.com"):!1},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;const r=Nr(t.idToken),n=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...n},data:r}},options:e}),IA=e=>({id:"kick",name:"Kick",createAuthorizationURL({state:t,scopes:r,redirectURI:n,codeVerifier:s}){const i=e.disableDefaultScope?[]:["user:read"];return e.scope&&i.push(...e.scope),r&&i.push(...r),fe({id:"kick",redirectURI:n,options:e,authorizationEndpoint:"https://id.kick.com/oauth/authorize",scopes:i,codeVerifier:s,state:t})},async validateAuthorizationCode({code:t,redirectURI:r,codeVerifier:n}){return ae({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.kick.com/oauth/token",codeVerifier:n})},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://api.kick.com/public/v1/users",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const s=r.data[0],i=await e.mapProfileToUser?.(s);return{user:{id:s.user_id,name:s.name,email:s.email,image:s.profile_picture,emailVerified:!0,...i},data:s}},options:e}),xA=e=>({id:"huggingface",name:"Hugging Face",createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:s}){const i=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&i.push(...e.scope),r&&i.push(...r),fe({id:"huggingface",options:e,authorizationEndpoint:"https://huggingface.co/oauth/authorize",scopes:i,state:t,codeVerifier:n,redirectURI:s})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ae({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://huggingface.co/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://huggingface.co/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://huggingface.co/oauth/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const s=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name||r.preferred_username,email:r.email,image:r.picture,emailVerified:r.email_verified??!1,...s},data:r}},options:e}),CA=e=>{const t=e.tenantId||"common",r=e.authority||"https://login.microsoftonline.com",n=`${r}/${t}/oauth2/v2.0/authorize`,s=`${r}/${t}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(i){const o=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&o.push(...e.scope),i.scopes&&o.push(...i.scopes),fe({id:"microsoft",options:e,authorizationEndpoint:n,state:i.state,codeVerifier:i.codeVerifier,scopes:o,redirectURI:i.redirectURI,prompt:e.prompt,loginHint:i.loginHint})},validateAuthorizationCode({code:i,codeVerifier:o,redirectURI:a}){return ae({code:i,codeVerifier:o,redirectURI:a,options:e,tokenEndpoint:s})},async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);if(!i.idToken)return null;const o=Nr(i.idToken),a=e.profilePhotoSize||48;await Z(`https://graph.microsoft.com/v1.0/me/photos/${a}x${a}/$value`,{headers:{Authorization:`Bearer ${i.accessToken}`},async onResponse(u){if(!(e.disableProfilePhoto||!u.response.ok))try{const l=await u.response.clone().arrayBuffer(),h=Ft.encode(l);o.picture=`data:image/jpeg;base64, ${h}`}catch(d){K.error(d&&typeof d=="object"&&"name"in d?d.name:"",d)}}});const c=await e.mapProfileToUser?.(o);return{user:{id:o.sub,name:o.name,email:o.email,image:o.picture,emailVerified:!0,...c},data:o}},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async i=>{const o=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&o.push(...e.scope),ue({refreshToken:i,options:{clientId:e.clientId,clientSecret:e.clientSecret},extraParams:{scope:o.join(" ")},tokenEndpoint:s})},options:e}},PA=e=>({id:"slack",name:"Slack",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const s=e.disableDefaultScope?[]:["openid","profile","email"];r&&s.push(...r),e.scope&&s.push(...e.scope);const i=new URL("https://slack.com/openid/connect/authorize");return i.searchParams.set("scope",s.join(" ")),i.searchParams.set("response_type","code"),i.searchParams.set("client_id",e.clientId),i.searchParams.set("redirect_uri",e.redirectURI||n),i.searchParams.set("state",t),i},validateAuthorizationCode:async({code:t,redirectURI:r})=>ae({code:t,redirectURI:r,options:e,tokenEndpoint:"https://slack.com/api/openid.connect.token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://slack.com/api/openid.connect.token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://slack.com/api/openid.connect.userInfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(n)return null;const s=await e.mapProfileToUser?.(r);return{user:{id:r["https://slack.com/user_id"],name:r.name||"",email:r.email,emailVerified:r.email_verified,image:r.picture||r["https://slack.com/user_image_512"],...s},data:r}},options:e}),UA=e=>{const t="https://api.notion.com/v1/oauth/token";return{id:"notion",name:"Notion",createAuthorizationURL({state:r,scopes:n,loginHint:s,redirectURI:i}){const o=e.disableDefaultScope?[]:[];return e.scope&&o.push(...e.scope),n&&o.push(...n),fe({id:"notion",options:e,authorizationEndpoint:"https://api.notion.com/v1/oauth/authorize",scopes:o,state:r,redirectURI:i,loginHint:s,additionalParams:{owner:"user"}})},validateAuthorizationCode:async({code:r,redirectURI:n})=>ae({code:r,redirectURI:n,options:e,tokenEndpoint:t,authentication:"basic"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ue({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);const{data:n,error:s}=await Z("https://api.notion.com/v1/users/me",{headers:{Authorization:`Bearer ${r.accessToken}`,"Notion-Version":"2022-06-28"}});if(s||!n)return null;const i=n.bot?.owner?.user;if(!i)return null;const o=await e.mapProfileToUser?.(i);return{user:{id:i.id,name:i.name||"Notion User",email:i.person?.email||null,image:i.avatar_url,emailVerified:!!i.person?.email,...o},data:i}},options:e}},LA=e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:s}){const i=e.disableDefaultScope?[]:["user-read-email"];return e.scope&&i.push(...e.scope),r&&i.push(...r),fe({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:i,state:t,codeVerifier:n,redirectURI:s})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ae({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const s=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1,...s},data:r}},options:e}),$A=e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const s=e.disableDefaultScope?[]:["user:read:email","openid"];return e.scope&&s.push(...e.scope),r&&s.push(...r),fe({id:"twitch",redirectURI:n,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:s,state:t,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:t,redirectURI:r})=>ae({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const r=t.idToken;if(!r)return K.error("No idToken found in token"),null;const n=Nr(r),s=await e.mapProfileToUser?.(n);return{user:{id:n.sub,name:n.preferred_username,email:n.email,image:n.picture,emailVerified:n.email_verified,...s},data:n}},options:e}),DA=e=>({id:"twitter",name:"Twitter",createAuthorizationURL(t){const r=e.disableDefaultScope?[]:["users.read","tweet.read","offline.access","users.email"];return e.scope&&r.push(...e.scope),t.scopes&&r.push(...t.scopes),fe({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:t.state,codeVerifier:t.codeVerifier,redirectURI:t.redirectURI})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ae({code:t,codeVerifier:r,authentication:"basic",redirectURI:n,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},authentication:"basic",tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const{data:s,error:i}=await Z("https://api.x.com/2/users/me?user.fields=confirmed_email",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});let o=!1;!i&&s?.data?.confirmed_email&&(r.data.email=s.data.confirmed_email,o=!0);const a=await e.mapProfileToUser?.(r);return{user:{id:r.data.id,name:r.data.name,email:r.data.email||r.data.username||null,image:r.data.profile_image_url,emailVerified:o,...a},data:r}},options:e}),qA=e=>{const t="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:r,scopes:n,codeVerifier:s,redirectURI:i})=>{const o=e.disableDefaultScope?[]:["account_info.read"];e.scope&&o.push(...e.scope),n&&o.push(...n);const a={};return e.accessType&&(a.token_access_type=e.accessType),await fe({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:o,state:r,redirectURI:i,codeVerifier:s,additionalParams:a})},validateAuthorizationCode:async({code:r,codeVerifier:n,redirectURI:s})=>await ae({code:r,codeVerifier:n,redirectURI:s,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ue({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.dropbox.com/oauth2/token"}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);const{data:n,error:s}=await Z("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});if(s)return null;const i=await e.mapProfileToUser?.(n);return{user:{id:n.account_id,name:n.name?.display_name,email:n.email,emailVerified:n.email_verified||!1,image:n.profile_photo_url,...i},data:n}},options:e}},WA=e=>{const t="https://api.linear.app/oauth/token";return{id:"linear",name:"Linear",createAuthorizationURL({state:r,scopes:n,loginHint:s,redirectURI:i}){const o=e.disableDefaultScope?[]:["read"];return e.scope&&o.push(...e.scope),n&&o.push(...n),fe({id:"linear",options:e,authorizationEndpoint:"https://linear.app/oauth/authorize",scopes:o,state:r,redirectURI:i,loginHint:s})},validateAuthorizationCode:async({code:r,redirectURI:n})=>ae({code:r,redirectURI:n,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ue({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);const{data:n,error:s}=await Z("https://api.linear.app/graphql",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.accessToken}`},body:JSON.stringify({query:`
							query {
								viewer {
									id
									name
									email
									avatarUrl
									active
									createdAt
									updatedAt
								}
							}
						`})});if(s||!n?.data?.viewer)return null;const i=n.data.viewer,o=await e.mapProfileToUser?.(i);return{user:{id:n.data.viewer.id,name:n.data.viewer.name,email:n.data.viewer.email,image:n.data.viewer.avatarUrl,emailVerified:!0,...o},data:i}},options:e}},zA=e=>{const t="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:n,scopes:s,redirectURI:i,loginHint:o})=>{const a=e.disableDefaultScope?[]:["profile","email","openid"];return e.scope&&a.push(...e.scope),s&&a.push(...s),await fe({id:"linkedin",options:e,authorizationEndpoint:t,scopes:a,state:n,loginHint:o,redirectURI:i})},validateAuthorizationCode:async({code:n,redirectURI:s})=>await ae({code:n,redirectURI:s,options:e,tokenEndpoint:r}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async n=>ue({refreshToken:n,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:r}),async getUserInfo(n){if(e.getUserInfo)return e.getUserInfo(n);const{data:s,error:i}=await Z("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${n.accessToken}`}});if(i)return null;const o=await e.mapProfileToUser?.(s);return{user:{id:s.sub,name:s.name,email:s.email,emailVerified:s.email_verified||!1,image:s.picture,...o},data:s}},options:e}},Eo=(e="")=>e.split("://").map(t=>t.replace(/\/{2,}/g,"/")).join("://"),MA=e=>{let t=e||"https://gitlab.com";return{authorizationEndpoint:Eo(`${t}/oauth/authorize`),tokenEndpoint:Eo(`${t}/oauth/token`),userinfoEndpoint:Eo(`${t}/api/v4/user`)}},jA=e=>{const{authorizationEndpoint:t,tokenEndpoint:r,userinfoEndpoint:n}=MA(e.issuer),s="gitlab";return{id:s,name:"Gitlab",createAuthorizationURL:async({state:o,scopes:a,codeVerifier:c,loginHint:u,redirectURI:d})=>{const l=e.disableDefaultScope?[]:["read_user"];return e.scope&&l.push(...e.scope),a&&l.push(...a),await fe({id:s,options:e,authorizationEndpoint:t,scopes:l,state:o,redirectURI:d,codeVerifier:c,loginHint:u})},validateAuthorizationCode:async({code:o,redirectURI:a,codeVerifier:c})=>ae({code:o,redirectURI:a,options:e,codeVerifier:c,tokenEndpoint:r}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async o=>ue({refreshToken:o,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://gitlab.com/oauth/token"}),async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);const{data:a,error:c}=await Z(n,{headers:{authorization:`Bearer ${o.accessToken}`}});if(c||a.state!=="active"||a.locked)return null;const u=await e.mapProfileToUser?.(a);return{user:{id:a.id,name:a.name??a.username,email:a.email,image:a.avatar_url,emailVerified:!0,...u},data:a}},options:e}},VA=e=>({id:"tiktok",name:"TikTok",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const s=e.disableDefaultScope?[]:["user.info.profile"];return e.scope&&s.push(...e.scope),r&&s.push(...r),new URL(`https://www.tiktok.com/v2/auth/authorize?scope=${s.join(",")}&response_type=code&client_key=${e.clientKey}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>ae({code:t,redirectURI:e.redirectURI||r,options:{clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientSecret:e.clientSecret},tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/",authentication:"post",extraParams:{client_key:e.clientKey}}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const r=["open_id","avatar_large_url","display_name","username"],{data:n,error:s}=await Z(`https://open.tiktokapis.com/v2/user/info/?fields=${r.join(",")}`,{headers:{authorization:`Bearer ${t.accessToken}`}});return s?null:{user:{email:n.data.user.email||n.data.user.username,id:n.data.user.open_id,name:n.data.user.display_name||n.data.user.username,image:n.data.user.avatar_large_url,emailVerified:!!n.data.user.email},data:n}},options:e}),FA=e=>({id:"reddit",name:"Reddit",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const s=e.disableDefaultScope?[]:["identity"];return e.scope&&s.push(...e.scope),r&&s.push(...r),fe({id:"reddit",options:e,authorizationEndpoint:"https://www.reddit.com/api/v1/authorize",scopes:s,state:t,redirectURI:n,duration:e.duration})},validateAuthorizationCode:async({code:t,redirectURI:r})=>{const n=new URLSearchParams({grant_type:"authorization_code",code:t,redirect_uri:e.redirectURI||r}),s={"content-type":"application/x-www-form-urlencoded",accept:"text/plain","user-agent":"better-auth",Authorization:`Basic ${Ft.encode(`${e.clientId}:${e.clientSecret}`)}`},{data:i,error:o}=await Z("https://www.reddit.com/api/v1/access_token",{method:"POST",headers:s,body:n.toString()});if(o)throw o;return Gl(i)},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},authentication:"basic",tokenEndpoint:"https://www.reddit.com/api/v1/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://oauth.reddit.com/api/v1/me",{headers:{Authorization:`Bearer ${t.accessToken}`,"User-Agent":"better-auth"}});if(n)return null;const s=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.oauth_client_id,emailVerified:r.has_verified_email,image:r.icon_img?.split("?")[0],...s},data:r}},options:e}),BA=e=>({id:"roblox",name:"Roblox",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const s=e.disableDefaultScope?[]:["openid","profile"];return e.scope&&s.push(...e.scope),r&&s.push(...r),new URL(`https://apis.roblox.com/oauth/v1/authorize?scope=${s.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}&prompt=${e.prompt||"select_account consent"}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>ae({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://apis.roblox.com/oauth/v1/token",authentication:"post"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://apis.roblox.com/oauth/v1/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://apis.roblox.com/oauth/v1/userinfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(n)return null;const s=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.nickname||r.preferred_username||"",image:r.picture,email:r.preferred_username||null,emailVerified:!0,...s},data:{...r}}},options:e}),HA=e=>{const r=(e.environment??"production")==="sandbox",n=e.loginUrl?`https://${e.loginUrl}/services/oauth2/authorize`:r?"https://test.salesforce.com/services/oauth2/authorize":"https://login.salesforce.com/services/oauth2/authorize",s=e.loginUrl?`https://${e.loginUrl}/services/oauth2/token`:r?"https://test.salesforce.com/services/oauth2/token":"https://login.salesforce.com/services/oauth2/token",i=e.loginUrl?`https://${e.loginUrl}/services/oauth2/userinfo`:r?"https://test.salesforce.com/services/oauth2/userinfo":"https://login.salesforce.com/services/oauth2/userinfo";return{id:"salesforce",name:"Salesforce",async createAuthorizationURL({state:o,scopes:a,codeVerifier:c,redirectURI:u}){if(!e.clientId||!e.clientSecret)throw K.error("Client Id and Client Secret are required for Salesforce. Make sure to provide them in the options."),new X("CLIENT_ID_AND_SECRET_REQUIRED");if(!c)throw new X("codeVerifier is required for Salesforce");const d=e.disableDefaultScope?[]:["openid","email","profile"];return e.scope&&d.push(...e.scope),a&&d.push(...a),fe({id:"salesforce",options:e,authorizationEndpoint:n,scopes:d,state:o,codeVerifier:c,redirectURI:e.redirectURI||u})},validateAuthorizationCode:async({code:o,codeVerifier:a,redirectURI:c})=>ae({code:o,codeVerifier:a,redirectURI:e.redirectURI||c,options:e,tokenEndpoint:s}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async o=>ue({refreshToken:o,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:s}),async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);try{const{data:a}=await Z(i,{headers:{Authorization:`Bearer ${o.accessToken}`}});if(!a)return K.error("Failed to fetch user info from Salesforce"),null;const c=await e.mapProfileToUser?.(a);return{user:{id:a.user_id,name:a.name,email:a.email,image:a.photos?.picture||a.photos?.thumbnail,emailVerified:a.email_verified??!1,...c},data:a}}catch(a){return K.error("Failed to fetch user info from Salesforce:",a),null}},options:e}},KA=e=>({id:"vk",name:"VK",async createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:s}){const i=e.disableDefaultScope?[]:["email","phone"];return e.scope&&i.push(...e.scope),r&&i.push(...r),fe({id:"vk",options:e,authorizationEndpoint:"https://id.vk.com/authorize",scopes:i,state:t,redirectURI:s,codeVerifier:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n,deviceId:s})=>ae({code:t,codeVerifier:r,redirectURI:e.redirectURI||n,options:e,deviceId:s,tokenEndpoint:"https://id.vk.com/oauth2/auth"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.vk.com/oauth2/auth"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return null;const r=new URLSearchParams({access_token:t.accessToken,client_id:e.clientId}).toString(),{data:n,error:s}=await Z("https://id.vk.com/oauth2/user_info",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});if(s||!n.user.email)return null;const i=await e.mapProfileToUser?.(n);return{user:{id:n.user.user_id,first_name:n.user.first_name,last_name:n.user.last_name,email:n.user.email,image:n.user.avatar,emailVerified:!!n.user.email,birthday:n.user.birthday,sex:n.user.sex,name:`${n.user.first_name} ${n.user.last_name}`,...i},data:n}},options:e}),ZA=e=>{const t={pkce:!0,...e};return{id:"zoom",name:"Zoom",createAuthorizationURL:async({state:r,redirectURI:n,codeVerifier:s})=>{const i=new URLSearchParams({response_type:"code",redirect_uri:t.redirectURI?t.redirectURI:n,client_id:t.clientId,state:r});if(t.pkce){const a=await Jl(s);i.set("code_challenge_method","S256"),i.set("code_challenge",a)}const o=new URL("https://zoom.us/oauth/authorize");return o.search=i.toString(),o},validateAuthorizationCode:async({code:r,redirectURI:n,codeVerifier:s})=>ae({code:r,redirectURI:t.redirectURI||n,codeVerifier:s,options:t,tokenEndpoint:"https://zoom.us/oauth/token",authentication:"post"}),async getUserInfo(r){if(t.getUserInfo)return t.getUserInfo(r);const{data:n,error:s}=await Z("https://api.zoom.us/v2/users/me",{headers:{authorization:`Bearer ${r.accessToken}`}});if(s)return null;const i=await t.mapProfileToUser?.(n);return{user:{id:n.id,name:n.display_name,image:n.pic_url,email:n.email,emailVerified:!!n.verified,...i},data:{...n}}}}},JA=e=>({id:"kakao",name:"Kakao",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const s=e.disableDefaultScope?[]:["account_email","profile_image","profile_nickname"];return e.scope&&s.push(...e.scope),r&&s.push(...r),fe({id:"kakao",options:e,authorizationEndpoint:"https://kauth.kakao.com/oauth/authorize",scopes:s,state:t,redirectURI:n})},validateAuthorizationCode:async({code:t,redirectURI:r})=>ae({code:t,redirectURI:r,options:e,tokenEndpoint:"https://kauth.kakao.com/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://kauth.kakao.com/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://kapi.kakao.com/v2/user/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(n||!r)return null;const s=await e.mapProfileToUser?.(r),i=r.kakao_account||{},o=i.profile||{};return{user:{id:String(r.id),name:o.nickname||i.name||void 0,email:i.email,image:o.profile_image_url||o.thumbnail_image_url,emailVerified:!!i.is_email_valid&&!!i.is_email_verified,...s},data:r}},options:e}),GA=e=>({id:"naver",name:"Naver",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const s=e.disableDefaultScope?[]:["profile","email"];return e.scope&&s.push(...e.scope),r&&s.push(...r),fe({id:"naver",options:e,authorizationEndpoint:"https://nid.naver.com/oauth2.0/authorize",scopes:s,state:t,redirectURI:n})},validateAuthorizationCode:async({code:t,redirectURI:r})=>ae({code:t,redirectURI:r,options:e,tokenEndpoint:"https://nid.naver.com/oauth2.0/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ue({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://nid.naver.com/oauth2.0/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await Z("https://openapi.naver.com/v1/nid/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(n||!r||r.resultcode!=="00")return null;const s=await e.mapProfileToUser?.(r),i=r.response||{};return{user:{id:i.id,name:i.name||i.nickname,email:i.email,image:i.profile_image,emailVerified:!1,...s},data:r}},options:e}),QA=e=>{const t="https://access.line.me/oauth2/v2.1/authorize",r="https://api.line.me/oauth2/v2.1/token",n="https://api.line.me/oauth2/v2.1/userinfo",s="https://api.line.me/oauth2/v2.1/verify";return{id:"line",name:"LINE",async createAuthorizationURL({state:i,scopes:o,codeVerifier:a,redirectURI:c,loginHint:u}){const d=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&d.push(...e.scope),o&&d.push(...o),await fe({id:"line",options:e,authorizationEndpoint:t,scopes:d,state:i,codeVerifier:a,redirectURI:c,loginHint:u})},validateAuthorizationCode:async({code:i,codeVerifier:o,redirectURI:a})=>ae({code:i,codeVerifier:o,redirectURI:a,options:e,tokenEndpoint:r}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async i=>ue({refreshToken:i,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:r}),async verifyIdToken(i,o){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(i,o);const a=new URLSearchParams;a.set("id_token",i),a.set("client_id",e.clientId),o&&a.set("nonce",o);const{data:c,error:u}=await Z(s,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:a});return!(u||!c||c.aud!==e.clientId||o&&c.nonce&&c.nonce!==o)},async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let o=null;if(i.idToken)try{o=Nr(i.idToken)}catch{}if(!o){const{data:h}=await Z(n,{headers:{authorization:`Bearer ${i.accessToken}`}});o=h||null}if(!o)return null;const a=await e.mapProfileToUser?.(o),c=o.sub||o.userId,u=o.name||o.displayName,d=o.picture||o.pictureUrl||void 0,l=o.email;return{user:{id:c,name:u,email:l,image:d,emailVerified:!1,...a},data:o}},options:e}},YA=e=>{const r=(e.environment||"sandbox")==="sandbox",n=r?"https://www.sandbox.paypal.com/signin/authorize":"https://www.paypal.com/signin/authorize",s=r?"https://api-m.sandbox.paypal.com/v1/oauth2/token":"https://api-m.paypal.com/v1/oauth2/token",i=r?"https://api-m.sandbox.paypal.com/v1/identity/oauth2/userinfo":"https://api-m.paypal.com/v1/identity/oauth2/userinfo";return{id:"paypal",name:"PayPal",async createAuthorizationURL({state:o,codeVerifier:a,redirectURI:c}){if(!e.clientId||!e.clientSecret)throw K.error("Client Id and Client Secret is required for PayPal. Make sure to provide them in the options."),new X("CLIENT_ID_AND_SECRET_REQUIRED");return await fe({id:"paypal",options:e,authorizationEndpoint:n,scopes:[],state:o,codeVerifier:a,redirectURI:c,prompt:e.prompt})},validateAuthorizationCode:async({code:o,redirectURI:a})=>{const c=Ft.encode(`${e.clientId}:${e.clientSecret}`);try{const u=await Z(s,{method:"POST",headers:{Authorization:`Basic ${c}`,Accept:"application/json","Accept-Language":"en_US","Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:a}).toString()});if(!u.data)throw new X("FAILED_TO_GET_ACCESS_TOKEN");const d=u.data;return{accessToken:d.access_token,refreshToken:d.refresh_token,accessTokenExpiresAt:d.expires_in?new Date(Date.now()+d.expires_in*1e3):void 0,idToken:d.id_token}}catch(u){throw K.error("PayPal token exchange failed:",u),new X("FAILED_TO_GET_ACCESS_TOKEN")}},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async o=>{const a=Ft.encode(`${e.clientId}:${e.clientSecret}`);try{const c=await Z(s,{method:"POST",headers:{Authorization:`Basic ${a}`,Accept:"application/json","Accept-Language":"en_US","Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:o}).toString()});if(!c.data)throw new X("FAILED_TO_REFRESH_ACCESS_TOKEN");const u=c.data;return{accessToken:u.access_token,refreshToken:u.refresh_token,accessTokenExpiresAt:u.expires_in?new Date(Date.now()+u.expires_in*1e3):void 0}}catch(c){throw K.error("PayPal token refresh failed:",c),new X("FAILED_TO_REFRESH_ACCESS_TOKEN")}},async verifyIdToken(o,a){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(o,a);try{return!!Nr(o).sub}catch(c){return K.error("Failed to verify PayPal ID token:",c),!1}},async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);if(!o.accessToken)return K.error("Access token is required to fetch PayPal user info"),null;try{const a=await Z(`${i}?schema=paypalv1.1`,{headers:{Authorization:`Bearer ${o.accessToken}`,Accept:"application/json"}});if(!a.data)return K.error("Failed to fetch user info from PayPal"),null;const c=a.data,u=await e.mapProfileToUser?.(c);return{user:{id:c.user_id,name:c.name,email:c.email,image:c.picture,emailVerified:c.email_verified,...u},data:c}}catch(a){return K.error("Failed to fetch user info from PayPal:",a),null}},options:e}},Yl={apple:vA,atlassian:EA,cognito:AA,discord:TA,facebook:_A,figma:SA,github:RA,microsoft:CA,google:OA,huggingface:xA,slack:PA,spotify:LA,twitch:$A,twitter:DA,dropbox:qA,kick:IA,linear:WA,linkedin:zA,gitlab:jA,tiktok:VA,reddit:FA,roblox:BA,salesforce:HA,vk:KA,zoom:ZA,notion:UA,kakao:JA,naver:GA,line:QA,paypal:YA},XA=Object.keys(Yl),Xl=Zd(XA).or(C()),ek=ee("/sign-in/social",{method:"POST",body:oe({callbackURL:C().describe("Callback URL to redirect to after the user has signed in").optional(),newUserCallbackURL:C().optional(),errorCallbackURL:C().describe("Callback URL to redirect to if an error happens").optional(),provider:Xl,disableRedirect:mr().describe("Disable automatic redirection to the provider. Useful for handling the redirection yourself").optional(),idToken:Ai(oe({token:C().describe("ID token from the provider"),nonce:C().describe("Nonce used to generate the token").optional(),accessToken:C().describe("Access token from the provider").optional(),refreshToken:C().describe("Refresh token from the provider").optional(),expiresAt:Fd().describe("Expiry date of the token").optional()})),scopes:Ei(C()).describe("Array of scopes to request from the provider. This will override the default scopes passed.").optional(),requestSignUp:mr().describe("Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider").optional(),loginHint:C().describe("The login hint to use for the authorization code request").optional()}),metadata:{openapi:{description:"Sign in with a social provider",operationId:"socialSignIn",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{redirect:{type:"boolean",enum:[!1]},token:{type:"string",description:"Session token",url:{type:"null",nullable:!0},user:{type:"object",properties:{id:{type:"string"},email:{type:"string"},name:{type:"string",nullable:!0},image:{type:"string",nullable:!0},emailVerified:{type:"boolean"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}},required:["id","email","emailVerified","createdAt","updatedAt"]}}},required:["redirect","token","user"]}}}}}}}},async e=>{const t=e.context.socialProviders.find(i=>i.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new T("NOT_FOUND",{message:V.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!t.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new T("NOT_FOUND",{message:V.ID_TOKEN_NOT_SUPPORTED});const{token:i,nonce:o}=e.body.idToken;if(!await t.verifyIdToken(i,o))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new T("UNAUTHORIZED",{message:V.INVALID_TOKEN});const c=await t.getUserInfo({idToken:i,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!c||!c?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new T("UNAUTHORIZED",{message:V.FAILED_TO_GET_USER_INFO});if(!c.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new T("UNAUTHORIZED",{message:V.USER_EMAIL_NOT_FOUND});const u=await Ql(e,{userInfo:{...c.user,email:c.user.email,id:String(c.user.id),name:c.user.name||"",image:c.user.image,emailVerified:c.user.emailVerified||!1},account:{providerId:t.id,accountId:String(c.user.id),accessToken:e.body.idToken.accessToken},callbackURL:e.body.callbackURL,disableSignUp:t.disableImplicitSignUp&&!e.body.requestSignUp||t.disableSignUp});if(u.error)throw new T("UNAUTHORIZED",{message:u.error});return await yt(e,u.data),e.json({redirect:!1,token:u.data.session.token,url:void 0,user:{id:u.data.user.id,email:u.data.user.email,name:u.data.user.name,image:u.data.user.image,emailVerified:u.data.user.emailVerified,createdAt:u.data.user.createdAt,updatedAt:u.data.user.updatedAt}})}const{codeVerifier:r,state:n}=await Zl(e),s=await t.createAuthorizationURL({state:n,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${t.id}`,scopes:e.body.scopes,loginHint:e.body.loginHint});return e.json({url:s.toString(),redirect:!e.body.disableRedirect})}),tk=ee("/sign-in/email",{method:"POST",body:oe({email:C().describe("Email of the user"),password:C().describe("Password of the user"),callbackURL:C().describe("Callback URL to use as a redirect for email verification").optional(),rememberMe:mr().describe("If this is false, the session will not be remembered. Default is `true`.").default(!0).optional()}),metadata:{openapi:{description:"Sign in with email and password",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{redirect:{type:"boolean",enum:[!1]},token:{type:"string",description:"Session token"},url:{type:"null",nullable:!0},user:{type:"object",properties:{id:{type:"string"},email:{type:"string"},name:{type:"string",nullable:!0},image:{type:"string",nullable:!0},emailVerified:{type:"boolean"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}},required:["id","email","emailVerified","createdAt","updatedAt"]}},required:["redirect","token","user"]}}}}}}}},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new T("BAD_REQUEST",{message:"Email and password is not enabled"});const{email:t,password:r}=e.body;if(!C().email().safeParse(t).success)throw new T("BAD_REQUEST",{message:V.INVALID_EMAIL});const s=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!s)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:t}),new T("UNAUTHORIZED",{message:V.INVALID_EMAIL_OR_PASSWORD});const i=s.accounts.find(u=>u.providerId==="credential");if(!i)throw e.context.logger.error("Credential account not found",{email:t}),new T("UNAUTHORIZED",{message:V.INVALID_EMAIL_OR_PASSWORD});const o=i?.password;if(!o)throw e.context.logger.error("Password not found",{email:t}),new T("UNAUTHORIZED",{message:V.INVALID_EMAIL_OR_PASSWORD});if(!await e.context.password.verify({hash:o,password:r}))throw e.context.logger.error("Invalid password"),new T("UNAUTHORIZED",{message:V.INVALID_EMAIL_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!s.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new T("FORBIDDEN",{message:V.EMAIL_NOT_VERIFIED});if(e.context.options?.emailVerification?.sendOnSignIn){const u=await Wr(e.context.secret,s.user.email,void 0,e.context.options.emailVerification?.expiresIn),d=`${e.context.baseURL}/verify-email?token=${u}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:s.user,url:d,token:u},e.request)}throw new T("FORBIDDEN",{message:V.EMAIL_NOT_VERIFIED})}const c=await e.context.internalAdapter.createSession(s.user.id,e,e.body.rememberMe===!1);if(!c)throw e.context.logger.error("Failed to create session"),new T("UNAUTHORIZED",{message:V.FAILED_TO_CREATE_SESSION});return await yt(e,{session:c,user:s.user},e.body.rememberMe===!1),e.json({redirect:!!e.body.callbackURL,token:c.token,url:e.body.callbackURL,user:{id:s.user.id,email:s.user.email,name:s.user.name,image:s.user.image,emailVerified:s.user.emailVerified,createdAt:s.user.createdAt,updatedAt:s.user.updatedAt}})}),Ks=oe({code:C().optional(),error:C().optional(),device_id:C().optional(),error_description:C().optional(),state:C().optional(),user:C().optional()}),rk=ee("/callback/:id",{method:["GET","POST"],body:Ks.optional(),query:Ks.optional(),metadata:Ia},async e=>{let t;const r=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;try{if(e.method==="GET")t=Ks.parse(e.query);else if(e.method==="POST")t=Ks.parse(e.body);else throw new Error("Unsupported method")}catch(A){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",A),e.redirect(`${r}?error=invalid_callback_request`)}const{code:n,error:s,state:i,error_description:o,device_id:a}=t;if(!i){e.context.logger.error("State not found",s);const A=r.includes("?")?"&":"?",S=`${r}${A}state=state_not_found`;throw e.redirect(S)}const{codeVerifier:c,callbackURL:u,link:d,errorURL:l,newUserURL:h,requestSignUp:p}=await yA(e);function m(A,S){const q=l??r,O=new URLSearchParams({error:A});S&&O.set("error_description",S);const $=q.includes("?")?"&":"?",I=`${q}${$}${O.toString()}`;throw e.redirect(I)}if(s&&m(s,o),!n)throw e.context.logger.error("Code not found"),m("no_code");const y=e.context.socialProviders.find(A=>A.id===e.params.id);if(!y)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),m("oauth_provider_not_found");let g;try{g=await y.validateAuthorizationCode({code:n,codeVerifier:c,deviceId:a,redirectURI:`${e.context.baseURL}/callback/${y.id}`})}catch(A){throw e.context.logger.error("",A),m("invalid_code")}const b=await y.getUserInfo({...g,user:e.body?.user?He(e.body.user):void 0}).then(A=>A?.user);if(!b)return e.context.logger.error("Unable to get user info"),m("unable_to_get_user_info");if(!u)throw e.context.logger.error("No callback URL found"),m("no_callback_url");if(d){if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(y.id)&&!b.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return e.context.logger.error("Unable to link account - untrusted provider"),m("unable_to_link_account");if(b.email!==d.email&&e.context.options.account?.accountLinking?.allowDifferentEmails!==!0)return m("email_doesn't_match");const q=await e.context.internalAdapter.findAccount(String(b.id));if(q){if(q.userId.toString()!==d.userId.toString())return m("account_already_linked_to_different_user");const $=Object.fromEntries(Object.entries({accessToken:await Qe(g.accessToken,e.context),refreshToken:await Qe(g.refreshToken,e.context),idToken:g.idToken,accessTokenExpiresAt:g.accessTokenExpiresAt,refreshTokenExpiresAt:g.refreshTokenExpiresAt,scope:g.scopes?.join(",")}).filter(([I,E])=>E!==void 0));await e.context.internalAdapter.updateAccount(q.id,$)}else if(!await e.context.internalAdapter.createAccount({userId:d.userId,providerId:y.id,accountId:String(b.id),...g,accessToken:await Qe(g.accessToken,e.context),refreshToken:await Qe(g.refreshToken,e.context),scope:g.scopes?.join(",")},e))return m("unable_to_link_account");let O;try{O=u.toString()}catch{O=u}throw e.redirect(O)}if(!b.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),m("email_not_found");const w=await Ql(e,{userInfo:{...b,id:String(b.id),email:b.email,name:b.name||b.email},account:{providerId:y.id,accountId:String(b.id),...g,scope:g.scopes?.join(",")},callbackURL:u,disableSignUp:y.disableImplicitSignUp&&!p||y.options?.disableSignUp,overrideUserInfo:y.options?.overrideUserInfoOnSignIn});if(w.error)return e.context.logger.error(w.error.split(" ").join("_")),m(w.error.split(" ").join("_"));const{session:N,user:v}=w.data;await yt(e,{session:N,user:v});let k;try{k=(w.isRegister&&h||u).toString()}catch{k=w.isRegister&&h||u}throw e.redirect(k)}),nk=ee("/sign-out",{method:"POST",requireHeaders:!0,metadata:{openapi:{description:"Sign out the current user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{const t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)throw In(e),new T("BAD_REQUEST",{message:V.FAILED_TO_GET_SESSION});return await e.context.internalAdapter.deleteSession(t),In(e),e.json({success:!0})});function du(e,t,r){const n=t?new URL(t,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([s,i])=>n.searchParams.set(s,i)),n.href}function sk(e,t,r){const n=new URL(t,e.baseURL);return r&&Object.entries(r).forEach(([s,i])=>n.searchParams.set(s,i)),n.href}const ik=ee("/request-password-reset",{method:"POST",body:oe({email:jd().describe("The email address of the user to send a password reset email to"),redirectTo:C().describe("The URL to redirect the user to reset their password").optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"},message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!"),new T("BAD_REQUEST",{message:"Reset password isn't enabled"});const{email:t,redirectTo:r}=e.body,n=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)return e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"});const s=3600*1,i=yr(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||s,"sec"),o=Kr(24);await e.context.internalAdapter.createVerificationValue({value:n.user.id,identifier:`reset-password:${o}`,expiresAt:i},e);const a=r?encodeURIComponent(r):"",c=`${e.context.baseURL}/reset-password/${o}?callbackURL=${a}`;return await e.context.options.emailAndPassword.sendResetPassword({user:n.user,url:c,token:o},e.request),e.json({status:!0})}),ok=ee("/forget-password",{method:"POST",body:oe({email:C().email().describe("The email address of the user to send a password reset email to"),redirectTo:C().describe("The URL to redirect the user to reset their password").optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"},message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!"),new T("BAD_REQUEST",{message:"Reset password isn't enabled"});const{email:t,redirectTo:r}=e.body,n=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)return e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"});const s=3600*1,i=yr(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||s,"sec"),o=Kr(24);await e.context.internalAdapter.createVerificationValue({value:n.user.id,identifier:`reset-password:${o}`,expiresAt:i},e);const a=r?encodeURIComponent(r):"",c=`${e.context.baseURL}/reset-password/${o}?callbackURL=${a}`;return await e.context.options.emailAndPassword.sendResetPassword({user:n.user,url:c,token:o},e.request),e.json({status:!0})}),eh=ee("/reset-password/:token",{method:"GET",query:oe({callbackURL:C().describe("The URL to redirect the user to reset their password")}),use:[Oa(e=>e.query.callbackURL)],metadata:{openapi:{description:"Redirects the user to the callback URL with the token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async e=>{const{token:t}=e.params,{callbackURL:r}=e.query;if(!t||!r)throw e.redirect(du(e.context,r,{error:"INVALID_TOKEN"}));const n=await e.context.internalAdapter.findVerificationValue(`reset-password:${t}`);throw!n||n.expiresAt<new Date?e.redirect(du(e.context,r,{error:"INVALID_TOKEN"})):e.redirect(sk(e.context,r,{token:t}))}),ak=eh,ck=ee("/reset-password",{method:"POST",query:oe({token:C().optional()}).optional(),body:oe({newPassword:C().describe("The new password to set"),token:C().describe("The token to reset the password").optional()}),metadata:{openapi:{description:"Reset the password for a user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{const t=e.body.token||e.query?.token;if(!t)throw new T("BAD_REQUEST",{message:V.INVALID_TOKEN});const{newPassword:r}=e.body,n=e.context.password?.config.minPasswordLength,s=e.context.password?.config.maxPasswordLength;if(r.length<n)throw new T("BAD_REQUEST",{message:V.PASSWORD_TOO_SHORT});if(r.length>s)throw new T("BAD_REQUEST",{message:V.PASSWORD_TOO_LONG});const i=`reset-password:${t}`,o=await e.context.internalAdapter.findVerificationValue(i);if(!o||o.expiresAt<new Date)throw new T("BAD_REQUEST",{message:V.INVALID_TOKEN});const a=o.value,c=await e.context.password.hash(r);if((await e.context.internalAdapter.findAccounts(a)).find(l=>l.providerId==="credential")?await e.context.internalAdapter.updatePassword(a,c,e):await e.context.internalAdapter.createAccount({userId:a,providerId:"credential",password:c,accountId:a},e),await e.context.internalAdapter.deleteVerificationValue(o.id),e.context.options.emailAndPassword?.onPasswordReset){const l=await e.context.internalAdapter.findUserById(a);l&&await e.context.options.emailAndPassword.onPasswordReset({user:l},e.request)}return e.context.options.emailAndPassword?.revokeSessionsOnPasswordReset&&await e.context.internalAdapter.deleteSessions(a),e.json({status:!0})}),uk=()=>ee("/update-user",{method:"POST",body:Kd(C().describe("Field name must be a string"),Hd()),use:[Ps],metadata:{$Infer:{body:{}},openapi:{description:"Update the current user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user"}}}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the update was successful"}}}}}}}}}},async e=>{const t=e.body;if(t.email)throw new T("BAD_REQUEST",{message:V.EMAIL_CAN_NOT_BE_UPDATED});const{name:r,image:n,...s}=t,i=e.context.session;if(n===void 0&&r===void 0&&Object.keys(s).length===0)return e.json({status:!0});const o=Bl(e.context.options,s,"update"),a=await e.context.internalAdapter.updateUser(i.user.id,{name:r,image:n,...o},e);return await yt(e,{session:i.session,user:a}),e.json({status:!0})}),dk=ee("/change-password",{method:"POST",body:oe({newPassword:C().describe("The new password to set"),currentPassword:C().describe("The current password is required"),revokeOtherSessions:mr().describe("Must be a boolean value").optional()}),use:[Hr],metadata:{openapi:{description:"Change the password of the user",responses:{200:{description:"Password successfully changed",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"New session token if other sessions were revoked"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}}}}}},async e=>{const{newPassword:t,currentPassword:r,revokeOtherSessions:n}=e.body,s=e.context.session,i=e.context.password.config.minPasswordLength;if(t.length<i)throw e.context.logger.error("Password is too short"),new T("BAD_REQUEST",{message:V.PASSWORD_TOO_SHORT});const o=e.context.password.config.maxPasswordLength;if(t.length>o)throw e.context.logger.error("Password is too long"),new T("BAD_REQUEST",{message:V.PASSWORD_TOO_LONG});const c=(await e.context.internalAdapter.findAccounts(s.user.id)).find(h=>h.providerId==="credential"&&h.password);if(!c||!c.password)throw new T("BAD_REQUEST",{message:V.CREDENTIAL_ACCOUNT_NOT_FOUND});const u=await e.context.password.hash(t);if(!await e.context.password.verify({hash:c.password,password:r}))throw new T("BAD_REQUEST",{message:V.INVALID_PASSWORD});await e.context.internalAdapter.updateAccount(c.id,{password:u});let l=null;if(n){await e.context.internalAdapter.deleteSessions(s.user.id);const h=await e.context.internalAdapter.createSession(s.user.id,e);if(!h)throw new T("INTERNAL_SERVER_ERROR",{message:V.FAILED_TO_GET_SESSION});await yt(e,{session:h,user:s.user}),l=h.token}return e.json({token:l,user:{id:s.user.id,email:s.user.email,name:s.user.name,image:s.user.image,emailVerified:s.user.emailVerified,createdAt:s.user.createdAt,updatedAt:s.user.updatedAt}})}),lk=ee("/set-password",{method:"POST",body:oe({newPassword:C().describe("The new password to set is required")}),metadata:{SERVER_ONLY:!0},use:[Hr]},async e=>{const{newPassword:t}=e.body,r=e.context.session,n=e.context.password.config.minPasswordLength;if(t.length<n)throw e.context.logger.error("Password is too short"),new T("BAD_REQUEST",{message:V.PASSWORD_TOO_SHORT});const s=e.context.password.config.maxPasswordLength;if(t.length>s)throw e.context.logger.error("Password is too long"),new T("BAD_REQUEST",{message:V.PASSWORD_TOO_LONG});const o=(await e.context.internalAdapter.findAccounts(r.user.id)).find(c=>c.providerId==="credential"&&c.password),a=await e.context.password.hash(t);if(!o)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:a},e),e.json({status:!0});throw new T("BAD_REQUEST",{message:"user already has a password"})}),hk=ee("/delete-user",{method:"POST",use:[Hr],body:oe({callbackURL:C().describe("The callback URL to redirect to after the user is deleted").optional(),password:C().describe("The password of the user is required to delete the user").optional(),token:C().describe("The token to delete the user is required").optional()}),metadata:{openapi:{description:"Delete the user",responses:{200:{description:"User deletion processed successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the operation was successful"},message:{type:"string",enum:["User deleted","Verification email sent"],description:"Status message of the deletion process"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options",{session:e.context.session}),new T("NOT_FOUND");const t=e.context.session;if(e.body.password){const i=(await e.context.internalAdapter.findAccounts(t.user.id)).find(a=>a.providerId==="credential"&&a.password);if(!i||!i.password)throw new T("BAD_REQUEST",{message:V.CREDENTIAL_ACCOUNT_NOT_FOUND});if(!await e.context.password.verify({hash:i.password,password:e.body.password}))throw new T("BAD_REQUEST",{message:V.INVALID_PASSWORD})}if(e.body.token)return await th({...e,query:{token:e.body.token}}),e.json({success:!0,message:"User deleted"});if(e.context.options.user.deleteUser?.sendDeleteAccountVerification){const s=Zo(32,"0-9","a-z");await e.context.internalAdapter.createVerificationValue({value:t.user.id,identifier:`delete-account-${s}`,expiresAt:new Date(Date.now()+(e.context.options.user.deleteUser?.deleteTokenExpiresIn||3600*24)*1e3)},e);const i=`${e.context.baseURL}/delete-user/callback?token=${s}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.deleteUser.sendDeleteAccountVerification({user:t.user,url:i,token:s},e.request),e.json({success:!0,message:"Verification email sent"})}if(!e.body.password&&e.context.sessionConfig.freshAge!==0){const s=new Date(t.session.createdAt).getTime(),i=e.context.sessionConfig.freshAge*1e3;if(Date.now()-s>i*1e3)throw new T("BAD_REQUEST",{message:V.SESSION_EXPIRED})}const r=e.context.options.user.deleteUser?.beforeDelete;r&&await r(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),await e.context.internalAdapter.deleteAccounts(t.user.id),In(e);const n=e.context.options.user.deleteUser?.afterDelete;return n&&await n(t.user,e.request),e.json({success:!0,message:"User deleted"})}),th=ee("/delete-user/callback",{method:"GET",query:oe({token:C().describe("The token to verify the deletion request"),callbackURL:C().describe("The URL to redirect to after deletion").optional()}),use:[Oa(e=>e.query.callbackURL)],metadata:{openapi:{description:"Callback to complete user deletion with verification token",responses:{200:{description:"User successfully deleted",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the deletion was successful"},message:{type:"string",enum:["User deleted"],description:"Confirmation message"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new T("NOT_FOUND");const t=await Rt(e);if(!t)throw new T("NOT_FOUND",{message:V.FAILED_TO_GET_USER_INFO});const r=await e.context.internalAdapter.findVerificationValue(`delete-account-${e.query.token}`);if(!r||r.expiresAt<new Date)throw new T("NOT_FOUND",{message:V.INVALID_TOKEN});if(r.value!==t.user.id)throw new T("NOT_FOUND",{message:V.INVALID_TOKEN});const n=e.context.options.user.deleteUser?.beforeDelete;n&&await n(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),await e.context.internalAdapter.deleteAccounts(t.user.id),await e.context.internalAdapter.deleteVerificationValue(r.id),In(e);const s=e.context.options.user.deleteUser?.afterDelete;if(s&&await s(t.user,e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL||"/");return e.json({success:!0,message:"User deleted"})}),fk=ee("/change-email",{method:"POST",body:oe({newEmail:jd().describe("The new email address to set must be a valid email address"),callbackURL:C().describe("The URL to redirect to after email verification").optional()}),use:[Hr],metadata:{openapi:{responses:{200:{description:"Email change request processed successfully",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the request was successful"},message:{type:"string",enum:["Email updated","Verification email sent"],description:"Status message of the email change process",nullable:!0}},required:["status"]}}}},422:{description:"Unprocessable Entity. Email already exists",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new T("BAD_REQUEST",{message:"Change email is disabled"});const t=e.body.newEmail.toLowerCase();if(t===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new T("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(t))throw e.context.logger.error("Email already exists"),new T("BAD_REQUEST",{message:"Couldn't update your email"});if(e.context.session.user.emailVerified!==!0){if(await e.context.internalAdapter.findUserByEmail(t))throw new T("UNPROCESSABLE_ENTITY",{message:V.USER_ALREADY_EXISTS});if(await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:t},e),await yt(e,{session:e.context.session.session,user:{...e.context.session.user,email:t}}),e.context.options.emailVerification?.sendVerificationEmail){const o=await Wr(e.context.secret,t,void 0,e.context.options.emailVerification?.expiresIn),a=`${e.context.baseURL}/verify-email?token=${o}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:{...e.context.session.user,email:t},url:a,token:o},e.request)}return e.json({status:!0})}if(!e.context.options.user.changeEmail.sendChangeEmailVerification)throw e.context.logger.error("Verification email isn't enabled."),new T("BAD_REQUEST",{message:"Verification email isn't enabled"});const n=await Wr(e.context.secret,e.context.session.user.email,t,e.context.options.emailVerification?.expiresIn),s=`${e.context.baseURL}/verify-email?token=${n}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.changeEmail.sendChangeEmailVerification({user:e.context.session.user,newEmail:t,url:s,token:n},e.request),e.json({status:!0})});function pk(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const mk=(e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon"></div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${pk(e)}</span></div>
    </div>
</body>
</html>`,yk=ee("/error",{method:"GET",metadata:{...Ia,openapi:{description:"Displays an error page",responses:{200:{description:"Success",content:{"text/html":{schema:{type:"string",description:"The HTML content of the error page"}}}}}}}},async e=>{const t=new URL(e.request?.url||"").searchParams.get("error")||"Unknown";return new Response(mk(t),{headers:{"Content-Type":"text/html"}})}),wk=ee("/ok",{method:"GET",metadata:{...Ia,openapi:{description:"Check if the API is working",responses:{200:{description:"API is working",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean",description:"Indicates if the API is working"}},required:["ok"]}}}}}}}},async e=>e.json({ok:!0})),gk=ee("/list-accounts",{method:"GET",use:[Ps],metadata:{openapi:{description:"List all accounts linked to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string"},providerId:{type:"string"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"},accountId:{type:"string"},scopes:{type:"array",items:{type:"string"}}},required:["id","providerId","createdAt","updatedAt","accountId","scopes"]}}}}}}}}},async e=>{const t=e.context.session,r=await e.context.internalAdapter.findAccounts(t.user.id);return e.json(r.map(n=>({id:n.id,providerId:n.providerId,createdAt:n.createdAt,updatedAt:n.updatedAt,accountId:n.accountId,scopes:n.scope?.split(",")||[]})))}),bk=ee("/link-social",{method:"POST",requireHeaders:!0,body:oe({callbackURL:C().describe("The URL to redirect to after the user has signed in").optional(),provider:Xl,idToken:oe({token:C(),nonce:C().optional(),accessToken:C().optional(),refreshToken:C().optional(),scopes:Ei(C()).optional()}).optional(),requestSignUp:mr().optional(),scopes:Ei(C()).describe("Additional scopes to request from the provider").optional(),errorCallbackURL:C().describe("The URL to redirect to if there is an error during the link process").optional(),disableRedirect:mr().describe("Disable automatic redirection to the provider. Useful for handling the redirection yourself").optional()}),use:[Ps],metadata:{openapi:{description:"Link a social account to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string",description:"The authorization URL to redirect the user to"},redirect:{type:"boolean",description:"Indicates if the user should be redirected to the authorization URL"},status:{type:"boolean"}},required:["redirect"]}}}}}}}},async e=>{const t=e.context.session,r=e.context.socialProviders.find(i=>i.id===e.body.provider);if(!r)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new T("NOT_FOUND",{message:V.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!r.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new T("NOT_FOUND",{message:V.ID_TOKEN_NOT_SUPPORTED});const{token:i,nonce:o}=e.body.idToken;if(!await r.verifyIdToken(i,o))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new T("UNAUTHORIZED",{message:V.INVALID_TOKEN});const c=await r.getUserInfo({idToken:i,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!c||!c?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new T("UNAUTHORIZED",{message:V.FAILED_TO_GET_USER_INFO});const u=String(c.user.id);if(!c.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new T("UNAUTHORIZED",{message:V.USER_EMAIL_NOT_FOUND});if((await e.context.internalAdapter.findAccounts(t.user.id)).find(m=>m.providerId===r.id&&m.accountId===u))return e.json({url:"",status:!0,redirect:!1});if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.id)&&!c.user.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)throw new T("UNAUTHORIZED",{message:"Account not linked - linking not allowed"});if(c.user.email!==t.user.email&&e.context.options.account?.accountLinking?.allowDifferentEmails!==!0)throw new T("UNAUTHORIZED",{message:"Account not linked - different emails not allowed"});try{await e.context.internalAdapter.createAccount({userId:t.user.id,providerId:r.id,accountId:u,accessToken:e.body.idToken.accessToken,idToken:i,refreshToken:e.body.idToken.refreshToken,scope:e.body.idToken.scopes?.join(",")},e)}catch{throw new T("EXPECTATION_FAILED",{message:"Account not linked - unable to create account"})}if(e.context.options.account?.accountLinking?.updateUserInfoOnLink===!0)try{await e.context.internalAdapter.updateUser(t.user.id,{name:c.user?.name,image:c.user?.image})}catch(m){console.warn("Could not update user - "+m.toString())}return e.json({url:"",status:!0,redirect:!1})}const n=await Zl(e,{userId:t.user.id,email:t.user.email}),s=await r.createAuthorizationURL({state:n.state,codeVerifier:n.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${r.id}`,scopes:e.body.scopes});return e.json({url:s.toString(),redirect:!e.body.disableRedirect})}),vk=ee("/unlink-account",{method:"POST",body:oe({providerId:C(),accountId:C().optional()}),use:[Vv],metadata:{openapi:{description:"Unlink an account",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{const{providerId:t,accountId:r}=e.body,n=await e.context.internalAdapter.findAccounts(e.context.session.user.id);if(n.length===1&&!e.context.options.account?.accountLinking?.allowUnlinkingAll)throw new T("BAD_REQUEST",{message:V.FAILED_TO_UNLINK_LAST_ACCOUNT});const s=n.find(i=>r?i.accountId===r&&i.providerId===t:i.providerId===t);if(!s)throw new T("BAD_REQUEST",{message:V.ACCOUNT_NOT_FOUND});return await e.context.internalAdapter.deleteAccount(s.id),e.json({status:!0})}),rh=ee("/get-access-token",{method:"POST",body:oe({providerId:C().describe("The provider ID for the OAuth provider"),accountId:C().describe("The account ID associated with the refresh token").optional(),userId:C().describe("The user ID associated with the account").optional()}),metadata:{openapi:{description:"Get a valid access token, doing a refresh if needed",responses:{200:{description:"A Valid access token",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{const{providerId:t,accountId:r,userId:n}=e.body,s=e.request,i=await Rt(e);if(s&&!i)throw e.error("UNAUTHORIZED");let o=i?.user?.id||n;if(!o)throw new T("BAD_REQUEST",{message:"Either userId or session is required"});if(!e.context.socialProviders.find(d=>d.id===t))throw new T("BAD_REQUEST",{message:`Provider ${t} is not supported.`});const c=(await e.context.internalAdapter.findAccounts(o)).find(d=>r?d.id===r&&d.providerId===t:d.providerId===t);if(!c)throw new T("BAD_REQUEST",{message:"Account not found"});const u=e.context.socialProviders.find(d=>d.id===t);if(!u)throw new T("BAD_REQUEST",{message:`Provider ${t} not found.`});try{let d=null;const l=c.accessTokenExpiresAt&&new Date(c.accessTokenExpiresAt).getTime()-Date.now()<5e3;c.refreshToken&&l&&u.refreshAccessToken&&(d=await u.refreshAccessToken(c.refreshToken),await e.context.internalAdapter.updateAccount(c.id,{accessToken:await Qe(d.accessToken,e.context),accessTokenExpiresAt:d.accessTokenExpiresAt,refreshToken:await Qe(d.refreshToken,e.context),refreshTokenExpiresAt:d.refreshTokenExpiresAt}));const h={accessToken:await wA(d?.accessToken??c.accessToken??"",e.context),accessTokenExpiresAt:d?.accessTokenExpiresAt??c.accessTokenExpiresAt??void 0,scopes:c.scope?.split(",")??[],idToken:d?.idToken??c.idToken??void 0};return e.json(h)}catch(d){throw new T("BAD_REQUEST",{message:"Failed to get a valid access token",cause:d})}}),Nk=ee("/refresh-token",{method:"POST",body:oe({providerId:C().describe("The provider ID for the OAuth provider"),accountId:C().describe("The account ID associated with the refresh token").optional(),userId:C().describe("The user ID associated with the account").optional()}),metadata:{openapi:{description:"Refresh the access token using a refresh token",responses:{200:{description:"Access token refreshed successfully",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{const{providerId:t,accountId:r,userId:n}=e.body,s=e.request,i=await Rt(e);if(s&&!i)throw e.error("UNAUTHORIZED");let o=i?.user?.id||n;if(!o)throw new T("BAD_REQUEST",{message:"Either userId or session is required"});const c=(await e.context.internalAdapter.findAccounts(o)).find(d=>r?d.id===r&&d.providerId===t:d.providerId===t);if(!c)throw new T("BAD_REQUEST",{message:"Account not found"});const u=e.context.socialProviders.find(d=>d.id===t);if(!u)throw new T("BAD_REQUEST",{message:`Provider ${t} not found.`});if(!u.refreshAccessToken)throw new T("BAD_REQUEST",{message:`Provider ${t} does not support token refreshing.`});try{const d=await u.refreshAccessToken(c.refreshToken);return await e.context.internalAdapter.updateAccount(c.id,{accessToken:await Qe(d.accessToken,e.context),refreshToken:await Qe(d.refreshToken,e.context),accessTokenExpiresAt:d.accessTokenExpiresAt,refreshTokenExpiresAt:d.refreshTokenExpiresAt}),e.json(d)}catch(d){throw new T("BAD_REQUEST",{message:"Failed to refresh access token",cause:d})}}),Ek=ee("/account-info",{method:"POST",use:[Ps],metadata:{openapi:{description:"Get the account info provided by the provider",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",properties:{id:{type:"string"},name:{type:"string"},email:{type:"string"},image:{type:"string"},emailVerified:{type:"boolean"}},required:["id","emailVerified"]},data:{type:"object",properties:{},additionalProperties:!0}},required:["user","data"],additionalProperties:!1}}}}}}},body:oe({accountId:C().describe("The provider given account id for which to get the account info")})},async e=>{const t=await e.context.internalAdapter.findAccount(e.body.accountId);if(!t||t.userId!==e.context.session.user.id)throw new T("BAD_REQUEST",{message:"Account not found"});const r=e.context.socialProviders.find(i=>i.id===t.providerId);if(!r)throw new T("INTERNAL_SERVER_ERROR",{message:`Provider account provider is ${t.providerId} but it is not configured`});const n=await rh({...e,body:{accountId:t.id,providerId:t.providerId},returnHeaders:!1});if(!n.accessToken)throw new T("BAD_REQUEST",{message:"Access token not found"});const s=await r.getUserInfo({...n,accessToken:n.accessToken});return e.json(s)}),nh=Hl((e,t,r)=>{if(Array.isArray(e[t])&&Array.isArray(r))return e[t]=r,!0});function Ak(e,t){const r={};for(const[n,s]of Object.entries(e))r[n]=async i=>{const o=await t;let a={...i,context:{...o,returned:void 0,responseHeaders:void 0,session:null},path:s.path,headers:i?.headers?new Headers(i?.headers):void 0};const{beforeHooks:c,afterHooks:u}=_k(o),d=await kk(a,c);if("context"in d&&d.context&&typeof d.context=="object"){const{headers:m,...y}=d.context;m&&m.forEach((g,b)=>{a.headers.set(b,g)}),a=nh(y,a)}else if(d)return i?.asResponse?Lr(d,{headers:i?.headers}):i?.returnHeaders?{headers:i?.headers,response:d}:d;a.asResponse=!1,a.returnHeaders=!0;const l=await s(a).catch(m=>{if(m instanceof T)return{response:m,headers:m.headers?new Headers(m.headers):null};throw m});if(l&&l instanceof Response)return l;a.context.returned=l.response,a.context.responseHeaders=l.headers;const h=await Tk(a,u);if(h.response&&(l.response=h.response),l.response instanceof T&&eo(o.logger.level,"debug")&&(l.response.stack=l.response.errorStack),l.response instanceof T&&!i?.asResponse)throw l.response;return i?.asResponse?Lr(l.response,{headers:l.headers}):i?.returnHeaders?{headers:l.headers,response:l.response}:l.response},r[n].path=s.path,r[n].options=s.options;return r}async function kk(e,t){let r={};for(const n of t)if(n.matcher(e)){const s=await n.handler({...e,returnHeaders:!1}).catch(i=>{throw i instanceof T&&eo(e.context.logger.level,"debug")&&(i.stack=i.errorStack),i});if(s&&typeof s=="object"){if("context"in s&&typeof s.context=="object"){const{headers:i,...o}=s.context;i instanceof Headers&&(r.headers?i.forEach((a,c)=>{r.headers?.set(c,a)}):r.headers=i),r=nh(o,r);continue}return s}}return{context:r}}async function Tk(e,t){for(const r of t)if(r.matcher(e)){const n=await r.handler(e).catch(s=>{if(s instanceof T)return eo(e.context.logger.level,"debug")&&(s.stack=s.errorStack),{response:s,headers:s.headers?new Headers(s.headers):null};throw s});n.headers&&n.headers.forEach((s,i)=>{e.context.responseHeaders?i.toLowerCase()==="set-cookie"?e.context.responseHeaders.append(i,s):e.context.responseHeaders.set(i,s):e.context.responseHeaders=new Headers({[i]:s})}),n.response&&(e.context.returned=n.response)}return{response:e.context.returned,headers:e.context.responseHeaders}}function _k(e){const t=e.options.plugins||[],r=[],n=[];e.options.hooks?.before&&r.push({matcher:()=>!0,handler:e.options.hooks.before}),e.options.hooks?.after&&n.push({matcher:()=>!0,handler:e.options.hooks.after});const s=t.map(o=>{if(o.hooks?.before)return o.hooks.before}).filter(o=>o!==void 0).flat(),i=t.map(o=>{if(o.hooks?.after)return o.hooks.after}).filter(o=>o!==void 0).flat();return s.length&&r.push(...s),i.length&&n.push(...i),{beforeHooks:r,afterHooks:n}}function sh(e,t){if(t.advanced?.ipAddress?.disableIpTracking)return null;if(Na()||va)return"127.0.0.1";const r="headers"in e?e.headers:e,n=["x-forwarded-for"],s=t.advanced?.ipAddress?.ipAddressHeaders||n;for(const i of s){const o="get"in r?r.get(i):r[i];if(typeof o=="string"){const a=o.split(",")[0].trim();if(Sk(a))return a}}return null}function Sk(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)?e.split(".").map(Number).every(s=>s>=0&&s<=255):/^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(e)}const Rk=()=>ee("/sign-up/email",{method:"POST",body:Kd(C(),Hd()),metadata:{$Infer:{body:{}},openapi:{description:"Sign up a user using email and password",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},email:{type:"string",description:"The email of the user"},password:{type:"string",description:"The password of the user"},image:{type:"string",description:"The profile image URL of the user"},callbackURL:{type:"string",description:"The URL to use for email verification callback"},rememberMe:{type:"boolean",description:"If this is false, the session will not be remembered. Default is `true`."}},required:["name","email","password"]}}}},responses:{200:{description:"Successfully created user",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"Authentication token for the session"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}},422:{description:"Unprocessable Entity. User already exists or failed to create user.",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.enabled||e.context.options.emailAndPassword?.disableSignUp)throw new T("BAD_REQUEST",{message:"Email and password sign up is not enabled"});const t=e.body,{name:r,email:n,password:s,image:i,callbackURL:o,rememberMe:a,...c}=t;if(!C().email().safeParse(n).success)throw new T("BAD_REQUEST",{message:V.INVALID_EMAIL});const d=e.context.password.config.minPasswordLength;if(s.length<d)throw e.context.logger.error("Password is too short"),new T("BAD_REQUEST",{message:V.PASSWORD_TOO_SHORT});const l=e.context.password.config.maxPasswordLength;if(s.length>l)throw e.context.logger.error("Password is too long"),new T("BAD_REQUEST",{message:V.PASSWORD_TOO_LONG});if((await e.context.internalAdapter.findUserByEmail(n))?.user)throw e.context.logger.info(`Sign-up attempt for existing email: ${n}`),new T("UNPROCESSABLE_ENTITY",{message:V.USER_ALREADY_EXISTS});const p=Bl(e.context.options,c),m=await e.context.password.hash(s);let y;try{if(y=await e.context.internalAdapter.createUser({email:n.toLowerCase(),name:r,image:i,...p,emailVerified:!1},e),!y)throw new T("BAD_REQUEST",{message:V.FAILED_TO_CREATE_USER})}catch(b){throw va&&e.context.logger.error("Failed to create user",b),b instanceof T?b:new T("UNPROCESSABLE_ENTITY",{message:V.FAILED_TO_CREATE_USER,details:b})}if(!y)throw new T("UNPROCESSABLE_ENTITY",{message:V.FAILED_TO_CREATE_USER});if(await e.context.internalAdapter.linkAccount({userId:y.id,providerId:"credential",accountId:y.id,password:m},e),e.context.options.emailVerification?.sendOnSignUp||e.context.options.emailAndPassword.requireEmailVerification){const b=await Wr(e.context.secret,y.email,void 0,e.context.options.emailVerification?.expiresIn),w=`${e.context.baseURL}/verify-email?token=${b}&callbackURL=${t.callbackURL||"/"}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:y,url:w,token:b},e.request)}if(e.context.options.emailAndPassword.autoSignIn===!1||e.context.options.emailAndPassword.requireEmailVerification)return e.json({token:null,user:{id:y.id,email:y.email,name:y.name,image:y.image,emailVerified:y.emailVerified,createdAt:y.createdAt,updatedAt:y.updatedAt}});const g=await e.context.internalAdapter.createSession(y.id,e,a===!1);if(!g)throw new T("BAD_REQUEST",{message:V.FAILED_TO_CREATE_SESSION});return await yt(e,{session:g,user:y},a===!1),e.json({token:g.token,user:{id:y.id,email:y.email,name:y.name,image:y.image,emailVerified:y.emailVerified,createdAt:y.createdAt,updatedAt:y.updatedAt}})});function Ok(e,t,r){const n=Date.now(),s=t*1e3;return n-r.lastRequest<s&&r.count>=e}function Ik(e){return new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests",headers:{"X-Retry-After":e.toString()}})}function xk(e,t){const r=Date.now(),n=t*1e3;return Math.ceil((e+n-r)/1e3)}function Ck(e){const t="rateLimit",r=e.adapter;return{get:async n=>{const i=(await r.findMany({model:t,where:[{field:"key",value:n}]}))[0];return typeof i?.lastRequest=="bigint"&&(i.lastRequest=Number(i.lastRequest)),i},set:async(n,s,i)=>{try{i?await r.updateMany({model:t,where:[{field:"key",value:n}],update:{count:s.count,lastRequest:s.lastRequest}}):await r.create({model:t,data:{key:n,count:s.count,lastRequest:s.lastRequest}})}catch(o){e.logger.error("Error setting rate limit",o)}}}}const lu=new Map;function Pk(e){return e.options.rateLimit?.customStorage?e.options.rateLimit.customStorage:e.rateLimit.storage==="secondary-storage"?{get:async r=>{const n=await e.options.secondaryStorage?.get(r);return n?He(n):void 0},set:async(r,n)=>{await e.options.secondaryStorage?.set?.(r,JSON.stringify(n))}}:e.rateLimit.storage==="memory"?{async get(r){return lu.get(r)},async set(r,n,s){lu.set(r,n)}}:Ck(e)}async function Uk(e,t){if(!t.rateLimit.enabled)return;const r=new URL(e.url).pathname.replace(t.options.basePath||"/api/auth","");let n=t.rateLimit.window,s=t.rateLimit.max;const i=sh(e,t.options);if(!i)return;const o=i+r,c=Lk().find(h=>h.pathMatcher(r));c&&(n=c.window,s=c.max);for(const h of t.options.plugins||[])if(h.rateLimit){const p=h.rateLimit.find(m=>m.pathMatcher(r));if(p){n=p.window,s=p.max;break}}if(t.rateLimit.customRules){const h=Object.keys(t.rateLimit.customRules).find(p=>p.includes("*")?ks(p)(r):p===r);if(h){const p=t.rateLimit.customRules[h],m=typeof p=="function"?await p(e):p;if(m&&(n=m.window,s=m.max),m===!1)return}}const u=Pk(t),d=await u.get(o),l=Date.now();if(!d)await u.set(o,{key:o,count:1,lastRequest:l});else{const h=l-d.lastRequest;if(Ok(s,n,d)){const p=xk(d.lastRequest,n);return Ik(p)}else h>n*1e3?await u.set(o,{...d,count:1,lastRequest:l},!0):await u.set(o,{...d,count:d.count+1,lastRequest:l},!0)}}function Lk(){return[{pathMatcher(t){return t.startsWith("/sign-in")||t.startsWith("/sign-up")||t.startsWith("/change-password")||t.startsWith("/change-email")},window:10,max:3}]}function $k(e,t){const r=new Map;e.plugins?.forEach(s=>{if(s.endpoints){for(const[i,o]of Object.entries(s.endpoints))if(o&&"path"in o){const a=o.path;let c=[];o.options&&"method"in o.options&&(Array.isArray(o.options.method)?c=o.options.method:typeof o.options.method=="string"&&(c=[o.options.method])),c.length===0&&(c=["*"]),r.has(a)||r.set(a,[]),r.get(a).push({pluginId:s.id,endpointKey:i,methods:c})}}});const n=[];for(const[s,i]of r.entries())if(i.length>1){const o=new Map;let a=!1;for(const c of i)for(const u of c.methods)o.has(u)||o.set(u,[]),o.get(u).push(c.pluginId),o.get(u).length>1&&(a=!0),(u==="*"&&i.length>1||u!=="*"&&o.has("*"))&&(a=!0);if(a){const c=[...new Set(i.map(d=>d.pluginId))],u=[];for(const[d,l]of o.entries())(l.length>1||d==="*"&&i.length>1||d!=="*"&&o.has("*"))&&u.push(d);n.push({path:s,plugins:c,conflictingMethods:u})}}if(n.length>0){const s=n.map(i=>`  - "${i.path}" [${i.conflictingMethods.join(", ")}] used by plugins: ${i.plugins.join(", ")}`).join(`
`);t.error(`Endpoint path conflicts detected! Multiple plugins are trying to use the same endpoint paths with conflicting HTTP methods:
${s}

To resolve this, you can:
	1. Use only one of the conflicting plugins
	2. Configure the plugins to use different paths (if supported)
	3. Ensure plugins use different HTTP methods for the same path
`)}}function ih(e,t){const r=t.plugins?.reduce((a,c)=>({...a,...c.endpoints}),{}),n=t.plugins?.map(a=>a.middlewares?.map(c=>{const u=(async d=>{const l=await e;return c.middleware({...d,context:{...l,...d.context}})});return u.options=c.middleware.options,{path:c.path,middleware:u}})).filter(a=>a!==void 0).flat()||[],i={...{signInSocial:ek,callbackOAuth:rk,getSession:ul(),signOut:nk,signUpEmail:Rk(),signInEmail:tk,forgetPassword:ok,resetPassword:ck,verifyEmail:mA,sendVerificationEmail:pA,changeEmail:fk,changePassword:dk,setPassword:lk,updateUser:uk(),deleteUser:hk,forgetPasswordCallback:ak,requestPasswordReset:ik,requestPasswordResetCallback:eh,listSessions:Fv(),revokeSession:Bv,revokeSessions:Hv,revokeOtherSessions:Kv,linkSocialAccount:bk,listUserAccounts:gk,deleteUserCallback:th,unlinkAccount:vk,refreshToken:Nk,getAccessToken:rh,accountInfo:Ek},...r,ok:wk,error:yk};return{api:Ak(i,e),middlewares:n}}const Dk=(e,t)=>{const{api:r,middlewares:n}=ih(e,t),s=new URL(e.baseURL).pathname;return dy(r,{routerContext:e,openapi:{disabled:!0},basePath:s,routerMiddleware:[{path:"/**",middleware:fA},...n],async onRequest(i){const o=e.options.disabledPaths||[],a=new URL(i.url).pathname.replace(s,"");if(o.includes(a))return new Response("Not Found",{status:404});for(const c of e.options.plugins||[])if(c.onRequest){const u=await c.onRequest(i,e);if(u&&"response"in u)return u.response}return Uk(i,e)},async onResponse(i){for(const o of e.options.plugins||[])if(o.onResponse){const a=await o.onResponse(i,e);if(a)return a.response}return i},onError(i){if(i instanceof T&&i.status==="FOUND")return;if(t.onAPIError?.throw)throw i;if(t.onAPIError?.onError){t.onAPIError.onError(i,e);return}const o=t.logger?.level,a=o==="error"||o==="warn"||o==="debug"?K:void 0;if(t.logger?.disabled!==!0){if(i&&typeof i=="object"&&"message"in i&&typeof i.message=="string"&&(i.message.includes("no column")||i.message.includes("column")||i.message.includes("relation")||i.message.includes("table")||i.message.includes("does not exist"))){e.logger?.error(i.message);return}i instanceof T?(i.status==="INTERNAL_SERVER_ERROR"&&e.logger.error(i.status,i),a?.error(i.message)):e.logger?.error(i&&typeof i=="object"&&"name"in i?i.name:"",i)}}})},Ts=e=>{const t=(e.plugins??[]).reduce((u,d)=>{const l=d.schema;if(!l)return u;for(const[h,p]of Object.entries(l))u[h]={fields:{...u[h]?.fields,...p.fields},modelName:p.modelName||h};return u},{}),r=e.rateLimit?.storage==="database",n={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",bigint:!0,fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:s,session:i,account:o,...a}=t,c={session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt",defaultValue:()=>new Date},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt",onUpdate:()=>new Date},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...i?.fields,...e.session?.additionalFields},order:2}};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name",sortable:!0},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email",sortable:!0},emailVerified:{type:"boolean",defaultValue:!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,onUpdate:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...s?.fields,...e.user?.additionalFields},order:1},...!e.secondaryStorage||e.session?.storeSessionInDatabase?c:{},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.refreshTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt",defaultValue:()=>new Date},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt",onUpdate:()=>new Date},...o?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!0,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,defaultValue:()=>new Date,onUpdate:()=>new Date,fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...a,...r?n:{}}};function Mt(e){return typeof e>"u"||e===void 0}function Me(e){return typeof e=="string"}function Pn(e){return typeof e=="number"}function _s(e){return typeof e=="boolean"}function so(e){return e===null}function oh(e){return e instanceof Date}function io(e){return typeof e=="bigint"}function qk(e){return typeof Buffer<"u"&&Buffer.isBuffer(e)}function Be(e){return typeof e=="function"}function it(e){return typeof e=="object"&&e!==null}function f(e){return Object.freeze(e)}function Zs(e){return Ht(e)?e:[e]}function Ht(e){return Array.isArray(e)}function st(e){return e}const te=f({is(e){return e.kind==="AlterTableNode"},create(e){return f({kind:"AlterTableNode",table:e})},cloneWithTableProps(e,t){return f({...e,...t})},cloneWithColumnAlteration(e,t){return f({...e,columnAlterations:e.columnAlterations?[...e.columnAlterations,t]:[t]})}}),re=f({is(e){return e.kind==="IdentifierNode"},create(e){return f({kind:"IdentifierNode",name:e})}}),Ut=f({is(e){return e.kind==="CreateIndexNode"},create(e){return f({kind:"CreateIndexNode",name:re.create(e)})},cloneWith(e,t){return f({...e,...t})},cloneWithColumns(e,t){return f({...e,columns:[...e.columns||[],...t]})}}),ah=f({is(e){return e.kind==="CreateSchemaNode"},create(e,t){return f({kind:"CreateSchemaNode",schema:re.create(e),...t})},cloneWith(e,t){return f({...e,...t})}}),Wk=["preserve rows","delete rows","drop"],et=f({is(e){return e.kind==="CreateTableNode"},create(e){return f({kind:"CreateTableNode",table:e,columns:f([])})},cloneWithColumn(e,t){return f({...e,columns:f([...e.columns,t])})},cloneWithConstraint(e,t){return f({...e,constraints:e.constraints?f([...e.constraints,t]):f([t])})},cloneWithFrontModifier(e,t){return f({...e,frontModifiers:e.frontModifiers?f([...e.frontModifiers,t]):f([t])})},cloneWithEndModifier(e,t){return f({...e,endModifiers:e.endModifiers?f([...e.endModifiers,t]):f([t])})},cloneWith(e,t){return f({...e,...t})}}),Kt=f({is(e){return e.kind==="SchemableIdentifierNode"},create(e){return f({kind:"SchemableIdentifierNode",identifier:re.create(e)})},createWithSchema(e,t){return f({kind:"SchemableIdentifierNode",schema:re.create(e),identifier:re.create(t)})}}),ss=f({is(e){return e.kind==="DropIndexNode"},create(e,t){return f({kind:"DropIndexNode",name:Kt.create(e),...t})},cloneWith(e,t){return f({...e,...t})}}),Qo=f({is(e){return e.kind==="DropSchemaNode"},create(e,t){return f({kind:"DropSchemaNode",schema:re.create(e),...t})},cloneWith(e,t){return f({...e,...t})}}),Yo=f({is(e){return e.kind==="DropTableNode"},create(e,t){return f({kind:"DropTableNode",table:e,...t})},cloneWith(e,t){return f({...e,...t})}}),Jt=f({is(e){return e.kind==="AliasNode"},create(e,t){return f({kind:"AliasNode",node:e,alias:t})}}),Wt=f({is(e){return e.kind==="TableNode"},create(e){return f({kind:"TableNode",table:Kt.create(e)})},createWithSchema(e,t){return f({kind:"TableNode",table:Kt.createWithSchema(e,t)})}});function Ke(e){return it(e)&&Be(e.toOperationNode)}function ch(e){return it(e)&&"expressionType"in e&&Ke(e)}function zk(e){return it(e)&&"expression"in e&&Me(e.alias)&&Ke(e)}const Pt=f({is(e){return e.kind==="SelectModifierNode"},create(e,t){return f({kind:"SelectModifierNode",modifier:e,of:t})},createWithExpression(e){return f({kind:"SelectModifierNode",rawModifier:e})}}),wr=f({is(e){return e.kind==="AndNode"},create(e,t){return f({kind:"AndNode",left:e,right:t})}}),zn=f({is(e){return e.kind==="OrNode"},create(e,t){return f({kind:"OrNode",left:e,right:t})}}),Ao=f({is(e){return e.kind==="OnNode"},create(e){return f({kind:"OnNode",on:e})},cloneWithOperation(e,t,r){return f({...e,on:t==="And"?wr.create(e.on,r):zn.create(e.on,r)})}}),Dr=f({is(e){return e.kind==="JoinNode"},create(e,t){return f({kind:"JoinNode",joinType:e,table:t,on:void 0})},createWithOn(e,t,r){return f({kind:"JoinNode",joinType:e,table:t,on:Ao.create(r)})},cloneWithOn(e,t){return f({...e,on:e.on?Ao.cloneWithOperation(e.on,"And",t):Ao.create(t)})}}),Un=f({is(e){return e.kind==="BinaryOperationNode"},create(e,t,r){return f({kind:"BinaryOperationNode",leftOperand:e,operator:t,rightOperand:r})}}),Mk=["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","^@","&&","?","?&","?|","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->","regexp","is distinct from","is not distinct from"],jk=["+","-","*","/","%","^","&","|","#","<<",">>"],uh=["->","->>"],Vk=[...Mk,...jk,"&&","||"],Fk=["exists","not exists"],Bk=["not","-",...Fk],Hk=[...Vk,...uh,...Bk,"between","between symmetric"],gr=f({is(e){return e.kind==="OperatorNode"},create(e){return f({kind:"OperatorNode",operator:e})}});function hu(e){return Me(e)&&uh.includes(e)}const Re=f({is(e){return e.kind==="ColumnNode"},create(e){return f({kind:"ColumnNode",column:re.create(e)})}}),xa=f({is(e){return e.kind==="SelectAllNode"},create(){return f({kind:"SelectAllNode"})}}),oo=f({is(e){return e.kind==="ReferenceNode"},create(e,t){return f({kind:"ReferenceNode",table:t,column:e})},createSelectAll(e){return f({kind:"ReferenceNode",table:e,column:xa.create()})}});class Kk{#e;get dynamicReference(){return this.#e}get refType(){}constructor(t){this.#e=t}toOperationNode(){return ph(this.#e)}}function dh(e){return it(e)&&Ke(e)&&Me(e.dynamicReference)}const qt=f({is(e){return e.kind==="OrderByItemNode"},create(e,t){return f({kind:"OrderByItemNode",orderBy:e,direction:t})},cloneWith(e,t){return f({...e,...t})}}),Se=f({is(e){return e.kind==="RawNode"},create(e,t){return f({kind:"RawNode",sqlFragments:f(e),parameters:f(t)})},createWithSql(e){return Se.create([e],[])},createWithChild(e){return Se.create(["",""],[e])},createWithChildren(e){return Se.create(new Array(e.length+1).fill(""),e)}}),Zk={is(e){return e.kind==="CollateNode"},create(e){return f({kind:"CollateNode",collation:re.create(e)})}};class _r{#e;constructor(t){this.#e=f(t)}desc(){return new _r({node:qt.cloneWith(this.#e.node,{direction:Se.createWithSql("desc")})})}asc(){return new _r({node:qt.cloneWith(this.#e.node,{direction:Se.createWithSql("asc")})})}nullsLast(){return new _r({node:qt.cloneWith(this.#e.node,{nulls:"last"})})}nullsFirst(){return new _r({node:qt.cloneWith(this.#e.node,{nulls:"first"})})}collate(t){return new _r({node:qt.cloneWith(this.#e.node,{collation:Zk.create(t)})})}toOperationNode(){return this.#e.node}}const fu=new Set;function Mn(e){fu.has(e)||(fu.add(e),console.log(e))}function lh(e){return e==="asc"||e==="desc"}function zr(e){if(e.length===2)return[ko(e[0],e[1])];if(e.length===1){const[t]=e;return Array.isArray(t)?(Mn("orderBy(array) is deprecated, use multiple orderBy calls instead."),t.map(r=>ko(r))):[ko(t)]}throw new Error(`Invalid number of arguments at order by! expected 1-2, received ${e.length}`)}function ko(e,t){const r=Jk(e);if(qt.is(r)){if(t)throw new Error("Cannot specify direction twice!");return r}return hh(r,t)}function Jk(e){if(Ds(e))return Zr(e);if(dh(e))return e.toOperationNode();const[t,r]=e.split(" ");return r?(Mn("`orderBy('column asc')` is deprecated. Use `orderBy('column', 'asc')` instead."),hh(Zt(t),r)):Zt(e)}function hh(e,t){if(typeof t=="string"){if(!lh(t))throw new Error(`Invalid order by direction: ${t}`);return qt.create(e,Se.createWithSql(t))}if(ch(t))return Mn("`orderBy(..., expr)` is deprecated. Use `orderBy(..., 'asc')` or `orderBy(..., (ob) => ...)` instead."),qt.create(e,t.toOperationNode());const r=qt.create(e);return t?t(new _r({node:r})).toOperationNode():r}const Oi=f({is(e){return e.kind==="JSONReferenceNode"},create(e,t){return f({kind:"JSONReferenceNode",reference:e,traversal:t})},cloneWithTraversal(e,t){return f({...e,traversal:t})}}),fh=f({is(e){return e.kind==="JSONOperatorChainNode"},create(e){return f({kind:"JSONOperatorChainNode",operator:e,values:f([])})},cloneWithValue(e,t){return f({...e,values:f([...e.values,t])})}}),is=f({is(e){return e.kind==="JSONPathNode"},create(e){return f({kind:"JSONPathNode",inOperator:e,pathLegs:f([])})},cloneWithLeg(e,t){return f({...e,pathLegs:f([...e.pathLegs,t])})}});function ph(e){return Me(e)?Zt(e):e.toOperationNode()}function Ss(e){return Ht(e)?e.map(t=>ot(t)):[ot(e)]}function ot(e){return Ds(e)?Zr(e):ph(e)}function Gk(e,t){const r=Zt(e);if(hu(t))return Oi.create(r,fh.create(gr.create(t)));const n=t.slice(0,-1);if(hu(n))return Oi.create(r,is.create(gr.create(n)));throw new Error(`Invalid JSON operator: ${t}`)}function Zt(e){if(!e.includes("."))return oo.create(Re.create(e));const r=e.split(".").map(Ca);if(r.length===3)return Yk(r);if(r.length===2)return Xk(r);throw new Error(`invalid column reference ${e}`)}function Qk(e){const t=" as ";if(e.includes(t)){const[r,n]=e.split(t).map(Ca);return Jt.create(Zt(r),re.create(n))}else return Zt(e)}function mh(e){return Re.create(e)}function Ii(e){if(e.includes(" ")){const[r,n]=e.split(" ").map(Ca);if(!lh(n))throw new Error(`invalid order direction "${n}" next to "${r}"`);return zr([r,n])[0]}else return mh(e)}function Yk(e){const[t,r,n]=e;return oo.create(Re.create(n),Wt.createWithSchema(t,r))}function Xk(e){const[t,r]=e;return oo.create(Re.create(r),Wt.create(t))}function Ca(e){return e.trim()}const yh=f({is(e){return e.kind==="PrimitiveValueListNode"},create(e){return f({kind:"PrimitiveValueListNode",values:f([...e])})}}),ao=f({is(e){return e.kind==="ValueListNode"},create(e){return f({kind:"ValueListNode",values:f(e)})}}),ut=f({is(e){return e.kind==="ValueNode"},create(e){return f({kind:"ValueNode",value:e})},createImmediate(e){return f({kind:"ValueNode",value:e,immediate:!0})}});function eT(e){return Ht(e)?tT(e):Oe(e)}function Oe(e){return Ds(e)?Zr(e):ut.create(e)}function Pa(e){return Pn(e)||_s(e)||so(e)}function Ua(e){if(!Pa(e))throw new Error(`unsafe immediate value ${JSON.stringify(e)}`);return ut.createImmediate(e)}function tT(e){return e.some(Ds)?ao.create(e.map(t=>Oe(t))):yh.create(e)}const Ln=f({is(e){return e.kind==="ParensNode"},create(e){return f({kind:"ParensNode",node:e})}});function je(e){if(e.length===3)return La(e[0],e[1],e[2]);if(e.length===1)return Oe(e[0]);throw new Error(`invalid arguments: ${JSON.stringify(e)}`)}function La(e,t,r){return rT(t)&&wh(r)?Un.create(ot(e),Xo(t),ut.createImmediate(r)):Un.create(ot(e),Xo(t),eT(r))}function Ot(e,t,r){return Un.create(ot(e),Xo(t),ot(r))}function pu(e,t){return xi(Object.entries(e).filter(([,r])=>!Mt(r)).map(([r,n])=>La(r,wh(n)?"is":"=",n)),t)}function xi(e,t,r=!0){const n=t==="and"?wr.create:zn.create;if(e.length===0)return Un.create(ut.createImmediate(1),gr.create("="),ut.createImmediate(t==="and"?1:0));let s=mu(e[0]);for(let i=1;i<e.length;++i)s=n(s,mu(e[i]));return e.length>1&&r?Ln.create(s):s}function rT(e){return e==="is"||e==="is not"}function wh(e){return so(e)||_s(e)}function Xo(e){if(Me(e)&&Hk.includes(e))return gr.create(e);if(Ke(e))return e.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(e)}`)}function mu(e){return Ke(e)?e.toOperationNode():e}const $n=f({is(e){return e.kind==="OrderByNode"},create(e){return f({kind:"OrderByNode",items:f([...e])})},cloneWithItems(e,t){return f({...e,items:f([...e.items,...t])})}}),yu=f({is(e){return e.kind==="PartitionByNode"},create(e){return f({kind:"PartitionByNode",items:f(e)})},cloneWithItems(e,t){return f({...e,items:f([...e.items,...t])})}}),ea=f({is(e){return e.kind==="OverNode"},create(){return f({kind:"OverNode"})},cloneWithOrderByItems(e,t){return f({...e,orderBy:e.orderBy?$n.cloneWithItems(e.orderBy,t):$n.create(t)})},cloneWithPartitionByItems(e,t){return f({...e,partitionBy:e.partitionBy?yu.cloneWithItems(e.partitionBy,t):yu.create(t)})}}),Ci=f({is(e){return e.kind==="FromNode"},create(e){return f({kind:"FromNode",froms:f(e)})},cloneWithFroms(e,t){return f({...e,froms:f([...e.froms,...t])})}}),wu=f({is(e){return e.kind==="GroupByNode"},create(e){return f({kind:"GroupByNode",items:f(e)})},cloneWithItems(e,t){return f({...e,items:f([...e.items,...t])})}}),gu=f({is(e){return e.kind==="HavingNode"},create(e){return f({kind:"HavingNode",having:e})},cloneWithOperation(e,t,r){return f({...e,having:t==="And"?wr.create(e.having,r):zn.create(e.having,r)})}}),$e=f({is(e){return e.kind==="InsertQueryNode"},create(e,t,r){return f({kind:"InsertQueryNode",into:e,...t&&{with:t},replace:r})},createWithoutInto(){return f({kind:"InsertQueryNode"})},cloneWith(e,t){return f({...e,...t})}}),gh=f({is(e){return e.kind==="ListNode"},create(e){return f({kind:"ListNode",items:f(e)})}}),An=f({is(e){return e.kind==="UpdateQueryNode"},create(e,t){return f({kind:"UpdateQueryNode",table:e.length===1?e[0]:gh.create(e),...t&&{with:t}})},createWithoutTable(){return f({kind:"UpdateQueryNode"})},cloneWithFromItems(e,t){return f({...e,from:e.from?Ci.cloneWithFroms(e.from,t):Ci.create(t)})},cloneWithUpdates(e,t){return f({...e,updates:e.updates?f([...e.updates,...t]):t})},cloneWithLimit(e,t){return f({...e,limit:t})}}),bu=f({is(e){return e.kind==="UsingNode"},create(e){return f({kind:"UsingNode",tables:f(e)})},cloneWithTables(e,t){return f({...e,tables:f([...e.tables,...t])})}}),os=f({is(e){return e.kind==="DeleteQueryNode"},create(e,t){return f({kind:"DeleteQueryNode",from:Ci.create(e),...t&&{with:t}})},cloneWithOrderByItems:(e,t)=>L.cloneWithOrderByItems(e,t),cloneWithoutOrderBy:e=>L.cloneWithoutOrderBy(e),cloneWithLimit(e,t){return f({...e,limit:t})},cloneWithoutLimit(e){return f({...e,limit:void 0})},cloneWithUsing(e,t){return f({...e,using:e.using!==void 0?bu.cloneWithTables(e.using,t):bu.create(t)})}}),Ze=f({is(e){return e.kind==="WhereNode"},create(e){return f({kind:"WhereNode",where:e})},cloneWithOperation(e,t,r){return f({...e,where:t==="And"?wr.create(e.where,r):zn.create(e.where,r)})}}),vu=f({is(e){return e.kind==="ReturningNode"},create(e){return f({kind:"ReturningNode",selections:f(e)})},cloneWithSelections(e,t){return f({...e,selections:e.selections?f([...e.selections,...t]):f(t)})}}),nT=f({is(e){return e.kind==="ExplainNode"},create(e,t){return f({kind:"ExplainNode",format:e,options:t})}}),Us=f({is(e){return e.kind==="WhenNode"},create(e){return f({kind:"WhenNode",condition:e})},cloneWithResult(e,t){return f({...e,result:t})}}),Ye=f({is(e){return e.kind==="MergeQueryNode"},create(e,t){return f({kind:"MergeQueryNode",into:e,...t&&{with:t}})},cloneWithUsing(e,t){return f({...e,using:t})},cloneWithWhen(e,t){return f({...e,whens:e.whens?f([...e.whens,t]):f([t])})},cloneWithThen(e,t){return f({...e,whens:e.whens?f([...e.whens.slice(0,-1),Us.cloneWithResult(e.whens[e.whens.length-1],t)]):void 0})}}),Nu=f({is(e){return e.kind==="OutputNode"},create(e){return f({kind:"OutputNode",selections:f(e)})},cloneWithSelections(e,t){return f({...e,selections:e.selections?f([...e.selections,...t]):f(t)})}}),L=f({is(e){return ce.is(e)||$e.is(e)||An.is(e)||os.is(e)||Ye.is(e)},cloneWithEndModifier(e,t){return f({...e,endModifiers:e.endModifiers?f([...e.endModifiers,t]):f([t])})},cloneWithWhere(e,t){return f({...e,where:e.where?Ze.cloneWithOperation(e.where,"And",t):Ze.create(t)})},cloneWithJoin(e,t){return f({...e,joins:e.joins?f([...e.joins,t]):f([t])})},cloneWithReturning(e,t){return f({...e,returning:e.returning?vu.cloneWithSelections(e.returning,t):vu.create(t)})},cloneWithoutReturning(e){return f({...e,returning:void 0})},cloneWithoutWhere(e){return f({...e,where:void 0})},cloneWithExplain(e,t,r){return f({...e,explain:nT.create(t,r?.toOperationNode())})},cloneWithTop(e,t){return f({...e,top:t})},cloneWithOutput(e,t){return f({...e,output:e.output?Nu.cloneWithSelections(e.output,t):Nu.create(t)})},cloneWithOrderByItems(e,t){return f({...e,orderBy:e.orderBy?$n.cloneWithItems(e.orderBy,t):$n.create(t)})},cloneWithoutOrderBy(e){return f({...e,orderBy:void 0})}}),ce=f({is(e){return e.kind==="SelectQueryNode"},create(e){return f({kind:"SelectQueryNode",...e&&{with:e}})},createFrom(e,t){return f({kind:"SelectQueryNode",from:Ci.create(e),...t&&{with:t}})},cloneWithSelections(e,t){return f({...e,selections:e.selections?f([...e.selections,...t]):f(t)})},cloneWithDistinctOn(e,t){return f({...e,distinctOn:e.distinctOn?f([...e.distinctOn,...t]):f(t)})},cloneWithFrontModifier(e,t){return f({...e,frontModifiers:e.frontModifiers?f([...e.frontModifiers,t]):f([t])})},cloneWithOrderByItems:(e,t)=>L.cloneWithOrderByItems(e,t),cloneWithGroupByItems(e,t){return f({...e,groupBy:e.groupBy?wu.cloneWithItems(e.groupBy,t):wu.create(t)})},cloneWithLimit(e,t){return f({...e,limit:t})},cloneWithOffset(e,t){return f({...e,offset:t})},cloneWithFetch(e,t){return f({...e,fetch:t})},cloneWithHaving(e,t){return f({...e,having:e.having?gu.cloneWithOperation(e.having,"And",t):gu.create(t)})},cloneWithSetOperations(e,t){return f({...e,setOperations:e.setOperations?f([...e.setOperations,...t]):f([...t])})},cloneWithoutSelections(e){return f({...e,selections:[]})},cloneWithoutLimit(e){return f({...e,limit:void 0})},cloneWithoutOffset(e){return f({...e,offset:void 0})},cloneWithoutOrderBy:e=>L.cloneWithoutOrderBy(e),cloneWithoutGroupBy(e){return f({...e,groupBy:void 0})}});class as{#e;constructor(t){this.#e=f(t)}on(...t){return new as({...this.#e,joinNode:Dr.cloneWithOn(this.#e.joinNode,je(t))})}onRef(t,r,n){return new as({...this.#e,joinNode:Dr.cloneWithOn(this.#e.joinNode,Ot(t,r,n))})}onTrue(){return new as({...this.#e,joinNode:Dr.cloneWithOn(this.#e.joinNode,Se.createWithSql("true"))})}$call(t){return t(this)}toOperationNode(){return this.#e.joinNode}}const sT=f({is(e){return e.kind==="PartitionByItemNode"},create(e){return f({kind:"PartitionByItemNode",partitionBy:e})}});function iT(e){return Ss(e).map(sT.create)}class cs{#e;constructor(t){this.#e=f(t)}orderBy(...t){return new cs({overNode:ea.cloneWithOrderByItems(this.#e.overNode,zr(t))})}clearOrderBy(){return new cs({overNode:L.cloneWithoutOrderBy(this.#e.overNode)})}partitionBy(t){return new cs({overNode:ea.cloneWithPartitionByItems(this.#e.overNode,iT(t))})}$call(t){return t(this)}toOperationNode(){return this.#e.overNode}}const us=f({is(e){return e.kind==="SelectionNode"},create(e){return f({kind:"SelectionNode",selection:e})},createSelectAll(){return f({kind:"SelectionNode",selection:xa.create()})},createSelectAllFromTable(e){return f({kind:"SelectionNode",selection:oo.createSelectAll(e)})}});function ct(e){return Be(e)?ct(e(Fn())):Ht(e)?e.map(t=>Eu(t)):[Eu(e)]}function Eu(e){return Me(e)?us.create(Qk(e)):dh(e)?us.create(e.toOperationNode()):us.create(Ih(e))}function dt(e){return e?Array.isArray(e)?e.map(Au):[Au(e)]:[us.createSelectAll()]}function Au(e){if(Me(e))return us.createSelectAllFromTable(_e(e));throw new Error(`invalid value selectAll expression: ${JSON.stringify(e)}`)}const oT=f({is(e){return e.kind==="ValuesNode"},create(e){return f({kind:"ValuesNode",values:f(e)})}}),aT=f({is(e){return e.kind==="DefaultInsertValueNode"},create(){return f({kind:"DefaultInsertValueNode"})}});function bh(e){const t=Be(e)?e(Fn()):e,r=Ht(t)?t:f([t]);return cT(r)}function cT(e){const t=uT(e);return[f([...t.keys()].map(Re.create)),oT.create(e.map(r=>dT(r,t)))]}function uT(e){const t=new Map;for(const r of e){const n=Object.keys(r);for(const s of n)!t.has(s)&&r[s]!==void 0&&t.set(s,t.size)}return t}function dT(e,t){const r=Object.keys(e),n=Array.from({length:t.size});let s=!1,i=r.length;for(const a of r){const c=t.get(a);if(Mt(c)){i--;continue}const u=e[a];(Mt(u)||Ds(u))&&(s=!0),n[c]=u}if(i<t.size||s){const a=aT.create();return ao.create(n.map(c=>Mt(c)?a:Oe(c)))}return yh.create(n)}const vh=f({is(e){return e.kind==="ColumnUpdateNode"},create(e,t){return f({kind:"ColumnUpdateNode",column:e,value:t})}});function lT(...e){return e.length===2?[vh.create(ot(e[0]),Oe(e[1]))]:$a(e[0])}function $a(e){const t=Be(e)?e(Fn()):e;return Object.entries(t).filter(([r,n])=>n!==void 0).map(([r,n])=>vh.create(Re.create(r),Oe(n)))}const hT=f({is(e){return e.kind==="OnDuplicateKeyNode"},create(e){return f({kind:"OnDuplicateKeyNode",updates:e})}});class fT{insertId;numInsertedOrUpdatedRows;constructor(t,r){this.insertId=t,this.numInsertedOrUpdatedRows=r}}class Ls extends Error{node;constructor(t){super("no result"),this.node=t}}function $s(e){return Object.prototype.hasOwnProperty.call(e,"prototype")}const rt=f({is(e){return e.kind==="OnConflictNode"},create(){return f({kind:"OnConflictNode"})},cloneWith(e,t){return f({...e,...t})},cloneWithIndexWhere(e,t){return f({...e,indexWhere:e.indexWhere?Ze.cloneWithOperation(e.indexWhere,"And",t):Ze.create(t)})},cloneWithIndexOrWhere(e,t){return f({...e,indexWhere:e.indexWhere?Ze.cloneWithOperation(e.indexWhere,"Or",t):Ze.create(t)})},cloneWithUpdateWhere(e,t){return f({...e,updateWhere:e.updateWhere?Ze.cloneWithOperation(e.updateWhere,"And",t):Ze.create(t)})},cloneWithUpdateOrWhere(e,t){return f({...e,updateWhere:e.updateWhere?Ze.cloneWithOperation(e.updateWhere,"Or",t):Ze.create(t)})},cloneWithoutIndexWhere(e){return f({...e,indexWhere:void 0})},cloneWithoutUpdateWhere(e){return f({...e,updateWhere:void 0})}});class Lt{#e;constructor(t){this.#e=f(t)}column(t){const r=Re.create(t);return new Lt({...this.#e,onConflictNode:rt.cloneWith(this.#e.onConflictNode,{columns:this.#e.onConflictNode.columns?f([...this.#e.onConflictNode.columns,r]):f([r])})})}columns(t){const r=t.map(Re.create);return new Lt({...this.#e,onConflictNode:rt.cloneWith(this.#e.onConflictNode,{columns:this.#e.onConflictNode.columns?f([...this.#e.onConflictNode.columns,...r]):f(r)})})}constraint(t){return new Lt({...this.#e,onConflictNode:rt.cloneWith(this.#e.onConflictNode,{constraint:re.create(t)})})}expression(t){return new Lt({...this.#e,onConflictNode:rt.cloneWith(this.#e.onConflictNode,{indexExpression:t.toOperationNode()})})}where(...t){return new Lt({...this.#e,onConflictNode:rt.cloneWithIndexWhere(this.#e.onConflictNode,je(t))})}whereRef(t,r,n){return new Lt({...this.#e,onConflictNode:rt.cloneWithIndexWhere(this.#e.onConflictNode,Ot(t,r,n))})}clearWhere(){return new Lt({...this.#e,onConflictNode:rt.cloneWithoutIndexWhere(this.#e.onConflictNode)})}doNothing(){return new pT({...this.#e,onConflictNode:rt.cloneWith(this.#e.onConflictNode,{doNothing:!0})})}doUpdateSet(t){return new ds({...this.#e,onConflictNode:rt.cloneWith(this.#e.onConflictNode,{updates:$a(t)})})}$call(t){return t(this)}}class pT{#e;constructor(t){this.#e=f(t)}toOperationNode(){return this.#e.onConflictNode}}class ds{#e;constructor(t){this.#e=f(t)}where(...t){return new ds({...this.#e,onConflictNode:rt.cloneWithUpdateWhere(this.#e.onConflictNode,je(t))})}whereRef(t,r,n){return new ds({...this.#e,onConflictNode:rt.cloneWithUpdateWhere(this.#e.onConflictNode,Ot(t,r,n))})}clearWhere(){return new ds({...this.#e,onConflictNode:rt.cloneWithoutUpdateWhere(this.#e.onConflictNode)})}$call(t){return t(this)}toOperationNode(){return this.#e.onConflictNode}}const mT=f({is(e){return e.kind==="TopNode"},create(e,t){return f({kind:"TopNode",expression:e,modifiers:t})}});function jn(e,t){if(!Pn(e)&&!io(e))throw new Error(`Invalid top expression: ${e}`);if(!Mt(t)&&!yT(t))throw new Error(`Invalid top modifiers: ${t}`);return mT.create(e,t)}function yT(e){return e==="percent"||e==="with ties"||e==="percent with ties"}const nn=f({is(e){return e.kind==="OrActionNode"},create(e){return f({kind:"OrActionNode",action:e})}});class ne{#e;constructor(t){this.#e=f(t)}values(t){const[r,n]=bh(t);return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{columns:r,values:n})})}columns(t){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{columns:f(t.map(Re.create))})})}expression(t){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{values:Zr(t)})})}defaultValues(){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{defaultValues:!0})})}modifyEnd(t){return new ne({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,t.toOperationNode())})}ignore(){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{orAction:nn.create("ignore")})})}orIgnore(){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{orAction:nn.create("ignore")})})}orAbort(){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{orAction:nn.create("abort")})})}orFail(){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{orAction:nn.create("fail")})})}orReplace(){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{orAction:nn.create("replace")})})}orRollback(){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{orAction:nn.create("rollback")})})}top(t,r){return new ne({...this.#e,queryNode:L.cloneWithTop(this.#e.queryNode,jn(t,r))})}onConflict(t){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{onConflict:t(new Lt({onConflictNode:rt.create()})).toOperationNode()})})}onDuplicateKeyUpdate(t){return new ne({...this.#e,queryNode:$e.cloneWith(this.#e.queryNode,{onDuplicateKey:hT.create($a(t))})})}returning(t){return new ne({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,ct(t))})}returningAll(){return new ne({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,dt())})}output(t){return new ne({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,ct(t))})}outputAll(t){return new ne({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,dt(t))})}clearReturning(){return new ne({...this.#e,queryNode:L.cloneWithoutReturning(this.#e.queryNode)})}$call(t){return t(this)}$if(t,r){return t?r(this):new ne({...this.#e})}$castTo(){return new ne(this.#e)}$narrowType(){return new ne(this.#e)}$assertType(){return new ne(this.#e)}withPlugin(t){return new ne({...this.#e,executor:this.#e.executor.withPlugin(t)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const t=this.compile(),r=await this.#e.executor.executeQuery(t),{adapter:n}=this.#e.executor,s=t.query;return s.returning&&n.supportsReturning||s.output&&n.supportsOutput?r.rows:[new fT(r.insertId,r.numAffectedRows??BigInt(0))]}async executeTakeFirst(){const[t]=await this.execute();return t}async executeTakeFirstOrThrow(t=Ls){const r=await this.executeTakeFirst();if(r===void 0)throw $s(t)?new t(this.toOperationNode()):t(this.toOperationNode());return r}async*stream(t=100){const r=this.compile(),n=this.#e.executor.stream(r,t);for await(const s of n)yield*s.rows}async explain(t,r){return await new ne({...this.#e,queryNode:L.cloneWithExplain(this.#e.queryNode,t,r)}).execute()}}class wT{numDeletedRows;constructor(t){this.numDeletedRows=t}}const Da=f({is(e){return e.kind==="LimitNode"},create(e){return f({kind:"LimitNode",limit:e})}});class we{#e;constructor(t){this.#e=f(t)}where(...t){return new we({...this.#e,queryNode:L.cloneWithWhere(this.#e.queryNode,je(t))})}whereRef(t,r,n){return new we({...this.#e,queryNode:L.cloneWithWhere(this.#e.queryNode,Ot(t,r,n))})}clearWhere(){return new we({...this.#e,queryNode:L.cloneWithoutWhere(this.#e.queryNode)})}top(t,r){return new we({...this.#e,queryNode:L.cloneWithTop(this.#e.queryNode,jn(t,r))})}using(t){return new we({...this.#e,queryNode:os.cloneWithUsing(this.#e.queryNode,kn(t))})}innerJoin(...t){return this.#t("InnerJoin",t)}leftJoin(...t){return this.#t("LeftJoin",t)}rightJoin(...t){return this.#t("RightJoin",t)}fullJoin(...t){return this.#t("FullJoin",t)}#t(t,r){return new we({...this.#e,queryNode:L.cloneWithJoin(this.#e.queryNode,uo(t,r))})}returning(t){return new we({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,ct(t))})}returningAll(t){return new we({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,dt(t))})}output(t){return new we({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,ct(t))})}outputAll(t){return new we({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,dt(t))})}clearReturning(){return new we({...this.#e,queryNode:L.cloneWithoutReturning(this.#e.queryNode)})}clearLimit(){return new we({...this.#e,queryNode:os.cloneWithoutLimit(this.#e.queryNode)})}orderBy(...t){return new we({...this.#e,queryNode:L.cloneWithOrderByItems(this.#e.queryNode,zr(t))})}clearOrderBy(){return new we({...this.#e,queryNode:L.cloneWithoutOrderBy(this.#e.queryNode)})}limit(t){return new we({...this.#e,queryNode:os.cloneWithLimit(this.#e.queryNode,Da.create(Oe(t)))})}modifyEnd(t){return new we({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,t.toOperationNode())})}$call(t){return t(this)}$if(t,r){return t?r(this):new we({...this.#e})}$castTo(){return new we(this.#e)}$narrowType(){return new we(this.#e)}$assertType(){return new we(this.#e)}withPlugin(t){return new we({...this.#e,executor:this.#e.executor.withPlugin(t)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const t=this.compile(),r=await this.#e.executor.executeQuery(t),{adapter:n}=this.#e.executor,s=t.query;return s.returning&&n.supportsReturning||s.output&&n.supportsOutput?r.rows:[new wT(r.numAffectedRows??BigInt(0))]}async executeTakeFirst(){const[t]=await this.execute();return t}async executeTakeFirstOrThrow(t=Ls){const r=await this.executeTakeFirst();if(r===void 0)throw $s(t)?new t(this.toOperationNode()):t(this.toOperationNode());return r}async*stream(t=100){const r=this.compile(),n=this.#e.executor.stream(r,t);for await(const s of n)yield*s.rows}async explain(t,r){return await new we({...this.#e,queryNode:L.cloneWithExplain(this.#e.queryNode,t,r)}).execute()}}class gT{numUpdatedRows;numChangedRows;constructor(t,r){this.numUpdatedRows=t,this.numChangedRows=r}}class le{#e;constructor(t){this.#e=f(t)}where(...t){return new le({...this.#e,queryNode:L.cloneWithWhere(this.#e.queryNode,je(t))})}whereRef(t,r,n){return new le({...this.#e,queryNode:L.cloneWithWhere(this.#e.queryNode,Ot(t,r,n))})}clearWhere(){return new le({...this.#e,queryNode:L.cloneWithoutWhere(this.#e.queryNode)})}top(t,r){return new le({...this.#e,queryNode:L.cloneWithTop(this.#e.queryNode,jn(t,r))})}from(t){return new le({...this.#e,queryNode:An.cloneWithFromItems(this.#e.queryNode,kn(t))})}innerJoin(...t){return this.#t("InnerJoin",t)}leftJoin(...t){return this.#t("LeftJoin",t)}rightJoin(...t){return this.#t("RightJoin",t)}fullJoin(...t){return this.#t("FullJoin",t)}#t(t,r){return new le({...this.#e,queryNode:L.cloneWithJoin(this.#e.queryNode,uo(t,r))})}orderBy(...t){return new le({...this.#e,queryNode:L.cloneWithOrderByItems(this.#e.queryNode,zr(t))})}clearOrderBy(){return new le({...this.#e,queryNode:L.cloneWithoutOrderBy(this.#e.queryNode)})}limit(t){return new le({...this.#e,queryNode:An.cloneWithLimit(this.#e.queryNode,Da.create(Oe(t)))})}set(...t){return new le({...this.#e,queryNode:An.cloneWithUpdates(this.#e.queryNode,lT(...t))})}returning(t){return new le({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,ct(t))})}returningAll(t){return new le({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,dt(t))})}output(t){return new le({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,ct(t))})}outputAll(t){return new le({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,dt(t))})}modifyEnd(t){return new le({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,t.toOperationNode())})}clearReturning(){return new le({...this.#e,queryNode:L.cloneWithoutReturning(this.#e.queryNode)})}$call(t){return t(this)}$if(t,r){return t?r(this):new le({...this.#e})}$castTo(){return new le(this.#e)}$narrowType(){return new le(this.#e)}$assertType(){return new le(this.#e)}withPlugin(t){return new le({...this.#e,executor:this.#e.executor.withPlugin(t)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const t=this.compile(),r=await this.#e.executor.executeQuery(t),{adapter:n}=this.#e.executor,s=t.query;return s.returning&&n.supportsReturning||s.output&&n.supportsOutput?r.rows:[new gT(r.numAffectedRows??BigInt(0),r.numChangedRows)]}async executeTakeFirst(){const[t]=await this.execute();return t}async executeTakeFirstOrThrow(t=Ls){const r=await this.executeTakeFirst();if(r===void 0)throw $s(t)?new t(this.toOperationNode()):t(this.toOperationNode());return r}async*stream(t=100){const r=this.compile(),n=this.#e.executor.stream(r,t);for await(const s of n)yield*s.rows}async explain(t,r){return await new le({...this.#e,queryNode:L.cloneWithExplain(this.#e.queryNode,t,r)}).execute()}}const ku=f({is(e){return e.kind==="CommonTableExpressionNameNode"},create(e,t){return f({kind:"CommonTableExpressionNameNode",table:Wt.create(e),columns:t?f(t.map(Re.create)):void 0})}}),Pi=f({is(e){return e.kind==="CommonTableExpressionNode"},create(e,t){return f({kind:"CommonTableExpressionNode",name:e,expression:t})},cloneWith(e,t){return f({...e,...t})}});class Ui{#e;constructor(t){this.#e=f(t)}materialized(){return new Ui({...this.#e,node:Pi.cloneWith(this.#e.node,{materialized:!0})})}notMaterialized(){return new Ui({...this.#e,node:Pi.cloneWith(this.#e.node,{materialized:!1})})}toOperationNode(){return this.#e.node}}function Tu(e,t){const r=t(OT()).toOperationNode();return Be(e)?e(bT(r)).toOperationNode():Pi.create(Nh(e),r)}function bT(e){return t=>new Ui({node:Pi.create(Nh(t),e)})}function Nh(e){if(e.includes("(")){const t=e.split(/[\(\)]/),r=t[0],n=t[1].split(",").map(s=>s.trim());return ku.create(r,n)}else return ku.create(e)}const Js=f({is(e){return e.kind==="WithNode"},create(e,t){return f({kind:"WithNode",expressions:f([e]),...t})},cloneWithExpression(e,t){return f({...e,expressions:f([...e.expressions,t])})}}),_u=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function Eh(e){let t="";for(let r=0;r<e;++r)t+=vT();return t}function vT(){return _u[~~(Math.random()*_u.length)]}function G(){return new NT}class NT{#e;get queryId(){return this.#e===void 0&&(this.#e=Eh(8)),this.#e}}class Ah{nodeStack=[];#e=f({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),RenameConstraintNode:this.transformRenameConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),RefreshMaterializedViewNode:this.transformRefreshMaterializedView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this),MergeQueryNode:this.transformMergeQuery.bind(this),MatchedNode:this.transformMatched.bind(this),AddIndexNode:this.transformAddIndex.bind(this),CastNode:this.transformCast.bind(this),FetchNode:this.transformFetch.bind(this),TopNode:this.transformTop.bind(this),OutputNode:this.transformOutput.bind(this),OrActionNode:this.transformOrAction.bind(this),CollateNode:this.transformCollate.bind(this)});transformNode(t,r){if(!t)return t;this.nodeStack.push(t);const n=this.transformNodeImpl(t,r);return this.nodeStack.pop(),f(n)}transformNodeImpl(t,r){return this.#e[t.kind](t,r)}transformNodeList(t,r){return t&&f(t.map(n=>this.transformNode(n,r)))}transformSelectQuery(t,r){return{kind:"SelectQueryNode",from:this.transformNode(t.from,r),selections:this.transformNodeList(t.selections,r),distinctOn:this.transformNodeList(t.distinctOn,r),joins:this.transformNodeList(t.joins,r),groupBy:this.transformNode(t.groupBy,r),orderBy:this.transformNode(t.orderBy,r),where:this.transformNode(t.where,r),frontModifiers:this.transformNodeList(t.frontModifiers,r),endModifiers:this.transformNodeList(t.endModifiers,r),limit:this.transformNode(t.limit,r),offset:this.transformNode(t.offset,r),with:this.transformNode(t.with,r),having:this.transformNode(t.having,r),explain:this.transformNode(t.explain,r),setOperations:this.transformNodeList(t.setOperations,r),fetch:this.transformNode(t.fetch,r),top:this.transformNode(t.top,r)}}transformSelection(t,r){return{kind:"SelectionNode",selection:this.transformNode(t.selection,r)}}transformColumn(t,r){return{kind:"ColumnNode",column:this.transformNode(t.column,r)}}transformAlias(t,r){return{kind:"AliasNode",node:this.transformNode(t.node,r),alias:this.transformNode(t.alias,r)}}transformTable(t,r){return{kind:"TableNode",table:this.transformNode(t.table,r)}}transformFrom(t,r){return{kind:"FromNode",froms:this.transformNodeList(t.froms,r)}}transformReference(t,r){return{kind:"ReferenceNode",column:this.transformNode(t.column,r),table:this.transformNode(t.table,r)}}transformAnd(t,r){return{kind:"AndNode",left:this.transformNode(t.left,r),right:this.transformNode(t.right,r)}}transformOr(t,r){return{kind:"OrNode",left:this.transformNode(t.left,r),right:this.transformNode(t.right,r)}}transformValueList(t,r){return{kind:"ValueListNode",values:this.transformNodeList(t.values,r)}}transformParens(t,r){return{kind:"ParensNode",node:this.transformNode(t.node,r)}}transformJoin(t,r){return{kind:"JoinNode",joinType:t.joinType,table:this.transformNode(t.table,r),on:this.transformNode(t.on,r)}}transformRaw(t,r){return{kind:"RawNode",sqlFragments:f([...t.sqlFragments]),parameters:this.transformNodeList(t.parameters,r)}}transformWhere(t,r){return{kind:"WhereNode",where:this.transformNode(t.where,r)}}transformInsertQuery(t,r){return{kind:"InsertQueryNode",into:this.transformNode(t.into,r),columns:this.transformNodeList(t.columns,r),values:this.transformNode(t.values,r),returning:this.transformNode(t.returning,r),onConflict:this.transformNode(t.onConflict,r),onDuplicateKey:this.transformNode(t.onDuplicateKey,r),endModifiers:this.transformNodeList(t.endModifiers,r),with:this.transformNode(t.with,r),ignore:t.ignore,orAction:this.transformNode(t.orAction,r),replace:t.replace,explain:this.transformNode(t.explain,r),defaultValues:t.defaultValues,top:this.transformNode(t.top,r),output:this.transformNode(t.output,r)}}transformValues(t,r){return{kind:"ValuesNode",values:this.transformNodeList(t.values,r)}}transformDeleteQuery(t,r){return{kind:"DeleteQueryNode",from:this.transformNode(t.from,r),using:this.transformNode(t.using,r),joins:this.transformNodeList(t.joins,r),where:this.transformNode(t.where,r),returning:this.transformNode(t.returning,r),endModifiers:this.transformNodeList(t.endModifiers,r),with:this.transformNode(t.with,r),orderBy:this.transformNode(t.orderBy,r),limit:this.transformNode(t.limit,r),explain:this.transformNode(t.explain,r),top:this.transformNode(t.top,r),output:this.transformNode(t.output,r)}}transformReturning(t,r){return{kind:"ReturningNode",selections:this.transformNodeList(t.selections,r)}}transformCreateTable(t,r){return{kind:"CreateTableNode",table:this.transformNode(t.table,r),columns:this.transformNodeList(t.columns,r),constraints:this.transformNodeList(t.constraints,r),temporary:t.temporary,ifNotExists:t.ifNotExists,onCommit:t.onCommit,frontModifiers:this.transformNodeList(t.frontModifiers,r),endModifiers:this.transformNodeList(t.endModifiers,r),selectQuery:this.transformNode(t.selectQuery,r)}}transformColumnDefinition(t,r){return{kind:"ColumnDefinitionNode",column:this.transformNode(t.column,r),dataType:this.transformNode(t.dataType,r),references:this.transformNode(t.references,r),primaryKey:t.primaryKey,autoIncrement:t.autoIncrement,unique:t.unique,notNull:t.notNull,unsigned:t.unsigned,defaultTo:this.transformNode(t.defaultTo,r),check:this.transformNode(t.check,r),generated:this.transformNode(t.generated,r),frontModifiers:this.transformNodeList(t.frontModifiers,r),endModifiers:this.transformNodeList(t.endModifiers,r),nullsNotDistinct:t.nullsNotDistinct,identity:t.identity,ifNotExists:t.ifNotExists}}transformAddColumn(t,r){return{kind:"AddColumnNode",column:this.transformNode(t.column,r)}}transformDropTable(t,r){return{kind:"DropTableNode",table:this.transformNode(t.table,r),ifExists:t.ifExists,cascade:t.cascade}}transformOrderBy(t,r){return{kind:"OrderByNode",items:this.transformNodeList(t.items,r)}}transformOrderByItem(t,r){return{kind:"OrderByItemNode",orderBy:this.transformNode(t.orderBy,r),direction:this.transformNode(t.direction,r),collation:this.transformNode(t.collation,r),nulls:t.nulls}}transformGroupBy(t,r){return{kind:"GroupByNode",items:this.transformNodeList(t.items,r)}}transformGroupByItem(t,r){return{kind:"GroupByItemNode",groupBy:this.transformNode(t.groupBy,r)}}transformUpdateQuery(t,r){return{kind:"UpdateQueryNode",table:this.transformNode(t.table,r),from:this.transformNode(t.from,r),joins:this.transformNodeList(t.joins,r),where:this.transformNode(t.where,r),updates:this.transformNodeList(t.updates,r),returning:this.transformNode(t.returning,r),endModifiers:this.transformNodeList(t.endModifiers,r),with:this.transformNode(t.with,r),explain:this.transformNode(t.explain,r),limit:this.transformNode(t.limit,r),top:this.transformNode(t.top,r),output:this.transformNode(t.output,r),orderBy:this.transformNode(t.orderBy,r)}}transformColumnUpdate(t,r){return{kind:"ColumnUpdateNode",column:this.transformNode(t.column,r),value:this.transformNode(t.value,r)}}transformLimit(t,r){return{kind:"LimitNode",limit:this.transformNode(t.limit,r)}}transformOffset(t,r){return{kind:"OffsetNode",offset:this.transformNode(t.offset,r)}}transformOnConflict(t,r){return{kind:"OnConflictNode",columns:this.transformNodeList(t.columns,r),constraint:this.transformNode(t.constraint,r),indexExpression:this.transformNode(t.indexExpression,r),indexWhere:this.transformNode(t.indexWhere,r),updates:this.transformNodeList(t.updates,r),updateWhere:this.transformNode(t.updateWhere,r),doNothing:t.doNothing}}transformOnDuplicateKey(t,r){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(t.updates,r)}}transformCreateIndex(t,r){return{kind:"CreateIndexNode",name:this.transformNode(t.name,r),table:this.transformNode(t.table,r),columns:this.transformNodeList(t.columns,r),unique:t.unique,using:this.transformNode(t.using,r),ifNotExists:t.ifNotExists,where:this.transformNode(t.where,r),nullsNotDistinct:t.nullsNotDistinct}}transformList(t,r){return{kind:"ListNode",items:this.transformNodeList(t.items,r)}}transformDropIndex(t,r){return{kind:"DropIndexNode",name:this.transformNode(t.name,r),table:this.transformNode(t.table,r),ifExists:t.ifExists,cascade:t.cascade}}transformPrimaryKeyConstraint(t,r){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(t.columns,r),name:this.transformNode(t.name,r),deferrable:t.deferrable,initiallyDeferred:t.initiallyDeferred}}transformUniqueConstraint(t,r){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(t.columns,r),name:this.transformNode(t.name,r),nullsNotDistinct:t.nullsNotDistinct,deferrable:t.deferrable,initiallyDeferred:t.initiallyDeferred}}transformForeignKeyConstraint(t,r){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(t.columns,r),references:this.transformNode(t.references,r),name:this.transformNode(t.name,r),onDelete:t.onDelete,onUpdate:t.onUpdate,deferrable:t.deferrable,initiallyDeferred:t.initiallyDeferred}}transformSetOperation(t,r){return{kind:"SetOperationNode",operator:t.operator,expression:this.transformNode(t.expression,r),all:t.all}}transformReferences(t,r){return{kind:"ReferencesNode",table:this.transformNode(t.table,r),columns:this.transformNodeList(t.columns,r),onDelete:t.onDelete,onUpdate:t.onUpdate}}transformCheckConstraint(t,r){return{kind:"CheckConstraintNode",expression:this.transformNode(t.expression,r),name:this.transformNode(t.name,r)}}transformWith(t,r){return{kind:"WithNode",expressions:this.transformNodeList(t.expressions,r),recursive:t.recursive}}transformCommonTableExpression(t,r){return{kind:"CommonTableExpressionNode",name:this.transformNode(t.name,r),materialized:t.materialized,expression:this.transformNode(t.expression,r)}}transformCommonTableExpressionName(t,r){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(t.table,r),columns:this.transformNodeList(t.columns,r)}}transformHaving(t,r){return{kind:"HavingNode",having:this.transformNode(t.having,r)}}transformCreateSchema(t,r){return{kind:"CreateSchemaNode",schema:this.transformNode(t.schema,r),ifNotExists:t.ifNotExists}}transformDropSchema(t,r){return{kind:"DropSchemaNode",schema:this.transformNode(t.schema,r),ifExists:t.ifExists,cascade:t.cascade}}transformAlterTable(t,r){return{kind:"AlterTableNode",table:this.transformNode(t.table,r),renameTo:this.transformNode(t.renameTo,r),setSchema:this.transformNode(t.setSchema,r),columnAlterations:this.transformNodeList(t.columnAlterations,r),addConstraint:this.transformNode(t.addConstraint,r),dropConstraint:this.transformNode(t.dropConstraint,r),renameConstraint:this.transformNode(t.renameConstraint,r),addIndex:this.transformNode(t.addIndex,r),dropIndex:this.transformNode(t.dropIndex,r)}}transformDropColumn(t,r){return{kind:"DropColumnNode",column:this.transformNode(t.column,r)}}transformRenameColumn(t,r){return{kind:"RenameColumnNode",column:this.transformNode(t.column,r),renameTo:this.transformNode(t.renameTo,r)}}transformAlterColumn(t,r){return{kind:"AlterColumnNode",column:this.transformNode(t.column,r),dataType:this.transformNode(t.dataType,r),dataTypeExpression:this.transformNode(t.dataTypeExpression,r),setDefault:this.transformNode(t.setDefault,r),dropDefault:t.dropDefault,setNotNull:t.setNotNull,dropNotNull:t.dropNotNull}}transformModifyColumn(t,r){return{kind:"ModifyColumnNode",column:this.transformNode(t.column,r)}}transformAddConstraint(t,r){return{kind:"AddConstraintNode",constraint:this.transformNode(t.constraint,r)}}transformDropConstraint(t,r){return{kind:"DropConstraintNode",constraintName:this.transformNode(t.constraintName,r),ifExists:t.ifExists,modifier:t.modifier}}transformRenameConstraint(t,r){return{kind:"RenameConstraintNode",oldName:this.transformNode(t.oldName,r),newName:this.transformNode(t.newName,r)}}transformCreateView(t,r){return{kind:"CreateViewNode",name:this.transformNode(t.name,r),temporary:t.temporary,orReplace:t.orReplace,ifNotExists:t.ifNotExists,materialized:t.materialized,columns:this.transformNodeList(t.columns,r),as:this.transformNode(t.as,r)}}transformRefreshMaterializedView(t,r){return{kind:"RefreshMaterializedViewNode",name:this.transformNode(t.name,r),concurrently:t.concurrently,withNoData:t.withNoData}}transformDropView(t,r){return{kind:"DropViewNode",name:this.transformNode(t.name,r),ifExists:t.ifExists,materialized:t.materialized,cascade:t.cascade}}transformGenerated(t,r){return{kind:"GeneratedNode",byDefault:t.byDefault,always:t.always,identity:t.identity,stored:t.stored,expression:this.transformNode(t.expression,r)}}transformDefaultValue(t,r){return{kind:"DefaultValueNode",defaultValue:this.transformNode(t.defaultValue,r)}}transformOn(t,r){return{kind:"OnNode",on:this.transformNode(t.on,r)}}transformSelectModifier(t,r){return{kind:"SelectModifierNode",modifier:t.modifier,rawModifier:this.transformNode(t.rawModifier,r),of:this.transformNodeList(t.of,r)}}transformCreateType(t,r){return{kind:"CreateTypeNode",name:this.transformNode(t.name,r),enum:this.transformNode(t.enum,r)}}transformDropType(t,r){return{kind:"DropTypeNode",name:this.transformNode(t.name,r),ifExists:t.ifExists}}transformExplain(t,r){return{kind:"ExplainNode",format:t.format,options:this.transformNode(t.options,r)}}transformSchemableIdentifier(t,r){return{kind:"SchemableIdentifierNode",schema:this.transformNode(t.schema,r),identifier:this.transformNode(t.identifier,r)}}transformAggregateFunction(t,r){return{kind:"AggregateFunctionNode",func:t.func,aggregated:this.transformNodeList(t.aggregated,r),distinct:t.distinct,orderBy:this.transformNode(t.orderBy,r),withinGroup:this.transformNode(t.withinGroup,r),filter:this.transformNode(t.filter,r),over:this.transformNode(t.over,r)}}transformOver(t,r){return{kind:"OverNode",orderBy:this.transformNode(t.orderBy,r),partitionBy:this.transformNode(t.partitionBy,r)}}transformPartitionBy(t,r){return{kind:"PartitionByNode",items:this.transformNodeList(t.items,r)}}transformPartitionByItem(t,r){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(t.partitionBy,r)}}transformBinaryOperation(t,r){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(t.leftOperand,r),operator:this.transformNode(t.operator,r),rightOperand:this.transformNode(t.rightOperand,r)}}transformUnaryOperation(t,r){return{kind:"UnaryOperationNode",operator:this.transformNode(t.operator,r),operand:this.transformNode(t.operand,r)}}transformUsing(t,r){return{kind:"UsingNode",tables:this.transformNodeList(t.tables,r)}}transformFunction(t,r){return{kind:"FunctionNode",func:t.func,arguments:this.transformNodeList(t.arguments,r)}}transformCase(t,r){return{kind:"CaseNode",value:this.transformNode(t.value,r),when:this.transformNodeList(t.when,r),else:this.transformNode(t.else,r),isStatement:t.isStatement}}transformWhen(t,r){return{kind:"WhenNode",condition:this.transformNode(t.condition,r),result:this.transformNode(t.result,r)}}transformJSONReference(t,r){return{kind:"JSONReferenceNode",reference:this.transformNode(t.reference,r),traversal:this.transformNode(t.traversal,r)}}transformJSONPath(t,r){return{kind:"JSONPathNode",inOperator:this.transformNode(t.inOperator,r),pathLegs:this.transformNodeList(t.pathLegs,r)}}transformJSONPathLeg(t,r){return{kind:"JSONPathLegNode",type:t.type,value:t.value}}transformJSONOperatorChain(t,r){return{kind:"JSONOperatorChainNode",operator:this.transformNode(t.operator,r),values:this.transformNodeList(t.values,r)}}transformTuple(t,r){return{kind:"TupleNode",values:this.transformNodeList(t.values,r)}}transformMergeQuery(t,r){return{kind:"MergeQueryNode",into:this.transformNode(t.into,r),using:this.transformNode(t.using,r),whens:this.transformNodeList(t.whens,r),with:this.transformNode(t.with,r),top:this.transformNode(t.top,r),endModifiers:this.transformNodeList(t.endModifiers,r),output:this.transformNode(t.output,r),returning:this.transformNode(t.returning,r)}}transformMatched(t,r){return{kind:"MatchedNode",not:t.not,bySource:t.bySource}}transformAddIndex(t,r){return{kind:"AddIndexNode",name:this.transformNode(t.name,r),columns:this.transformNodeList(t.columns,r),unique:t.unique,using:this.transformNode(t.using,r),ifNotExists:t.ifNotExists}}transformCast(t,r){return{kind:"CastNode",expression:this.transformNode(t.expression,r),dataType:this.transformNode(t.dataType,r)}}transformFetch(t,r){return{kind:"FetchNode",rowCount:this.transformNode(t.rowCount,r),modifier:t.modifier}}transformTop(t,r){return{kind:"TopNode",expression:t.expression,modifiers:t.modifiers}}transformOutput(t,r){return{kind:"OutputNode",selections:this.transformNodeList(t.selections,r)}}transformDataType(t,r){return t}transformSelectAll(t,r){return t}transformIdentifier(t,r){return t}transformValue(t,r){return t}transformPrimitiveValueList(t,r){return t}transformOperator(t,r){return t}transformDefaultInsertValue(t,r){return t}transformOrAction(t,r){return t}transformCollate(t,r){return t}}const ET=f({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,RefreshMaterializedViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0,MergeQueryNode:!0}),AT={json_agg:!0,to_json:!0};class kT extends Ah{#e;#t=new Set;#r=new Set;constructor(t){super(),this.#e=t}transformNodeImpl(t,r){if(!this.#s(t))return super.transformNodeImpl(t,r);const n=this.#c(t);for(const o of n)this.#r.add(o);const s=this.#i(t);for(const o of s)this.#t.add(o);const i=super.transformNodeImpl(t,r);for(const o of s)this.#t.delete(o);for(const o of n)this.#r.delete(o);return i}transformSchemableIdentifier(t,r){const n=super.transformSchemableIdentifier(t,r);return n.schema||!this.#t.has(t.identifier.name)?n:{...n,schema:re.create(this.#e)}}transformReferences(t,r){const n=super.transformReferences(t,r);return n.table.table.schema?n:{...n,table:Wt.createWithSchema(this.#e,n.table.table.identifier.name)}}transformAggregateFunction(t,r){return{...super.transformAggregateFunction({...t,aggregated:[]},r),aggregated:this.#n(t,r,"aggregated")}}transformFunction(t,r){return{...super.transformFunction({...t,arguments:[]},r),arguments:this.#n(t,r,"arguments")}}#n(t,r,n){return AT[t.func]?t[n].map(s=>!Wt.is(s)||s.table.schema?this.transformNode(s,r):{...s,table:this.transformIdentifier(s.table.identifier,r)}):this.transformNodeList(t[n],r)}#s(t){return t.kind in ET}#i(t){const r=new Set;if("name"in t&&t.name&&Kt.is(t.name)&&this.#o(t.name,r),"from"in t&&t.from)for(const n of t.from.froms)this.#a(n,r);if("into"in t&&t.into&&this.#a(t.into,r),"table"in t&&t.table&&this.#a(t.table,r),"joins"in t&&t.joins)for(const n of t.joins)this.#a(n.table,r);return"using"in t&&t.using&&(Dr.is(t.using)?this.#a(t.using.table,r):this.#a(t.using,r)),r}#c(t){const r=new Set;return"with"in t&&t.with&&this.#u(t.with,r),r}#a(t,r){if(Wt.is(t))this.#o(t.table,r);else if(Jt.is(t)&&Wt.is(t.node))this.#o(t.node.table,r);else if(gh.is(t))for(const n of t.items)this.#a(n,r)}#o(t,r){const n=t.identifier.name;!this.#t.has(n)&&!this.#r.has(n)&&r.add(n)}#u(t,r){for(const n of t.expressions){const s=n.name.table.table.identifier.name;this.#r.has(s)||r.add(s)}}}class Vn{#e;constructor(t){this.#e=new kT(t)}transformQuery(t){return this.#e.transformNode(t.node,t.queryId)}async transformResult(t){return t.result}}const TT=f({is(e){return e.kind==="MatchedNode"},create(e,t=!1){return f({kind:"MatchedNode",not:e,bySource:t})}});function Su(e,t,r){return Us.create(xi([TT.create(!e.isMatched,e.bySource),...t&&t.length>0?[t.length===3&&r?Ot(t[0],t[1],t[2]):je(t)]:[]],"and",!1))}function ls(e){return Me(e)?Se.create([e],[]):Ke(e)?e.toOperationNode():e}class hs{#e;#t;#r;constructor(){this.#e=new Promise((t,r)=>{this.#r=r,this.#t=t})}get promise(){return this.#e}resolve=t=>{this.#t&&this.#t(t)};reject=t=>{this.#r&&this.#r(t)}}async function kh(e){const t=new hs,r=new hs;return e.provideConnection(async n=>(t.resolve(n),await r.promise)).catch(n=>t.reject(n)),f({connection:await t.promise,release:r.resolve})}const _T=f([]);class Th{#e;constructor(t=_T){this.#e=t}get plugins(){return this.#e}transformQuery(t,r){for(const n of this.#e){const s=n.transformQuery({node:t,queryId:r});if(s.kind===t.kind)t=s;else throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${t.kind}`,`but it returned a ${s.kind}`].join(" "))}return t}async executeQuery(t){return await this.provideConnection(async r=>{const n=await r.executeQuery(t);return"numUpdatedOrDeletedRows"in n&&Mn("kysely:warning: outdated driver/plugin detected! `QueryResult.numUpdatedOrDeletedRows` has been replaced with `QueryResult.numAffectedRows`."),await this.#t(n,t.queryId)})}async*stream(t,r){const{connection:n,release:s}=await kh(this);try{for await(const i of n.streamQuery(t,r))yield await this.#t(i,t.queryId)}finally{s()}}async#t(t,r){for(const n of this.#e)t=await n.transformResult({result:t,queryId:r});return t}}class yn extends Th{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(t){return new yn([...this.plugins,t])}withPlugins(t){return new yn([...this.plugins,...t])}withPluginAtFront(t){return new yn([t,...this.plugins])}withoutPlugins(){return new yn([])}}const co=new yn;class ST{numChangedRows;constructor(t){this.numChangedRows=t}}class tr{#e;constructor(t){this.#e=f(t)}modifyEnd(t){return new tr({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,t.toOperationNode())})}top(t,r){return new tr({...this.#e,queryNode:L.cloneWithTop(this.#e.queryNode,jn(t,r))})}using(...t){return new Ge({...this.#e,queryNode:Ye.cloneWithUsing(this.#e.queryNode,uo("Using",t))})}returning(t){return new tr({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,ct(t))})}returningAll(t){return new tr({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,dt(t))})}output(t){return new tr({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,ct(t))})}outputAll(t){return new tr({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,dt(t))})}}class Ge{#e;constructor(t){this.#e=f(t)}modifyEnd(t){return new Ge({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,t.toOperationNode())})}top(t,r){return new Ge({...this.#e,queryNode:L.cloneWithTop(this.#e.queryNode,jn(t,r))})}whenMatched(){return this.#t([])}whenMatchedAnd(...t){return this.#t(t)}whenMatchedAndRef(t,r,n){return this.#t([t,r,n],!0)}#t(t,r){return new Ru({...this.#e,queryNode:Ye.cloneWithWhen(this.#e.queryNode,Su({isMatched:!0},t,r))})}whenNotMatched(){return this.#r([])}whenNotMatchedAnd(...t){return this.#r(t)}whenNotMatchedAndRef(t,r,n){return this.#r([t,r,n],!0)}whenNotMatchedBySource(){return this.#r([],!1,!0)}whenNotMatchedBySourceAnd(...t){return this.#r(t,!1,!0)}whenNotMatchedBySourceAndRef(t,r,n){return this.#r([t,r,n],!0,!0)}returning(t){return new Ge({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,ct(t))})}returningAll(t){return new Ge({...this.#e,queryNode:L.cloneWithReturning(this.#e.queryNode,dt(t))})}output(t){return new Ge({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,ct(t))})}outputAll(t){return new Ge({...this.#e,queryNode:L.cloneWithOutput(this.#e.queryNode,dt(t))})}#r(t,r=!1,n=!1){const s={...this.#e,queryNode:Ye.cloneWithWhen(this.#e.queryNode,Su({isMatched:!1,bySource:n},t,r))},i=n?Ru:RT;return new i(s)}$call(t){return t(this)}$if(t,r){return t?r(this):new Ge({...this.#e})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const t=this.compile(),r=await this.#e.executor.executeQuery(t),{adapter:n}=this.#e.executor,s=t.query;return s.returning&&n.supportsReturning||s.output&&n.supportsOutput?r.rows:[new ST(r.numAffectedRows)]}async executeTakeFirst(){const[t]=await this.execute();return t}async executeTakeFirstOrThrow(t=Ls){const r=await this.executeTakeFirst();if(r===void 0)throw $s(t)?new t(this.toOperationNode()):t(this.toOperationNode());return r}}class Ru{#e;constructor(t){this.#e=f(t)}thenDelete(){return new Ge({...this.#e,queryNode:Ye.cloneWithThen(this.#e.queryNode,ls("delete"))})}thenDoNothing(){return new Ge({...this.#e,queryNode:Ye.cloneWithThen(this.#e.queryNode,ls("do nothing"))})}thenUpdate(t){return new Ge({...this.#e,queryNode:Ye.cloneWithThen(this.#e.queryNode,ls(t(new le({queryId:this.#e.queryId,executor:co,queryNode:An.createWithoutTable()}))))})}thenUpdateSet(...t){return this.thenUpdate(r=>r.set(...t))}}class RT{#e;constructor(t){this.#e=f(t)}thenDoNothing(){return new Ge({...this.#e,queryNode:Ye.cloneWithThen(this.#e.queryNode,ls("do nothing"))})}thenInsertValues(t){const[r,n]=bh(t);return new Ge({...this.#e,queryNode:Ye.cloneWithThen(this.#e.queryNode,ls($e.cloneWith($e.createWithoutInto(),{columns:r,values:n})))})}}class ar{#e;constructor(t){this.#e=f(t)}selectFrom(t){return ta({queryId:G(),executor:this.#e.executor,queryNode:ce.createFrom(kn(t),this.#e.withNode)})}selectNoFrom(t){return ta({queryId:G(),executor:this.#e.executor,queryNode:ce.cloneWithSelections(ce.create(this.#e.withNode),ct(t))})}insertInto(t){return new ne({queryId:G(),executor:this.#e.executor,queryNode:$e.create(_e(t),this.#e.withNode)})}replaceInto(t){return new ne({queryId:G(),executor:this.#e.executor,queryNode:$e.create(_e(t),this.#e.withNode,!0)})}deleteFrom(t){return new we({queryId:G(),executor:this.#e.executor,queryNode:os.create(kn(t),this.#e.withNode)})}updateTable(t){return new le({queryId:G(),executor:this.#e.executor,queryNode:An.create(kn(t),this.#e.withNode)})}mergeInto(t){return new tr({queryId:G(),executor:this.#e.executor,queryNode:Ye.create(xh(t),this.#e.withNode)})}with(t,r){const n=Tu(t,r);return new ar({...this.#e,withNode:this.#e.withNode?Js.cloneWithExpression(this.#e.withNode,n):Js.create(n)})}withRecursive(t,r){const n=Tu(t,r);return new ar({...this.#e,withNode:this.#e.withNode?Js.cloneWithExpression(this.#e.withNode,n):Js.create(n,{recursive:!0})})}withPlugin(t){return new ar({...this.#e,executor:this.#e.executor.withPlugin(t)})}withoutPlugins(){return new ar({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(t){return new ar({...this.#e,executor:this.#e.executor.withPluginAtFront(new Vn(t))})}}function OT(){return new ar({executor:co})}function IT(e,t){return new as({joinNode:Dr.create(e,Os(t))})}function xT(){return new cs({overNode:ea.create()})}function uo(e,t){if(t.length===3)return PT(e,t[0],t[1],t[2]);if(t.length===2)return CT(e,t[0],t[1]);if(t.length===1)return UT(e,t[0]);throw new Error("not implemented")}function CT(e,t,r){return r(IT(e,t)).toOperationNode()}function PT(e,t,r,n){return Dr.createWithOn(e,Os(t),Ot(r,"=",n))}function UT(e,t){return Dr.create(e,Os(t))}const LT=f({is(e){return e.kind==="OffsetNode"},create(e){return f({kind:"OffsetNode",offset:e})}}),$T=f({is(e){return e.kind==="GroupByItemNode"},create(e){return f({kind:"GroupByItemNode",groupBy:e})}});function DT(e){return e=Be(e)?e(Fn()):e,Ss(e).map($T.create)}const _h=f({is(e){return e.kind==="SetOperationNode"},create(e,t,r){return f({kind:"SetOperationNode",operator:e,expression:t,all:r})}});function sn(e,t,r){return Be(t)&&(t=t(Wa())),Ht(t)||(t=[t]),t.map(n=>_h.create(e,Zr(n),r))}class se{#e;constructor(t){this.#e=t}get expressionType(){}as(t){return new qa(this,t)}or(...t){return new Li(zn.create(this.#e,je(t)))}and(...t){return new $i(wr.create(this.#e,je(t)))}$castTo(){return new se(this.#e)}$notNull(){return new se(this.#e)}toOperationNode(){return this.#e}}class qa{#e;#t;constructor(t,r){this.#e=t,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return Jt.create(this.#e.toOperationNode(),Ke(this.#t)?this.#t.toOperationNode():re.create(this.#t))}}class Li{#e;constructor(t){this.#e=t}get expressionType(){}as(t){return new qa(this,t)}or(...t){return new Li(zn.create(this.#e,je(t)))}$castTo(){return new Li(this.#e)}toOperationNode(){return Ln.create(this.#e)}}class $i{#e;constructor(t){this.#e=t}get expressionType(){}as(t){return new qa(this,t)}and(...t){return new $i(wr.create(this.#e,je(t)))}$castTo(){return new $i(this.#e)}toOperationNode(){return Ln.create(this.#e)}}const qT={is(e){return e.kind==="FetchNode"},create(e,t){return{kind:"FetchNode",rowCount:ut.create(e),modifier:t}}};function WT(e,t){if(!Pn(e)&&!io(e))throw new Error(`Invalid fetch row count: ${e}`);if(!zT(t))throw new Error(`Invalid fetch modifier: ${t}`);return qT.create(e,t)}function zT(e){return e==="only"||e==="with ties"}class H{#e;constructor(t){this.#e=f(t)}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...t){return new H({...this.#e,queryNode:L.cloneWithWhere(this.#e.queryNode,je(t))})}whereRef(t,r,n){return new H({...this.#e,queryNode:L.cloneWithWhere(this.#e.queryNode,Ot(t,r,n))})}having(...t){return new H({...this.#e,queryNode:ce.cloneWithHaving(this.#e.queryNode,je(t))})}havingRef(t,r,n){return new H({...this.#e,queryNode:ce.cloneWithHaving(this.#e.queryNode,Ot(t,r,n))})}select(t){return new H({...this.#e,queryNode:ce.cloneWithSelections(this.#e.queryNode,ct(t))})}distinctOn(t){return new H({...this.#e,queryNode:ce.cloneWithDistinctOn(this.#e.queryNode,Ss(t))})}modifyFront(t){return new H({...this.#e,queryNode:ce.cloneWithFrontModifier(this.#e.queryNode,Pt.createWithExpression(t.toOperationNode()))})}modifyEnd(t){return new H({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,Pt.createWithExpression(t.toOperationNode()))})}distinct(){return new H({...this.#e,queryNode:ce.cloneWithFrontModifier(this.#e.queryNode,Pt.create("Distinct"))})}forUpdate(t){return new H({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,Pt.create("ForUpdate",t?Zs(t).map(_e):void 0))})}forShare(t){return new H({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,Pt.create("ForShare",t?Zs(t).map(_e):void 0))})}forKeyShare(t){return new H({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,Pt.create("ForKeyShare",t?Zs(t).map(_e):void 0))})}forNoKeyUpdate(t){return new H({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,Pt.create("ForNoKeyUpdate",t?Zs(t).map(_e):void 0))})}skipLocked(){return new H({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,Pt.create("SkipLocked"))})}noWait(){return new H({...this.#e,queryNode:L.cloneWithEndModifier(this.#e.queryNode,Pt.create("NoWait"))})}selectAll(t){return new H({...this.#e,queryNode:ce.cloneWithSelections(this.#e.queryNode,dt(t))})}innerJoin(...t){return this.#t("InnerJoin",t)}leftJoin(...t){return this.#t("LeftJoin",t)}rightJoin(...t){return this.#t("RightJoin",t)}fullJoin(...t){return this.#t("FullJoin",t)}crossJoin(...t){return this.#t("CrossJoin",t)}innerJoinLateral(...t){return this.#t("LateralInnerJoin",t)}leftJoinLateral(...t){return this.#t("LateralLeftJoin",t)}crossJoinLateral(...t){return this.#t("LateralCrossJoin",t)}crossApply(...t){return this.#t("CrossApply",t)}outerApply(...t){return this.#t("OuterApply",t)}#t(t,r){return new H({...this.#e,queryNode:L.cloneWithJoin(this.#e.queryNode,uo(t,r))})}orderBy(...t){return new H({...this.#e,queryNode:L.cloneWithOrderByItems(this.#e.queryNode,zr(t))})}groupBy(t){return new H({...this.#e,queryNode:ce.cloneWithGroupByItems(this.#e.queryNode,DT(t))})}limit(t){return new H({...this.#e,queryNode:ce.cloneWithLimit(this.#e.queryNode,Da.create(Oe(t)))})}offset(t){return new H({...this.#e,queryNode:ce.cloneWithOffset(this.#e.queryNode,LT.create(Oe(t)))})}fetch(t,r="only"){return new H({...this.#e,queryNode:ce.cloneWithFetch(this.#e.queryNode,WT(t,r))})}top(t,r){return new H({...this.#e,queryNode:L.cloneWithTop(this.#e.queryNode,jn(t,r))})}union(t){return new H({...this.#e,queryNode:ce.cloneWithSetOperations(this.#e.queryNode,sn("union",t,!1))})}unionAll(t){return new H({...this.#e,queryNode:ce.cloneWithSetOperations(this.#e.queryNode,sn("union",t,!0))})}intersect(t){return new H({...this.#e,queryNode:ce.cloneWithSetOperations(this.#e.queryNode,sn("intersect",t,!1))})}intersectAll(t){return new H({...this.#e,queryNode:ce.cloneWithSetOperations(this.#e.queryNode,sn("intersect",t,!0))})}except(t){return new H({...this.#e,queryNode:ce.cloneWithSetOperations(this.#e.queryNode,sn("except",t,!1))})}exceptAll(t){return new H({...this.#e,queryNode:ce.cloneWithSetOperations(this.#e.queryNode,sn("except",t,!0))})}as(t){return new MT(this,t)}clearSelect(){return new H({...this.#e,queryNode:ce.cloneWithoutSelections(this.#e.queryNode)})}clearWhere(){return new H({...this.#e,queryNode:L.cloneWithoutWhere(this.#e.queryNode)})}clearLimit(){return new H({...this.#e,queryNode:ce.cloneWithoutLimit(this.#e.queryNode)})}clearOffset(){return new H({...this.#e,queryNode:ce.cloneWithoutOffset(this.#e.queryNode)})}clearOrderBy(){return new H({...this.#e,queryNode:L.cloneWithoutOrderBy(this.#e.queryNode)})}clearGroupBy(){return new H({...this.#e,queryNode:ce.cloneWithoutGroupBy(this.#e.queryNode)})}$call(t){return t(this)}$if(t,r){return t?r(this):new H({...this.#e})}$castTo(){return new H(this.#e)}$narrowType(){return new H(this.#e)}$assertType(){return new H(this.#e)}$asTuple(){return new se(this.toOperationNode())}$asScalar(){return new se(this.toOperationNode())}withPlugin(t){return new H({...this.#e,executor:this.#e.executor.withPlugin(t)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const t=this.compile();return(await this.#e.executor.executeQuery(t)).rows}async executeTakeFirst(){const[t]=await this.execute();return t}async executeTakeFirstOrThrow(t=Ls){const r=await this.executeTakeFirst();if(r===void 0)throw $s(t)?new t(this.toOperationNode()):t(this.toOperationNode());return r}async*stream(t=100){const r=this.compile(),n=this.#e.executor.stream(r,t);for await(const s of n)yield*s.rows}async explain(t,r){return await new H({...this.#e,queryNode:L.cloneWithExplain(this.#e.queryNode,t,r)}).execute()}}function ta(e){return new H(e)}class MT{#e;#t;constructor(t,r){this.#e=t,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return Jt.create(this.#e.toOperationNode(),re.create(this.#t))}}const cr=f({is(e){return e.kind==="AggregateFunctionNode"},create(e,t=[]){return f({kind:"AggregateFunctionNode",func:e,aggregated:t})},cloneWithDistinct(e){return f({...e,distinct:!0})},cloneWithOrderBy(e,t,r=!1){const n=r?"withinGroup":"orderBy";return f({...e,[n]:e[n]?$n.cloneWithItems(e[n],t):$n.create(t)})},cloneWithFilter(e,t){return f({...e,filter:e.filter?Ze.cloneWithOperation(e.filter,"And",t):Ze.create(t)})},cloneWithOrFilter(e,t){return f({...e,filter:e.filter?Ze.cloneWithOperation(e.filter,"Or",t):Ze.create(t)})},cloneWithOver(e,t){return f({...e,over:t})}}),Ou=f({is(e){return e.kind==="FunctionNode"},create(e,t){return f({kind:"FunctionNode",func:e,arguments:t})}});class nt{#e;constructor(t){this.#e=f(t)}get expressionType(){}as(t){return new jT(this,t)}distinct(){return new nt({...this.#e,aggregateFunctionNode:cr.cloneWithDistinct(this.#e.aggregateFunctionNode)})}orderBy(...t){return new nt({...this.#e,aggregateFunctionNode:L.cloneWithOrderByItems(this.#e.aggregateFunctionNode,zr(t))})}clearOrderBy(){return new nt({...this.#e,aggregateFunctionNode:L.cloneWithoutOrderBy(this.#e.aggregateFunctionNode)})}withinGroupOrderBy(...t){return new nt({...this.#e,aggregateFunctionNode:cr.cloneWithOrderBy(this.#e.aggregateFunctionNode,zr(t),!0)})}filterWhere(...t){return new nt({...this.#e,aggregateFunctionNode:cr.cloneWithFilter(this.#e.aggregateFunctionNode,je(t))})}filterWhereRef(t,r,n){return new nt({...this.#e,aggregateFunctionNode:cr.cloneWithFilter(this.#e.aggregateFunctionNode,Ot(t,r,n))})}over(t){const r=xT();return new nt({...this.#e,aggregateFunctionNode:cr.cloneWithOver(this.#e.aggregateFunctionNode,(t?t(r):r).toOperationNode())})}$call(t){return t(this)}$castTo(){return new nt(this.#e)}$notNull(){return new nt(this.#e)}toOperationNode(){return this.#e.aggregateFunctionNode}}class jT{#e;#t;constructor(t,r){this.#e=t,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return Jt.create(this.#e.toOperationNode(),re.create(this.#t))}}function Sh(){const e=(r,n)=>new se(Ou.create(r,Ss(n??[]))),t=(r,n)=>new nt({aggregateFunctionNode:cr.create(r,n?Ss(n):void 0)});return Object.assign(e,{agg:t,avg(r){return t("avg",[r])},coalesce(...r){return e("coalesce",r)},count(r){return t("count",[r])},countAll(r){return new nt({aggregateFunctionNode:cr.create("count",dt(r))})},max(r){return t("max",[r])},min(r){return t("min",[r])},sum(r){return t("sum",[r])},any(r){return e("any",[r])},jsonAgg(r){return new nt({aggregateFunctionNode:cr.create("json_agg",[Me(r)?_e(r):r.toOperationNode()])})},toJson(r){return new se(Ou.create("to_json",[Me(r)?_e(r):r.toOperationNode()]))}})}const VT=f({is(e){return e.kind==="UnaryOperationNode"},create(e,t){return f({kind:"UnaryOperationNode",operator:e,operand:t})}});function FT(e,t){return VT.create(gr.create(e),ot(t))}const St=f({is(e){return e.kind==="CaseNode"},create(e){return f({kind:"CaseNode",value:e})},cloneWithWhen(e,t){return f({...e,when:f(e.when?[...e.when,t]:[t])})},cloneWithThen(e,t){return f({...e,when:e.when?f([...e.when.slice(0,-1),Us.cloneWithResult(e.when[e.when.length-1],t)]):void 0})},cloneWith(e,t){return f({...e,...t})}});class Rh{#e;constructor(t){this.#e=f(t)}when(...t){return new Oh({...this.#e,node:St.cloneWithWhen(this.#e.node,Us.create(je(t)))})}}class Oh{#e;constructor(t){this.#e=f(t)}then(t){return new BT({...this.#e,node:St.cloneWithThen(this.#e.node,Pa(t)?Ua(t):Oe(t))})}}class BT{#e;constructor(t){this.#e=f(t)}when(...t){return new Oh({...this.#e,node:St.cloneWithWhen(this.#e.node,Us.create(je(t)))})}else(t){return new HT({...this.#e,node:St.cloneWith(this.#e.node,{else:Pa(t)?Ua(t):Oe(t)})})}end(){return new se(St.cloneWith(this.#e.node,{isStatement:!1}))}endCase(){return new se(St.cloneWith(this.#e.node,{isStatement:!0}))}}class HT{#e;constructor(t){this.#e=f(t)}end(){return new se(St.cloneWith(this.#e.node,{isStatement:!1}))}endCase(){return new se(St.cloneWith(this.#e.node,{isStatement:!0}))}}const Iu=f({is(e){return e.kind==="JSONPathLegNode"},create(e,t){return f({kind:"JSONPathLegNode",type:e,value:t})}});class ra{#e;constructor(t){this.#e=t}at(t){return this.#t("ArrayLocation",t)}key(t){return this.#t("Member",t)}#t(t,r){return Oi.is(this.#e)?new Rs(Oi.cloneWithTraversal(this.#e,is.is(this.#e.traversal)?is.cloneWithLeg(this.#e.traversal,Iu.create(t,r)):fh.cloneWithValue(this.#e.traversal,ut.createImmediate(r)))):new Rs(is.cloneWithLeg(this.#e,Iu.create(t,r)))}}class Rs extends ra{#e;constructor(t){super(t),this.#e=t}get expressionType(){}as(t){return new KT(this,t)}$castTo(){return new Rs(this.#e)}$notNull(){return new Rs(this.#e)}toOperationNode(){return this.#e}}class KT{#e;#t;constructor(t,r){this.#e=t,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return Jt.create(this.#e.toOperationNode(),Ke(this.#t)?this.#t.toOperationNode():re.create(this.#t))}}const xu=f({is(e){return e.kind==="TupleNode"},create(e){return f({kind:"TupleNode",values:f(e)})}}),ZT=["varchar","char","text","integer","int2","int4","int8","smallint","bigint","boolean","real","double precision","float4","float8","decimal","numeric","binary","bytea","date","datetime","time","timetz","timestamp","timestamptz","serial","bigserial","uuid","json","jsonb","blob","varbinary","int4range","int4multirange","int8range","int8multirange","numrange","nummultirange","tsrange","tsmultirange","tstzrange","tstzmultirange","daterange","datemultirange"],JT=[/^varchar\(\d+\)$/,/^char\(\d+\)$/,/^decimal\(\d+, \d+\)$/,/^numeric\(\d+, \d+\)$/,/^binary\(\d+\)$/,/^datetime\(\d+\)$/,/^time\(\d+\)$/,/^timetz\(\d+\)$/,/^timestamp\(\d+\)$/,/^timestamptz\(\d+\)$/,/^varbinary\(\d+\)$/],GT=f({is(e){return e.kind==="DataTypeNode"},create(e){return f({kind:"DataTypeNode",dataType:e})}});function QT(e){return!!(ZT.includes(e)||JT.some(t=>t.test(e)))}function Mr(e){if(Ke(e))return e.toOperationNode();if(QT(e))return GT.create(e);throw new Error(`invalid column data type ${JSON.stringify(e)}`)}const YT=f({is(e){return e.kind==="CastNode"},create(e,t){return f({kind:"CastNode",expression:e,dataType:t})}});function Wa(e=co){function t(s,i,o){return new se(La(s,i,o))}function r(s,i){return new se(FT(s,i))}const n=Object.assign(t,{fn:void 0,eb:void 0,selectFrom(s){return ta({queryId:G(),executor:e,queryNode:ce.createFrom(kn(s))})},case(s){return new Rh({node:St.create(Mt(s)?void 0:ot(s))})},ref(s,i){return Mt(i)?new se(Zt(s)):new ra(Gk(s,i))},jsonPath(){return new ra(is.create())},table(s){return new se(_e(s))},val(s){return new se(Oe(s))},refTuple(...s){return new se(xu.create(s.map(ot)))},tuple(...s){return new se(xu.create(s.map(Oe)))},lit(s){return new se(Ua(s))},unary:r,not(s){return r("not",s)},exists(s){return r("exists",s)},neg(s){return r("-",s)},between(s,i,o){return new se(Un.create(ot(s),gr.create("between"),wr.create(Oe(i),Oe(o))))},betweenSymmetric(s,i,o){return new se(Un.create(ot(s),gr.create("between symmetric"),wr.create(Oe(i),Oe(o))))},and(s){return Ht(s)?new se(xi(s,"and")):new se(pu(s,"and"))},or(s){return Ht(s)?new se(xi(s,"or")):new se(pu(s,"or"))},parens(...s){const i=je(s);return Ln.is(i)?new se(i):new se(Ln.create(i))},cast(s,i){return new se(YT.create(ot(s),Mr(i)))},withSchema(s){return Wa(e.withPluginAtFront(new Vn(s)))}});return n.fn=Sh(),n.eb=n,n}function Fn(e){return Wa()}function Zr(e){if(Ke(e))return e.toOperationNode();if(Be(e))return e(Fn()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(e)}`)}function Ih(e){if(Ke(e))return e.toOperationNode();if(Be(e))return e(Fn()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(e)}`)}function Ds(e){return ch(e)||zk(e)||Be(e)}class XT{#e;get table(){return this.#e}constructor(t){this.#e=t}as(t){return new e_(this.#e,t)}}class e_{#e;#t;get table(){return this.#e}get alias(){return this.#t}constructor(t,r){this.#e=t,this.#t=r}toOperationNode(){return Jt.create(_e(this.#e),re.create(this.#t))}}function t_(e){return it(e)&&Ke(e)&&Me(e.table)&&Me(e.alias)}function kn(e){return Ht(e)?e.map(t=>Os(t)):[Os(e)]}function Os(e){return Me(e)?xh(e):t_(e)?e.toOperationNode():Ih(e)}function xh(e){const t=" as ";if(e.includes(t)){const[r,n]=e.split(t).map(Ch);return Jt.create(_e(r),re.create(n))}else return _e(e)}function _e(e){if(e.includes(".")){const[r,n]=e.split(".").map(Ch);return Wt.createWithSchema(r,n)}else return Wt.create(e)}function Ch(e){return e.trim()}const Ph=f({is(e){return e.kind==="AddColumnNode"},create(e){return f({kind:"AddColumnNode",column:e})}}),ge=f({is(e){return e.kind==="ColumnDefinitionNode"},create(e,t){return f({kind:"ColumnDefinitionNode",column:Re.create(e),dataType:t})},cloneWithFrontModifier(e,t){return f({...e,frontModifiers:e.frontModifiers?f([...e.frontModifiers,t]):[t]})},cloneWithEndModifier(e,t){return f({...e,endModifiers:e.endModifiers?f([...e.endModifiers,t]):[t]})},cloneWith(e,t){return f({...e,...t})}}),Uh=f({is(e){return e.kind==="DropColumnNode"},create(e){return f({kind:"DropColumnNode",column:Re.create(e)})}}),Lh=f({is(e){return e.kind==="RenameColumnNode"},create(e,t){return f({kind:"RenameColumnNode",column:Re.create(e),renameTo:Re.create(t)})}}),za=f({is(e){return e.kind==="CheckConstraintNode"},create(e,t){return f({kind:"CheckConstraintNode",expression:e,name:t?re.create(t):void 0})}}),r_=["no action","restrict","cascade","set null","set default"],ai=f({is(e){return e.kind==="ReferencesNode"},create(e,t){return f({kind:"ReferencesNode",table:e,columns:f([...t])})},cloneWithOnDelete(e,t){return f({...e,onDelete:t})},cloneWithOnUpdate(e,t){return f({...e,onUpdate:t})}});function $h(e){return Ke(e)?e.toOperationNode():ut.createImmediate(e)}const Gs=f({is(e){return e.kind==="GeneratedNode"},create(e){return f({kind:"GeneratedNode",...e})},createWithExpression(e){return f({kind:"GeneratedNode",always:!0,expression:e})},cloneWith(e,t){return f({...e,...t})}}),n_=f({is(e){return e.kind==="DefaultValueNode"},create(e){return f({kind:"DefaultValueNode",defaultValue:e})}});function Di(e){if(r_.includes(e))return e;throw new Error(`invalid OnModifyForeignAction ${e}`)}class he{#e;constructor(t){this.#e=t}autoIncrement(){return new he(ge.cloneWith(this.#e,{autoIncrement:!0}))}identity(){return new he(ge.cloneWith(this.#e,{identity:!0}))}primaryKey(){return new he(ge.cloneWith(this.#e,{primaryKey:!0}))}references(t){const r=Zt(t);if(!r.table||xa.is(r.column))throw new Error(`invalid call references('${t}'). The reference must have format table.column or schema.table.column`);return new he(ge.cloneWith(this.#e,{references:ai.create(r.table,[r.column])}))}onDelete(t){if(!this.#e.references)throw new Error("on delete constraint can only be added for foreign keys");return new he(ge.cloneWith(this.#e,{references:ai.cloneWithOnDelete(this.#e.references,Di(t))}))}onUpdate(t){if(!this.#e.references)throw new Error("on update constraint can only be added for foreign keys");return new he(ge.cloneWith(this.#e,{references:ai.cloneWithOnUpdate(this.#e.references,Di(t))}))}unique(){return new he(ge.cloneWith(this.#e,{unique:!0}))}notNull(){return new he(ge.cloneWith(this.#e,{notNull:!0}))}unsigned(){return new he(ge.cloneWith(this.#e,{unsigned:!0}))}defaultTo(t){return new he(ge.cloneWith(this.#e,{defaultTo:n_.create($h(t))}))}check(t){return new he(ge.cloneWith(this.#e,{check:za.create(t.toOperationNode())}))}generatedAlwaysAs(t){return new he(ge.cloneWith(this.#e,{generated:Gs.createWithExpression(t.toOperationNode())}))}generatedAlwaysAsIdentity(){return new he(ge.cloneWith(this.#e,{generated:Gs.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new he(ge.cloneWith(this.#e,{generated:Gs.create({identity:!0,byDefault:!0})}))}stored(){if(!this.#e.generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new he(ge.cloneWith(this.#e,{generated:Gs.cloneWith(this.#e.generated,{stored:!0})}))}modifyFront(t){return new he(ge.cloneWithFrontModifier(this.#e,t.toOperationNode()))}nullsNotDistinct(){return new he(ge.cloneWith(this.#e,{nullsNotDistinct:!0}))}ifNotExists(){return new he(ge.cloneWith(this.#e,{ifNotExists:!0}))}modifyEnd(t){return new he(ge.cloneWithEndModifier(this.#e,t.toOperationNode()))}$call(t){return t(this)}toOperationNode(){return this.#e}}const Dh=f({is(e){return e.kind==="ModifyColumnNode"},create(e){return f({kind:"ModifyColumnNode",column:e})}}),rr=f({is(e){return e.kind==="ForeignKeyConstraintNode"},create(e,t,r,n){return f({kind:"ForeignKeyConstraintNode",columns:e,references:ai.create(t,r),name:n?re.create(n):void 0})},cloneWith(e,t){return f({...e,...t})}});class Dt{#e;constructor(t){this.#e=t}onDelete(t){return new Dt(rr.cloneWith(this.#e,{onDelete:Di(t)}))}onUpdate(t){return new Dt(rr.cloneWith(this.#e,{onUpdate:Di(t)}))}deferrable(){return new Dt(rr.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new Dt(rr.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new Dt(rr.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new Dt(rr.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(t){return t(this)}toOperationNode(){return this.#e}}const ci=f({is(e){return e.kind==="AddConstraintNode"},create(e){return f({kind:"AddConstraintNode",constraint:e})}}),Sr=f({is(e){return e.kind==="UniqueConstraintNode"},create(e,t,r){return f({kind:"UniqueConstraintNode",columns:f(e.map(Re.create)),name:t?re.create(t):void 0,nullsNotDistinct:r})},cloneWith(e,t){return f({...e,...t})}}),ui=f({is(e){return e.kind==="DropConstraintNode"},create(e){return f({kind:"DropConstraintNode",constraintName:re.create(e)})},cloneWith(e,t){return f({...e,...t})}}),Qn=f({is(e){return e.kind==="AlterColumnNode"},create(e,t,r){return f({kind:"AlterColumnNode",column:Re.create(e),[t]:r})}});class qh{#e;constructor(t){this.#e=t}setDataType(t){return new Yn(Qn.create(this.#e,"dataType",Mr(t)))}setDefault(t){return new Yn(Qn.create(this.#e,"setDefault",$h(t)))}dropDefault(){return new Yn(Qn.create(this.#e,"dropDefault",!0))}setNotNull(){return new Yn(Qn.create(this.#e,"setNotNull",!0))}dropNotNull(){return new Yn(Qn.create(this.#e,"dropNotNull",!0))}$call(t){return t(this)}}class Yn{#e;constructor(t){this.#e=t}toOperationNode(){return this.#e}}class on{#e;constructor(t){this.#e=f(t)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class nr{#e;constructor(t){this.#e=f(t)}onDelete(t){return new nr({...this.#e,constraintBuilder:this.#e.constraintBuilder.onDelete(t)})}onUpdate(t){return new nr({...this.#e,constraintBuilder:this.#e.constraintBuilder.onUpdate(t)})}deferrable(){return new nr({...this.#e,constraintBuilder:this.#e.constraintBuilder.deferrable()})}notDeferrable(){return new nr({...this.#e,constraintBuilder:this.#e.constraintBuilder.notDeferrable()})}initiallyDeferred(){return new nr({...this.#e,constraintBuilder:this.#e.constraintBuilder.initiallyDeferred()})}initiallyImmediate(){return new nr({...this.#e,constraintBuilder:this.#e.constraintBuilder.initiallyImmediate()})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(te.cloneWithTableProps(this.#e.node,{addConstraint:ci.create(this.#e.constraintBuilder.toOperationNode())}),this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class Tn{#e;constructor(t){this.#e=f(t)}ifExists(){return new Tn({...this.#e,node:te.cloneWithTableProps(this.#e.node,{dropConstraint:ui.cloneWith(this.#e.node.dropConstraint,{ifExists:!0})})})}cascade(){return new Tn({...this.#e,node:te.cloneWithTableProps(this.#e.node,{dropConstraint:ui.cloneWith(this.#e.node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new Tn({...this.#e,node:te.cloneWithTableProps(this.#e.node,{dropConstraint:ui.cloneWith(this.#e.node.dropConstraint,{modifier:"restrict"})})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const wn=f({is(e){return e.kind==="PrimaryKeyConstraintNode"},create(e,t){return f({kind:"PrimaryKeyConstraintNode",columns:f(e.map(Re.create)),name:t?re.create(t):void 0})},cloneWith(e,t){return f({...e,...t})}}),dn=f({is(e){return e.kind==="AddIndexNode"},create(e){return f({kind:"AddIndexNode",name:re.create(e)})},cloneWith(e,t){return f({...e,...t})},cloneWithColumns(e,t){return f({...e,columns:[...e.columns||[],...t]})}});class Rr{#e;constructor(t){this.#e=f(t)}unique(){return new Rr({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addIndex:dn.cloneWith(this.#e.node.addIndex,{unique:!0})})})}column(t){return new Rr({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addIndex:dn.cloneWithColumns(this.#e.node.addIndex,[Ii(t)])})})}columns(t){return new Rr({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addIndex:dn.cloneWithColumns(this.#e.node.addIndex,t.map(Ii))})})}expression(t){return new Rr({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addIndex:dn.cloneWithColumns(this.#e.node.addIndex,[t.toOperationNode()])})})}using(t){return new Rr({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addIndex:dn.cloneWith(this.#e.node.addIndex,{using:Se.createWithSql(t)})})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class ur{#e;constructor(t){this.#e=t}nullsNotDistinct(){return new ur(Sr.cloneWith(this.#e,{nullsNotDistinct:!0}))}deferrable(){return new ur(Sr.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new ur(Sr.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new ur(Sr.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new ur(Sr.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(t){return t(this)}toOperationNode(){return this.#e}}class Cr{#e;constructor(t){this.#e=t}deferrable(){return new Cr(wn.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new Cr(wn.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new Cr(wn.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new Cr(wn.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(t){return t(this)}toOperationNode(){return this.#e}}class Wh{#e;constructor(t){this.#e=t}$call(t){return t(this)}toOperationNode(){return this.#e}}const s_=f({is(e){return e.kind==="RenameConstraintNode"},create(e,t){return f({kind:"RenameConstraintNode",oldName:re.create(e),newName:re.create(t)})}});class i_{#e;constructor(t){this.#e=f(t)}renameTo(t){return new on({...this.#e,node:te.cloneWithTableProps(this.#e.node,{renameTo:_e(t)})})}setSchema(t){return new on({...this.#e,node:te.cloneWithTableProps(this.#e.node,{setSchema:re.create(t)})})}alterColumn(t,r){const n=r(new qh(t));return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,n.toOperationNode())})}dropColumn(t){return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,Uh.create(t))})}renameColumn(t,r){return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,Lh.create(t,r))})}addColumn(t,r,n=st){const s=n(new he(ge.create(t,Mr(r))));return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,Ph.create(s.toOperationNode()))})}modifyColumn(t,r,n=st){const s=n(new he(ge.create(t,Mr(r))));return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,Dh.create(s.toOperationNode()))})}addUniqueConstraint(t,r,n=st){const s=n(new ur(Sr.create(r,t)));return new on({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addConstraint:ci.create(s.toOperationNode())})})}addCheckConstraint(t,r,n=st){const s=n(new Wh(za.create(r.toOperationNode(),t)));return new on({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addConstraint:ci.create(s.toOperationNode())})})}addForeignKeyConstraint(t,r,n,s,i=st){const o=i(new Dt(rr.create(r.map(Re.create),_e(n),s.map(Re.create),t)));return new nr({...this.#e,constraintBuilder:o})}addPrimaryKeyConstraint(t,r,n=st){const s=n(new Cr(wn.create(r,t)));return new on({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addConstraint:ci.create(s.toOperationNode())})})}dropConstraint(t){return new Tn({...this.#e,node:te.cloneWithTableProps(this.#e.node,{dropConstraint:ui.create(t)})})}renameConstraint(t,r){return new Tn({...this.#e,node:te.cloneWithTableProps(this.#e.node,{renameConstraint:s_.create(t,r)})})}addIndex(t){return new Rr({...this.#e,node:te.cloneWithTableProps(this.#e.node,{addIndex:dn.create(t)})})}dropIndex(t){return new on({...this.#e,node:te.cloneWithTableProps(this.#e.node,{dropIndex:ss.create(t)})})}$call(t){return t(this)}}class mt{#e;constructor(t){this.#e=f(t)}alterColumn(t,r){const n=r(new qh(t));return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,n.toOperationNode())})}dropColumn(t){return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,Uh.create(t))})}renameColumn(t,r){return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,Lh.create(t,r))})}addColumn(t,r,n=st){const s=n(new he(ge.create(t,Mr(r))));return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,Ph.create(s.toOperationNode()))})}modifyColumn(t,r,n=st){const s=n(new he(ge.create(t,Mr(r))));return new mt({...this.#e,node:te.cloneWithColumnAlteration(this.#e.node,Dh.create(s.toOperationNode()))})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class zh extends Ah{transformPrimitiveValueList(t){return ao.create(t.values.map(ut.createImmediate))}transformValue(t){return ut.createImmediate(t.value)}}class ft{#e;constructor(t){this.#e=f(t)}ifNotExists(){return new ft({...this.#e,node:Ut.cloneWith(this.#e.node,{ifNotExists:!0})})}unique(){return new ft({...this.#e,node:Ut.cloneWith(this.#e.node,{unique:!0})})}nullsNotDistinct(){return new ft({...this.#e,node:Ut.cloneWith(this.#e.node,{nullsNotDistinct:!0})})}on(t){return new ft({...this.#e,node:Ut.cloneWith(this.#e.node,{table:_e(t)})})}column(t){return new ft({...this.#e,node:Ut.cloneWithColumns(this.#e.node,[Ii(t)])})}columns(t){return new ft({...this.#e,node:Ut.cloneWithColumns(this.#e.node,t.map(Ii))})}expression(t){return new ft({...this.#e,node:Ut.cloneWithColumns(this.#e.node,[t.toOperationNode()])})}using(t){return new ft({...this.#e,node:Ut.cloneWith(this.#e.node,{using:Se.createWithSql(t)})})}where(...t){const r=new zh;return new ft({...this.#e,node:L.cloneWithWhere(this.#e.node,r.transformNode(je(t),this.#e.queryId))})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class Ma{#e;constructor(t){this.#e=f(t)}ifNotExists(){return new Ma({...this.#e,node:ah.cloneWith(this.#e.node,{ifNotExists:!0})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}function o_(e){if(Wk.includes(e))return e;throw new Error(`invalid OnCommitAction ${e}`)}class tt{#e;constructor(t){this.#e=f(t)}temporary(){return new tt({...this.#e,node:et.cloneWith(this.#e.node,{temporary:!0})})}onCommit(t){return new tt({...this.#e,node:et.cloneWith(this.#e.node,{onCommit:o_(t)})})}ifNotExists(){return new tt({...this.#e,node:et.cloneWith(this.#e.node,{ifNotExists:!0})})}addColumn(t,r,n=st){const s=n(new he(ge.create(t,Mr(r))));return new tt({...this.#e,node:et.cloneWithColumn(this.#e.node,s.toOperationNode())})}addPrimaryKeyConstraint(t,r,n=st){const s=n(new Cr(wn.create(r,t)));return new tt({...this.#e,node:et.cloneWithConstraint(this.#e.node,s.toOperationNode())})}addUniqueConstraint(t,r,n=st){const s=n(new ur(Sr.create(r,t)));return new tt({...this.#e,node:et.cloneWithConstraint(this.#e.node,s.toOperationNode())})}addCheckConstraint(t,r,n=st){const s=n(new Wh(za.create(r.toOperationNode(),t)));return new tt({...this.#e,node:et.cloneWithConstraint(this.#e.node,s.toOperationNode())})}addForeignKeyConstraint(t,r,n,s,i=st){const o=i(new Dt(rr.create(r.map(Re.create),_e(n),s.map(Re.create),t)));return new tt({...this.#e,node:et.cloneWithConstraint(this.#e.node,o.toOperationNode())})}modifyFront(t){return new tt({...this.#e,node:et.cloneWithFrontModifier(this.#e.node,t.toOperationNode())})}modifyEnd(t){return new tt({...this.#e,node:et.cloneWithEndModifier(this.#e.node,t.toOperationNode())})}as(t){return new tt({...this.#e,node:et.cloneWith(this.#e.node,{selectQuery:Zr(t)})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class fs{#e;constructor(t){this.#e=f(t)}on(t){return new fs({...this.#e,node:ss.cloneWith(this.#e.node,{table:_e(t)})})}ifExists(){return new fs({...this.#e,node:ss.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new fs({...this.#e,node:ss.cloneWith(this.#e.node,{cascade:!0})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class qi{#e;constructor(t){this.#e=f(t)}ifExists(){return new qi({...this.#e,node:Qo.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new qi({...this.#e,node:Qo.cloneWith(this.#e.node,{cascade:!0})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class Wi{#e;constructor(t){this.#e=f(t)}ifExists(){return new Wi({...this.#e,node:Yo.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new Wi({...this.#e,node:Yo.cloneWith(this.#e.node,{cascade:!0})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const sr=f({is(e){return e.kind==="CreateViewNode"},create(e){return f({kind:"CreateViewNode",name:Kt.create(e)})},cloneWith(e,t){return f({...e,...t})}});class a_{#e=new zh;transformQuery(t){return this.#e.transformNode(t.node,t.queryId)}transformResult(t){return Promise.resolve(t.result)}}class ir{#e;constructor(t){this.#e=f(t)}temporary(){return new ir({...this.#e,node:sr.cloneWith(this.#e.node,{temporary:!0})})}materialized(){return new ir({...this.#e,node:sr.cloneWith(this.#e.node,{materialized:!0})})}ifNotExists(){return new ir({...this.#e,node:sr.cloneWith(this.#e.node,{ifNotExists:!0})})}orReplace(){return new ir({...this.#e,node:sr.cloneWith(this.#e.node,{orReplace:!0})})}columns(t){return new ir({...this.#e,node:sr.cloneWith(this.#e.node,{columns:t.map(mh)})})}as(t){const r=t.withPlugin(new a_).toOperationNode();return new ir({...this.#e,node:sr.cloneWith(this.#e.node,{as:r})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const di=f({is(e){return e.kind==="DropViewNode"},create(e){return f({kind:"DropViewNode",name:Kt.create(e)})},cloneWith(e,t){return f({...e,...t})}});class ps{#e;constructor(t){this.#e=f(t)}materialized(){return new ps({...this.#e,node:di.cloneWith(this.#e.node,{materialized:!0})})}ifExists(){return new ps({...this.#e,node:di.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new ps({...this.#e,node:di.cloneWith(this.#e.node,{cascade:!0})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const Mh=f({is(e){return e.kind==="CreateTypeNode"},create(e){return f({kind:"CreateTypeNode",name:e})},cloneWithEnum(e,t){return f({...e,enum:ao.create(t.map(ut.createImmediate))})}});class ja{#e;constructor(t){this.#e=f(t)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}asEnum(t){return new ja({...this.#e,node:Mh.cloneWithEnum(this.#e.node,t)})}$call(t){return t(this)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const jh=f({is(e){return e.kind==="DropTypeNode"},create(e){return f({kind:"DropTypeNode",name:e})},cloneWith(e,t){return f({...e,...t})}});class Va{#e;constructor(t){this.#e=f(t)}ifExists(){return new Va({...this.#e,node:jh.cloneWith(this.#e.node,{ifExists:!0})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}function Cu(e){if(e.includes(".")){const r=e.split(".").map(c_);if(r.length===2)return Kt.createWithSchema(r[0],r[1]);throw new Error(`invalid schemable identifier ${e}`)}else return Kt.create(e)}function c_(e){return e.trim()}const li=f({is(e){return e.kind==="RefreshMaterializedViewNode"},create(e){return f({kind:"RefreshMaterializedViewNode",name:Kt.create(e)})},cloneWith(e,t){return f({...e,...t})}});class ms{#e;constructor(t){this.#e=f(t)}concurrently(){return new ms({...this.#e,node:li.cloneWith(this.#e.node,{concurrently:!0,withNoData:!1})})}withData(){return new ms({...this.#e,node:li.cloneWith(this.#e.node,{withNoData:!1})})}withNoData(){return new ms({...this.#e,node:li.cloneWith(this.#e.node,{withNoData:!0,concurrently:!1})})}$call(t){return t(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class ys{#e;constructor(t){this.#e=t}createTable(t){return new tt({queryId:G(),executor:this.#e,node:et.create(_e(t))})}dropTable(t){return new Wi({queryId:G(),executor:this.#e,node:Yo.create(_e(t))})}createIndex(t){return new ft({queryId:G(),executor:this.#e,node:Ut.create(t)})}dropIndex(t){return new fs({queryId:G(),executor:this.#e,node:ss.create(t)})}createSchema(t){return new Ma({queryId:G(),executor:this.#e,node:ah.create(t)})}dropSchema(t){return new qi({queryId:G(),executor:this.#e,node:Qo.create(t)})}alterTable(t){return new i_({queryId:G(),executor:this.#e,node:te.create(_e(t))})}createView(t){return new ir({queryId:G(),executor:this.#e,node:sr.create(t)})}refreshMaterializedView(t){return new ms({queryId:G(),executor:this.#e,node:li.create(t)})}dropView(t){return new ps({queryId:G(),executor:this.#e,node:di.create(t)})}createType(t){return new ja({queryId:G(),executor:this.#e,node:Mh.create(Cu(t))})}dropType(t){return new Va({queryId:G(),executor:this.#e,node:jh.create(Cu(t))})}withPlugin(t){return new ys(this.#e.withPlugin(t))}withoutPlugins(){return new ys(this.#e.withoutPlugins())}withSchema(t){return new ys(this.#e.withPluginAtFront(new Vn(t)))}}class u_{ref(t){return new Kk(t)}table(t){return new XT(t)}}class d_{#e;constructor(t){this.#e=t}async provideConnection(t){const r=await this.#e.acquireConnection();try{return await t(r)}finally{await this.#e.releaseConnection(r)}}}class Or extends Th{#e;#t;#r;constructor(t,r,n,s=[]){super(s),this.#e=t,this.#t=r,this.#r=n}get adapter(){return this.#t}compileQuery(t,r){return this.#e.compileQuery(t,r)}provideConnection(t){return this.#r.provideConnection(t)}withPlugins(t){return new Or(this.#e,this.#t,this.#r,[...this.plugins,...t])}withPlugin(t){return new Or(this.#e,this.#t,this.#r,[...this.plugins,t])}withPluginAtFront(t){return new Or(this.#e,this.#t,this.#r,[t,...this.plugins])}withConnectionProvider(t){return new Or(this.#e,this.#t,t,[...this.plugins])}withoutPlugins(){return new Or(this.#e,this.#t,this.#r,[])}}function To(){return typeof performance<"u"&&Be(performance.now)?performance.now():Date.now()}class l_{#e;#t;#r;#n;#s;#i=new WeakSet;constructor(t,r){this.#n=!1,this.#e=t,this.#t=r}async init(){if(this.#s)throw new Error("driver has already been destroyed");this.#r||(this.#r=this.#e.init().then(()=>{this.#n=!0}).catch(t=>(this.#r=void 0,Promise.reject(t)))),await this.#r}async acquireConnection(){if(this.#s)throw new Error("driver has already been destroyed");this.#n||await this.init();const t=await this.#e.acquireConnection();return this.#i.has(t)||(this.#c()&&this.#a(t),this.#i.add(t)),t}async releaseConnection(t){await this.#e.releaseConnection(t)}beginTransaction(t,r){return this.#e.beginTransaction(t,r)}commitTransaction(t){return this.#e.commitTransaction(t)}rollbackTransaction(t){return this.#e.rollbackTransaction(t)}savepoint(t,r,n){if(this.#e.savepoint)return this.#e.savepoint(t,r,n);throw new Error("The `savepoint` method is not supported by this driver")}rollbackToSavepoint(t,r,n){if(this.#e.rollbackToSavepoint)return this.#e.rollbackToSavepoint(t,r,n);throw new Error("The `rollbackToSavepoint` method is not supported by this driver")}releaseSavepoint(t,r,n){if(this.#e.releaseSavepoint)return this.#e.releaseSavepoint(t,r,n);throw new Error("The `releaseSavepoint` method is not supported by this driver")}async destroy(){this.#r&&(await this.#r,this.#s||(this.#s=this.#e.destroy().catch(t=>(this.#s=void 0,Promise.reject(t)))),await this.#s)}#c(){return this.#t.isLevelEnabled("query")||this.#t.isLevelEnabled("error")}#a(t){const r=t.executeQuery,n=t.streamQuery,s=this;t.executeQuery=async i=>{let o;const a=To();try{return await r.call(t,i)}catch(c){throw o=c,await s.#o(c,i,a),c}finally{o||await s.#u(i,a)}},t.streamQuery=async function*(i,o){let a;const c=To();try{for await(const u of n.call(t,i,o))yield u}catch(u){throw a=u,await s.#o(u,i,c),u}finally{a||await s.#u(i,c,!0)}}}async#o(t,r,n){await this.#t.error(()=>({level:"error",error:t,query:r,queryDurationMillis:this.#d(n)}))}async#u(t,r,n=!1){await this.#t.query(()=>({level:"query",isStream:n,query:t,queryDurationMillis:this.#d(r)}))}#d(t){return To()-t}}const h_=()=>{};class Fa{#e;#t;constructor(t){this.#e=t}async provideConnection(t){for(;this.#t;)await this.#t.catch(h_);return this.#t=this.#r(t).finally(()=>{this.#t=void 0}),this.#t}async#r(t){return await t(this.#e)}}const f_=["read only","read write"],p_=["read uncommitted","read committed","repeatable read","serializable","snapshot"];function Vh(e){if(e.accessMode&&!f_.includes(e.accessMode))throw new Error(`invalid transaction access mode ${e.accessMode}`);if(e.isolationLevel&&!p_.includes(e.isolationLevel))throw new Error(`invalid transaction isolation level ${e.isolationLevel}`)}f(["query","error"]);class m_{#e;#t;constructor(t){Be(t)?(this.#t=t,this.#e=f({query:!0,error:!0})):(this.#t=y_,this.#e=f({query:t.includes("query"),error:t.includes("error")}))}isLevelEnabled(t){return this.#e[t]}async query(t){this.#e.query&&await this.#t(t())}async error(t){this.#e.error&&await this.#t(t())}}function y_(e){if(e.level==="query"){const t=`kysely:query:${e.isStream?"stream:":""}`;console.log(`${t} ${e.query.sql}`),console.log(`${t} duration: ${e.queryDurationMillis.toFixed(1)}ms`)}else e.level==="error"&&(e.error instanceof Error?console.error(`kysely:error: ${e.error.stack??e.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:e.error,query:e.query.sql,queryDurationMillis:e.queryDurationMillis})}`))}function w_(e){return it(e)&&Be(e.compile)}Symbol.asyncDispose??=Symbol("Symbol.asyncDispose");class zt extends ar{#e;constructor(t){let r,n;if(g_(t))r={executor:t.executor},n={...t};else{const s=t.dialect,i=s.createDriver(),o=s.createQueryCompiler(),a=s.createAdapter(),c=new m_(t.log??[]),u=new l_(i,c),d=new d_(u),l=new Or(o,a,d,t.plugins??[]);r={executor:l},n={config:t,executor:l,dialect:s,driver:u}}super(r),this.#e=f(n)}get schema(){return new ys(this.#e.executor)}get dynamic(){return new u_}get introspection(){return this.#e.dialect.createIntrospector(this.withoutPlugins())}case(t){return new Rh({node:St.create(Mt(t)?void 0:Zr(t))})}get fn(){return Sh()}transaction(){return new zi({...this.#e})}startTransaction(){return new Mi({...this.#e})}connection(){return new b_({...this.#e})}withPlugin(t){return new zt({...this.#e,executor:this.#e.executor.withPlugin(t)})}withoutPlugins(){return new zt({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(t){return new zt({...this.#e,executor:this.#e.executor.withPluginAtFront(new Vn(t))})}withTables(){return new zt({...this.#e})}async destroy(){await this.#e.driver.destroy()}get isTransaction(){return!1}getExecutor(){return this.#e.executor}executeQuery(t,r){r!==void 0&&Mn("Passing `queryId` in `db.executeQuery` is deprecated and will result in a compile-time error in the future.");const n=w_(t)?t.compile():t;return this.getExecutor().executeQuery(n)}async[Symbol.asyncDispose](){await this.destroy()}}class Pr extends zt{#e;constructor(t){super(t),this.#e=t}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(t){return new Pr({...this.#e,executor:this.#e.executor.withPlugin(t)})}withoutPlugins(){return new Pr({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(t){return new Pr({...this.#e,executor:this.#e.executor.withPluginAtFront(new Vn(t))})}withTables(){return new Pr({...this.#e})}}function g_(e){return it(e)&&it(e.config)&&it(e.driver)&&it(e.executor)&&it(e.dialect)}class b_{#e;constructor(t){this.#e=f(t)}async execute(t){return this.#e.executor.provideConnection(async r=>{const n=this.#e.executor.withConnectionProvider(new Fa(r)),s=new zt({...this.#e,executor:n});return await t(s)})}}class zi{#e;constructor(t){this.#e=f(t)}setAccessMode(t){return new zi({...this.#e,accessMode:t})}setIsolationLevel(t){return new zi({...this.#e,isolationLevel:t})}async execute(t){const{isolationLevel:r,accessMode:n,...s}=this.#e,i={isolationLevel:r,accessMode:n};return Vh(i),this.#e.executor.provideConnection(async o=>{const a=this.#e.executor.withConnectionProvider(new Fa(o)),c=new Pr({...s,executor:a});let u=!1;try{await this.#e.driver.beginTransaction(o,i),u=!0;const d=await t(c);return await this.#e.driver.commitTransaction(o),d}catch(d){throw u&&await this.#e.driver.rollbackTransaction(o),d}})}}class Mi{#e;constructor(t){this.#e=f(t)}setAccessMode(t){return new Mi({...this.#e,accessMode:t})}setIsolationLevel(t){return new Mi({...this.#e,isolationLevel:t})}async execute(){const{isolationLevel:t,accessMode:r,...n}=this.#e,s={isolationLevel:t,accessMode:r};Vh(s);const i=await kh(this.#e.executor);return await this.#e.driver.beginTransaction(i.connection,s),new $t({...n,connection:i,executor:this.#e.executor.withConnectionProvider(new Fa(i.connection))})}}class $t extends Pr{#e;#t;#r;constructor(t){const r={isCommitted:!1,isRolledBack:!1};t={...t,executor:new or(t.executor,r)};const{connection:n,...s}=t;super(s),this.#e=f(t),this.#r=r;const i=G();this.#t=o=>t.executor.compileQuery(o,i)}get isCommitted(){return this.#r.isCommitted}get isRolledBack(){return this.#r.isRolledBack}commit(){return Ir(this.#r),new Xn(async()=>{await this.#e.driver.commitTransaction(this.#e.connection.connection),this.#r.isCommitted=!0,this.#e.connection.release()})}rollback(){return Ir(this.#r),new Xn(async()=>{await this.#e.driver.rollbackTransaction(this.#e.connection.connection),this.#r.isRolledBack=!0,this.#e.connection.release()})}savepoint(t){return Ir(this.#r),new Xn(async()=>(await this.#e.driver.savepoint?.(this.#e.connection.connection,t,this.#t),new $t({...this.#e})))}rollbackToSavepoint(t){return Ir(this.#r),new Xn(async()=>(await this.#e.driver.rollbackToSavepoint?.(this.#e.connection.connection,t,this.#t),new $t({...this.#e})))}releaseSavepoint(t){return Ir(this.#r),new Xn(async()=>(await this.#e.driver.releaseSavepoint?.(this.#e.connection.connection,t,this.#t),new $t({...this.#e})))}withPlugin(t){return new $t({...this.#e,executor:this.#e.executor.withPlugin(t)})}withoutPlugins(){return new $t({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(t){return new $t({...this.#e,executor:this.#e.executor.withPluginAtFront(new Vn(t))})}withTables(){return new $t({...this.#e})}}class Xn{#e;constructor(t){this.#e=t}async execute(){return await this.#e()}}function Ir(e){if(e.isCommitted)throw new Error("Transaction is already committed");if(e.isRolledBack)throw new Error("Transaction is already rolled back")}class or{#e;#t;constructor(t,r){t instanceof or?this.#e=t.#e:this.#e=t,this.#t=r}get adapter(){return this.#e.adapter}get plugins(){return this.#e.plugins}transformQuery(t,r){return this.#e.transformQuery(t,r)}compileQuery(t,r){return this.#e.compileQuery(t,r)}provideConnection(t){return this.#e.provideConnection(t)}executeQuery(t){return Ir(this.#t),this.#e.executeQuery(t)}stream(t,r){return Ir(this.#t),this.#e.stream(t,r)}withConnectionProvider(t){return new or(this.#e.withConnectionProvider(t),this.#t)}withPlugin(t){return new or(this.#e.withPlugin(t),this.#t)}withPlugins(t){return new or(this.#e.withPlugins(t),this.#t)}withPluginAtFront(t){return new or(this.#e.withPluginAtFront(t),this.#t)}withoutPlugins(){return new or(this.#e.withoutPlugins(),this.#t)}}class ws{#e;constructor(t){this.#e=f(t)}get expressionType(){}get isRawBuilder(){return!0}as(t){return new v_(this,t)}$castTo(){return new ws({...this.#e})}$notNull(){return new ws(this.#e)}withPlugin(t){return new ws({...this.#e,plugins:this.#e.plugins!==void 0?f([...this.#e.plugins,t]):f([t])})}toOperationNode(){return this.#r(this.#t())}compile(t){return this.#n(this.#t(t))}async execute(t){const r=this.#t(t);return r.executeQuery(this.#n(r))}#t(t){const r=t!==void 0?t.getExecutor():co;return this.#e.plugins!==void 0?r.withPlugins(this.#e.plugins):r}#r(t){return t.transformQuery(this.#e.rawNode,this.#e.queryId)}#n(t){return t.compileQuery(this.#r(t),this.#e.queryId)}}function Yt(e){return new ws(e)}class v_{#e;#t;constructor(t,r){this.#e=t,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}get rawBuilder(){return this.#e}toOperationNode(){return Jt.create(this.#e.toOperationNode(),Ke(this.#t)?this.#t.toOperationNode():re.create(this.#t))}}const Ie=Object.assign((e,...t)=>Yt({queryId:G(),rawNode:Se.create(e,t?.map(Pu)??[])}),{ref(e){return Yt({queryId:G(),rawNode:Se.createWithChild(Zt(e))})},val(e){return Yt({queryId:G(),rawNode:Se.createWithChild(Oe(e))})},value(e){return this.val(e)},table(e){return Yt({queryId:G(),rawNode:Se.createWithChild(_e(e))})},id(...e){const t=new Array(e.length+1).fill(".");return t[0]="",t[t.length-1]="",Yt({queryId:G(),rawNode:Se.create(t,e.map(re.create))})},lit(e){return Yt({queryId:G(),rawNode:Se.createWithChild(ut.createImmediate(e))})},literal(e){return this.lit(e)},raw(e){return Yt({queryId:G(),rawNode:Se.createWithSql(e)})},join(e,t=Ie`, `){const r=new Array(Math.max(2*e.length-1,0)),n=t.toOperationNode();for(let s=0;s<e.length;++s)r[2*s]=Pu(e[s]),s!==e.length-1&&(r[2*s+1]=n);return Yt({queryId:G(),rawNode:Se.createWithChildren(r)})}});function Pu(e){return Ke(e)?e.toOperationNode():Oe(e)}class N_{nodeStack=[];get parentNode(){return this.nodeStack[this.nodeStack.length-2]}#e=f({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),RenameConstraintNode:this.visitRenameConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),RefreshMaterializedViewNode:this.visitRefreshMaterializedView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),MergeQueryNode:this.visitMergeQuery.bind(this),MatchedNode:this.visitMatched.bind(this),AddIndexNode:this.visitAddIndex.bind(this),CastNode:this.visitCast.bind(this),FetchNode:this.visitFetch.bind(this),TopNode:this.visitTop.bind(this),OutputNode:this.visitOutput.bind(this),OrActionNode:this.visitOrAction.bind(this),CollateNode:this.visitCollate.bind(this)});visitNode=t=>{this.nodeStack.push(t),this.#e[t.kind](t),this.nodeStack.pop()}}const E_=/'/g;class Bn extends N_{#e="";#t=[];get numParameters(){return this.#t.length}compileQuery(t,r){return this.#e="",this.#t=[],this.nodeStack.splice(0,this.nodeStack.length),this.visitNode(t),f({query:t,queryId:r,sql:this.getSql(),parameters:[...this.#t]})}getSql(){return this.#e}visitSelectQuery(t){const r=this.parentNode!==void 0&&!Ln.is(this.parentNode)&&!$e.is(this.parentNode)&&!et.is(this.parentNode)&&!sr.is(this.parentNode)&&!_h.is(this.parentNode);this.parentNode===void 0&&t.explain&&(this.visitNode(t.explain),this.append(" ")),r&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("select"),t.distinctOn&&(this.append(" "),this.compileDistinctOn(t.distinctOn)),t.frontModifiers?.length&&(this.append(" "),this.compileList(t.frontModifiers," ")),t.top&&(this.append(" "),this.visitNode(t.top)),t.selections&&(this.append(" "),this.compileList(t.selections)),t.from&&(this.append(" "),this.visitNode(t.from)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.groupBy&&(this.append(" "),this.visitNode(t.groupBy)),t.having&&(this.append(" "),this.visitNode(t.having)),t.setOperations&&(this.append(" "),this.compileList(t.setOperations," ")),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.offset&&(this.append(" "),this.visitNode(t.offset)),t.fetch&&(this.append(" "),this.visitNode(t.fetch)),t.endModifiers?.length&&(this.append(" "),this.compileList(this.sortSelectModifiers([...t.endModifiers])," ")),r&&this.append(")")}visitFrom(t){this.append("from "),this.compileList(t.froms)}visitSelection(t){this.visitNode(t.selection)}visitColumn(t){this.visitNode(t.column)}compileDistinctOn(t){this.append("distinct on ("),this.compileList(t),this.append(")")}compileList(t,r=", "){const n=t.length-1;for(let s=0;s<=n;s++)this.visitNode(t[s]),s<n&&this.append(r)}visitWhere(t){this.append("where "),this.visitNode(t.where)}visitHaving(t){this.append("having "),this.visitNode(t.having)}visitInsertQuery(t){const r=this.nodeStack.find(L.is),n=r!==t;!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&!Ye.is(r)&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append(t.replace?"replace":"insert"),t.ignore&&(Mn("`InsertQueryNode.ignore` is deprecated. Use `InsertQueryNode.orAction` instead."),this.append(" ignore")),t.orAction&&(this.append(" "),this.visitNode(t.orAction)),t.top&&(this.append(" "),this.visitNode(t.top)),t.into&&(this.append(" into "),this.visitNode(t.into)),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.output&&(this.append(" "),this.visitNode(t.output)),t.values&&(this.append(" "),this.visitNode(t.values)),t.defaultValues&&(this.append(" "),this.append("default values")),t.onConflict&&(this.append(" "),this.visitNode(t.onConflict)),t.onDuplicateKey&&(this.append(" "),this.visitNode(t.onDuplicateKey)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&!Ye.is(r)&&this.append(")"),t.endModifiers?.length&&(this.append(" "),this.compileList(t.endModifiers," "))}visitValues(t){this.append("values "),this.compileList(t.values)}visitDeleteQuery(t){const r=this.nodeStack.find(L.is)!==t;!r&&t.explain&&(this.visitNode(t.explain),this.append(" ")),r&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("delete "),t.top&&(this.visitNode(t.top),this.append(" ")),this.visitNode(t.from),t.output&&(this.append(" "),this.visitNode(t.output)),t.using&&(this.append(" "),this.visitNode(t.using)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.returning&&(this.append(" "),this.visitNode(t.returning)),r&&this.append(")"),t.endModifiers?.length&&(this.append(" "),this.compileList(t.endModifiers," "))}visitReturning(t){this.append("returning "),this.compileList(t.selections)}visitAlias(t){this.visitNode(t.node),this.append(" as "),this.visitNode(t.alias)}visitReference(t){t.table&&(this.visitNode(t.table),this.append(".")),this.visitNode(t.column)}visitSelectAll(t){this.append("*")}visitIdentifier(t){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(t),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(t){if(!Me(t.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(t.name))}visitAnd(t){this.visitNode(t.left),this.append(" and "),this.visitNode(t.right)}visitOr(t){this.visitNode(t.left),this.append(" or "),this.visitNode(t.right)}visitValue(t){t.immediate?this.appendImmediateValue(t.value):this.appendValue(t.value)}visitValueList(t){this.append("("),this.compileList(t.values),this.append(")")}visitTuple(t){this.append("("),this.compileList(t.values),this.append(")")}visitPrimitiveValueList(t){this.append("(");const{values:r}=t;for(let n=0;n<r.length;++n)this.appendValue(r[n]),n!==r.length-1&&this.append(", ");this.append(")")}visitParens(t){this.append("("),this.visitNode(t.node),this.append(")")}visitJoin(t){this.append(k_[t.joinType]),this.append(" "),this.visitNode(t.table),t.on&&(this.append(" "),this.visitNode(t.on))}visitOn(t){this.append("on "),this.visitNode(t.on)}visitRaw(t){const{sqlFragments:r,parameters:n}=t;for(let s=0;s<r.length;++s)this.append(r[s]),n.length>s&&this.visitNode(n[s])}visitOperator(t){this.append(t.operator)}visitTable(t){this.visitNode(t.table)}visitSchemableIdentifier(t){t.schema&&(this.visitNode(t.schema),this.append(".")),this.visitNode(t.identifier)}visitCreateTable(t){this.append("create "),t.frontModifiers&&t.frontModifiers.length>0&&(this.compileList(t.frontModifiers," "),this.append(" ")),t.temporary&&this.append("temporary "),this.append("table "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.table),t.selectQuery?(this.append(" as "),this.visitNode(t.selectQuery)):(this.append(" ("),this.compileList([...t.columns,...t.constraints??[]]),this.append(")"),t.onCommit&&(this.append(" on commit "),this.append(t.onCommit)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," ")))}visitColumnDefinition(t){t.ifNotExists&&this.append("if not exists "),this.visitNode(t.column),this.append(" "),this.visitNode(t.dataType),t.unsigned&&this.append(" unsigned"),t.frontModifiers&&t.frontModifiers.length>0&&(this.append(" "),this.compileList(t.frontModifiers," ")),t.generated&&(this.append(" "),this.visitNode(t.generated)),t.identity&&this.append(" identity"),t.defaultTo&&(this.append(" "),this.visitNode(t.defaultTo)),t.notNull&&this.append(" not null"),t.unique&&this.append(" unique"),t.nullsNotDistinct&&this.append(" nulls not distinct"),t.primaryKey&&this.append(" primary key"),t.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),t.references&&(this.append(" "),this.visitNode(t.references)),t.check&&(this.append(" "),this.visitNode(t.check)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(t){this.append("references "),this.visitNode(t.table),this.append(" ("),this.compileList(t.columns),this.append(")"),t.onDelete&&(this.append(" on delete "),this.append(t.onDelete)),t.onUpdate&&(this.append(" on update "),this.append(t.onUpdate))}visitDropTable(t){this.append("drop table "),t.ifExists&&this.append("if exists "),this.visitNode(t.table),t.cascade&&this.append(" cascade")}visitDataType(t){this.append(t.dataType)}visitOrderBy(t){this.append("order by "),this.compileList(t.items)}visitOrderByItem(t){this.visitNode(t.orderBy),t.collation&&(this.append(" "),this.visitNode(t.collation)),t.direction&&(this.append(" "),this.visitNode(t.direction)),t.nulls&&(this.append(" nulls "),this.append(t.nulls))}visitGroupBy(t){this.append("group by "),this.compileList(t.items)}visitGroupByItem(t){this.visitNode(t.groupBy)}visitUpdateQuery(t){const r=this.nodeStack.find(L.is),n=r!==t;if(!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&!Ye.is(r)&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("update "),t.top&&(this.visitNode(t.top),this.append(" ")),t.table&&(this.visitNode(t.table),this.append(" ")),this.append("set "),t.updates&&this.compileList(t.updates),t.output&&(this.append(" "),this.visitNode(t.output)),t.from&&(this.append(" "),this.visitNode(t.from)),t.joins){if(!t.from)throw new Error("Joins in an update query are only supported as a part of a PostgreSQL 'update set from join' query. If you want to create a MySQL 'update join set' query, see https://kysely.dev/docs/examples/update/my-sql-joins");this.append(" "),this.compileList(t.joins," ")}t.where&&(this.append(" "),this.visitNode(t.where)),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&!Ye.is(r)&&this.append(")"),t.endModifiers?.length&&(this.append(" "),this.compileList(t.endModifiers," "))}visitColumnUpdate(t){this.visitNode(t.column),this.append(" = "),this.visitNode(t.value)}visitLimit(t){this.append("limit "),this.visitNode(t.limit)}visitOffset(t){this.append("offset "),this.visitNode(t.offset)}visitOnConflict(t){this.append("on conflict"),t.columns?(this.append(" ("),this.compileList(t.columns),this.append(")")):t.constraint?(this.append(" on constraint "),this.visitNode(t.constraint)):t.indexExpression&&(this.append(" ("),this.visitNode(t.indexExpression),this.append(")")),t.indexWhere&&(this.append(" "),this.visitNode(t.indexWhere)),t.doNothing===!0?this.append(" do nothing"):t.updates&&(this.append(" do update set "),this.compileList(t.updates),t.updateWhere&&(this.append(" "),this.visitNode(t.updateWhere)))}visitOnDuplicateKey(t){this.append("on duplicate key update "),this.compileList(t.updates)}visitCreateIndex(t){this.append("create "),t.unique&&this.append("unique "),this.append("index "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),t.table&&(this.append(" on "),this.visitNode(t.table)),t.using&&(this.append(" using "),this.visitNode(t.using)),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.nullsNotDistinct&&this.append(" nulls not distinct"),t.where&&(this.append(" "),this.visitNode(t.where))}visitDropIndex(t){this.append("drop index "),t.ifExists&&this.append("if exists "),this.visitNode(t.name),t.table&&(this.append(" on "),this.visitNode(t.table)),t.cascade&&this.append(" cascade")}visitCreateSchema(t){this.append("create schema "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.schema)}visitDropSchema(t){this.append("drop schema "),t.ifExists&&this.append("if exists "),this.visitNode(t.schema),t.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("primary key ("),this.compileList(t.columns),this.append(")"),this.buildDeferrable(t)}buildDeferrable(t){t.deferrable!==void 0&&(t.deferrable?this.append(" deferrable"):this.append(" not deferrable")),t.initiallyDeferred!==void 0&&(t.initiallyDeferred?this.append(" initially deferred"):this.append(" initially immediate"))}visitUniqueConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("unique"),t.nullsNotDistinct&&this.append(" nulls not distinct"),this.append(" ("),this.compileList(t.columns),this.append(")"),this.buildDeferrable(t)}visitCheckConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("check ("),this.visitNode(t.expression),this.append(")")}visitForeignKeyConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("foreign key ("),this.compileList(t.columns),this.append(") "),this.visitNode(t.references),t.onDelete&&(this.append(" on delete "),this.append(t.onDelete)),t.onUpdate&&(this.append(" on update "),this.append(t.onUpdate)),this.buildDeferrable(t)}visitList(t){this.compileList(t.items)}visitWith(t){this.append("with "),t.recursive&&this.append("recursive "),this.compileList(t.expressions)}visitCommonTableExpression(t){this.visitNode(t.name),this.append(" as "),_s(t.materialized)&&(t.materialized||this.append("not "),this.append("materialized ")),this.visitNode(t.expression)}visitCommonTableExpressionName(t){this.visitNode(t.table),t.columns&&(this.append("("),this.compileList(t.columns),this.append(")"))}visitAlterTable(t){this.append("alter table "),this.visitNode(t.table),this.append(" "),t.renameTo&&(this.append("rename to "),this.visitNode(t.renameTo)),t.setSchema&&(this.append("set schema "),this.visitNode(t.setSchema)),t.addConstraint&&this.visitNode(t.addConstraint),t.dropConstraint&&this.visitNode(t.dropConstraint),t.renameConstraint&&this.visitNode(t.renameConstraint),t.columnAlterations&&this.compileColumnAlterations(t.columnAlterations),t.addIndex&&this.visitNode(t.addIndex),t.dropIndex&&this.visitNode(t.dropIndex)}visitAddColumn(t){this.append("add column "),this.visitNode(t.column)}visitRenameColumn(t){this.append("rename column "),this.visitNode(t.column),this.append(" to "),this.visitNode(t.renameTo)}visitDropColumn(t){this.append("drop column "),this.visitNode(t.column)}visitAlterColumn(t){this.append("alter column "),this.visitNode(t.column),this.append(" "),t.dataType&&(this.announcesNewColumnDataType()&&this.append("type "),this.visitNode(t.dataType),t.dataTypeExpression&&(this.append("using "),this.visitNode(t.dataTypeExpression))),t.setDefault&&(this.append("set default "),this.visitNode(t.setDefault)),t.dropDefault&&this.append("drop default"),t.setNotNull&&this.append("set not null"),t.dropNotNull&&this.append("drop not null")}visitModifyColumn(t){this.append("modify column "),this.visitNode(t.column)}visitAddConstraint(t){this.append("add "),this.visitNode(t.constraint)}visitDropConstraint(t){this.append("drop constraint "),t.ifExists&&this.append("if exists "),this.visitNode(t.constraintName),t.modifier==="cascade"?this.append(" cascade"):t.modifier==="restrict"&&this.append(" restrict")}visitRenameConstraint(t){this.append("rename constraint "),this.visitNode(t.oldName),this.append(" to "),this.visitNode(t.newName)}visitSetOperation(t){this.append(t.operator),this.append(" "),t.all&&this.append("all "),this.visitNode(t.expression)}visitCreateView(t){this.append("create "),t.orReplace&&this.append("or replace "),t.materialized&&this.append("materialized "),t.temporary&&this.append("temporary "),this.append("view "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),this.append(" "),t.columns&&(this.append("("),this.compileList(t.columns),this.append(") ")),t.as&&(this.append("as "),this.visitNode(t.as))}visitRefreshMaterializedView(t){this.append("refresh materialized view "),t.concurrently&&this.append("concurrently "),this.visitNode(t.name),t.withNoData?this.append(" with no data"):this.append(" with data")}visitDropView(t){this.append("drop "),t.materialized&&this.append("materialized "),this.append("view "),t.ifExists&&this.append("if exists "),this.visitNode(t.name),t.cascade&&this.append(" cascade")}visitGenerated(t){this.append("generated "),t.always&&this.append("always "),t.byDefault&&this.append("by default "),this.append("as "),t.identity&&this.append("identity"),t.expression&&(this.append("("),this.visitNode(t.expression),this.append(")")),t.stored&&this.append(" stored")}visitDefaultValue(t){this.append("default "),this.visitNode(t.defaultValue)}visitSelectModifier(t){t.rawModifier?this.visitNode(t.rawModifier):this.append(A_[t.modifier]),t.of&&(this.append(" of "),this.compileList(t.of,", "))}visitCreateType(t){this.append("create type "),this.visitNode(t.name),t.enum&&(this.append(" as enum "),this.visitNode(t.enum))}visitDropType(t){this.append("drop type "),t.ifExists&&this.append("if exists "),this.visitNode(t.name)}visitExplain(t){this.append("explain"),(t.options||t.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),t.options&&(this.visitNode(t.options),t.format&&this.append(this.getExplainOptionsDelimiter())),t.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(t.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(t){this.append("default")}visitAggregateFunction(t){this.append(t.func),this.append("("),t.distinct&&this.append("distinct "),this.compileList(t.aggregated),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),this.append(")"),t.withinGroup&&(this.append(" within group ("),this.visitNode(t.withinGroup),this.append(")")),t.filter&&(this.append(" filter("),this.visitNode(t.filter),this.append(")")),t.over&&(this.append(" "),this.visitNode(t.over))}visitOver(t){this.append("over("),t.partitionBy&&(this.visitNode(t.partitionBy),t.orderBy&&this.append(" ")),t.orderBy&&this.visitNode(t.orderBy),this.append(")")}visitPartitionBy(t){this.append("partition by "),this.compileList(t.items)}visitPartitionByItem(t){this.visitNode(t.partitionBy)}visitBinaryOperation(t){this.visitNode(t.leftOperand),this.append(" "),this.visitNode(t.operator),this.append(" "),this.visitNode(t.rightOperand)}visitUnaryOperation(t){this.visitNode(t.operator),this.isMinusOperator(t.operator)||this.append(" "),this.visitNode(t.operand)}isMinusOperator(t){return gr.is(t)&&t.operator==="-"}visitUsing(t){this.append("using "),this.compileList(t.tables)}visitFunction(t){this.append(t.func),this.append("("),this.compileList(t.arguments),this.append(")")}visitCase(t){this.append("case"),t.value&&(this.append(" "),this.visitNode(t.value)),t.when&&(this.append(" "),this.compileList(t.when," ")),t.else&&(this.append(" else "),this.visitNode(t.else)),this.append(" end"),t.isStatement&&this.append(" case")}visitWhen(t){this.append("when "),this.visitNode(t.condition),t.result&&(this.append(" then "),this.visitNode(t.result))}visitJSONReference(t){this.visitNode(t.reference),this.visitNode(t.traversal)}visitJSONPath(t){t.inOperator&&this.visitNode(t.inOperator),this.append("'$");for(const r of t.pathLegs)this.visitNode(r);this.append("'")}visitJSONPathLeg(t){const r=t.type==="ArrayLocation";this.append(r?"[":"."),this.append(String(t.value)),r&&this.append("]")}visitJSONOperatorChain(t){for(let r=0,n=t.values.length;r<n;r++)r===n-1?this.visitNode(t.operator):this.append("->"),this.visitNode(t.values[r])}visitMergeQuery(t){t.with&&(this.visitNode(t.with),this.append(" ")),this.append("merge "),t.top&&(this.visitNode(t.top),this.append(" ")),this.append("into "),this.visitNode(t.into),t.using&&(this.append(" "),this.visitNode(t.using)),t.whens&&(this.append(" "),this.compileList(t.whens," ")),t.returning&&(this.append(" "),this.visitNode(t.returning)),t.output&&(this.append(" "),this.visitNode(t.output)),t.endModifiers?.length&&(this.append(" "),this.compileList(t.endModifiers," "))}visitMatched(t){t.not&&this.append("not "),this.append("matched"),t.bySource&&this.append(" by source")}visitAddIndex(t){this.append("add "),t.unique&&this.append("unique "),this.append("index "),this.visitNode(t.name),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.using&&(this.append(" using "),this.visitNode(t.using))}visitCast(t){this.append("cast("),this.visitNode(t.expression),this.append(" as "),this.visitNode(t.dataType),this.append(")")}visitFetch(t){this.append("fetch next "),this.visitNode(t.rowCount),this.append(` rows ${t.modifier}`)}visitOutput(t){this.append("output "),this.compileList(t.selections)}visitTop(t){this.append(`top(${t.expression})`),t.modifiers&&this.append(` ${t.modifiers}`)}visitOrAction(t){this.append(t.action)}visitCollate(t){this.append("collate "),this.visitNode(t.collation)}append(t){this.#e+=t}appendValue(t){this.addParameter(t),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(t){const r=this.getLeftIdentifierWrapper(),n=this.getRightIdentifierWrapper();let s="";for(const i of t)s+=i,i===r?s+=r:i===n&&(s+=n);return s}sanitizeStringLiteral(t){return t.replace(E_,"''")}addParameter(t){this.#t.push(t)}appendImmediateValue(t){if(Me(t))this.appendStringLiteral(t);else if(Pn(t)||_s(t)||io(t))this.append(t.toString());else if(so(t))this.append("null");else if(oh(t))this.appendImmediateValue(t.toISOString());else throw new Error(`invalid immediate value ${t}`)}appendStringLiteral(t){this.append("'"),this.append(this.sanitizeStringLiteral(t)),this.append("'")}sortSelectModifiers(t){return t.sort((r,n)=>r.modifier&&n.modifier?Uu[r.modifier]-Uu[n.modifier]:1),f(t)}compileColumnAlterations(t){this.compileList(t)}announcesNewColumnDataType(){return!0}}const A_=f({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),Uu=f({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),k_=f({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",CrossJoin:"cross join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral",LateralCrossJoin:"cross join lateral",OuterApply:"outer apply",CrossApply:"cross apply",Using:"using"}),De=f({raw(e,t=[]){return f({sql:e,query:Se.createWithSql(e),parameters:f(t),queryId:G()})}});class lo{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}get supportsOutput(){return!1}}function jt(e,t){return Se.createWithChildren([Se.createWithSql(`${e} `),re.create(t)])}class T_{#e;#t=new S_;#r;#n;constructor(t){this.#e=f({...t})}async init(){this.#r=Be(this.#e.database)?await this.#e.database():this.#e.database,this.#n=new __(this.#r),this.#e.onCreateConnection&&await this.#e.onCreateConnection(this.#n)}async acquireConnection(){return await this.#t.lock(),this.#n}async beginTransaction(t){await t.executeQuery(De.raw("begin"))}async commitTransaction(t){await t.executeQuery(De.raw("commit"))}async rollbackTransaction(t){await t.executeQuery(De.raw("rollback"))}async savepoint(t,r,n){await t.executeQuery(n(jt("savepoint",r),G()))}async rollbackToSavepoint(t,r,n){await t.executeQuery(n(jt("rollback to",r),G()))}async releaseSavepoint(t,r,n){await t.executeQuery(n(jt("release",r),G()))}async releaseConnection(){this.#t.unlock()}async destroy(){this.#r?.close()}}class __{#e;constructor(t){this.#e=t}executeQuery(t){const{sql:r,parameters:n}=t,s=this.#e.prepare(r);if(s.reader)return Promise.resolve({rows:s.all(n)});const{changes:i,lastInsertRowid:o}=s.run(n);return Promise.resolve({numAffectedRows:i!=null?BigInt(i):void 0,insertId:o!=null?BigInt(o):void 0,rows:[]})}async*streamQuery(t,r){const{sql:n,parameters:s,query:i}=t,o=this.#e.prepare(n);if(ce.is(i)){const a=o.iterate(s);for(const c of a)yield{rows:[c]}}else throw new Error("Sqlite driver only supports streaming of select queries")}}let S_=class{#e;#t;async lock(){for(;this.#e;)await this.#e;this.#e=new Promise(t=>{this.#t=t})}unlock(){const t=this.#t;this.#e=void 0,this.#t=void 0,t?.()}};const R_=/"/g;class O_ extends Bn{visitOrAction(t){this.append("or "),this.append(t.action)}getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}sanitizeIdentifier(t){return t.replace(R_,'""')}visitDefaultInsertValue(t){this.append("null")}}const Jr="kysely_migration",Hn="kysely_migration_lock";f({__noMigrations__:!0});class I_{#e;constructor(t){this.#e=t}async getSchemas(){return[]}async getTables(t={withInternalKyselyTables:!1}){return await this.#r(t)}async getMetadata(t){return{tables:await this.getTables(t)}}#t(t,r){let n=t.selectFrom("sqlite_master").where("type","in",["table","view"]).where("name","not like","sqlite_%").select(["name","sql","type"]).orderBy("name");return r.withInternalKyselyTables||(n=n.where("name","!=",Jr).where("name","!=",Hn)),n}async#r(t){const r=await this.#t(this.#e,t).execute(),n=await this.#e.with("table_list",i=>this.#t(i,t)).selectFrom(["table_list as tl",Ie`pragma_table_info(tl.name)`.as("p")]).select(["tl.name as table","p.cid","p.name","p.type","p.notnull","p.dflt_value","p.pk"]).orderBy("tl.name").orderBy("p.cid").execute(),s={};for(const i of n)s[i.table]??=[],s[i.table].push(i);return r.map(({name:i,sql:o,type:a})=>{let c=o?.split(/[\(\),]/)?.find(d=>d.toLowerCase().includes("autoincrement"))?.trimStart()?.split(/\s+/)?.[0]?.replace(/["`]/g,"");const u=s[i]??[];if(!c){const d=u.filter(l=>l.pk>0);d.length===1&&d[0].type.toLowerCase()==="integer"&&(c=d[0].name)}return{name:i,isView:a==="view",columns:u.map(d=>({name:d.name,dataType:d.type,isNullable:!d.notnull,isAutoIncrementing:d.name===c,hasDefaultValue:d.dflt_value!=null,comment:void 0}))}})}}class x_ extends lo{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(t,r){}async releaseMigrationLock(t,r){}}class Fh{#e;constructor(t){this.#e=f({...t})}createDriver(){return new T_(this.#e)}createQueryCompiler(){return new O_}createAdapter(){return new x_}createIntrospector(t){return new I_(t)}}const C_=/"/g;class P_ extends Bn{sanitizeIdentifier(t){return t.replace(C_,'""')}}class U_{#e;constructor(t){this.#e=t}async getSchemas(){return(await this.#e.selectFrom("pg_catalog.pg_namespace").select("nspname").$castTo().execute()).map(r=>({name:r.nspname}))}async getTables(t={withInternalKyselyTables:!1}){let r=this.#e.selectFrom("pg_catalog.pg_attribute as a").innerJoin("pg_catalog.pg_class as c","a.attrelid","c.oid").innerJoin("pg_catalog.pg_namespace as ns","c.relnamespace","ns.oid").innerJoin("pg_catalog.pg_type as typ","a.atttypid","typ.oid").innerJoin("pg_catalog.pg_namespace as dtns","typ.typnamespace","dtns.oid").select(["a.attname as column","a.attnotnull as not_null","a.atthasdef as has_default","c.relname as table","c.relkind as table_type","ns.nspname as schema","typ.typname as type","dtns.nspname as type_schema",Ie`col_description(a.attrelid, a.attnum)`.as("column_description"),Ie`pg_get_serial_sequence(quote_ident(ns.nspname) || '.' || quote_ident(c.relname), a.attname)`.as("auto_incrementing")]).where("c.relkind","in",["r","v","p"]).where("ns.nspname","!~","^pg_").where("ns.nspname","!=","information_schema").where("ns.nspname","!=","crdb_internal").where("a.attnum",">=",0).where("a.attisdropped","!=",!0).orderBy("ns.nspname").orderBy("c.relname").orderBy("a.attnum").$castTo();t.withInternalKyselyTables||(r=r.where("c.relname","!=",Jr).where("c.relname","!=",Hn));const n=await r.execute();return this.#t(n)}async getMetadata(t){return{tables:await this.getTables(t)}}#t(t){return t.reduce((r,n)=>{let s=r.find(i=>i.name===n.table&&i.schema===n.schema);return s||(s=f({name:n.table,isView:n.table_type==="v",schema:n.schema,columns:[]}),r.push(s)),s.columns.push(f({name:n.column,dataType:n.type,dataTypeSchema:n.type_schema,isNullable:!n.not_null,isAutoIncrementing:n.auto_incrementing!==null,hasDefaultValue:n.has_default,comment:n.column_description??void 0})),r},[])}}const L_=BigInt("3853314791062309107");class $_ extends lo{get supportsTransactionalDdl(){return!0}get supportsReturning(){return!0}async acquireMigrationLock(t,r){await Ie`select pg_advisory_xact_lock(${Ie.lit(L_)})`.execute(t)}async releaseMigrationLock(t,r){}}function Ba(e,t){if(D_(e)&&t.stack){const r=t.stack.split(`
`).slice(1).join(`
`);return e.stack+=`
${r}`,e}return e}function D_(e){return it(e)&&Me(e.stack)}const Bh=Symbol();class q_{#e;#t=new WeakMap;#r;constructor(t){this.#e=f({...t})}async init(){this.#r=Be(this.#e.pool)?await this.#e.pool():this.#e.pool}async acquireConnection(){const t=await this.#n();let r=this.#t.get(t);return r||(r=new z_(t),this.#t.set(t,r),this.#e?.onCreateConnection&&await this.#e.onCreateConnection(r)),this.#e?.onReserveConnection&&await this.#e.onReserveConnection(r),r}async#n(){return new Promise((t,r)=>{this.#r.getConnection(async(n,s)=>{n?r(n):t(s)})})}async beginTransaction(t,r){if(r.isolationLevel||r.accessMode){const n=[];r.isolationLevel&&n.push(`isolation level ${r.isolationLevel}`),r.accessMode&&n.push(r.accessMode);const s=`set transaction ${n.join(", ")}`;await t.executeQuery(De.raw(s))}await t.executeQuery(De.raw("begin"))}async commitTransaction(t){await t.executeQuery(De.raw("commit"))}async rollbackTransaction(t){await t.executeQuery(De.raw("rollback"))}async savepoint(t,r,n){await t.executeQuery(n(jt("savepoint",r),G()))}async rollbackToSavepoint(t,r,n){await t.executeQuery(n(jt("rollback to",r),G()))}async releaseSavepoint(t,r,n){await t.executeQuery(n(jt("release savepoint",r),G()))}async releaseConnection(t){t[Bh]()}async destroy(){return new Promise((t,r)=>{this.#r.end(n=>{n?r(n):t()})})}}function W_(e){return it(e)&&"insertId"in e&&"affectedRows"in e}class z_{#e;constructor(t){this.#e=t}async executeQuery(t){try{const r=await this.#t(t);if(W_(r)){const{insertId:n,affectedRows:s,changedRows:i}=r;return{insertId:n!=null&&n.toString()!=="0"?BigInt(n):void 0,numAffectedRows:s!=null?BigInt(s):void 0,numChangedRows:i!=null?BigInt(i):void 0,rows:[]}}else if(Array.isArray(r))return{rows:r};return{rows:[]}}catch(r){throw Ba(r,new Error)}}#t(t){return new Promise((r,n)=>{this.#e.query(t.sql,t.parameters,(s,i)=>{s?n(s):r(i)})})}async*streamQuery(t,r){const n=this.#e.query(t.sql,t.parameters).stream({objectMode:!0});try{for await(const s of n)yield{rows:[s]}}catch(s){if(s&&typeof s=="object"&&"code"in s&&s.code==="ERR_STREAM_PREMATURE_CLOSE")return;throw s}}[Bh](){this.#e.release()}}const M_=/`/g;class j_ extends Bn{getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getExplainOptionAssignment(){return"="}getExplainOptionsDelimiter(){return" "}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return"`"}getRightIdentifierWrapper(){return"`"}sanitizeIdentifier(t){return t.replace(M_,"``")}visitCreateIndex(t){this.append("create "),t.unique&&this.append("unique "),this.append("index "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),t.using&&(this.append(" using "),this.visitNode(t.using)),t.table&&(this.append(" on "),this.visitNode(t.table)),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.where&&(this.append(" "),this.visitNode(t.where))}}class V_{#e;constructor(t){this.#e=t}async getSchemas(){return(await this.#e.selectFrom("information_schema.schemata").select("schema_name").$castTo().execute()).map(r=>({name:r.SCHEMA_NAME}))}async getTables(t={withInternalKyselyTables:!1}){let r=this.#e.selectFrom("information_schema.columns as columns").innerJoin("information_schema.tables as tables",s=>s.onRef("columns.TABLE_CATALOG","=","tables.TABLE_CATALOG").onRef("columns.TABLE_SCHEMA","=","tables.TABLE_SCHEMA").onRef("columns.TABLE_NAME","=","tables.TABLE_NAME")).select(["columns.COLUMN_NAME","columns.COLUMN_DEFAULT","columns.TABLE_NAME","columns.TABLE_SCHEMA","tables.TABLE_TYPE","columns.IS_NULLABLE","columns.DATA_TYPE","columns.EXTRA","columns.COLUMN_COMMENT"]).where("columns.TABLE_SCHEMA","=",Ie`database()`).orderBy("columns.TABLE_NAME").orderBy("columns.ORDINAL_POSITION").$castTo();t.withInternalKyselyTables||(r=r.where("columns.TABLE_NAME","!=",Jr).where("columns.TABLE_NAME","!=",Hn));const n=await r.execute();return this.#t(n)}async getMetadata(t){return{tables:await this.getTables(t)}}#t(t){return t.reduce((r,n)=>{let s=r.find(i=>i.name===n.TABLE_NAME);return s||(s=f({name:n.TABLE_NAME,isView:n.TABLE_TYPE==="VIEW",schema:n.TABLE_SCHEMA,columns:[]}),r.push(s)),s.columns.push(f({name:n.COLUMN_NAME,dataType:n.DATA_TYPE,isNullable:n.IS_NULLABLE==="YES",isAutoIncrementing:n.EXTRA.toLowerCase().includes("auto_increment"),hasDefaultValue:n.COLUMN_DEFAULT!==null,comment:n.COLUMN_COMMENT===""?void 0:n.COLUMN_COMMENT})),r},[])}}const Lu="ea586330-2c93-47c8-908d-981d9d270f9d",F_=3600;class B_ extends lo{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}async acquireMigrationLock(t,r){await Ie`select get_lock(${Ie.lit(Lu)}, ${Ie.lit(F_)})`.execute(t)}async releaseMigrationLock(t,r){await Ie`select release_lock(${Ie.lit(Lu)})`.execute(t)}}class Hh{#e;constructor(t){this.#e=t}createDriver(){return new q_(this.#e)}createQueryCompiler(){return new j_}createAdapter(){return new B_}createIntrospector(t){return new V_(t)}}const Kh=Symbol();class H_{#e;#t=new WeakMap;#r;constructor(t){this.#e=f({...t})}async init(){this.#r=Be(this.#e.pool)?await this.#e.pool():this.#e.pool}async acquireConnection(){const t=await this.#r.connect();let r=this.#t.get(t);return r||(r=new K_(t,{cursor:this.#e.cursor??null}),this.#t.set(t,r),this.#e.onCreateConnection&&await this.#e.onCreateConnection(r)),this.#e.onReserveConnection&&await this.#e.onReserveConnection(r),r}async beginTransaction(t,r){if(r.isolationLevel||r.accessMode){let n="start transaction";r.isolationLevel&&(n+=` isolation level ${r.isolationLevel}`),r.accessMode&&(n+=` ${r.accessMode}`),await t.executeQuery(De.raw(n))}else await t.executeQuery(De.raw("begin"))}async commitTransaction(t){await t.executeQuery(De.raw("commit"))}async rollbackTransaction(t){await t.executeQuery(De.raw("rollback"))}async savepoint(t,r,n){await t.executeQuery(n(jt("savepoint",r),G()))}async rollbackToSavepoint(t,r,n){await t.executeQuery(n(jt("rollback to",r),G()))}async releaseSavepoint(t,r,n){await t.executeQuery(n(jt("release",r),G()))}async releaseConnection(t){t[Kh]()}async destroy(){if(this.#r){const t=this.#r;this.#r=void 0,await t.end()}}}class K_{#e;#t;constructor(t,r){this.#e=t,this.#t=r}async executeQuery(t){try{const{command:r,rowCount:n,rows:s}=await this.#e.query(t.sql,[...t.parameters]);return{numAffectedRows:r==="INSERT"||r==="UPDATE"||r==="DELETE"||r==="MERGE"?BigInt(n):void 0,rows:s??[]}}catch(r){throw Ba(r,new Error)}}async*streamQuery(t,r){if(!this.#t.cursor)throw new Error("'cursor' is not present in your postgres dialect config. It's required to make streaming work in postgres.");if(!Number.isInteger(r)||r<=0)throw new Error("chunkSize must be a positive integer");const n=this.#e.query(new this.#t.cursor(t.sql,t.parameters.slice()));try{for(;;){const s=await n.read(r);if(s.length===0)break;yield{rows:s}}}finally{await n.close()}}[Kh](){this.#e.release()}}class Zh{#e;constructor(t){this.#e=t}createDriver(){return new H_(this.#e)}createQueryCompiler(){return new P_}createAdapter(){return new $_}createIntrospector(t){return new U_(t)}}class Z_ extends lo{get supportsCreateIfNotExists(){return!1}get supportsTransactionalDdl(){return!0}get supportsOutput(){return!0}async acquireMigrationLock(t){await Ie`exec sp_getapplock @DbPrincipal = ${Ie.lit("dbo")}, @Resource = ${Ie.lit(Jr)}, @LockMode = ${Ie.lit("Exclusive")}`.execute(t)}async releaseMigrationLock(){}}const Jh=Symbol(),Gh=Symbol(),Qh=Symbol();class J_{#e;#t;constructor(t){this.#e=f({...t});const{tarn:r,tedious:n,validateConnections:s}=this.#e,{validateConnections:i,...o}=r.options;this.#t=new r.Pool({...o,create:async()=>{const a=await n.connectionFactory();return await new G_(a,n).connect()},destroy:async a=>{await a[Gh]()},validate:s===!1||i===!1?void 0:a=>a[Qh]()})}async init(){}async acquireConnection(){return await this.#t.acquire().promise}async beginTransaction(t,r){await t.beginTransaction(r)}async commitTransaction(t){await t.commitTransaction()}async rollbackTransaction(t){await t.rollbackTransaction()}async savepoint(t,r){await t.savepoint(r)}async rollbackToSavepoint(t,r){await t.rollbackTransaction(r)}async releaseConnection(t){(this.#e.resetConnectionsOnRelease||this.#e.tedious.resetConnectionOnRelease)&&await t[Jh](),this.#t.release(t)}async destroy(){await this.#t.destroy()}}class G_{#e;#t;#r;constructor(t,r){this.#e=t,this.#t=!1,this.#r=r}async beginTransaction(t){const{isolationLevel:r}=t;await new Promise((n,s)=>this.#e.beginTransaction(i=>{i?s(i):n(void 0)},r?Eh(8):void 0,r?this.#n(r):void 0))}async commitTransaction(){await new Promise((t,r)=>this.#e.commitTransaction(n=>{n?r(n):t(void 0)}))}async connect(){const{promise:t,reject:r,resolve:n}=new hs;this.#e.connect(i=>{if(i)return r(i);n()}),this.#e.on("error",i=>{i instanceof Error&&"code"in i&&i.code==="ESOCKET"&&(this.#t=!0),console.error(i),r(i)});function s(){r(new Error("The connection ended without ever completing the connection"))}return this.#e.once("end",s),await t,this.#e.off("end",s),this}async executeQuery(t){try{const r=new hs,n=new _o({compiledQuery:t,tedious:this.#r,onDone:r});this.#e.execSql(n.request);const{rowCount:s,rows:i}=await r.promise;return{numAffectedRows:s!==void 0?BigInt(s):void 0,rows:i}}catch(r){throw Ba(r,new Error)}}async rollbackTransaction(t){await new Promise((r,n)=>this.#e.rollbackTransaction(s=>{s?n(s):r(void 0)},t))}async savepoint(t){await new Promise((r,n)=>this.#e.saveTransaction(s=>{s?n(s):r(void 0)},t))}async*streamQuery(t,r){if(!Number.isInteger(r)||r<=0)throw new Error("chunkSize must be a positive integer");const n=new _o({compiledQuery:t,streamChunkSize:r,tedious:this.#r});this.#e.execSql(n.request);try{for(;;){const s=await n.readChunk();if(s.length===0||(yield{rows:s},s.length<r))break}}finally{await this.#s(n)}}#n(t){const{ISOLATION_LEVEL:r}=this.#r,s={"read committed":r.READ_COMMITTED,"read uncommitted":r.READ_UNCOMMITTED,"repeatable read":r.REPEATABLE_READ,serializable:r.SERIALIZABLE,snapshot:r.SNAPSHOT}[t];if(s===void 0)throw new Error(`Unknown isolation level: ${t}`);return s}#s(t){return new Promise(r=>{t.request.once("requestCompleted",r),this.#e.cancel()||(t.request.off("requestCompleted",r),r())})}[Gh](){return"closed"in this.#e&&this.#e.closed?Promise.resolve():new Promise(t=>{this.#e.once("end",t),this.#e.close()})}async[Jh](){await new Promise((t,r)=>{this.#e.reset(n=>{if(n)return r(n);t()})})}async[Qh](){if(this.#t||this.#i())return!1;try{const t=new hs,r=new _o({compiledQuery:De.raw("select 1"),onDone:t,tedious:this.#r});return this.#e.execSql(r.request),await t.promise,!0}catch{return!1}}#i(){return"closed"in this.#e&&!!this.#e.closed}}class _o{#e;#t;#r;#n;#s;#i;constructor(t){const{compiledQuery:r,onDone:n,streamChunkSize:s,tedious:i}=t;if(this.#t=[],this.#r=s,this.#n={},this.#s=i,n){const o="onDone";this.#n[o]=(a,c)=>{if(a!=="chunkReady"){if(delete this.#n[o],a==="error")return n.reject(c);n.resolve({rowCount:this.#i,rows:this.#t})}}}this.#e=new this.#s.Request(r.sql,(o,a)=>{if(o)return Object.values(this.#n).forEach(c=>c("error",o instanceof AggregateError?o.errors:o));this.#i=a}),this.#c(r.parameters),this.#a()}get request(){return this.#e}readChunk(){const t=this.readChunk.name;return new Promise((r,n)=>{this.#n[t]=(s,i)=>{if(delete this.#n[t],s==="error")return n(i);r(this.#t.splice(0,this.#r))},this.#e.resume()})}#c(t){for(let r=0;r<t.length;r++){const n=t[r];this.#e.addParameter(String(r+1),this.#o(n),n)}}#a(){const t=this.#r?()=>{this.#r<=this.#t.length&&(this.#e.pause(),Object.values(this.#n).forEach(n=>n("chunkReady")))}:()=>{},r=n=>{const s={};for(const i of n)s[i.metadata.colName]=i.value;this.#t.push(s),t()};this.#e.on("row",r),this.#e.once("requestCompleted",()=>{Object.values(this.#n).forEach(n=>n("completed")),this.#e.off("row",r)})}#o(t){return so(t)||Mt(t)||Me(t)?this.#s.TYPES.NVarChar:io(t)||Pn(t)&&t%1===0?t<-2147483648||t>2147483647?this.#s.TYPES.BigInt:this.#s.TYPES.Int:Pn(t)?this.#s.TYPES.Float:_s(t)?this.#s.TYPES.Bit:oh(t)?this.#s.TYPES.DateTime:qk(t)?this.#s.TYPES.VarBinary:this.#s.TYPES.NVarChar}}class Q_{#e;constructor(t){this.#e=t}async getSchemas(){return await this.#e.selectFrom("sys.schemas").select("name").execute()}async getTables(t={withInternalKyselyTables:!1}){const r=await this.#e.selectFrom("sys.tables as tables").leftJoin("sys.schemas as table_schemas","table_schemas.schema_id","tables.schema_id").innerJoin("sys.columns as columns","columns.object_id","tables.object_id").innerJoin("sys.types as types","types.user_type_id","columns.user_type_id").leftJoin("sys.schemas as type_schemas","type_schemas.schema_id","types.schema_id").leftJoin("sys.extended_properties as comments",s=>s.onRef("comments.major_id","=","tables.object_id").onRef("comments.minor_id","=","columns.column_id").on("comments.name","=","MS_Description")).$if(!t.withInternalKyselyTables,s=>s.where("tables.name","!=",Jr).where("tables.name","!=",Hn)).select(["tables.name as table_name",s=>s.ref("tables.type").$castTo().as("table_type"),"table_schemas.name as table_schema_name","columns.default_object_id as column_default_object_id","columns.generated_always_type_desc as column_generated_always_type","columns.is_computed as column_is_computed","columns.is_identity as column_is_identity","columns.is_nullable as column_is_nullable","columns.is_rowguidcol as column_is_rowguidcol","columns.name as column_name","types.is_nullable as type_is_nullable","types.name as type_name","type_schemas.name as type_schema_name","comments.value as column_comment"]).unionAll(this.#e.selectFrom("sys.views as views").leftJoin("sys.schemas as view_schemas","view_schemas.schema_id","views.schema_id").innerJoin("sys.columns as columns","columns.object_id","views.object_id").innerJoin("sys.types as types","types.user_type_id","columns.user_type_id").leftJoin("sys.schemas as type_schemas","type_schemas.schema_id","types.schema_id").leftJoin("sys.extended_properties as comments",s=>s.onRef("comments.major_id","=","views.object_id").onRef("comments.minor_id","=","columns.column_id").on("comments.name","=","MS_Description")).select(["views.name as table_name","views.type as table_type","view_schemas.name as table_schema_name","columns.default_object_id as column_default_object_id","columns.generated_always_type_desc as column_generated_always_type","columns.is_computed as column_is_computed","columns.is_identity as column_is_identity","columns.is_nullable as column_is_nullable","columns.is_rowguidcol as column_is_rowguidcol","columns.name as column_name","types.is_nullable as type_is_nullable","types.name as type_name","type_schemas.name as type_schema_name","comments.value as column_comment"])).orderBy("table_schema_name").orderBy("table_name").orderBy("column_name").execute(),n={};for(const s of r){const i=`${s.table_schema_name}.${s.table_name}`;(n[i]=n[i]||f({columns:[],isView:s.table_type==="V ",name:s.table_name,schema:s.table_schema_name??void 0})).columns.push(f({dataType:s.type_name,dataTypeSchema:s.type_schema_name??void 0,hasDefaultValue:s.column_default_object_id>0||s.column_generated_always_type!=="NOT_APPLICABLE"||s.column_is_identity||s.column_is_computed||s.column_is_rowguidcol,isAutoIncrementing:s.column_is_identity,isNullable:s.column_is_nullable&&s.type_is_nullable,name:s.column_name,comment:s.column_comment??void 0}))}return Object.values(n)}async getMetadata(t){return{tables:await this.getTables(t)}}}const Y_=/^[a-z0-9_]$/i;class X_ extends Bn{getCurrentParameterPlaceholder(){return`@${this.numParameters}`}visitOffset(t){super.visitOffset(t),this.append(" rows")}compileColumnAlterations(t){const r={};for(const s of t)r[s.kind]||(r[s.kind]=[]),r[s.kind].push(s);let n=!0;r.AddColumnNode&&(this.append("add "),this.compileList(r.AddColumnNode),n=!1),r.AlterColumnNode&&(n||this.append(", "),this.compileList(r.AlterColumnNode)),r.DropColumnNode&&(n||this.append(", "),this.append("drop column "),this.compileList(r.DropColumnNode)),r.ModifyColumnNode&&(n||this.append(", "),this.compileList(r.ModifyColumnNode)),r.RenameColumnNode&&(n||this.append(", "),this.compileList(r.RenameColumnNode))}visitAddColumn(t){this.visitNode(t.column)}visitDropColumn(t){this.visitNode(t.column)}visitMergeQuery(t){super.visitMergeQuery(t),this.append(";")}visitCollate(t){this.append("collate ");const{name:r}=t.collation;for(const n of r)if(!Y_.test(n))throw new Error(`Invalid collation: ${r}`);this.append(r)}announcesNewColumnDataType(){return!1}}class eS{#e;constructor(t){this.#e=t}createDriver(){return new J_(this.#e)}createQueryCompiler(){return new X_}createAdapter(){return new Z_}createIntrospector(t){return new Q_(t)}}function tS(e,t,r){return r==="update"?e===void 0&&t.onUpdate!==void 0?typeof t.onUpdate=="function"?t.onUpdate():t.onUpdate:e:e==null&&t.defaultValue!==void 0?typeof t.defaultValue=="function"?t.defaultValue():t.defaultValue:e}let So=[],Fe=-1;const Vt={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",fg:{yellow:"\x1B[33m",magenta:"\x1B[35m"},bg:{black:"\x1B[40m"}},rS=e=>t=>t(e),Is=({adapter:e,config:t})=>r=>{const n={...t,supportsBooleans:t.supportsBooleans??!0,supportsDates:t.supportsDates??!0,supportsJSON:t.supportsJSON??!1,adapterName:t.adapterName??t.adapterId,supportsNumericIds:t.supportsNumericIds??!0,transaction:t.transaction??!1};if(r.advanced?.database?.useNumberId===!0&&n.supportsNumericIds===!1)throw new Error(`[${n.adapterName}] Your database or database adapter does not support numeric ids. Please disable "useNumberId" in your config.`);const s=Ts(r),i=({field:w,model:N})=>{if(w==="id"||w==="_id")return"id";const v=o(N);let k=s[v]?.fields[w];if(k||(k=Object.values(s[v]?.fields).find(A=>A.fieldName===w)),!k)throw u(`Field ${w} not found in model ${v}`),u("Schema:",s),new Error(`Field ${w} not found in model ${v}`);return w},o=w=>{if(n.usePlural&&w.charAt(w.length-1)==="s"){let v=w.slice(0,-1),k=s[v]?v:void 0;if(k||(k=Object.entries(s).find(([A,S])=>S.modelName===v)?.[0]),k)return k}let N=s[w]?w:void 0;if(N||(N=Object.entries(s).find(([v,k])=>k.modelName===w)?.[0]),!N)throw u(`Model "${w}" not found in schema`),u("Schema:",s),new Error(`Model "${w}" not found in schema`);return N},a=w=>{const N=o(w),v=n&&n.usePlural;return s&&s[N]&&s[N].modelName!==w?v?`${s[N].modelName}s`:s[N].modelName:v?`${w}s`:w};function c({model:w,field:N}){const v=o(w),k=i({model:v,field:N});return s[v]?.fields[k]?.fieldName||k}const u=(...w)=>{if(n.debugLogs===!0||typeof n.debugLogs=="object"){if(typeof n.debugLogs=="object"&&"isRunningAdapterTests"in n.debugLogs){n.debugLogs.isRunningAdapterTests&&(w.shift(),So.push(w));return}if(typeof n.debugLogs=="object"&&n.debugLogs.logCondition&&!n.debugLogs.logCondition?.())return;if(typeof w[0]=="object"&&"method"in w[0]){const N=w.shift().method;if(typeof n.debugLogs=="object"){if(N==="create"&&!n.debugLogs.create)return;if(N==="update"&&!n.debugLogs.update)return;if(N==="updateMany"&&!n.debugLogs.updateMany)return;if(N==="findOne"&&!n.debugLogs.findOne)return;if(N==="findMany"&&!n.debugLogs.findMany)return;if(N==="delete"&&!n.debugLogs.delete)return;if(N==="deleteMany"&&!n.debugLogs.deleteMany)return;if(N==="count"&&!n.debugLogs.count)return}K.info(`[${n.adapterName}]`,...w)}else K.info(`[${n.adapterName}]`,...w)}},d=({customModelName:w,forceAllowId:N})=>{const v=!n.disableIdGeneration&&!r.advanced?.database?.useNumberId&&!N,k=o(w??"id");return{type:r.advanced?.database?.useNumberId?"number":"string",required:!!v,...v?{defaultValue(){if(n.disableIdGeneration)return;const A=r.advanced?.database?.useNumberId;let S=r.advanced?.database?.generateId;if(r.advanced?.generateId!==void 0&&(K.warn("Your Better Auth config includes advanced.generateId which is deprecated. Please use advanced.database.generateId instead. This will be removed in future releases."),S=r.advanced?.generateId),!(S===!1||A))return S?S({model:k}):n.customIdGenerator?n.customIdGenerator({model:k}):Kr()}}:{}}},l=({model:w,field:N})=>{const v=o(w),k=i({field:N,model:w}),A=s[v].fields;return A.id=d({customModelName:v}),A[k]},h=e({options:r,schema:s,debugLog:u,getFieldName:c,getModelName:a,getDefaultModelName:o,getDefaultFieldName:i,getFieldAttributes:l}),p=async(w,N,v,k)=>{const A={},S=s[N].fields,q=n.mapKeysTransformInput??{};!n.disableIdGeneration&&!r.advanced?.database?.useNumberId&&(S.id=d({customModelName:N,forceAllowId:k&&"id"in w}));for(const O in S){const $=w[O],I=S[O];let E=q[O]||S[O].fieldName||O;if($===void 0&&(I.defaultValue===void 0&&!I.transform?.input&&!(v==="update"&&I.onUpdate)||v==="update"&&!I.onUpdate))continue;let R=tS($,I,v);I.transform?.input&&(R=await I.transform.input(R)),I.references?.field==="id"&&r.advanced?.database?.useNumberId?Array.isArray(R)?R=R.map(Number):R=Number(R):n.supportsJSON===!1&&typeof R=="object"&&I.type==="json"?R=JSON.stringify(R):n.supportsDates===!1&&R instanceof Date&&I.type==="date"?R=R.toISOString():n.supportsBooleans===!1&&typeof R=="boolean"&&(R=R?1:0),n.customTransformInput&&(R=n.customTransformInput({data:R,action:v,field:E,fieldAttributes:I,model:N,schema:s,options:r})),R!==void 0&&(A[E]=R)}return A},m=async(w,N,v=[])=>{if(!w)return null;const k=n.mapKeysTransformOutput??{},A={},S=s[N].fields,q=Object.entries(k).find(([O,$])=>$==="id")?.[0];S[q??"id"]={type:r.advanced?.database?.useNumberId?"number":"string"};for(const O in S){if(v.length&&!v.includes(O))continue;const $=S[O];if($){const I=$.fieldName||O;let E=w[Object.entries(k).find(([P,D])=>D===I)?.[0]||I];$.transform?.output&&(E=await $.transform.output(E));let R=k[O]||O;I==="id"||$.references?.field==="id"?typeof E<"u"&&E!==null&&(E=String(E)):n.supportsJSON===!1&&typeof E=="string"&&$.type==="json"?E=He(E):n.supportsDates===!1&&typeof E=="string"&&$.type==="date"?E=new Date(E):n.supportsBooleans===!1&&typeof E=="number"&&$.type==="boolean"&&(E=E===1),n.customTransformOutput&&(E=n.customTransformOutput({data:E,field:R,fieldAttributes:$,select:v,model:N,schema:s,options:r})),A[R]=E}}return A},y=({model:w,where:N})=>{if(!N)return;const v=n.mapKeysTransformInput??{};return N.map(k=>{const{field:A,value:S,operator:q="eq",connector:O="AND"}=k;if(q==="in"&&!Array.isArray(S))throw new Error("Value must be an array");const $=o(w),I=i({field:A,model:w}),E=v[I]||c({field:I,model:$}),R=l({field:I,model:$});return(I==="id"||R.references?.field==="id")&&r.advanced?.database?.useNumberId?Array.isArray(S)?{operator:q,connector:O,field:E,value:S.map(Number)}:{operator:q,connector:O,field:E,value:Number(S)}:{operator:q,connector:O,field:E,value:S}})};let g=null;const b={transaction:async w=>(g||(n.transaction?(K.debug(`[${n.adapterName}] - Using provided transaction implementation.`),g=n.transaction):(K.warn(`[${n.adapterName}] - Transactions are not supported. Executing operations sequentially.`),g=rS(b))),g(w)),create:async({data:w,model:N,select:v,forceAllowId:k=!1})=>{Fe++;let A=Fe;const S=a(N);if("id"in w&&!k){K.warn(`[${n.adapterName}] - You are trying to create a record with an id. This is not allowed as we handle id generation for you, unless you pass in the \`forceAllowId\` parameter. The id will be ignored.`);const E=new Error().stack?.split(`
`).filter((R,P)=>P!==1).join(`
`).replace("Error:","Create method with `id` being called at:");console.log(E),w.id=void 0}u({method:"create"},`${pe(A)} ${me(1,4)}`,`${ye("create")} ${xe("Unsafe Input")}:`,{model:S,data:w});const q=await p(w,N,"create",k);u({method:"create"},`${pe(A)} ${me(2,4)}`,`${ye("create")} ${xe("Parsed Input")}:`,{model:S,data:q});const O=await h.create({data:q,model:S});u({method:"create"},`${pe(A)} ${me(3,4)}`,`${ye("create")} ${xe("DB Result")}:`,{model:S,res:O});const $=await m(O,N,v);return u({method:"create"},`${pe(A)} ${me(4,4)}`,`${ye("create")} ${xe("Parsed Result")}:`,{model:S,data:$}),$},update:async({model:w,where:N,update:v})=>{Fe++;let k=Fe;const A=a(w),S=y({model:w,where:N});u({method:"update"},`${pe(k)} ${me(1,4)}`,`${ye("update")} ${xe("Unsafe Input")}:`,{model:A,data:v});const q=await p(v,w,"update");u({method:"update"},`${pe(k)} ${me(2,4)}`,`${ye("update")} ${xe("Parsed Input")}:`,{model:A,data:q});const O=await h.update({model:A,where:S,update:q});u({method:"update"},`${pe(k)} ${me(3,4)}`,`${ye("update")} ${xe("DB Result")}:`,{model:A,data:O});const $=await m(O,w);return u({method:"update"},`${pe(k)} ${me(4,4)}`,`${ye("update")} ${xe("Parsed Result")}:`,{model:A,data:$}),$},updateMany:async({model:w,where:N,update:v})=>{Fe++;let k=Fe;const A=a(w),S=y({model:w,where:N});u({method:"updateMany"},`${pe(k)} ${me(1,4)}`,`${ye("updateMany")} ${xe("Unsafe Input")}:`,{model:A,data:v});const q=await p(v,w,"update");u({method:"updateMany"},`${pe(k)} ${me(2,4)}`,`${ye("updateMany")} ${xe("Parsed Input")}:`,{model:A,data:q});const O=await h.updateMany({model:A,where:S,update:q});return u({method:"updateMany"},`${pe(k)} ${me(3,4)}`,`${ye("updateMany")} ${xe("DB Result")}:`,{model:A,data:O}),u({method:"updateMany"},`${pe(k)} ${me(4,4)}`,`${ye("updateMany")} ${xe("Parsed Result")}:`,{model:A,data:O}),O},findOne:async({model:w,where:N,select:v})=>{Fe++;let k=Fe;const A=a(w),S=y({model:w,where:N});u({method:"findOne"},`${pe(k)} ${me(1,3)}`,`${ye("findOne")}:`,{model:A,where:S,select:v});const q=await h.findOne({model:A,where:S,select:v});u({method:"findOne"},`${pe(k)} ${me(2,3)}`,`${ye("findOne")} ${xe("DB Result")}:`,{model:A,data:q});const O=await m(q,w,v);return u({method:"findOne"},`${pe(k)} ${me(3,3)}`,`${ye("findOne")} ${xe("Parsed Result")}:`,{model:A,data:O}),O},findMany:async({model:w,where:N,limit:v,sortBy:k,offset:A})=>{Fe++;let S=Fe;const q=v??r.advanced?.database?.defaultFindManyLimit??100,O=a(w),$=y({model:w,where:N});u({method:"findMany"},`${pe(S)} ${me(1,3)}`,`${ye("findMany")}:`,{model:O,where:$,limit:q,sortBy:k,offset:A});const I=await h.findMany({model:O,where:$,limit:q,sortBy:k,offset:A});u({method:"findMany"},`${pe(S)} ${me(2,3)}`,`${ye("findMany")} ${xe("DB Result")}:`,{model:O,data:I});const E=await Promise.all(I.map(async R=>await m(R,w)));return u({method:"findMany"},`${pe(S)} ${me(3,3)}`,`${ye("findMany")} ${xe("Parsed Result")}:`,{model:O,data:E}),E},delete:async({model:w,where:N})=>{Fe++;let v=Fe;const k=a(w),A=y({model:w,where:N});u({method:"delete"},`${pe(v)} ${me(1,2)}`,`${ye("delete")}:`,{model:k,where:A}),await h.delete({model:k,where:A}),u({method:"delete"},`${pe(v)} ${me(2,2)}`,`${ye("delete")} ${xe("DB Result")}:`,{model:k})},deleteMany:async({model:w,where:N})=>{Fe++;let v=Fe;const k=a(w),A=y({model:w,where:N});u({method:"deleteMany"},`${pe(v)} ${me(1,2)}`,`${ye("deleteMany")} ${xe("DeleteMany")}:`,{model:k,where:A});const S=await h.deleteMany({model:k,where:A});return u({method:"deleteMany"},`${pe(v)} ${me(2,2)}`,`${ye("deleteMany")} ${xe("DB Result")}:`,{model:k,data:S}),S},count:async({model:w,where:N})=>{Fe++;let v=Fe;const k=a(w),A=y({model:w,where:N});u({method:"count"},`${pe(v)} ${me(1,2)}`,`${ye("count")}:`,{model:k,where:A});const S=await h.count({model:k,where:A});return u({method:"count"},`${pe(v)} ${me(2,2)}`,`${ye("count")}:`,{model:k,data:S}),S},createSchema:h.createSchema?async(w,N)=>{const v=Ts(r);return r.secondaryStorage&&!r.session?.storeSessionInDatabase&&delete v.session,r.rateLimit&&r.rateLimit.storage==="database"&&(typeof r.rateLimit.enabled>"u"||r.rateLimit.enabled===!0)&&(v.ratelimit={modelName:r.rateLimit.modelName??"ratelimit",fields:{key:{type:"string",unique:!0,required:!0,fieldName:r.rateLimit.fields?.key??"key"},count:{type:"number",required:!0,fieldName:r.rateLimit.fields?.count??"count"},lastRequest:{type:"number",required:!0,bigint:!0,defaultValue:()=>Date.now(),fieldName:r.rateLimit.fields?.lastRequest??"lastRequest"}}}),h.createSchema({file:N,tables:v})}:void 0,options:{adapterConfig:n,...h.options??{}},id:n.adapterId,...n.debugLogs?.isRunningAdapterTests?{adapterTestDebugLogs:{resetDebugLogs(){So=[]},printDebugLogs(){const w="".repeat(80);let N=So.reverse().map(v=>(v[0]=`
${v[0]}`,[...v,`
`])).reduce((v,k)=>[...k,...v],[`
${w}`]);console.log(...N)}}}:{}};return b};function pe(e){return`${Vt.fg.magenta}#${e}${Vt.reset}`}function me(e,t){return`${Vt.bg.black}${Vt.fg.yellow}[${e}/${t}]${Vt.reset}`}function ye(e){return`${Vt.bright}${e}${Vt.reset}`}function xe(e){return`${Vt.dim}(${e})${Vt.reset}`}function Ha(e){if(!e)return null;if("dialect"in e)return Ha(e.dialect);if("createDriver"in e){if(e instanceof Fh)return"sqlite";if(e instanceof Hh)return"mysql";if(e instanceof Zh)return"postgres";if(e instanceof eS)return"mssql"}return"aggregate"in e?"sqlite":"getConnection"in e?"mysql":"connect"in e?"postgres":"fileControl"in e||"open"in e&&"close"in e&&"prepare"in e?"sqlite":null}const Yh=async e=>{const t=e.database;if(!t)return{kysely:null,databaseType:null,transaction:void 0};if("db"in t)return{kysely:t.db,databaseType:t.type,transaction:t.transaction};if("dialect"in t)return{kysely:new zt({dialect:t.dialect}),databaseType:t.type,transaction:t.transaction};let r;const n=Ha(t);if("createDriver"in t&&(r=t),"aggregate"in t&&!("createSession"in t)&&(r=new Fh({database:t})),"getConnection"in t&&(r=new Hh(t)),"connect"in t&&(r=new Zh({pool:t})),"fileControl"in t){const{BunSqliteDialect:s}=await Promise.resolve().then(()=>SR);r=new s({database:t})}if("createSession"in t&&typeof window>"u"){let s;try{({DatabaseSync:s}=await import("node:sqlite"))}catch(i){if(i!==null&&typeof i=="object"&&"code"in i&&i.code!=="ERR_UNKNOWN_BUILTIN_MODULE")throw i}if(s&&t instanceof s){const{NodeSqliteDialect:i}=await Promise.resolve().then(()=>xR);r=new i({database:t})}}return{kysely:r?new zt({dialect:r}):null,databaseType:n,transaction:void 0}};function nS(e){const t=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds());return new Date(t)}const sS=(e,t)=>{let r=null;const n=o=>({getFieldName:a,schema:c})=>{const u=async(p,m,y,g)=>{let b;if(t?.type==="mysql"){await m.execute();const w=p.id?"id":g.length>0&&g[0]?.field?g[0].field:"id";if(!p.id&&g.length===0)return b=await o.selectFrom(y).selectAll().orderBy(a({model:y,field:w}),"desc").limit(1).executeTakeFirst(),b;const N=p[w]||g[0]?.value;return b=await o.selectFrom(y).selectAll().orderBy(a({model:y,field:w}),"desc").where(a({model:y,field:w}),"=",N).limit(1).executeTakeFirst(),b}return t?.type==="mssql"?(b=await m.outputAll("inserted").executeTakeFirst(),b):(b=await m.returningAll().executeTakeFirst(),b)};function d(p,m,y){if(y==="id")return p;const{type:g="sqlite"}=t||{};let b=c[m]?.fields[y];return b||(b=Object.values(c).find(w=>w.modelName===m)),b.type==="boolean"&&(g==="sqlite"||g==="mssql")&&p!==null&&p!==void 0?p?1:0:b.type==="date"&&p&&p instanceof Date&&g==="sqlite"?p.toISOString():p}function l(p){function m(y){for(const g in y){if(!Object.prototype.hasOwnProperty.call(y,g))continue;const b=y[g];b instanceof Date&&t?.type==="mysql"?y[g]=nS(b):typeof b=="object"&&b!==null&&m(b)}}if(Array.isArray(p))for(let y=0;y<p.length;y++){const g=p[y];typeof g=="object"&&g!==null&&m(g)}else typeof p=="object"&&p!==null&&m(p);return p}function h(p,m){if(!m)return{and:null,or:null};const y={and:[],or:[]};return m.forEach(g=>{let{field:b,value:w,operator:N="=",connector:v="AND"}=g;const k=a({model:p,field:b});w=d(w,p,b);const A=S=>N.toLowerCase()==="in"?S(k,"in",Array.isArray(w)?w:[w]):N.toLowerCase()==="not_in"?S(k,"not in",Array.isArray(w)?w:[w]):N==="contains"?S(k,"like",`%${w}%`):N==="starts_with"?S(k,"like",`${w}%`):N==="ends_with"?S(k,"like",`%${w}`):N==="eq"?S(k,"=",w):N==="ne"?S(k,"<>",w):N==="gt"?S(k,">",w):N==="gte"?S(k,">=",w):N==="lt"?S(k,"<",w):N==="lte"?S(k,"<=",w):S(k,N,w);v==="OR"?y.or.push(A):y.and.push(A)}),{and:y.and.length?y.and:null,or:y.or.length?y.or:null}}return{async create({data:p,model:m}){const y=o.insertInto(m).values(p);return l(await u(p,y,m,[]))},async findOne({model:p,where:m,select:y}){const{and:g,or:b}=h(p,m);let w=o.selectFrom(p).selectAll();g&&(w=w.where(v=>v.and(g.map(k=>k(v))))),b&&(w=w.where(v=>v.or(b.map(k=>k(v)))));const N=await w.executeTakeFirst();return N?l(N):null},async findMany({model:p,where:m,limit:y,offset:g,sortBy:b}){const{and:w,or:N}=h(p,m);let v=o.selectFrom(p);w&&(v=v.where(A=>A.and(w.map(S=>S(A))))),N&&(v=v.where(A=>A.or(N.map(S=>S(A))))),t?.type==="mssql"?g||(v=v.top(y||100)):v=v.limit(y||100),b&&(v=v.orderBy(a({model:p,field:b.field}),b.direction)),g&&(t?.type==="mssql"?(b||(v=v.orderBy(a({model:p,field:"id"}))),v=v.offset(g).fetch(y||100)):v=v.offset(g));const k=await v.selectAll().execute();return k?l(k):[]},async update({model:p,where:m,update:y}){const{and:g,or:b}=h(p,m);let w=o.updateTable(p).set(y);return g&&(w=w.where(N=>N.and(g.map(v=>v(N))))),b&&(w=w.where(N=>N.or(b.map(v=>v(N))))),l(await u(y,w,p,m))},async updateMany({model:p,where:m,update:y}){const{and:g,or:b}=h(p,m);let w=o.updateTable(p).set(y);return g&&(w=w.where(v=>v.and(g.map(k=>k(v))))),b&&(w=w.where(v=>v.or(b.map(k=>k(v))))),(await w.execute()).length},async count({model:p,where:m}){const{and:y,or:g}=h(p,m);let b=o.selectFrom(p).select(o.fn.count("id").as("count"));return y&&(b=b.where(N=>N.and(y.map(v=>v(N))))),g&&(b=b.where(N=>N.or(g.map(v=>v(N))))),(await b.execute())[0].count},async delete({model:p,where:m}){const{and:y,or:g}=h(p,m);let b=o.deleteFrom(p);y&&(b=b.where(w=>w.and(y.map(N=>N(w))))),g&&(b=b.where(w=>w.or(g.map(N=>N(w))))),await b.execute()},async deleteMany({model:p,where:m}){const{and:y,or:g}=h(p,m);let b=o.deleteFrom(p);return y&&(b=b.where(w=>w.and(y.map(N=>N(w))))),g&&(b=b.where(w=>w.or(g.map(N=>N(w))))),(await b.execute()).length},options:t}};let s=null;s={config:{adapterId:"kysely",adapterName:"Kysely Adapter",usePlural:t?.usePlural,debugLogs:t?.debugLogs,supportsBooleans:!(t?.type==="sqlite"||t?.type==="mssql"||!t?.type),supportsDates:!(t?.type==="sqlite"||t?.type==="mssql"||!t?.type),supportsJSON:!1,transaction:t?.transaction??!1?o=>e.transaction().execute(a=>{const c=Is({config:s.config,adapter:n(a)})(r);return o(c)}):!1},adapter:n(e)};const i=Is(s);return o=>(r=o,i(o))},iS=(e,t)=>{let r=null,n=Is({config:{adapterId:"memory",adapterName:"Memory Adapter",usePlural:!1,debugLogs:!1,customTransformInput(s){return s.options.advanced?.database?.useNumberId&&s.field==="id"&&s.action==="create"?e[s.model].length+1:s.data},transaction:async s=>{let i=structuredClone(e);try{return s(n(r))}catch{throw Object.keys(e).forEach(o=>{e[o]=i[o]}),new Error("Transaction failed, rolling back changes")}}},adapter:({getFieldName:s,options:i,debugLog:o})=>{function a(c,u){const d=e[u];if(!d)throw K.error(`[MemoryAdapter] Model ${u} not found in the DB`,Object.keys(e)),new Error(`Model ${u} not found`);const l=(h,p)=>{const{field:m,value:y,operator:g}=p;switch(g){case"in":if(!Array.isArray(y))throw new Error("Value must be an array");return y.includes(h[m]);case"not_in":if(!Array.isArray(y))throw new Error("Value must be an array");return!y.includes(h[m]);case"contains":return h[m].includes(y);case"starts_with":return h[m].startsWith(y);case"ends_with":return h[m].endsWith(y);default:return h[m]===y}};return d.filter(h=>{if(!c.length||c.length===0)return!0;let p=l(h,c[0]);for(const m of c){const y=l(h,m);m.connector==="OR"?p=p||y:p=p&&y}return p})}return{create:async({model:c,data:u})=>(i.advanced?.database?.useNumberId&&(u.id=e[c].length+1),e[c]||(e[c]=[]),e[c].push(u),u),findOne:async({model:c,where:u})=>a(u,c)[0]||null,findMany:async({model:c,where:u,sortBy:d,limit:l,offset:h})=>{let p=e[c];return u&&(p=a(u,c)),d&&(p=p.sort((m,y)=>{const g=s({model:c,field:d.field});return d.direction==="asc"?m[g]>y[g]?1:-1:m[g]<y[g]?1:-1})),h!==void 0&&(p=p.slice(h)),l!==void 0&&(p=p.slice(0,l)),p||[]},count:async({model:c})=>e[c].length,update:async({model:c,where:u,update:d})=>{const l=a(u,c);return l.forEach(h=>{Object.assign(h,d)}),l[0]||null},delete:async({model:c,where:u})=>{const d=e[c],l=a(u,c);e[c]=d.filter(h=>!l.includes(h))},deleteMany:async({model:c,where:u})=>{const d=e[c],l=a(u,c);let h=0;return e[c]=d.filter(p=>l.includes(p)?(h++,!1):!l.includes(p)),h},updateMany({model:c,where:u,update:d}){const l=a(u,c);return l.forEach(h=>{Object.assign(h,d)}),l[0]||null}}}});return s=>(r=s,n(s))};function oS(e,t){const r=t.hooks;async function n(o,a,c,u,d){let l=o;for(const m of r||[]){const y=m[a]?.create?.before;if(y){const g=await y(l,u);if(g===!1)return null;typeof g=="object"&&"data"in g&&(l={...l,...g.data})}}const h=c?await c.fn(l):null,p=!c||c.executeMainFn?await(d||e).create({model:a,data:l,forceAllowId:!0}):h;for(const m of r||[]){const y=m[a]?.create?.after;y&&await y(p,u)}return p}async function s(o,a,c,u,d,l){let h=o;for(const y of r||[]){const g=y[c]?.update?.before;if(g){const b=await g(o,d);if(b===!1)return null;h=typeof b=="object"?b.data:b}}const p=u?await u.fn(h):null,m=!u||u.executeMainFn?await(l||e).update({model:c,update:h,where:a}):p;for(const y of r||[]){const g=y[c]?.update?.after;g&&await g(m,d)}return m}async function i(o,a,c,u,d,l){let h=o;for(const y of r||[]){const g=y[c]?.update?.before;if(g){const b=await g(o,d);if(b===!1)return null;h=typeof b=="object"?b.data:b}}const p=u?await u.fn(h):null,m=!u||u.executeMainFn?await(l||e).updateMany({model:c,update:h,where:a}):p;for(const y of r||[]){const g=y[c]?.update?.after;g&&await g(m,d)}return m}return{createWithHooks:n,updateWithHooks:s,updateManyWithHooks:i}}const Xh=(e,t)=>{const r=t.logger,n=t.options,s=n.secondaryStorage,i=n.session?.expiresIn||3600*24*7,{createWithHooks:o,updateWithHooks:a,updateManyWithHooks:c}=oS(e,t);async function u(d){if(!s)return;const l=await s.get(`active-sessions-${d.id}`);if(!l)return;const h=Date.now(),m=(He(l)||[]).filter(y=>y.expiresAt>h);await Promise.all(m.map(async({token:y})=>{const g=await s.get(y);if(!g)return;const b=He(g);if(!b)return;const w=Math.max(Math.floor((new Date(b.session.expiresAt).getTime()-h)/1e3),0);await s.set(y,JSON.stringify({session:b.session,user:d}),w)}))}return{createOAuthUser:async(d,l,h)=>e.transaction(async p=>{const m=await o({createdAt:new Date,updatedAt:new Date,...d},"user",void 0,h,p),y=await o({...l,userId:m.id,createdAt:new Date,updatedAt:new Date},"account",void 0,h,p);return{user:m,account:y}}),createUser:async(d,l,h)=>await o({createdAt:new Date,updatedAt:new Date,...d,email:d.email?.toLowerCase()},"user",void 0,l,h),createAccount:async(d,l,h)=>await o({createdAt:new Date,updatedAt:new Date,...d},"account",void 0,l,h),listSessions:async(d,l)=>{if(s){const p=await s.get(`active-sessions-${d}`);if(!p)return[];const m=He(p)||[],y=Date.now(),g=m.filter(w=>w.expiresAt>y),b=[];for(const w of g){const N=await s.get(w.token);if(N){const v=He(N);if(!v)return[];const k=vo(t.options,{...v.session,expiresAt:new Date(v.session.expiresAt)});b.push(k)}}return b}return await(l||e).findMany({model:"session",where:[{field:"userId",value:d}]})},listUsers:async(d,l,h,p,m)=>await(m||e).findMany({model:"user",limit:d,offset:l,sortBy:h,where:p}),countTotalUsers:async(d,l)=>{const h=await(l||e).count({model:"user",where:d});return typeof h=="string"?parseInt(h):h},deleteUser:async(d,l)=>{s&&await s.delete(`active-sessions-${d}`),(!s||n.session?.storeSessionInDatabase)&&await(l||e).deleteMany({model:"session",where:[{field:"userId",value:d}]}),await(l||e).deleteMany({model:"account",where:[{field:"userId",value:d}]}),await(l||e).delete({model:"user",where:[{field:"id",value:d}]})},createSession:async(d,l,h,p,m,y)=>{const g=l.headers||l.request?.headers,{id:b,...w}=p||{},N={ipAddress:(l.request||l.headers)&&sh(l.request||l.headers,l.context.options)||"",userAgent:g?.get("user-agent")||"",...w,expiresAt:yr(h?3600*24:i,"sec"),userId:d,token:Kr(32),createdAt:new Date,updatedAt:new Date,...m?w:{}};return await o(N,"session",s?{fn:async k=>{const A=await s.get(`active-sessions-${d}`);let S=[];const q=Date.now();return A&&(S=He(A)||[],S=S.filter(O=>O.expiresAt>q)),S.push({token:N.token,expiresAt:q+i*1e3}),await s.set(`active-sessions-${d}`,JSON.stringify(S),i),k},executeMainFn:n.session?.storeSessionInDatabase}:void 0,l,y)},findSession:async(d,l)=>{if(s){const g=await s.get(d);if(!g&&!n.session?.storeSessionInDatabase)return null;if(g){const b=He(g);if(!b)return null;const w=vo(t.options,{...b.session,expiresAt:new Date(b.session.expiresAt),createdAt:new Date(b.session.createdAt),updatedAt:new Date(b.session.updatedAt)}),N=cu(t.options,{...b.user,createdAt:new Date(b.user.createdAt),updatedAt:new Date(b.user.updatedAt)});return{session:w,user:N}}}const h=await(l||e).findOne({model:"session",where:[{value:d,field:"token"}]});if(!h)return null;const p=await(l||e).findOne({model:"user",where:[{value:h.userId,field:"id"}]});if(!p)return null;const m=vo(t.options,h),y=cu(t.options,p);return{session:m,user:y}},findSessions:async(d,l)=>{if(s){const y=[];for(const g of d){const b=await s.get(g);if(b){const w=He(b);if(!w)return[];const N={session:{...w.session,expiresAt:new Date(w.session.expiresAt)},user:{...w.user,createdAt:new Date(w.user.createdAt),updatedAt:new Date(w.user.updatedAt)}};y.push(N)}}return y}const h=await(l||e).findMany({model:"session",where:[{field:"token",value:d,operator:"in"}]}),p=h.map(y=>y.userId);if(!p.length)return[];const m=await(l||e).findMany({model:"user",where:[{field:"id",value:p,operator:"in"}]});return h.map(y=>{const g=m.find(b=>b.id===y.userId);return g?{session:y,user:g}:null})},updateSession:async(d,l,h,p)=>await a(l,[{field:"token",value:d}],"session",s?{async fn(y){const g=await s.get(d);let b=null;if(g){const w=He(g);return w?(b={...w.session,...y},b):null}else return null},executeMainFn:n.session?.storeSessionInDatabase}:void 0,h,p),deleteSession:async(d,l)=>{if(s){const h=await s.get(d);if(h){const{session:p}=He(h)??{};if(!p){r.error("Session not found in secondary storage");return}const m=p.userId,y=await s.get(`active-sessions-${m}`);if(y){let g=He(y)||[];g=g.filter(b=>b.token!==d),g.length>0?await s.set(`active-sessions-${m}`,JSON.stringify(g),i):await s.delete(`active-sessions-${m}`)}else r.error("Active sessions list not found in secondary storage")}if(await s.delete(d),!n.session?.storeSessionInDatabase||t.options.session?.preserveSessionInDatabase)return}await(l||e).delete({model:"session",where:[{field:"token",value:d}]})},deleteAccounts:async(d,l)=>{await(l||e).deleteMany({model:"account",where:[{field:"userId",value:d}]})},deleteAccount:async(d,l)=>{await(l||e).delete({model:"account",where:[{field:"id",value:d}]})},deleteSessions:async(d,l)=>{if(s){if(typeof d=="string"){const h=await s.get(`active-sessions-${d}`),p=h?He(h):[];if(!p)return;for(const m of p)await s.delete(m.token)}else for(const h of d)await s.get(h)&&await s.delete(h);if(!n.session?.storeSessionInDatabase||t.options.session?.preserveSessionInDatabase)return}await(l||e).deleteMany({model:"session",where:[{field:Array.isArray(d)?"token":"userId",value:d,operator:Array.isArray(d)?"in":void 0}]})},findOAuthUser:async(d,l,h,p)=>{const m=await(p||e).findMany({model:"account",where:[{value:l,field:"accountId"}]}).then(y=>y.find(g=>g.providerId===h));if(m){const y=await(p||e).findOne({model:"user",where:[{value:m.userId,field:"id"}]});if(y)return{user:y,accounts:[m]};{const g=await(p||e).findOne({model:"user",where:[{value:d.toLowerCase(),field:"email"}]});return g?{user:g,accounts:[m]}:null}}else{const y=await(p||e).findOne({model:"user",where:[{value:d.toLowerCase(),field:"email"}]});if(y){const g=await(p||e).findMany({model:"account",where:[{value:y.id,field:"userId"}]});return{user:y,accounts:g||[]}}else return null}},findUserByEmail:async(d,l,h)=>{const p=await(h||e).findOne({model:"user",where:[{value:d.toLowerCase(),field:"email"}]});if(!p)return null;if(l?.includeAccounts){const m=await(h||e).findMany({model:"account",where:[{value:p.id,field:"userId"}]});return{user:p,accounts:m}}return{user:p,accounts:[]}},findUserById:async(d,l)=>await(l||e).findOne({model:"user",where:[{field:"id",value:d}]}),linkAccount:async(d,l,h)=>await o({createdAt:new Date,updatedAt:new Date,...d},"account",void 0,l,h),updateUser:async(d,l,h,p)=>{const m=await a(l,[{field:"id",value:d}],"user",void 0,h,p);return await u(m),m},updateUserByEmail:async(d,l,h,p)=>{const m=await a(l,[{field:"email",value:d.toLowerCase()}],"user",void 0,h,p);return await u(m),m},updatePassword:async(d,l,h,p)=>{await c({password:l},[{field:"userId",value:d},{field:"providerId",value:"credential"}],"account",void 0,h,p)},findAccounts:async(d,l)=>await(l||e).findMany({model:"account",where:[{field:"userId",value:d}]}),findAccount:async(d,l)=>await(l||e).findOne({model:"account",where:[{field:"accountId",value:d}]}),findAccountByProviderId:async(d,l,h)=>await(h||e).findOne({model:"account",where:[{field:"accountId",value:d},{field:"providerId",value:l}]}),findAccountByUserId:async(d,l)=>await(l||e).findMany({model:"account",where:[{field:"userId",value:d}]}),updateAccount:async(d,l,h,p)=>await a(l,[{field:"id",value:d}],"account",void 0,h,p),createVerificationValue:async(d,l,h)=>await o({createdAt:new Date,updatedAt:new Date,...d},"verification",void 0,l,h),findVerificationValue:async(d,l)=>{const h=await(l||e).findMany({model:"verification",where:[{field:"identifier",value:d}],sortBy:{field:"createdAt",direction:"desc"},limit:1});return n.verification?.disableCleanup||await(l||e).deleteMany({model:"verification",where:[{field:"expiresAt",value:new Date,operator:"lt"}]}),h[0]},deleteVerificationValue:async(d,l)=>{await(l||e).delete({model:"verification",where:[{field:"id",value:d}]})},deleteVerificationByIdentifier:async(d,l)=>{await(l||e).delete({model:"verification",where:[{field:"identifier",value:d}]})},updateVerificationValue:async(d,l,h,p)=>await a(l,[{field:"id",value:d}],"verification",void 0,h,p)}};async function aS(e){if(!e.database){const s=Ts(e),i=Object.keys(s).reduce((o,a)=>(o[a]=[],o),{});return K.warn("No database configuration provided. Using memory adapter in development"),iS(i)(e)}if(typeof e.database=="function")return e.database(e);const{kysely:t,databaseType:r,transaction:n}=await Yh(e);if(!t)throw new X("Failed to initialize database adapter");return sS(t,{type:r||"sqlite",debugLogs:"debugLogs"in e.database?e.database.debugLogs:!1,transaction:n})(e)}function cS(e){const t=Ts(e);let r={};for(const n in t){const s=t[n],i=s.fields;let o={};if(Object.entries(i).forEach(([a,c])=>{if(o[c.fieldName||a]=c,c.references){const u=t[c.references.model];u&&(o[c.fieldName||a].references={model:u.modelName,field:c.references.field})}}),r[s.modelName]){r[s.modelName].fields={...r[s.modelName].fields,...o};continue}r[s.modelName]={fields:o,order:s.order||1/0}}return r}const uS={string:["character varying","varchar","text"],number:["int4","integer","bigint","smallint","numeric","real","double precision"],boolean:["bool","boolean"],date:["timestamptz","timestamp","date"],json:["json","jsonb"]},dS={string:["varchar","text"],number:["integer","int","bigint","smallint","decimal","float","double"],boolean:["boolean","tinyint"],date:["timestamp","datetime","date"],json:["json"]},lS={string:["TEXT"],number:["INTEGER","REAL"],boolean:["INTEGER","BOOLEAN"],date:["DATE","INTEGER"],json:["TEXT"]},hS={string:["varchar","nvarchar"],number:["int","bigint","smallint","decimal","float","double"],boolean:["bit","smallint"],date:["datetime","date"],json:["varchar","nvarchar"]},fS={postgres:uS,mysql:dS,sqlite:lS,mssql:hS};function pS(e,t,r){function n(o){return o.toLowerCase().split("(")[0].trim()}if(t==="string[]"||t==="number[]")return e.toLowerCase().includes("json");const s=fS[r];return(Array.isArray(t)?s.string.map(o=>o.toLowerCase()):s[t].map(o=>o.toLowerCase())).includes(n(e))}async function mS(e){const t=cS(e),r=Ea(e.logger);let{kysely:n,databaseType:s}=await Yh(e);s||(r.warn("Could not determine database type, defaulting to sqlite. Please provide a type in the database options to avoid this."),s="sqlite"),n||(r.error("Only kysely adapter is supported for migrations. You can use `generate` command to generate the schema, if you're using a different adapter."),process.exit(1));const i=await n.introspection.getTables(),o=[],a=[];for(const[h,p]of Object.entries(t)){const m=i.find(g=>g.name===h);if(!m){const g=o.findIndex(N=>N.table===h),b={table:h,fields:p.fields,order:p.order||1/0},w=o.findIndex(N=>(N.order||1/0)>b.order);w===-1?g===-1?o.push(b):o[g].fields={...o[g].fields,...p.fields}:o.splice(w,0,b);continue}let y={};for(const[g,b]of Object.entries(p.fields)){const w=m.columns.find(N=>N.name===g);if(!w){y[g]=b;continue}pS(w.dataType,b.type,s)||r.warn(`Field ${g} in table ${h} has a different type in the database. Expected ${b.type} but got ${w.dataType}.`)}Object.keys(y).length>0&&a.push({table:h,fields:y,order:p.order||1/0})}const c=[];function u(h,p){const m=h.type,y={string:{sqlite:"text",postgres:"text",mysql:h.unique?"varchar(255)":h.references?"varchar(36)":"text",mssql:h.unique||h.sortable?"varchar(255)":h.references?"varchar(36)":"varchar(8000)"},boolean:{sqlite:"integer",postgres:"boolean",mysql:"boolean",mssql:"smallint"},number:{sqlite:h.bigint?"bigint":"integer",postgres:h.bigint?"bigint":"integer",mysql:h.bigint?"bigint":"integer",mssql:h.bigint?"bigint":"integer"},date:{sqlite:"date",postgres:"timestamptz",mysql:"timestamp",mssql:"datetime"},json:{sqlite:"text",postgres:"jsonb",mysql:"json",mssql:"varchar(8000)"},id:{postgres:e.advanced?.database?.useNumberId?"serial":"text",mysql:e.advanced?.database?.useNumberId?"integer":"varchar(36)",mssql:e.advanced?.database?.useNumberId?"integer":"varchar(36)",sqlite:e.advanced?.database?.useNumberId?"integer":"text"}};return p==="id"||h.references?.field==="id"?y.id[s]:s==="sqlite"&&(m==="string[]"||m==="number[]")?"text":m==="string[]"||m==="number[]"?"jsonb":Array.isArray(m)?"text":y[m][s||"sqlite"]}if(a.length)for(const h of a)for(const[p,m]of Object.entries(h.fields)){const y=u(m,p),g=n.schema.alterTable(h.table).addColumn(p,y,b=>(b=m.required!==!1?b.notNull():b,m.references&&(b=b.references(`${m.references.model}.${m.references.field}`).onDelete(m.references.onDelete||"cascade")),m.unique&&(b=b.unique()),m.type==="date"&&typeof m.defaultValue=="function"&&(s==="postgres"||s==="mysql"||s==="mssql")&&(b=b.defaultTo(Ie`CURRENT_TIMESTAMP`)),b));c.push(g)}if(o.length)for(const h of o){let p=n.schema.createTable(h.table).addColumn("id",e.advanced?.database?.useNumberId?s==="postgres"?"serial":"integer":s==="mysql"||s==="mssql"?"varchar(36)":"text",m=>e.advanced?.database?.useNumberId?s==="postgres"||s==="sqlite"?m.primaryKey().notNull():m.autoIncrement().primaryKey().notNull():m.primaryKey().notNull());for(const[m,y]of Object.entries(h.fields)){const g=u(y,m);p=p.addColumn(m,g,b=>(b=y.required!==!1?b.notNull():b,y.references&&(b=b.references(`${y.references.model}.${y.references.field}`).onDelete(y.references.onDelete||"cascade")),y.unique&&(b=b.unique()),y.type==="date"&&typeof y.defaultValue=="function"&&(s==="postgres"||s==="mysql"||s==="mssql")&&(b=b.defaultTo(Ie`CURRENT_TIMESTAMP`)),b))}c.push(p)}async function d(){for(const h of c)await h.execute()}async function l(){return c.map(p=>p.compile().sql).join(`;

`)+";"}return{toBeCreated:o,toBeAdded:a,runMigrations:d,compileMigrations:l}}async function yS(e,t){const n=(await t.context.internalAdapter.findAccounts(e))?.find(o=>o.providerId==="credential"),s=n?.password;if(!n||!s||!t.body.password)throw new T("BAD_REQUEST",{message:"No password credential found"});if(!await t.context.password.verify({hash:s,password:t.body.password}))throw new T("BAD_REQUEST",{message:"Invalid password"});return!0}const $u="better-auth-secret-123456789";let dr;async function ef(){if(dr)return dr;try{const e=typeof process<"u"&&typeof process.cwd=="function"?process.cwd():"";if(!e)return;const t=i=>Function("mm","return import(mm)")(i),[{default:r},{default:n}]=await Promise.all([t("fs/promises"),t("path")]),s=await r.readFile(n.join(e,"package.json"),"utf-8");return dr=JSON.parse(s),dr}catch{}}async function tf(e){if(dr)return dr.dependencies?.[e]||dr.devDependencies?.[e]||dr.peerDependencies?.[e];try{const r=typeof process<"u"&&typeof process.cwd=="function"?process.cwd():"";if(!r)throw new Error("no-cwd");const n=d=>Function("mm","return import(mm)")(d),[{default:s},{default:i}]=await Promise.all([n("fs/promises"),n("path")]),o=i.join(r,"node_modules",e,"package.json"),a=await s.readFile(o,"utf-8");return JSON.parse(a).version||await Du(e)||void 0}catch{}return await Du(e)}async function Du(e){const t=await ef();return t?{...t.dependencies,...t.devDependencies,...t.peerDependencies}[e]:void 0}async function wS(){return(await ef())?.name}let Xt=null;async function qu(e){if(Xt)return Xt;const t=await wS();return t?(Xt=await ru(e?e+t:t),Xt):e?(Xt=await ru(e),Xt):(Xt=Kr(32),Xt)}const Dn=e=>Function("mm","return import(mm)")(e);function jr(){const e=(...t)=>t.some(r=>!!ie[r]);return e("CF_PAGES","CF_PAGES_URL","CF_ACCOUNT_ID")||typeof navigator<"u"&&navigator.userAgent==="Cloudflare-Workers"?"cloudflare":e("VERCEL","VERCEL_URL","VERCEL_ENV")?"vercel":e("NETLIFY","NETLIFY_URL")?"netlify":e("RENDER","RENDER_URL","RENDER_INTERNAL_HOSTNAME","RENDER_SERVICE_ID")?"render":e("AWS_LAMBDA_FUNCTION_NAME","AWS_EXECUTION_ENV","LAMBDA_TASK_ROOT")?"aws":e("GOOGLE_CLOUD_FUNCTION_NAME","GOOGLE_CLOUD_PROJECT","GCP_PROJECT","K_SERVICE")?"gcp":e("AZURE_FUNCTION_NAME","FUNCTIONS_WORKER_RUNTIME","WEBSITE_INSTANCE_ID","WEBSITE_SITE_NAME")?"azure":e("DENO_DEPLOYMENT_ID","DENO_REGION")?"deno-deploy":e("FLY_APP_NAME","FLY_REGION","FLY_ALLOC_ID")?"fly-io":e("RAILWAY_STATIC_URL","RAILWAY_ENVIRONMENT_NAME")?"railway":e("DYNO","HEROKU_APP_NAME")?"heroku":e("DO_DEPLOYMENT_ID","DO_APP_NAME","DIGITALOCEAN")?"digitalocean":e("KOYEB","KOYEB_DEPLOYMENT_ID","KOYEB_APP_NAME")?"koyeb":null}async function gS(){try{if(jr()==="cloudflare")return"cloudflare";const e=await Dn("os"),t=e.cpus();return{deploymentVendor:jr(),systemPlatform:e.platform(),systemRelease:e.release(),systemArchitecture:e.arch(),cpuCount:t.length,cpuModel:t.length?t[0].model:null,cpuSpeed:t.length?t[0].speed:null,memory:e.totalmem(),isWSL:await NS(),isDocker:await rf(),isTTY:typeof process<"u"&&process.stdout?process.stdout.isTTY:null}}catch{return{systemPlatform:null,systemRelease:null,systemArchitecture:null,cpuCount:null,cpuModel:null,cpuSpeed:null,memory:null,isWSL:null,isDocker:null,isTTY:null}}}let Ro;async function bS(){if(jr()==="cloudflare")return!1;try{return(await Dn("fs")).statSync("/.dockerenv"),!0}catch{return!1}}async function vS(){if(jr()==="cloudflare")return!1;try{return(await Dn("fs")).readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}async function rf(){return jr()==="cloudflare"?!1:(Ro===void 0&&(Ro=await bS()||await vS()),Ro)}async function NS(){try{if(jr()==="cloudflare"||typeof process>"u"||process.platform!=="linux")return!1;const e=await Dn("fs");return(await Dn("os")).release().toLowerCase().includes("microsoft")?!await Wu():e.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")?!await Wu():!1}catch{return!1}}let Oo;const ES=async()=>{if(jr()==="cloudflare")return!1;try{return(await Dn("fs")).statSync("/run/.containerenv"),!0}catch{return!1}};async function Wu(){return Oo===void 0&&(Oo=await ES()||await rf()),Oo}function AS(){return ie.CI!=="false"&&("BUILD_ID"in ie||"BUILD_NUMBER"in ie||"CI"in ie||"CI_APP_ID"in ie||"CI_BUILD_ID"in ie||"CI_BUILD_NUMBER"in ie||"CI_NAME"in ie||"CONTINUOUS_INTEGRATION"in ie||"RUN_ID"in ie)}function kS(){return typeof Deno<"u"?{name:"deno",version:Deno?.version?.deno??null}:typeof Bun<"u"?{name:"bun",version:Bun?.version??null}:typeof process<"u"&&process?.versions?.node?{name:"node",version:process.versions.node??null}:{name:"edge",version:null}}function TS(){return Ee("NODE_ENV")==="production"?"production":AS()?"ci":Na()?"test":"development"}const _S={pg:"postgresql",mysql:"mysql",mariadb:"mariadb",sqlite3:"sqlite","better-sqlite3":"sqlite","@prisma/client":"prisma",mongoose:"mongodb",mongodb:"mongodb","drizzle-orm":"drizzle"};async function SS(){for(const[e,t]of Object.entries(_S)){const r=await tf(e);if(r)return{name:t,version:r}}}const RS={next:"next",nuxt:"nuxt","@remix-run/server-runtime":"remix",astro:"astro","@sveltejs/kit":"sveltekit","solid-start":"solid-start","tanstack-start":"tanstack-start",hono:"hono",express:"express",elysia:"elysia",expo:"expo"};async function OS(){for(const[e,t]of Object.entries(RS)){const r=await tf(e);if(r)return{name:t,version:r}}}function IS(){const e=ie.npm_config_user_agent;if(!e)return;const t=e.split(" ")[0],r=t.lastIndexOf("/"),n=t.substring(0,r);return{name:n==="npminstall"?"cnpm":n,version:t.substring(r+1)}}function xS(e,t){return{database:t?.database,adapter:t?.adapter,emailVerification:{sendVerificationEmail:!!e.emailVerification?.sendVerificationEmail,sendOnSignUp:!!e.emailVerification?.sendOnSignUp,sendOnSignIn:!!e.emailVerification?.sendOnSignIn,autoSignInAfterVerification:!!e.emailVerification?.autoSignInAfterVerification,expiresIn:e.emailVerification?.expiresIn,onEmailVerification:!!e.emailVerification?.onEmailVerification,afterEmailVerification:!!e.emailVerification?.afterEmailVerification},emailAndPassword:{enabled:!!e.emailAndPassword?.enabled,disableSignUp:!!e.emailAndPassword?.disableSignUp,requireEmailVerification:!!e.emailAndPassword?.requireEmailVerification,maxPasswordLength:e.emailAndPassword?.maxPasswordLength,minPasswordLength:e.emailAndPassword?.minPasswordLength,sendResetPassword:!!e.emailAndPassword?.sendResetPassword,resetPasswordTokenExpiresIn:e.emailAndPassword?.resetPasswordTokenExpiresIn,onPasswordReset:!!e.emailAndPassword?.onPasswordReset,password:{hash:!!e.emailAndPassword?.password?.hash,verify:!!e.emailAndPassword?.password?.verify},autoSignIn:!!e.emailAndPassword?.autoSignIn,revokeSessionsOnPasswordReset:!!e.emailAndPassword?.revokeSessionsOnPasswordReset},socialProviders:Object.keys(e.socialProviders||{}).map(r=>{const n=e.socialProviders?.[r];return n?{id:r,mapProfileToUser:!!n.mapProfileToUser,disableDefaultScope:!!n.disableDefaultScope,disableIdTokenSignIn:!!n.disableIdTokenSignIn,disableImplicitSignUp:n.disableImplicitSignUp,disableSignUp:n.disableSignUp,getUserInfo:!!n.getUserInfo,overrideUserInfoOnSignIn:!!n.overrideUserInfoOnSignIn,prompt:n.prompt,verifyIdToken:!!n.verifyIdToken,scope:n.scope,refreshAccessToken:!!n.refreshAccessToken}:{}}),plugins:e.plugins?.map(r=>r.id.toString()),user:{modelName:e.user?.modelName,fields:e.user?.fields,additionalFields:e.user?.additionalFields,changeEmail:{enabled:e.user?.changeEmail?.enabled,sendChangeEmailVerification:!!e.user?.changeEmail?.sendChangeEmailVerification}},verification:{modelName:e.verification?.modelName,disableCleanup:e.verification?.disableCleanup,fields:e.verification?.fields},session:{modelName:e.session?.modelName,additionalFields:e.session?.additionalFields,cookieCache:{enabled:e.session?.cookieCache?.enabled,maxAge:e.session?.cookieCache?.maxAge},disableSessionRefresh:e.session?.disableSessionRefresh,expiresIn:e.session?.expiresIn,fields:e.session?.fields,freshAge:e.session?.freshAge,preserveSessionInDatabase:e.session?.preserveSessionInDatabase,storeSessionInDatabase:e.session?.storeSessionInDatabase,updateAge:e.session?.updateAge},account:{modelName:e.account?.modelName,fields:e.account?.fields,encryptOAuthTokens:e.account?.encryptOAuthTokens,updateAccountOnSignIn:e.account?.updateAccountOnSignIn,accountLinking:{enabled:e.account?.accountLinking?.enabled,trustedProviders:e.account?.accountLinking?.trustedProviders,updateUserInfoOnLink:e.account?.accountLinking?.updateUserInfoOnLink,allowUnlinkingAll:e.account?.accountLinking?.allowUnlinkingAll}},hooks:{after:!!e.hooks?.after,before:!!e.hooks?.before},secondaryStorage:!!e.secondaryStorage,advanced:{cookiePrefix:!!e.advanced?.cookiePrefix,cookies:!!e.advanced?.cookies,crossSubDomainCookies:{domain:!!e.advanced?.crossSubDomainCookies?.domain,enabled:e.advanced?.crossSubDomainCookies?.enabled,additionalCookies:e.advanced?.crossSubDomainCookies?.additionalCookies},database:{useNumberId:!!e.advanced?.database?.useNumberId,generateId:e.advanced?.database?.generateId,defaultFindManyLimit:e.advanced?.database?.defaultFindManyLimit},useSecureCookies:e.advanced?.useSecureCookies,ipAddress:{disableIpTracking:e.advanced?.ipAddress?.disableIpTracking,ipAddressHeaders:e.advanced?.ipAddress?.ipAddressHeaders},disableCSRFCheck:e.advanced?.disableCSRFCheck,cookieAttributes:{expires:e.advanced?.defaultCookieAttributes?.expires,secure:e.advanced?.defaultCookieAttributes?.secure,sameSite:e.advanced?.defaultCookieAttributes?.sameSite,domain:!!e.advanced?.defaultCookieAttributes?.domain,path:e.advanced?.defaultCookieAttributes?.path,httpOnly:e.advanced?.defaultCookieAttributes?.httpOnly}},trustedOrigins:e.trustedOrigins?.length,rateLimit:{storage:e.rateLimit?.storage,modelName:e.rateLimit?.modelName,window:e.rateLimit?.window,customStorage:!!e.rateLimit?.customStorage,enabled:e.rateLimit?.enabled,max:e.rateLimit?.max},onAPIError:{errorURL:e.onAPIError?.errorURL,onError:!!e.onAPIError?.onError,throw:e.onAPIError?.throw},logger:{disabled:e.logger?.disabled,level:e.logger?.level,log:!!e.logger?.log},databaseHooks:{user:{create:{after:!!e.databaseHooks?.user?.create?.after,before:!!e.databaseHooks?.user?.create?.before},update:{after:!!e.databaseHooks?.user?.update?.after,before:!!e.databaseHooks?.user?.update?.before}},session:{create:{after:!!e.databaseHooks?.session?.create?.after,before:!!e.databaseHooks?.session?.create?.before},update:{after:!!e.databaseHooks?.session?.update?.after,before:!!e.databaseHooks?.session?.update?.before}},account:{create:{after:!!e.databaseHooks?.account?.create?.after,before:!!e.databaseHooks?.account?.create?.before},update:{after:!!e.databaseHooks?.account?.update?.after,before:!!e.databaseHooks?.account?.update?.before}},verification:{create:{after:!!e.databaseHooks?.verification?.create?.after,before:!!e.databaseHooks?.verification?.create?.before},update:{after:!!e.databaseHooks?.verification?.update?.after,before:!!e.databaseHooks?.verification?.update?.before}}}}}async function CS(e,t){const r=e.telemetry?.debug||qc("BETTER_AUTH_TELEMETRY_DEBUG",!1),n=Sv.BETTER_AUTH_TELEMETRY_ENDPOINT,s=async c=>{try{t?.customTrack?await t.customTrack(c):r?await Promise.resolve(K.info("telemetry event",JSON.stringify(c,null,2))):await Z(n,{method:"POST",body:c})}catch{}},o=await(async()=>{const c=e.telemetry?.enabled!==void 0?e.telemetry.enabled:!1;return(qc("BETTER_AUTH_TELEMETRY",!1)||c)&&(t?.skipTestCheck||!Na())})();let a;if(o){a=await qu(e.baseURL);const c={config:xS(e),runtime:kS(),database:await SS(),framework:await OS(),environment:TS(),systemInfo:await gS(),packageManager:IS()};s({type:"init",payload:c,anonymousId:a})}return{publish:async c=>{o&&(a||(a=await qu(e.baseURL)),await s({type:c.type,payload:c.payload,anonymousId:a}))}}}function nf(e){return!!e&&(typeof e=="object"||typeof e=="function")&&typeof e.then=="function"}const PS=async e=>{const t=await aS(e),r=e.plugins||[],n=LS(e),s=Ea(e.logger),i=Aa(e.baseURL,e.basePath),o=e.secret||ie.BETTER_AUTH_SECRET||ie.AUTH_SECRET||$u;o===$u&&Mo&&s.error("You are using the default secret. Please set `BETTER_AUTH_SECRET` in your environment variables or pass `secret` in your auth config."),e={...e,secret:o,baseURL:i?new URL(i).origin:"",basePath:e.basePath||"/api/auth",plugins:r.concat(n)},$k(e,s);const a=Mv(e),c=Ts(e),u=Object.entries(e.socialProviders||{}).map(([y,g])=>{if(g==null||g.enabled===!1)return null;g.clientId||s.warn(`Social provider ${y} is missing clientId or clientSecret`);const b=Yl[y](g);return b.disableImplicitSignUp=g.disableImplicitSignUp,b}).filter(y=>y!==null),d=({model:y,size:g})=>typeof e.advanced?.generateId=="function"?e.advanced.generateId({model:y,size:g}):typeof e?.advanced?.database?.generateId=="function"?e.advanced.database.generateId({model:y,size:g}):Kr(g),{publish:l}=await CS(e,{adapter:t.id,database:typeof e.database=="function"?"adapter":Ha(e.database)||"unknown"});let h={appName:e.appName||"Better Auth",socialProviders:u,options:e,tables:c,trustedOrigins:$S(e),baseURL:i||"",sessionConfig:{updateAge:e.session?.updateAge!==void 0?e.session.updateAge:1440*60,expiresIn:e.session?.expiresIn||3600*24*7,freshAge:e.session?.freshAge===void 0?3600*24:e.session.freshAge},secret:o,rateLimit:{...e.rateLimit,enabled:e.rateLimit?.enabled??Mo,window:e.rateLimit?.window||10,max:e.rateLimit?.max||100,storage:e.rateLimit?.storage||(e.secondaryStorage?"secondary-storage":"memory")},authCookies:a,logger:s,generateId:d,session:null,secondaryStorage:e.secondaryStorage,password:{hash:e.emailAndPassword?.password?.hash||DE,verify:e.emailAndPassword?.password?.verify||qE,config:{minPasswordLength:e.emailAndPassword?.minPasswordLength||8,maxPasswordLength:e.emailAndPassword?.maxPasswordLength||128},checkPassword:yS},setNewSession(y){this.newSession=y},newSession:null,adapter:t,internalAdapter:Xh(t,{options:e,logger:s,hooks:e.databaseHooks?[e.databaseHooks]:[]}),createAuthCookie:ol(e),async runMigrations(){if(!e.database||"updateMany"in e.database)throw new X("Database is not provided or it's an adapter. Migrations are only supported with a database instance.");const{runMigrations:y}=await mS(e);await y()},publishTelemetry:l};const p=US(h);let m;return nf(p)?{context:m}=await p:{context:m}=p,m};async function US(e){let t=e.options;const r=t.plugins||[];let n=e;const s=[];for(const i of r)if(i.init){let o=i.init(n),a;if(nf(o)?a=await o:a=o,typeof a=="object"){if(a.options){const{databaseHooks:c,...u}=a.options;c&&s.push(c),t=dA(t,u)}a.context&&(n={...n,...a.context})}}return s.push(t.databaseHooks),n.internalAdapter=Xh(e.adapter,{options:t,logger:e.logger,hooks:s.filter(i=>i!==void 0),generateId:e.generateId}),n.options=t,{context:n}}function LS(e){const t=[];return e.advanced?.crossSubDomainCookies?.enabled,t}function $S(e){const t=Aa(e.baseURL,e.basePath);if(!t)return[];const r=[new URL(t).origin];e.trustedOrigins&&Array.isArray(e.trustedOrigins)&&r.push(...e.trustedOrigins);const n=ie.BETTER_AUTH_TRUSTED_ORIGINS;if(n&&r.push(...n.split(",")),r.filter(s=>!s).length)throw new X("A provided trusted origin is invalid, make sure your trusted origins list is properly defined.");return r}const DS=e=>{const t=PS(e),{api:r}=ih(t,e),n=e.plugins?.reduce((s,i)=>i.$ERROR_CODES?{...s,...i.$ERROR_CODES}:s,{});return{handler:async s=>{const i=await t,o=i.options.basePath||"/api/auth";if(!i.options.baseURL){const c=Aa(void 0,o,s);if(c)i.baseURL=c,i.options.baseURL=On(i.baseURL)||void 0;else throw new X("Could not get base URL from request. Please provide a valid base URL.")}i.trustedOrigins=[...e.trustedOrigins?Array.isArray(e.trustedOrigins)?e.trustedOrigins:await e.trustedOrigins(s):[],i.options.baseURL];const{handler:a}=Dk(i,e);return a(s)},api:r,options:e,$context:t,$Infer:{},$ERROR_CODES:{...n,...V}}},qS=(e,t)=>{let r=null;const n=o=>({getFieldName:a})=>{const c=o,u=(h,p)=>{if(!(!h||!p))return h.reduce((m,y)=>({...m,[a({model:p,field:y})]:!0}),{})};function d(h){switch(h){case"starts_with":return"startsWith";case"ends_with":return"endsWith";case"ne":return"not";case"not_in":return"notIn";default:return h}}const l=(h,p)=>{if(!p)return{};if(p.length===1){const w=p[0];return w?{[a({model:h,field:w.field})]:w.operator==="eq"||!w.operator?w.value:{[d(w.operator)]:w.value}}:void 0}const m=p.filter(w=>w.connector==="AND"||!w.connector),y=p.filter(w=>w.connector==="OR"),g=m.map(w=>({[a({model:h,field:w.field})]:w.operator==="eq"||!w.operator?w.value:{[d(w.operator)]:w.value}})),b=y.map(w=>({[a({model:h,field:w.field})]:w.operator==="eq"||!w.operator?w.value:{[d(w.operator)]:w.value}}));return{...g.length?{AND:g}:{},...b.length?{OR:b}:{}}};return{async create({model:h,data:p,select:m}){if(!c[h])throw new X(`Model ${h} does not exist in the database. If you haven't generated the Prisma client, you need to run 'npx prisma generate'`);return await c[h].create({data:p,select:u(m,h)})},async findOne({model:h,where:p,select:m}){const y=l(h,p);if(!c[h])throw new X(`Model ${h} does not exist in the database. If you haven't generated the Prisma client, you need to run 'npx prisma generate'`);return await c[h].findFirst({where:y,select:u(m,h)})},async findMany({model:h,where:p,limit:m,offset:y,sortBy:g}){const b=l(h,p);if(!c[h])throw new X(`Model ${h} does not exist in the database. If you haven't generated the Prisma client, you need to run 'npx prisma generate'`);return await c[h].findMany({where:b,take:m||100,skip:y||0,...g?.field?{orderBy:{[a({model:h,field:g.field})]:g.direction==="desc"?"desc":"asc"}}:{}})},async count({model:h,where:p}){const m=l(h,p);if(!c[h])throw new X(`Model ${h} does not exist in the database. If you haven't generated the Prisma client, you need to run 'npx prisma generate'`);return await c[h].count({where:m})},async update({model:h,where:p,update:m}){if(!c[h])throw new X(`Model ${h} does not exist in the database. If you haven't generated the Prisma client, you need to run 'npx prisma generate'`);const y=l(h,p);return await c[h].update({where:y,data:m})},async updateMany({model:h,where:p,update:m}){const y=l(h,p),g=await c[h].updateMany({where:y,data:m});return g?g.count:0},async delete({model:h,where:p}){const m=l(h,p);try{await c[h].delete({where:m})}catch{}},async deleteMany({model:h,where:p}){const m=l(h,p),y=await c[h].deleteMany({where:m});return y?y.count:0},options:t}};let s=null;s={config:{adapterId:"prisma",adapterName:"Prisma Adapter",usePlural:t.usePlural??!1,debugLogs:t.debugLogs??!1,transaction:t.transaction??!1?o=>e.$transaction(a=>{const c=Is({config:s.config,adapter:n(a)})(r);return o(c)}):!1},adapter:n(e)};const i=Is(s);return o=>(r=o,i(o))},WS=()=>new xf,Kn=globalThis.prismaGlobal??WS();var Qs={};const ho=DS({secret:String(Qs.BETTER_AUTH_SECRET),baseURL:Qs.BETTER_AUTH_URL,database:qS(Kn,{provider:"postgresql"}),socialProviders:{google:{prompt:"select_account",clientId:String(Qs.GOOGLE_CLIENT_ID),clientSecret:String(Qs.GOOGLE_CLIENT_SECRET),redirectUrl:"myapp://callback"}},user:{additionalFields:{role:{type:"string",required:!0,defaultValue:"Pacient",input:!1}}},emailAndPassword:{enabled:!0}});var zu=(e,t,r)=>(n,s)=>{let i=-1;return o(0);async function o(a){if(a<=i)throw new Error("next() called multiple times");i=a;let c,u=!1,d;if(e[a]?(d=e[a][0][0],n.req.routeIndex=a):d=a===e.length&&s||void 0,d)try{c=await d(n,()=>o(a+1))}catch(l){if(l instanceof Error&&t)n.error=l,c=await t(l,n),u=!0;else throw l}else n.finalized===!1&&r&&(c=await r(n));return c&&(n.finalized===!1||u)&&(n.res=c),n}},zS=Symbol(),MS=async(e,t=Object.create(null))=>{const{all:r=!1,dot:n=!1}=t,i=(e instanceof df?e.raw.headers:e.headers).get("Content-Type");return i?.startsWith("multipart/form-data")||i?.startsWith("application/x-www-form-urlencoded")?jS(e,{all:r,dot:n}):{}};async function jS(e,t){const r=await e.formData();return r?VS(r,t):{}}function VS(e,t){const r=Object.create(null);return e.forEach((n,s)=>{t.all||s.endsWith("[]")?FS(r,s,n):r[s]=n}),t.dot&&Object.entries(r).forEach(([n,s])=>{n.includes(".")&&(BS(r,n,s),delete r[n])}),r}var FS=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},BS=(e,t,r)=>{let n=e;const s=t.split(".");s.forEach((i,o)=>{o===s.length-1?n[i]=r:((!n[i]||typeof n[i]!="object"||Array.isArray(n[i])||n[i]instanceof File)&&(n[i]=Object.create(null)),n=n[i])})},sf=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},HS=e=>{const{groups:t,path:r}=KS(e),n=sf(r);return ZS(n,t)},KS=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,n)=>{const s=`@${n}`;return t.push([s,r]),s}),{groups:t,path:e}},ZS=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[n]=t[r];for(let s=e.length-1;s>=0;s--)if(e[s].includes(n)){e[s]=e[s].replace(n,t[r][1]);break}}return e},Ys={},JS=(e,t)=>{if(e==="*")return"*";const r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){const n=`${e}#${t}`;return Ys[n]||(r[2]?Ys[n]=t&&t[0]!==":"&&t[0]!=="*"?[n,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:Ys[n]=[e,r[1],!0]),Ys[n]}return null},Ka=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},GS=e=>Ka(e,decodeURI),of=e=>{const t=e.url,r=t.indexOf("/",t.indexOf(":")+4);let n=r;for(;n<t.length;n++){const s=t.charCodeAt(n);if(s===37){const i=t.indexOf("?",n),o=t.slice(r,i===-1?void 0:i);return GS(o.includes("%25")?o.replace(/%25/g,"%2525"):o)}else if(s===63)break}return t.slice(r,n)},QS=e=>{const t=of(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},ln=(e,t,...r)=>(r.length&&(t=ln(t,...r)),`${e?.[0]==="/"?"":"/"}${e}${t==="/"?"":`${e?.at(-1)==="/"?"":"/"}${t?.[0]==="/"?t.slice(1):t}`}`),af=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),r=[];let n="";return t.forEach(s=>{if(s!==""&&!/\:/.test(s))n+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){r.length===0&&n===""?r.push("/"):r.push(n);const i=s.replace("?","");n+="/"+i,r.push(n)}else n+="/"+s}),r.filter((s,i,o)=>o.indexOf(s)===i)},Io=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?Ka(e,uf):e):e,cf=(e,t,r)=>{let n;if(!r&&t&&!/[%+]/.test(t)){let o=e.indexOf(`?${t}`,8);for(o===-1&&(o=e.indexOf(`&${t}`,8));o!==-1;){const a=e.charCodeAt(o+t.length+1);if(a===61){const c=o+t.length+2,u=e.indexOf("&",c);return Io(e.slice(c,u===-1?void 0:u))}else if(a==38||isNaN(a))return"";o=e.indexOf(`&${t}`,o+1)}if(n=/[%+]/.test(e),!n)return}const s={};n??=/[%+]/.test(e);let i=e.indexOf("?",8);for(;i!==-1;){const o=e.indexOf("&",i+1);let a=e.indexOf("=",i);a>o&&o!==-1&&(a=-1);let c=e.slice(i+1,a===-1?o===-1?void 0:o:a);if(n&&(c=Io(c)),i=o,c==="")continue;let u;a===-1?u="":(u=e.slice(a+1,o===-1?void 0:o),n&&(u=Io(u))),r?(s[c]&&Array.isArray(s[c])||(s[c]=[]),s[c].push(u)):s[c]??=u}return t?s[t]:s},YS=cf,XS=(e,t)=>cf(e,t,!0),uf=decodeURIComponent,Mu=e=>Ka(e,uf),df=class{raw;#e;#t;routeIndex=0;path;bodyCache={};constructor(e,t="/",r=[[]]){this.raw=e,this.path=t,this.#t=r,this.#e={}}param(e){return e?this.#r(e):this.#n()}#r(e){const t=this.#t[0][this.routeIndex][1][e],r=this.#s(t);return r&&/\%/.test(r)?Mu(r):r}#n(){const e={},t=Object.keys(this.#t[0][this.routeIndex][1]);for(const r of t){const n=this.#s(this.#t[0][this.routeIndex][1][r]);n!==void 0&&(e[r]=/\%/.test(n)?Mu(n):n)}return e}#s(e){return this.#t[1]?this.#t[1][e]:e}query(e){return YS(this.url,e)}queries(e){return XS(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((r,n)=>{t[n]=r}),t}async parseBody(e){return this.bodyCache.parsedBody??=await MS(this,e)}#i=e=>{const{bodyCache:t,raw:r}=this,n=t[e];if(n)return n;const s=Object.keys(t)[0];return s?t[s].then(i=>(s==="json"&&(i=JSON.stringify(i)),new Response(i)[e]())):t[e]=r[e]()};json(){return this.#i("text").then(e=>JSON.parse(e))}text(){return this.#i("text")}arrayBuffer(){return this.#i("arrayBuffer")}blob(){return this.#i("blob")}formData(){return this.#i("formData")}addValidatedData(e,t){this.#e[e]=t}valid(e){return this.#e[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[zS](){return this.#t}get matchedRoutes(){return this.#t[0].map(([[,e]])=>e)}get routePath(){return this.#t[0].map(([[,e]])=>e)[this.routeIndex].path}},eR={Stringify:1},lf=async(e,t,r,n,s)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const i=e.callbacks;return i?.length?(s?s[0]+=e:s=[e],Promise.all(i.map(a=>a({phase:t,buffer:s,context:n}))).then(a=>Promise.all(a.filter(Boolean).map(c=>lf(c,t,!1,n,s))).then(()=>s[0]))):Promise.resolve(e)},tR="text/plain; charset=UTF-8",xo=(e,t)=>({"Content-Type":e,...t}),rR=class{#e;#t;env={};#r;finalized=!1;error;#n;#s;#i;#c;#a;#o;#u;#d;#h;constructor(e,t){this.#e=e,t&&(this.#s=t.executionCtx,this.env=t.env,this.#o=t.notFoundHandler,this.#h=t.path,this.#d=t.matchResult)}get req(){return this.#t??=new df(this.#e,this.#h,this.#d),this.#t}get event(){if(this.#s&&"respondWith"in this.#s)return this.#s;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#s)return this.#s;throw Error("This context has no ExecutionContext")}get res(){return this.#i||=new Response(null,{headers:this.#u??=new Headers})}set res(e){if(this.#i&&e){e=new Response(e.body,e);for(const[t,r]of this.#i.headers.entries())if(t!=="content-type")if(t==="set-cookie"){const n=this.#i.headers.getSetCookie();e.headers.delete("set-cookie");for(const s of n)e.headers.append("set-cookie",s)}else e.headers.set(t,r)}this.#i=e,this.finalized=!0}render=(...e)=>(this.#a??=t=>this.html(t),this.#a(...e));setLayout=e=>this.#c=e;getLayout=()=>this.#c;setRenderer=e=>{this.#a=e};header=(e,t,r)=>{this.finalized&&(this.#i=new Response(this.#i.body,this.#i));const n=this.#i?this.#i.headers:this.#u??=new Headers;t===void 0?n.delete(e):r?.append?n.append(e,t):n.set(e,t)};status=e=>{this.#n=e};set=(e,t)=>{this.#r??=new Map,this.#r.set(e,t)};get=e=>this.#r?this.#r.get(e):void 0;get var(){return this.#r?Object.fromEntries(this.#r):{}}#l(e,t,r){const n=this.#i?new Headers(this.#i.headers):this.#u??new Headers;if(typeof t=="object"&&"headers"in t){const i=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[o,a]of i)o.toLowerCase()==="set-cookie"?n.append(o,a):n.set(o,a)}if(r)for(const[i,o]of Object.entries(r))if(typeof o=="string")n.set(i,o);else{n.delete(i);for(const a of o)n.append(i,a)}const s=typeof t=="number"?t:t?.status??this.#n;return new Response(e,{status:s,headers:n})}newResponse=(...e)=>this.#l(...e);body=(e,t,r)=>this.#l(e,t,r);text=(e,t,r)=>!this.#u&&!this.#n&&!t&&!r&&!this.finalized?new Response(e):this.#l(e,t,xo(tR,r));json=(e,t,r)=>this.#l(JSON.stringify(e),t,xo("application/json",r));html=(e,t,r)=>{const n=s=>this.#l(s,t,xo("text/html; charset=UTF-8",r));return typeof e=="object"?lf(e,eR.Stringify,!1,{}).then(n):n(e)};redirect=(e,t)=>{const r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)};notFound=()=>(this.#o??=()=>new Response,this.#o(this))},Ce="ALL",nR="all",sR=["get","post","put","delete","options","patch"],hf="Can not add a route since the matcher is already built.",ff=class extends Error{},iR="__COMPOSED_HANDLER",oR=e=>e.text("404 Not Found",404),ju=(e,t)=>{if("getResponse"in e){const r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},pf=class{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#e="/";routes=[];constructor(t={}){[...sR,nR].forEach(i=>{this[i]=(o,...a)=>(typeof o=="string"?this.#e=o:this.#n(i,this.#e,o),a.forEach(c=>{this.#n(i,this.#e,c)}),this)}),this.on=(i,o,...a)=>{for(const c of[o].flat()){this.#e=c;for(const u of[i].flat())a.map(d=>{this.#n(u.toUpperCase(),this.#e,d)})}return this},this.use=(i,...o)=>(typeof i=="string"?this.#e=i:(this.#e="*",o.unshift(i)),o.forEach(a=>{this.#n(Ce,this.#e,a)}),this);const{strict:n,...s}=t;Object.assign(this,s),this.getPath=n??!0?t.getPath??of:QS}#t(){const t=new pf({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,t.#r=this.#r,t.routes=this.routes,t}#r=oR;errorHandler=ju;route(t,r){const n=this.basePath(t);return r.routes.map(s=>{let i;r.errorHandler===ju?i=s.handler:(i=async(o,a)=>(await zu([],r.errorHandler)(o,()=>s.handler(o,a))).res,i[iR]=s.handler),n.#n(s.method,s.path,i)}),this}basePath(t){const r=this.#t();return r._basePath=ln(this._basePath,t),r}onError=t=>(this.errorHandler=t,this);notFound=t=>(this.#r=t,this);mount(t,r,n){let s,i;n&&(typeof n=="function"?i=n:(i=n.optionHandler,n.replaceRequest===!1?s=c=>c:s=n.replaceRequest));const o=i?c=>{const u=i(c);return Array.isArray(u)?u:[u]}:c=>{let u;try{u=c.executionCtx}catch{}return[c.env,u]};s||=(()=>{const c=ln(this._basePath,t),u=c==="/"?0:c.length;return d=>{const l=new URL(d.url);return l.pathname=l.pathname.slice(u)||"/",new Request(l,d)}})();const a=async(c,u)=>{const d=await r(s(c.req.raw),...o(c));if(d)return d;await u()};return this.#n(Ce,ln(t,"*"),a),this}#n(t,r,n){t=t.toUpperCase(),r=ln(this._basePath,r);const s={basePath:this._basePath,path:r,method:t,handler:n};this.router.add(t,r,[n,s]),this.routes.push(s)}#s(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t}#i(t,r,n,s){if(s==="HEAD")return(async()=>new Response(null,await this.#i(t,r,n,"GET")))();const i=this.getPath(t,{env:n}),o=this.router.match(s,i),a=new rR(t,{path:i,matchResult:o,env:n,executionCtx:r,notFoundHandler:this.#r});if(o[0].length===1){let u;try{u=o[0][0][0][0](a,async()=>{a.res=await this.#r(a)})}catch(d){return this.#s(d,a)}return u instanceof Promise?u.then(d=>d||(a.finalized?a.res:this.#r(a))).catch(d=>this.#s(d,a)):u??this.#r(a)}const c=zu(o[0],this.errorHandler,this.#r);return(async()=>{try{const u=await c(a);if(!u.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return u.res}catch(u){return this.#s(u,a)}})()}fetch=(t,...r)=>this.#i(t,r[1],r[0],t.method);request=(t,r,n,s)=>t instanceof Request?this.fetch(r?new Request(t,r):t,n,s):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${ln("/",t)}`,r),n,s));fire=()=>{addEventListener("fetch",t=>{t.respondWith(this.#i(t.request,t,void 0,t.request.method))})}},ji="[^/]+",gs=".*",bs="(?:|/.*)",hn=Symbol(),aR=new Set(".\\+*[^]$()");function cR(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===gs||e===bs?1:t===gs||t===bs?-1:e===ji?1:t===ji?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var na=class{#e;#t;#r=Object.create(null);insert(t,r,n,s,i){if(t.length===0){if(this.#e!==void 0)throw hn;if(i)return;this.#e=r;return}const[o,...a]=t,c=o==="*"?a.length===0?["","",gs]:["","",ji]:o==="/*"?["","",bs]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let u;if(c){const d=c[1];let l=c[2]||ji;if(d&&c[2]&&(l===".*"||(l=l.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(l))))throw hn;if(u=this.#r[l],!u){if(Object.keys(this.#r).some(h=>h!==gs&&h!==bs))throw hn;if(i)return;u=this.#r[l]=new na,d!==""&&(u.#t=s.varIndex++)}!i&&d!==""&&n.push([d,u.#t])}else if(u=this.#r[o],!u){if(Object.keys(this.#r).some(d=>d.length>1&&d!==gs&&d!==bs))throw hn;if(i)return;u=this.#r[o]=new na}u.insert(a,r,n,s,i)}buildRegExpStr(){const r=Object.keys(this.#r).sort(cR).map(n=>{const s=this.#r[n];return(typeof s.#t=="number"?`(${n})@${s.#t}`:aR.has(n)?`\\${n}`:n)+s.buildRegExpStr()});return typeof this.#e=="number"&&r.unshift(`#${this.#e}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},uR=class{#e={varIndex:0};#t=new na;insert(e,t,r){const n=[],s=[];for(let o=0;;){let a=!1;if(e=e.replace(/\{[^}]+\}/g,c=>{const u=`@\\${o}`;return s[o]=[u,c],o++,a=!0,u}),!a)break}const i=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let o=s.length-1;o>=0;o--){const[a]=s[o];for(let c=i.length-1;c>=0;c--)if(i[c].indexOf(a)!==-1){i[c]=i[c].replace(a,s[o][1]);break}}return this.#t.insert(i,t,n,this.#e,r),n}buildRegExp(){let e=this.#t.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],n=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,i,o)=>i!==void 0?(r[++t]=Number(i),"$()"):(o!==void 0&&(n[Number(o)]=++t),"")),[new RegExp(`^${e}`),r,n]}},mf=[],dR=[/^$/,[],Object.create(null)],yf=Object.create(null);function wf(e){return yf[e]??=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`)}function lR(){yf=Object.create(null)}function hR(e){const t=new uR,r=[];if(e.length===0)return dR;const n=e.map(u=>[!/\*|\/:/.test(u[0]),...u]).sort(([u,d],[l,h])=>u?1:l?-1:d.length-h.length),s=Object.create(null);for(let u=0,d=-1,l=n.length;u<l;u++){const[h,p,m]=n[u];h?s[p]=[m.map(([g])=>[g,Object.create(null)]),mf]:d++;let y;try{y=t.insert(p,d,h)}catch(g){throw g===hn?new ff(p):g}h||(r[d]=m.map(([g,b])=>{const w=Object.create(null);for(b-=1;b>=0;b--){const[N,v]=y[b];w[N]=v}return[g,w]}))}const[i,o,a]=t.buildRegExp();for(let u=0,d=r.length;u<d;u++)for(let l=0,h=r[u].length;l<h;l++){const p=r[u][l]?.[1];if(!p)continue;const m=Object.keys(p);for(let y=0,g=m.length;y<g;y++)p[m[y]]=a[p[m[y]]]}const c=[];for(const u in o)c[u]=r[o[u]];return[i,c,s]}function an(e,t){if(e){for(const r of Object.keys(e).sort((n,s)=>s.length-n.length))if(wf(r).test(t))return[...e[r]]}}var fR=class{name="RegExpRouter";#e;#t;constructor(){this.#e={[Ce]:Object.create(null)},this.#t={[Ce]:Object.create(null)}}add(e,t,r){const n=this.#e,s=this.#t;if(!n||!s)throw new Error(hf);n[e]||[n,s].forEach(a=>{a[e]=Object.create(null),Object.keys(a[Ce]).forEach(c=>{a[e][c]=[...a[Ce][c]]})}),t==="/*"&&(t="*");const i=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const a=wf(t);e===Ce?Object.keys(n).forEach(c=>{n[c][t]||=an(n[c],t)||an(n[Ce],t)||[]}):n[e][t]||=an(n[e],t)||an(n[Ce],t)||[],Object.keys(n).forEach(c=>{(e===Ce||e===c)&&Object.keys(n[c]).forEach(u=>{a.test(u)&&n[c][u].push([r,i])})}),Object.keys(s).forEach(c=>{(e===Ce||e===c)&&Object.keys(s[c]).forEach(u=>a.test(u)&&s[c][u].push([r,i]))});return}const o=af(t)||[t];for(let a=0,c=o.length;a<c;a++){const u=o[a];Object.keys(s).forEach(d=>{(e===Ce||e===d)&&(s[d][u]||=[...an(n[d],u)||an(n[Ce],u)||[]],s[d][u].push([r,i-c+a+1]))})}}match(e,t){lR();const r=this.#r();return this.match=(n,s)=>{const i=r[n]||r[Ce],o=i[2][s];if(o)return o;const a=s.match(i[0]);if(!a)return[[],mf];const c=a.indexOf("",1);return[i[1][c],a]},this.match(e,t)}#r(){const e=Object.create(null);return Object.keys(this.#t).concat(Object.keys(this.#e)).forEach(t=>{e[t]||=this.#n(t)}),this.#e=this.#t=void 0,e}#n(e){const t=[];let r=e===Ce;return[this.#e,this.#t].forEach(n=>{const s=n[e]?Object.keys(n[e]).map(i=>[i,n[e][i]]):[];s.length!==0?(r||=!0,t.push(...s)):e!==Ce&&t.push(...Object.keys(n[Ce]).map(i=>[i,n[Ce][i]]))}),r?hR(t):null}},pR=class{name="SmartRouter";#e=[];#t=[];constructor(e){this.#e=e.routers}add(e,t,r){if(!this.#t)throw new Error(hf);this.#t.push([e,t,r])}match(e,t){if(!this.#t)throw new Error("Fatal error");const r=this.#e,n=this.#t,s=r.length;let i=0,o;for(;i<s;i++){const a=r[i];try{for(let c=0,u=n.length;c<u;c++)a.add(...n[c]);o=a.match(e,t)}catch(c){if(c instanceof ff)continue;throw c}this.match=a.match.bind(a),this.#e=[a],this.#t=void 0;break}if(i===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,o}get activeRouter(){if(this.#t||this.#e.length!==1)throw new Error("No active router has been determined yet.");return this.#e[0]}},es=Object.create(null),gf=class{#e;#t;#r;#n=0;#s=es;constructor(e,t,r){if(this.#t=r||Object.create(null),this.#e=[],e&&t){const n=Object.create(null);n[e]={handler:t,possibleKeys:[],score:0},this.#e=[n]}this.#r=[]}insert(e,t,r){this.#n=++this.#n;let n=this;const s=HS(t),i=[];for(let o=0,a=s.length;o<a;o++){const c=s[o],u=s[o+1],d=JS(c,u),l=Array.isArray(d)?d[0]:c;if(l in n.#t){n=n.#t[l],d&&i.push(d[1]);continue}n.#t[l]=new gf,d&&(n.#r.push(d),i.push(d[1])),n=n.#t[l]}return n.#e.push({[e]:{handler:r,possibleKeys:i.filter((o,a,c)=>c.indexOf(o)===a),score:this.#n}}),n}#i(e,t,r,n){const s=[];for(let i=0,o=e.#e.length;i<o;i++){const a=e.#e[i],c=a[t]||a[Ce],u={};if(c!==void 0&&(c.params=Object.create(null),s.push(c),r!==es||n&&n!==es))for(let d=0,l=c.possibleKeys.length;d<l;d++){const h=c.possibleKeys[d],p=u[c.score];c.params[h]=n?.[h]&&!p?n[h]:r[h]??n?.[h],u[c.score]=!0}}return s}search(e,t){const r=[];this.#s=es;let s=[this];const i=sf(t),o=[];for(let a=0,c=i.length;a<c;a++){const u=i[a],d=a===c-1,l=[];for(let h=0,p=s.length;h<p;h++){const m=s[h],y=m.#t[u];y&&(y.#s=m.#s,d?(y.#t["*"]&&r.push(...this.#i(y.#t["*"],e,m.#s)),r.push(...this.#i(y,e,m.#s))):l.push(y));for(let g=0,b=m.#r.length;g<b;g++){const w=m.#r[g],N=m.#s===es?{}:{...m.#s};if(w==="*"){const O=m.#t["*"];O&&(r.push(...this.#i(O,e,m.#s)),O.#s=N,l.push(O));continue}const[v,k,A]=w;if(!u&&!(A instanceof RegExp))continue;const S=m.#t[v],q=i.slice(a).join("/");if(A instanceof RegExp){const O=A.exec(q);if(O){if(N[k]=O[0],r.push(...this.#i(S,e,m.#s,N)),Object.keys(S.#t).length){S.#s=N;const $=O[0].match(/\//)?.length??0;(o[$]||=[]).push(S)}continue}}(A===!0||A.test(u))&&(N[k]=u,d?(r.push(...this.#i(S,e,N,m.#s)),S.#t["*"]&&r.push(...this.#i(S.#t["*"],e,N,m.#s))):(S.#s=N,l.push(S)))}}s=l.concat(o.shift()??[])}return r.length>1&&r.sort((a,c)=>a.score-c.score),[r.map(({handler:a,params:c})=>[a,c])]}},mR=class{name="TrieRouter";#e;constructor(){this.#e=new gf}add(e,t,r){const n=af(t);if(n){for(let s=0,i=n.length;s<i;s++)this.#e.insert(e,n[s],r);return}this.#e.insert(e,t,r)}match(e,t){return this.#e.search(e,t)}},Gr=class extends pf{constructor(e={}){super(e),this.router=e.router??new pR({routers:[new fR,new mR]})}};const qs=new Gr;qs.post("/provider",async e=>{await e.req.json();try{const t=await ho.api.signInSocial({body:{provider:"google"}});return e.json({status:!0,statusCode:200,message:"Success login provider",result:"session"})}catch(t){return t instanceof T?e.json({status:!1,statusCode:t.body?.code,message:t.message,result:null},t.body?.code??401):e.json({status:!1,statusCode:500,message:"Internal Server Error",result:t},500)}});qs.post("/login",async e=>{const t=await e.req.json();try{const r=await ho.api.signInEmail({body:{email:t.email,password:t.password}});return e.json({status:!0,statusCode:200,message:"Success login",result:{...r}},200)}catch(r){return r instanceof T?e.json({status:!1,statusCode:r.body?.code,message:r.message,result:null},r.body?.code??401):e.json({status:!1,statusCode:500,message:"Internal Server Error",result:r},500)}});qs.post("/register",async e=>{const t=await e.req.json();try{if(t.password!==t.confirmPassword)throw new T(422,{code:"422",message:"Invalid Password and Confirmation Password"});const r=await ho.api.signUpEmail({body:{email:t.email,name:t.name,password:t.password}});return e.json({status:!0,statusCode:200,message:"Success login",result:{...r}},200)}catch(r){return r instanceof T?e.json({status:!1,statusCode:r.body?.code,message:r.message,result:null},r.body?.code??401):e.json({status:!1,statusCode:500,message:"Internal Server Error",result:r},500)}});qs.get("/session",async e=>{const r=(e.req.header("authorization")||"").replace(/^Bearer\s+/i,""),n=await Kn.session.findFirst({where:{token:r},select:{id:!0,expiresAt:!0,token:!0,createdAt:!0,user:{select:{id:!0,name:!0,email:!0,image:!0,role:!0}}}});if(!n)return e.json({status:!1,statusCode:404,message:"Session not found"},404);const{user:s,...i}=n;return e.json({status:!0,statusCode:200,message:"Success get session",result:{session:i,user:s}},200)});const bf=new Gr;bf.on(["POST","GET"],"/*",e=>ho.handler(e.req.raw));const Ws=new Gr;Ws.post("/",async e=>{const t=await e.req.json();try{const r=await Kn.hospital.create({data:{id:Kr(32),name:t.name,address:t.address,email:t.email,numberPhone:t.numberPhone,open:t.open,room:t.room,adminId:t.admin_id}});return e.json({status:!0,statusCode:200,message:"Success register hospital",result:r},200)}catch{return e.json({status:!1,statusCode:500,message:"Internal Server Error",result:null},500)}});Ws.get("/",async e=>{const t=e.req.query("keyword"),r=t?{OR:[{name:{contains:t,mode:"insensitive"}},{address:{contains:t,mode:"insensitive"}}]}:{},n=await Kn.hospital.findMany({where:r,select:{id:!0,name:!0,address:!0,image:!0}});return e.json({status:!0,statusCode:200,message:"Success find hospital",result:n})});Ws.delete("/:hospital_id",async e=>{const t=e.req.param("hospital_id"),r=await Kn.hospital.delete({where:{id:t}});return e.json({status:!0,statusCode:200,message:"Success delete hospital",result:r})});Ws.put("/:hospital_id",async e=>{const t=await e.req.json(),r=e.req.param("hospital_id");try{const n=await Kn.hospital.update({where:{id:r},data:{name:t.name,address:t.address,email:t.email,numberPhone:t.numberPhone,open:t.open,room:t.room,adminId:t.admin_id}});return e.json({status:!0,statusCode:200,message:"Success update hospital",result:n})}catch{return e.json({status:!1,statusCode:500,message:"Internal Server Error",result:null})}});const vf=new Gr;vf.get("/",e=>e.json({status:!0,message:"Success create API"}));const yR=new Gr().basePath("/api"),wR=yR.route("/user",vf).route("/auth",bf).route("/sign",qs).route("/hospital",Ws);var Nt={exports:{}};const gR="17.2.3",bR={version:gR};var Vu;function vR(){if(Vu)return Nt.exports;Vu=1;var e={};const t=Cf,r=Pf,n=Uf,s=Fu,o=bR.version,a=[" encrypt with Dotenvx: https://dotenvx.com"," prevent committing .env to code: https://dotenvx.com/precommit"," prevent building .env in docker: https://dotenvx.com/prebuild"," add observability to secrets: https://dotenvx.com/ops"," sync secrets across teammates & machines: https://dotenvx.com/ops"," backup and recover secrets: https://dotenvx.com/ops"," audit secrets and track compliance: https://dotenvx.com/ops"," add secrets lifecycle management: https://dotenvx.com/ops"," add access controls to secrets: https://dotenvx.com/ops","  run anywhere with `dotenvx run -- yourcommand`","  specify custom .env file path with { path: '/custom/path/.env' }","  enable debug logging with { debug: true }","  override existing env vars with { override: true }","  suppress all logs with { quiet: true }","  write to custom object with { processEnv: myObject }","  load multiple .env files with { path: ['.env.local', '.env'] }"];function c(){return a[Math.floor(Math.random()*a.length)]}function u(E){return typeof E=="string"?!["false","0","no","off",""].includes(E.toLowerCase()):!!E}function d(){return process.stdout.isTTY}function l(E){return d()?`\x1B[2m${E}\x1B[0m`:E}const h=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function p(E){const R={};let P=E.toString();P=P.replace(/\r\n?/mg,`
`);let D;for(;(D=h.exec(P))!=null;){const W=D[1];let M=D[2]||"";M=M.trim();const U=M[0];M=M.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),U==='"'&&(M=M.replace(/\\n/g,`
`),M=M.replace(/\\r/g,"\r")),R[W]=M}return R}function m(E){E=E||{};const R=v(E);E.path=R;const P=I.configDotenv(E);if(!P.parsed){const U=new Error(`MISSING_DATA: Cannot parse ${R} for an unknown reason`);throw U.code="MISSING_DATA",U}const D=w(E).split(","),W=D.length;let M;for(let U=0;U<W;U++)try{const x=D[U].trim(),B=N(P,x);M=I.decrypt(B.ciphertext,B.key);break}catch(x){if(U+1>=W)throw x}return I.parse(M)}function y(E){console.error(`[dotenv@${o}][WARN] ${E}`)}function g(E){console.log(`[dotenv@${o}][DEBUG] ${E}`)}function b(E){console.log(`[dotenv@${o}] ${E}`)}function w(E){return E&&E.DOTENV_KEY&&E.DOTENV_KEY.length>0?E.DOTENV_KEY:e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:""}function N(E,R){let P;try{P=new URL(R)}catch(x){if(x.code==="ERR_INVALID_URL"){const B=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw B.code="INVALID_DOTENV_KEY",B}throw x}const D=P.password;if(!D){const x=new Error("INVALID_DOTENV_KEY: Missing key part");throw x.code="INVALID_DOTENV_KEY",x}const W=P.searchParams.get("environment");if(!W){const x=new Error("INVALID_DOTENV_KEY: Missing environment part");throw x.code="INVALID_DOTENV_KEY",x}const M=`DOTENV_VAULT_${W.toUpperCase()}`,U=E.parsed[M];if(!U){const x=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${M} in your .env.vault file.`);throw x.code="NOT_FOUND_DOTENV_ENVIRONMENT",x}return{ciphertext:U,key:D}}function v(E){let R=null;if(E&&E.path&&E.path.length>0)if(Array.isArray(E.path))for(const P of E.path)t.existsSync(P)&&(R=P.endsWith(".vault")?P:`${P}.vault`);else R=E.path.endsWith(".vault")?E.path:`${E.path}.vault`;else R=r.resolve(process.cwd(),".env.vault");return t.existsSync(R)?R:null}function k(E){return E[0]==="~"?r.join(n.homedir(),E.slice(1)):E}function A(E){const R=u(e.DOTENV_CONFIG_DEBUG||E&&E.debug),P=u(e.DOTENV_CONFIG_QUIET||E&&E.quiet);(R||!P)&&b("Loading env from encrypted .env.vault");const D=I._parseVault(E);let W=e;return E&&E.processEnv!=null&&(W=E.processEnv),I.populate(W,D,E),{parsed:D}}function S(E){const R=r.resolve(process.cwd(),".env");let P="utf8",D=e;E&&E.processEnv!=null&&(D=E.processEnv);let W=u(D.DOTENV_CONFIG_DEBUG||E&&E.debug),M=u(D.DOTENV_CONFIG_QUIET||E&&E.quiet);E&&E.encoding?P=E.encoding:W&&g("No encoding is specified. UTF-8 is used by default");let U=[R];if(E&&E.path)if(!Array.isArray(E.path))U=[k(E.path)];else{U=[];for(const J of E.path)U.push(k(J))}let x;const B={};for(const J of U)try{const qe=I.parse(t.readFileSync(J,{encoding:P}));I.populate(B,qe,E)}catch(qe){W&&g(`Failed to load ${J} ${qe.message}`),x=qe}const Q=I.populate(D,B,E);if(W=u(D.DOTENV_CONFIG_DEBUG||W),M=u(D.DOTENV_CONFIG_QUIET||M),W||!M){const J=Object.keys(Q).length,qe=[];for(const It of U)try{const ht=r.relative(process.cwd(),It);qe.push(ht)}catch(ht){W&&g(`Failed to load ${It} ${ht.message}`),x=ht}b(`injecting env (${J}) from ${qe.join(",")} ${l(`-- tip: ${c()}`)}`)}return x?{parsed:B,error:x}:{parsed:B}}function q(E){if(w(E).length===0)return I.configDotenv(E);const R=v(E);return R?I._configVault(E):(y(`You set DOTENV_KEY but you are missing a .env.vault file at ${R}. Did you forget to build it?`),I.configDotenv(E))}function O(E,R){const P=Buffer.from(R.slice(-64),"hex");let D=Buffer.from(E,"base64");const W=D.subarray(0,12),M=D.subarray(-16);D=D.subarray(12,-16);try{const U=s.createDecipheriv("aes-256-gcm",P,W);return U.setAuthTag(M),`${U.update(D)}${U.final()}`}catch(U){const x=U instanceof RangeError,B=U.message==="Invalid key length",Q=U.message==="Unsupported state or unable to authenticate data";if(x||B){const J=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw J.code="INVALID_DOTENV_KEY",J}else if(Q){const J=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw J.code="DECRYPTION_FAILED",J}else throw U}}function $(E,R,P={}){const D=!!(P&&P.debug),W=!!(P&&P.override),M={};if(typeof R!="object"){const U=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw U.code="OBJECT_REQUIRED",U}for(const U of Object.keys(R))Object.prototype.hasOwnProperty.call(E,U)?(W===!0&&(E[U]=R[U],M[U]=R[U]),D&&g(W===!0?`"${U}" is already defined and WAS overwritten`:`"${U}" is already defined and was NOT overwritten`)):(E[U]=R[U],M[U]=R[U]);return M}const I={configDotenv:S,_configVault:A,_parseVault:m,config:q,decrypt:O,parse:p,populate:$};return Nt.exports.configDotenv=I.configDotenv,Nt.exports._configVault=I._configVault,Nt.exports._parseVault=I._parseVault,Nt.exports.config=I.config,Nt.exports.decrypt=I.decrypt,Nt.exports.parse=I.parse,Nt.exports.populate=I.populate,Nt.exports=I,Nt.exports}var NR=vR(),ER={};NR.config();const Za=new Gr;Za.route("/",wR);Yu({fetch:Za.fetch,port:Number(ER.PORT)||3001},e=>{console.log(`Server is running on http://localhost:${e.port}`)});const sa=new Gr,AR=Object.assign({"/src/index.ts":Za});let Nf=!1;for(const[,e]of Object.entries(AR))e&&(sa.all("*",t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),sa.notFound(t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),Nf=!0);if(!Nf)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");Yu({fetch:sa.fetch,port:3e3});class Ef{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(){}async releaseMigrationLock(){}get supportsOutput(){return!0}}class Af{#e;#t=new TR;#r;#n;constructor(t){this.#e={...t}}async init(){this.#r=this.#e.database,this.#n=new kR(this.#r),this.#e.onCreateConnection&&await this.#e.onCreateConnection(this.#n)}async acquireConnection(){return await this.#t.lock(),this.#n}async beginTransaction(t){await t.executeQuery(De.raw("begin"))}async commitTransaction(t){await t.executeQuery(De.raw("commit"))}async rollbackTransaction(t){await t.executeQuery(De.raw("rollback"))}async releaseConnection(){this.#t.unlock()}async destroy(){this.#r?.close()}}class kR{#e;constructor(t){this.#e=t}executeQuery(t){const{sql:r,parameters:n}=t,s=this.#e.prepare(r);return Promise.resolve({rows:s.all(n)})}async*streamQuery(){throw new Error("Streaming query is not supported by SQLite driver.")}}let TR=class{#e;#t;async lock(){for(;this.#e;)await this.#e;this.#e=new Promise(t=>{this.#t=t})}unlock(){const t=this.#t;this.#e=void 0,this.#t=void 0,t?.()}};class kf{#e;constructor(t){this.#e=t}async getSchemas(){return[]}async getTables(t={withInternalKyselyTables:!1}){let r=this.#e.selectFrom("sqlite_schema").where("type","=","table").where("name","not like","sqlite_%").select("name").$castTo();t.withInternalKyselyTables||(r=r.where("name","!=",Jr).where("name","!=",Hn));const n=await r.execute();return Promise.all(n.map(({name:s})=>this.#t(s)))}async getMetadata(t){return{tables:await this.getTables(t)}}async#t(t){const r=this.#e,s=(await r.selectFrom("sqlite_master").where("name","=",t).select("sql").$castTo().execute())[0]?.sql?.split(/[\(\),]/)?.find(o=>o.toLowerCase().includes("autoincrement"))?.split(/\s+/)?.[0]?.replace(/["`]/g,""),i=await r.selectFrom(Ie`pragma_table_info(${t})`.as("table_info")).select(["name","type","notnull","dflt_value"]).execute();return{name:t,columns:i.map(o=>({name:o.name,dataType:o.type,isNullable:!o.notnull,isAutoIncrementing:o.name===s,hasDefaultValue:o.dflt_value!=null})),isView:!0}}}class Tf extends Bn{getCurrentParameterPlaceholder(){return"?"}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}}class _R{#e;constructor(t){this.#e={...t}}createDriver(){return new Af(this.#e)}createQueryCompiler(){return new Tf}createAdapter(){return new Ef}createIntrospector(t){return new kf(t)}}const SR=Object.freeze(Object.defineProperty({__proto__:null,BunSqliteAdapter:Ef,BunSqliteDialect:_R,BunSqliteDriver:Af,BunSqliteIntrospector:kf,BunSqliteQueryCompiler:Tf},Symbol.toStringTag,{value:"Module"}));class _f{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(){}async releaseMigrationLock(){}get supportsOutput(){return!0}}class Sf{#e;#t=new OR;#r;#n;constructor(t){this.#e={...t}}async init(){this.#r=this.#e.database,this.#n=new RR(this.#r),this.#e.onCreateConnection&&await this.#e.onCreateConnection(this.#n)}async acquireConnection(){return await this.#t.lock(),this.#n}async beginTransaction(t){await t.executeQuery(De.raw("begin"))}async commitTransaction(t){await t.executeQuery(De.raw("commit"))}async rollbackTransaction(t){await t.executeQuery(De.raw("rollback"))}async releaseConnection(){this.#t.unlock()}async destroy(){this.#r?.close()}}class RR{#e;constructor(t){this.#e=t}executeQuery(t){const{sql:r,parameters:n}=t,i=this.#e.prepare(r).all(...n);return Promise.resolve({rows:i})}async*streamQuery(){throw new Error("Streaming query is not supported by SQLite driver.")}}class OR{#e;#t;async lock(){for(;this.#e;)await this.#e;this.#e=new Promise(t=>{this.#t=t})}unlock(){const t=this.#t;this.#e=void 0,this.#t=void 0,t?.()}}class Rf{#e;constructor(t){this.#e=t}async getSchemas(){return[]}async getTables(t={withInternalKyselyTables:!1}){let r=this.#e.selectFrom("sqlite_schema").where("type","=","table").where("name","not like","sqlite_%").select("name").$castTo();t.withInternalKyselyTables||(r=r.where("name","!=",Jr).where("name","!=",Hn));const n=await r.execute();return Promise.all(n.map(({name:s})=>this.#t(s)))}async getMetadata(t){return{tables:await this.getTables(t)}}async#t(t){const r=this.#e,s=(await r.selectFrom("sqlite_master").where("name","=",t).select("sql").$castTo().execute())[0]?.sql?.split(/[\(\),]/)?.find(o=>o.toLowerCase().includes("autoincrement"))?.split(/\s+/)?.[0]?.replace(/["`]/g,""),i=await r.selectFrom(Ie`pragma_table_info(${t})`.as("table_info")).select(["name","type","notnull","dflt_value"]).execute();return{name:t,columns:i.map(o=>({name:o.name,dataType:o.type,isNullable:!o.notnull,isAutoIncrementing:o.name===s,hasDefaultValue:o.dflt_value!=null})),isView:!0}}}class Of extends Bn{getCurrentParameterPlaceholder(){return"?"}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}}class IR{#e;constructor(t){this.#e={...t}}createDriver(){return new Sf(this.#e)}createQueryCompiler(){return new Of}createAdapter(){return new _f}createIntrospector(t){return new Rf(t)}}const xR=Object.freeze(Object.defineProperty({__proto__:null,NodeSqliteAdapter:_f,NodeSqliteDialect:IR,NodeSqliteDriver:Sf,NodeSqliteIntrospector:Rf,NodeSqliteQueryCompiler:Of},Symbol.toStringTag,{value:"Module"}));export{sa as default};
//# sourceMappingURL=index.js.map
